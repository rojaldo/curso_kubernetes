<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.26">
<title>Ejercicios Prácticos de Kubernetes</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child{border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock pre>code{display:block}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active,#footnotes .footnote a:first-of-type:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<style>
pre.pygments .hll { background-color: #ffffcc }
pre.pygments { background: #f8f8f8; }
pre.pygments .tok-c { color: #3D7B7B; font-style: italic } /* Comment */
pre.pygments .tok-err { border: 1px solid #F00 } /* Error */
pre.pygments .tok-k { color: #008000; font-weight: bold } /* Keyword */
pre.pygments .tok-o { color: #666 } /* Operator */
pre.pygments .tok-ch { color: #3D7B7B; font-style: italic } /* Comment.Hashbang */
pre.pygments .tok-cm { color: #3D7B7B; font-style: italic } /* Comment.Multiline */
pre.pygments .tok-cp { color: #9C6500 } /* Comment.Preproc */
pre.pygments .tok-cpf { color: #3D7B7B; font-style: italic } /* Comment.PreprocFile */
pre.pygments .tok-c1 { color: #3D7B7B; font-style: italic } /* Comment.Single */
pre.pygments .tok-cs { color: #3D7B7B; font-style: italic } /* Comment.Special */
pre.pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
pre.pygments .tok-ge { font-style: italic } /* Generic.Emph */
pre.pygments .tok-ges { font-weight: bold; font-style: italic } /* Generic.EmphStrong */
pre.pygments .tok-gr { color: #E40000 } /* Generic.Error */
pre.pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
pre.pygments .tok-gi { color: #008400 } /* Generic.Inserted */
pre.pygments .tok-go { color: #717171 } /* Generic.Output */
pre.pygments .tok-gp { color: #000080; font-weight: bold } /* Generic.Prompt */
pre.pygments .tok-gs { font-weight: bold } /* Generic.Strong */
pre.pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
pre.pygments .tok-gt { color: #04D } /* Generic.Traceback */
pre.pygments .tok-kc { color: #008000; font-weight: bold } /* Keyword.Constant */
pre.pygments .tok-kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
pre.pygments .tok-kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
pre.pygments .tok-kp { color: #008000 } /* Keyword.Pseudo */
pre.pygments .tok-kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
pre.pygments .tok-kt { color: #B00040 } /* Keyword.Type */
pre.pygments .tok-m { color: #666 } /* Literal.Number */
pre.pygments .tok-s { color: #BA2121 } /* Literal.String */
pre.pygments .tok-na { color: #687822 } /* Name.Attribute */
pre.pygments .tok-nb { color: #008000 } /* Name.Builtin */
pre.pygments .tok-nc { color: #00F; font-weight: bold } /* Name.Class */
pre.pygments .tok-no { color: #800 } /* Name.Constant */
pre.pygments .tok-nd { color: #A2F } /* Name.Decorator */
pre.pygments .tok-ni { color: #717171; font-weight: bold } /* Name.Entity */
pre.pygments .tok-ne { color: #CB3F38; font-weight: bold } /* Name.Exception */
pre.pygments .tok-nf { color: #00F } /* Name.Function */
pre.pygments .tok-nl { color: #767600 } /* Name.Label */
pre.pygments .tok-nn { color: #00F; font-weight: bold } /* Name.Namespace */
pre.pygments .tok-nt { color: #008000; font-weight: bold } /* Name.Tag */
pre.pygments .tok-nv { color: #19177C } /* Name.Variable */
pre.pygments .tok-ow { color: #A2F; font-weight: bold } /* Operator.Word */
pre.pygments .tok-w { color: #BBB } /* Text.Whitespace */
pre.pygments .tok-mb { color: #666 } /* Literal.Number.Bin */
pre.pygments .tok-mf { color: #666 } /* Literal.Number.Float */
pre.pygments .tok-mh { color: #666 } /* Literal.Number.Hex */
pre.pygments .tok-mi { color: #666 } /* Literal.Number.Integer */
pre.pygments .tok-mo { color: #666 } /* Literal.Number.Oct */
pre.pygments .tok-sa { color: #BA2121 } /* Literal.String.Affix */
pre.pygments .tok-sb { color: #BA2121 } /* Literal.String.Backtick */
pre.pygments .tok-sc { color: #BA2121 } /* Literal.String.Char */
pre.pygments .tok-dl { color: #BA2121 } /* Literal.String.Delimiter */
pre.pygments .tok-sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
pre.pygments .tok-s2 { color: #BA2121 } /* Literal.String.Double */
pre.pygments .tok-se { color: #AA5D1F; font-weight: bold } /* Literal.String.Escape */
pre.pygments .tok-sh { color: #BA2121 } /* Literal.String.Heredoc */
pre.pygments .tok-si { color: #A45A77; font-weight: bold } /* Literal.String.Interpol */
pre.pygments .tok-sx { color: #008000 } /* Literal.String.Other */
pre.pygments .tok-sr { color: #A45A77 } /* Literal.String.Regex */
pre.pygments .tok-s1 { color: #BA2121 } /* Literal.String.Single */
pre.pygments .tok-ss { color: #19177C } /* Literal.String.Symbol */
pre.pygments .tok-bp { color: #008000 } /* Name.Builtin.Pseudo */
pre.pygments .tok-fm { color: #00F } /* Name.Function.Magic */
pre.pygments .tok-vc { color: #19177C } /* Name.Variable.Class */
pre.pygments .tok-vg { color: #19177C } /* Name.Variable.Global */
pre.pygments .tok-vi { color: #19177C } /* Name.Variable.Instance */
pre.pygments .tok-vm { color: #19177C } /* Name.Variable.Magic */
pre.pygments .tok-il { color: #666 } /* Literal.Number.Integer.Long */
</style>
</head>
<body class="article">
<div id="header">
<h1>Ejercicios Prácticos de Kubernetes</h1>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_módulo_1_introducción_a_kubernetes">1. Módulo 1: Introducción a Kubernetes</a>
<ul class="sectlevel2">
<li><a href="#_ejercicio_1_1_crear_tu_primer_pod_con_nginx">1.1. Ejercicio 1.1: Crear tu primer Pod con nginx</a></li>
<li><a href="#_ejercicio_1_2_crear_un_deployment_con_múltiples_réplicas">1.2. Ejercicio 1.2: Crear un Deployment con múltiples réplicas</a></li>
<li><a href="#_ejercicio_1_3_crear_un_service_de_tipo_clusterip_para_acceder_a_tus_pods">1.3. Ejercicio 1.3: Crear un Service de tipo ClusterIP para acceder a tus Pods</a></li>
<li><a href="#_ejercicio_1_4_crear_un_service_de_tipo_nodeport_para_acceso_externo">1.4. Ejercicio 1.4: Crear un Service de tipo NodePort para acceso externo</a></li>
<li><a href="#_ejercicio_1_5_entender_resource_requests_y_limits_scheduling">1.5. Ejercicio 1.5: Entender Resource Requests y Limits (Scheduling)</a></li>
<li><a href="#_ejercicio_1_6_trabajar_con_namespaces_y_selectors">1.6. Ejercicio 1.6: Trabajar con Namespaces y Selectors</a></li>
<li><a href="#_ejercicio_1_7_implementar_health_checks_liveness_y_readiness_probes">1.7. Ejercicio 1.7: Implementar Health Checks (Liveness y Readiness Probes)</a></li>
<li><a href="#_ejercicio_1_8_usar_configmaps_para_externalizar_configuración">1.8. Ejercicio 1.8: Usar ConfigMaps para externalizar configuración</a></li>
<li><a href="#_ejercicio_1_9_usar_secrets_para_almacenar_datos_sensibles">1.9. Ejercicio 1.9: Usar Secrets para almacenar datos sensibles</a></li>
<li><a href="#_ejercicio_1_10_realizar_rolling_updates_con_deployment">1.10. Ejercicio 1.10: Realizar Rolling Updates con Deployment</a></li>
</ul>
</li>
<li><a href="#_resumen_de_conceptos">2. Resumen de Conceptos</a></li>
<li><a href="#_módulo_2_trabajando_con_pods">3. Módulo 2: Trabajando con Pods</a>
<ul class="sectlevel2">
<li><a href="#_ejercicio_2_1_pod_multi_contenedor_con_patrón_sidecar_logging">3.1. Ejercicio 2.1: Pod multi-contenedor con patrón Sidecar (Logging)</a></li>
<li><a href="#_ejercicio_2_2_pod_con_init_containers">3.2. Ejercicio 2.2: Pod con Init Containers</a></li>
<li><a href="#_ejercicio_2_3_pod_con_patrón_ambassador_proxy">3.3. Ejercicio 2.3: Pod con patrón Ambassador (Proxy)</a></li>
<li><a href="#_ejercicio_2_4_debugging_de_pods_logs_exec_y_port_forward">3.4. Ejercicio 2.4: Debugging de Pods - Logs, Exec y Port Forward</a></li>
<li><a href="#_ejercicio_2_5_pod_con_restart_policy">3.5. Ejercicio 2.5: Pod con Restart Policy</a></li>
<li><a href="#_ejercicio_2_6_pod_con_imagepullpolicy">3.6. Ejercicio 2.6: Pod con ImagePullPolicy</a></li>
<li><a href="#_ejercicio_2_7_pod_con_securitycontext">3.7. Ejercicio 2.7: Pod con SecurityContext</a></li>
<li><a href="#_ejercicio_2_8_pod_con_labels_y_selectors_avanzados">3.8. Ejercicio 2.8: Pod con Labels y Selectors avanzados</a></li>
<li><a href="#_ejercicio_2_9_pod_con_liveness_readiness_y_startup_probes">3.9. Ejercicio 2.9: Pod con Liveness, Readiness y Startup Probes</a></li>
<li><a href="#_ejercicio_2_10_pod_con_volumes_emptydir_y_resourcequotas">3.10. Ejercicio 2.10: Pod con Volumes emptyDir y resourceQuotas</a></li>
</ul>
</li>
<li><a href="#_resumen_de_conceptos_2">4. Resumen de Conceptos</a></li>
<li><a href="#_módulo_3_controllers_y_workloads">5. Módulo 3: Controllers y Workloads</a>
<ul class="sectlevel2">
<li><a href="#_ejercicio_3_1_crear_y_gestionar_un_replicaset_básico">5.1. Ejercicio 3.1: Crear y gestionar un ReplicaSet básico</a></li>
<li><a href="#_ejercicio_3_2_escalar_un_replicaset">5.2. Ejercicio 3.2: Escalar un ReplicaSet</a></li>
<li><a href="#_ejercicio_3_3_crear_un_deployment_simple">5.3. Ejercicio 3.3: Crear un Deployment simple</a></li>
<li><a href="#_ejercicio_3_4_rolling_updates_actualizar_imagen_de_deployment">5.4. Ejercicio 3.4: Rolling Updates - Actualizar imagen de Deployment</a></li>
<li><a href="#_ejercicio_3_5_rollback_a_versión_anterior">5.5. Ejercicio 3.5: Rollback a versión anterior</a></li>
<li><a href="#_ejercicio_3_6_pausa_y_reanuda_de_deployments">5.6. Ejercicio 3.6: Pausa y reanuda de Deployments</a></li>
<li><a href="#_ejercicio_3_7_statefulset_básico">5.7. Ejercicio 3.7: StatefulSet básico</a></li>
<li><a href="#_ejercicio_3_8_statefulset_con_volumeclaimtemplates">5.8. Ejercicio 3.8: StatefulSet con volumeClaimTemplates</a></li>
<li><a href="#_ejercicio_3_9_estrategias_de_actualización_en_statefulset">5.9. Ejercicio 3.9: Estrategias de actualización en StatefulSet</a></li>
<li><a href="#_ejercicio_3_10_headless_service_para_statefulset">5.10. Ejercicio 3.10: Headless Service para StatefulSet</a></li>
</ul>
</li>
<li><a href="#_resumen_de_conceptos_3">6. Resumen de Conceptos</a></li>
<li><a href="#_módulo_4_servicios_y_redes">7. Módulo 4: Servicios y Redes</a>
<ul class="sectlevel2">
<li><a href="#_ejercicio_4_1_comunicación_pod_to_pod_directa">7.1. Ejercicio 4.1: Comunicación Pod-to-Pod directa</a></li>
<li><a href="#_ejercicio_4_2_crear_un_service_clusterip_básico">7.2. Ejercicio 4.2: Crear un Service ClusterIP básico</a></li>
<li><a href="#_ejercicio_4_3_service_nodeport_para_acceso_externo">7.3. Ejercicio 4.3: Service NodePort para acceso externo</a></li>
<li><a href="#_ejercicio_4_4_load_balancing_y_distribución_de_tráfico">7.4. Ejercicio 4.4: Load balancing y distribución de tráfico</a></li>
<li><a href="#_ejercicio_4_5_session_affinity_clientip">7.5. Ejercicio 4.5: Session Affinity (ClientIP)</a></li>
<li><a href="#_ejercicio_4_6_multi_port_services">7.6. Ejercicio 4.6: Multi-port Services</a></li>
<li><a href="#_ejercicio_4_7_dns_en_kubernetes">7.7. Ejercicio 4.7: DNS en Kubernetes</a></li>
<li><a href="#_ejercicio_4_8_ingress_básico">7.8. Ejercicio 4.8: Ingress básico</a></li>
<li><a href="#_ejercicio_4_9_ingress_con_path_based_routing">7.9. Ejercicio 4.9: Ingress con path-based routing</a></li>
<li><a href="#_ejercicio_4_10_externalname_service">7.10. Ejercicio 4.10: ExternalName Service</a></li>
</ul>
</li>
<li><a href="#_resumen_de_conceptos_4">8. Resumen de Conceptos</a></li>
<li><a href="#_próximos_pasos">9. Próximos Pasos</a></li>
<li><a href="#_módulo_5_almacenamiento">10. Módulo 5: Almacenamiento</a>
<ul class="sectlevel2">
<li><a href="#_ejercicio_5_1_pod_multi_contenedor_con_emptydir">10.1. Ejercicio 5.1: Pod Multi-Contenedor con emptyDir</a></li>
<li><a href="#_ejercicio_5_2_acceso_a_sistema_host_con_hostpath">10.2. Ejercicio 5.2: Acceso a Sistema Host con hostPath</a></li>
<li><a href="#_ejercicio_5_3_configmap_como_volumen">10.3. Ejercicio 5.3: ConfigMap como Volumen</a></li>
<li><a href="#_ejercicio_5_4_secret_como_volumen">10.4. Ejercicio 5.4: Secret como Volumen</a></li>
<li><a href="#_ejercicio_5_5_creando_persistentvolume_y_persistentvolumeclaim">10.5. Ejercicio 5.5: Creando PersistentVolume y PersistentVolumeClaim</a></li>
<li><a href="#_ejercicio_5_6_storageclass_y_dynamic_provisioning">10.6. Ejercicio 5.6: StorageClass y Dynamic Provisioning</a></li>
<li><a href="#_ejercicio_5_7_pvc_con_múltiples_contenedores">10.7. Ejercicio 5.7: PVC con Múltiples Contenedores</a></li>
<li><a href="#_ejercicio_5_8_statefulset_con_volumeclaimtemplates">10.8. Ejercicio 5.8: StatefulSet con volumeClaimTemplates</a></li>
<li><a href="#_ejercicio_5_9_expansión_de_volúmenes">10.9. Ejercicio 5.9: Expansión de Volúmenes</a></li>
<li><a href="#_ejercicio_5_10_subpath_para_múltiples_montes">10.10. Ejercicio 5.10: subPath para Múltiples Montes</a></li>
</ul>
</li>
<li><a href="#_resumen_de_conceptos_5">11. Resumen de Conceptos</a></li>
<li><a href="#_próximos_pasos_2">12. Próximos Pasos</a></li>
<li><a href="#_módulo_6_configuración_y_secrets">13. Módulo 6: Configuración y Secrets</a>
<ul class="sectlevel2">
<li><a href="#_ejercicio_6_1_configmap_básico_con_literales">13.1. Ejercicio 6.1: ConfigMap Básico con Literales</a></li>
<li><a href="#_ejercicio_6_2_configmap_desde_archivos">13.2. Ejercicio 6.2: ConfigMap desde Archivos</a></li>
<li><a href="#_ejercicio_6_3_envfrom_inyección_bulk">13.3. Ejercicio 6.3: envFrom - Inyección Bulk</a></li>
<li><a href="#_ejercicio_6_4_secret_básico">13.4. Ejercicio 6.4: Secret Básico</a></li>
<li><a href="#_ejercicio_6_5_secret_como_volumen_más_seguro">13.5. Ejercicio 6.5: Secret como Volumen (Más Seguro)</a></li>
<li><a href="#_ejercicio_6_6_secret_yaml_declarativo">13.6. Ejercicio 6.6: Secret YAML Declarativo</a></li>
<li><a href="#_ejercicio_6_7_downward_api">13.7. Ejercicio 6.7: Downward API</a></li>
<li><a href="#_ejercicio_6_8_configmap_multi_archivo_desde_directorio">13.8. Ejercicio 6.8: ConfigMap multi-archivo desde directorio</a></li>
<li><a href="#_ejercicio_6_9_combinando_configmap_y_secret_en_un_pod">13.9. Ejercicio 6.9: Combinando ConfigMap y Secret en un Pod</a></li>
<li><a href="#_ejercicio_6_10_docker_registry_secret_para_imagepullsecrets">13.10. Ejercicio 6.10: Docker Registry Secret para ImagePullSecrets</a></li>
</ul>
</li>
<li><a href="#_resumen_de_conceptos_6">14. Resumen de Conceptos</a></li>
<li><a href="#_próximos_pasos_3">15. Próximos Pasos</a></li>
<li><a href="#_módulo_7_seguridad">16. Módulo 7: Seguridad</a>
<ul class="sectlevel2">
<li><a href="#_ejercicio_7_1_creación_de_service_account">16.1. Ejercicio 7.1: Creación de Service Account</a></li>
<li><a href="#_ejercicio_7_2_role_y_rolebinding_básico">16.2. Ejercicio 7.2: Role y RoleBinding básico</a></li>
<li><a href="#_ejercicio_7_3_clusterrole_y_clusterrolebinding">16.3. Ejercicio 7.3: ClusterRole y ClusterRoleBinding</a></li>
<li><a href="#_ejercicio_7_4_rbac_con_usuarios_y_grupos">16.4. Ejercicio 7.4: RBAC con Usuarios y Grupos</a></li>
<li><a href="#_ejercicio_7_5_security_context_ejecutar_como_usuario_no_root">16.5. Ejercicio 7.5: Security Context - Ejecutar como usuario no-root</a></li>
<li><a href="#_ejercicio_7_6_capabilities_de_linux_en_security_context">16.6. Ejercicio 7.6: Capabilities de Linux en Security Context</a></li>
<li><a href="#_ejercicio_7_7_pod_security_policy_simulada_pod_security_standards">16.7. Ejercicio 7.7: Pod Security Policy simulada (Pod Security Standards)</a></li>
<li><a href="#_ejercicio_7_8_rbac_con_resources_específicas">16.8. Ejercicio 7.8: RBAC con Resources específicas</a></li>
<li><a href="#_ejercicio_7_9_auditoría_de_rbac">16.9. Ejercicio 7.9: Auditoría de RBAC</a></li>
<li><a href="#_ejercicio_7_10_namespace_isolation_con_rbac">16.10. Ejercicio 7.10: Namespace Isolation con RBAC</a></li>
</ul>
</li>
<li><a href="#_resumen_de_conceptos_7">17. Resumen de Conceptos</a></li>
<li><a href="#_próximos_pasos_4">18. Próximos Pasos</a></li>
<li><a href="#_módulo_8_observabilidad">19. Módulo 8: Observabilidad</a>
<ul class="sectlevel2">
<li><a href="#_ejercicio_8_1_obtener_logs_de_contenedores">19.1. Ejercicio 8.1: Obtener Logs de Contenedores</a></li>
<li><a href="#_ejercicio_8_2_logs_en_pods_multi_contenedor">19.2. Ejercicio 8.2: Logs en Pods Multi-Contenedor</a></li>
<li><a href="#_ejercicio_8_3_logs_de_deployments">19.3. Ejercicio 8.3: Logs de Deployments</a></li>
<li><a href="#_ejercicio_8_4_eventos_del_cluster">19.4. Ejercicio 8.4: Eventos del Cluster</a></li>
<li><a href="#_ejercicio_8_5_métricas_con_kubectl_top">19.5. Ejercicio 8.5: Métricas con kubectl top</a></li>
<li><a href="#_ejercicio_8_6_monitoreo_de_recursos_con_resource_limits">19.6. Ejercicio 8.6: Monitoreo de Recursos con Resource Limits</a></li>
<li><a href="#_ejercicio_8_7_logging_con_sidecar_pattern">19.7. Ejercicio 8.7: Logging con Sidecar Pattern</a></li>
<li><a href="#_ejercicio_8_8_exposición_de_métricas_de_aplicación">19.8. Ejercicio 8.8: Exposición de Métricas de Aplicación</a></li>
<li><a href="#_ejercicio_8_9_análisis_de_logs_con_herramientas">19.9. Ejercicio 8.9: Análisis de Logs con Herramientas</a></li>
<li><a href="#_ejercicio_8_10_health_checks_y_probes">19.10. Ejercicio 8.10: Health Checks y Probes</a></li>
</ul>
</li>
<li><a href="#_resumen_de_conceptos_8">20. Resumen de Conceptos</a></li>
<li><a href="#_módulo_9_escalado_y_performance">21. Módulo 9: Escalado y Performance</a>
<ul class="sectlevel2">
<li><a href="#_ejercicio_9_1_horizontal_pod_autoscaler_con_métrica_cpu">21.1. Ejercicio 9.1: Horizontal Pod Autoscaler con métrica CPU</a></li>
<li><a href="#_ejercicio_9_2_hpa_con_múltiples_métricas_cpu_y_memoria">21.2. Ejercicio 9.2: HPA con múltiples métricas (CPU y Memoria)</a></li>
<li><a href="#_ejercicio_9_3_vertical_pod_autoscaler_en_modo_off_recomendaciones">21.3. Ejercicio 9.3: Vertical Pod Autoscaler en modo "off" (Recomendaciones)</a></li>
<li><a href="#_ejercicio_9_4_vertical_pod_autoscaler_en_modo_initial">21.4. Ejercicio 9.4: Vertical Pod Autoscaler en modo "initial"</a></li>
<li><a href="#_ejercicio_9_5_resource_quotas_para_limitar_uso_de_namespace">21.5. Ejercicio 9.5: Resource Quotas para limitar uso de namespace</a></li>
<li><a href="#_ejercicio_9_6_pod_anti_affinity_para_alta_disponibilidad">21.6. Ejercicio 9.6: Pod Anti-Affinity para alta disponibilidad</a></li>
<li><a href="#_ejercicio_9_7_taints_y_tolerations_para_nodos_especializados">21.7. Ejercicio 9.7: Taints y Tolerations para nodos especializados</a></li>
<li><a href="#_ejercicio_9_8_priority_classes_para_preemption">21.8. Ejercicio 9.8: Priority Classes para preemption</a></li>
<li><a href="#_ejercicio_9_9_resource_limits_y_monitoreo_con_kubectl_top">21.9. Ejercicio 9.9: Resource Limits y monitoreo con kubectl top</a></li>
<li><a href="#_ejercicio_9_10_cluster_autoscaler_y_node_affinity">21.10. Ejercicio 9.10: Cluster Autoscaler y Node Affinity</a></li>
</ul>
</li>
<li><a href="#_resumen_de_conceptos_9">22. Resumen de Conceptos</a></li>
<li><a href="#_módulo_10_helm_y_package_management">23. Módulo 10: Helm y Package Management</a>
<ul class="sectlevel2">
<li><a href="#_ejercicio_10_1_gestión_de_repositorios_de_helm">23.1. Ejercicio 10.1: Gestión de Repositorios de Helm</a></li>
<li><a href="#_ejercicio_10_2_instalación_de_un_chart_desde_repositorio">23.2. Ejercicio 10.2: Instalación de un Chart desde Repositorio</a></li>
<li><a href="#_ejercicio_10_3_instalación_con_valores_personalizados">23.3. Ejercicio 10.3: Instalación con Valores Personalizados</a></li>
<li><a href="#_ejercicio_10_4_actualización_de_releases_helm_upgrade">23.4. Ejercicio 10.4: Actualización de Releases (helm upgrade)</a></li>
<li><a href="#_ejercicio_10_5_historial_y_rollback_de_releases">23.5. Ejercicio 10.5: Historial y Rollback de Releases</a></li>
<li><a href="#_ejercicio_10_6_crear_un_chart_básico_desde_cero">23.6. Ejercicio 10.6: Crear un Chart Básico desde Cero</a></li>
<li><a href="#_ejercicio_10_7_templates_con_lógica_condicionales_y_loops">23.7. Ejercicio 10.7: Templates con Lógica (Condicionales y Loops)</a></li>
<li><a href="#_ejercicio_10_8_chart_dependencies_subcharts">23.8. Ejercicio 10.8: Chart Dependencies (Subcharts)</a></li>
<li><a href="#_ejercicio_10_9_empaquetar_y_distribuir_charts">23.9. Ejercicio 10.9: Empaquetar y Distribuir Charts</a></li>
<li><a href="#_ejercicio_10_10_helm_en_cicd_despliegues_automatizados">23.10. Ejercicio 10.10: Helm en CI/CD (Despliegues Automatizados)</a></li>
</ul>
</li>
<li><a href="#_resumen_de_conceptos_10">24. Resumen de Conceptos</a></li>
<li><a href="#_módulo_11_cicd_con_kubernetes">25. Módulo 11: CI/CD con Kubernetes</a>
<ul class="sectlevel2">
<li><a href="#_ejercicio_11_1_blue_green_deployment">25.1. Ejercicio 11.1: Blue-Green Deployment</a></li>
<li><a href="#_ejercicio_11_2_canary_deployment_usando_réplicas">25.2. Ejercicio 11.2: Canary Deployment usando Réplicas</a></li>
<li><a href="#_ejercicio_11_3_rolling_update_avanzado">25.3. Ejercicio 11.3: Rolling Update Avanzado</a></li>
<li><a href="#_ejercicio_11_4_gitops_con_argocd_simulación">25.4. Ejercicio 11.4: GitOps con ArgoCD (Simulación)</a></li>
<li><a href="#_ejercicio_11_5_estrategia_de_image_pull_secrets">25.5. Ejercicio 11.5: Estrategia de Image Pull Secrets</a></li>
<li><a href="#_ejercicio_11_6_image_scanning_con_simulación">25.6. Ejercicio 11.6: Image Scanning con Simulación</a></li>
<li><a href="#_ejercicio_11_7_rolling_update_con_health_checks">25.7. Ejercicio 11.7: Rolling Update con Health Checks</a></li>
<li><a href="#_ejercicio_11_8_recreate_strategy_vs_rolling_update">25.8. Ejercicio 11.8: Recreate Strategy vs Rolling Update</a></li>
<li><a href="#_ejercicio_11_9_multi_environment_deployment">25.9. Ejercicio 11.9: Multi-Environment Deployment</a></li>
<li><a href="#_ejercicio_11_10_rollout_control_y_monitoring">25.10. Ejercicio 11.10: Rollout Control y Monitoring</a></li>
</ul>
</li>
<li><a href="#_resumen_de_conceptos_11">26. Resumen de Conceptos</a></li>
<li><a href="#_próximos_pasos_5">27. Próximos Pasos</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_módulo_1_introducción_a_kubernetes">1. Módulo 1: Introducción a Kubernetes</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_ejercicio_1_1_crear_tu_primer_pod_con_nginx">1.1. Ejercicio 1.1: Crear tu primer Pod con nginx</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Entender cómo crear un Pod simple y interactuar con él usando kubectl. Comprender que un Pod es la unidad mínima desplegable en Kubernetes.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
En este ejercicio crearás un Pod que ejecuta un servidor nginx. Esto te permitirá entender cómo Kubernetes acepta manifiestos YAML, cómo el API Server procesa la solicitud y cómo kubelet en los nodos ejecuta el contenedor.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un archivo YAML llamado <code>nginx-pod.yaml</code> con el siguiente contenido:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Pod</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx-pod</span>
<span class="tok-w">  </span><span class="tok-nt">namespace</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">default</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx:1.21</span>
<span class="tok-w">    </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">containerPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span>
<span class="tok-w">      </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">http</span></code></pre>
</div>
</div>
</li>
<li>
<p>Despliega el Pod en el cluster:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>nginx-pod.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que el Pod se creó correctamente:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>pod<span class="tok-w"> </span>nginx-pod</code></pre>
</div>
</div>
</li>
<li>
<p>Accede a los logs del contenedor:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>nginx-pod</code></pre>
</div>
</div>
</li>
<li>
<p>Ejecuta un comando dentro del contenedor:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>nginx-pod<span class="tok-w"> </span>--<span class="tok-w"> </span>bash
<span class="tok-c1"># Dentro del contenedor</span>
curl<span class="tok-w"> </span>localhost:80
<span class="tok-nb">exit</span></code></pre>
</div>
</div>
</li>
<li>
<p>Elimina el Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>nginx-pod</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong>
Deberías poder ver el Pod listado con <code>kubectl get pods</code>, acceder a su información con <code>describe</code>, ver logs y ejecutar comandos dentro del contenedor.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong>
1. ¿Qué paso ocurre después de que ejecutas <code>kubectl apply</code>?
2. ¿Quién almacena la especificación del Pod que creaste?
3. ¿En qué momento el contenedor nginx comienza a ejecutarse?
4. ¿Qué ocurriría si el Pod muere/falla? ¿Kubernetes lo reinicia automáticamente?</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_1_2_crear_un_deployment_con_múltiples_réplicas">1.2. Ejercicio 1.2: Crear un Deployment con múltiples réplicas</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Entender cómo Kubernetes mantiene el estado deseado usando Deployments y el bucle de reconciliación del Controller Manager.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
A diferencia de Pods, los Deployments aseguran que siempre haya un número específico de réplicas ejecutándose. Si una réplica falla, el Controller Manager automáticamente crea una nueva. En este ejercicio crearás un Deployment con 3 réplicas de nginx.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un archivo YAML llamado <code>nginx-deployment.yaml</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">apps/v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Deployment</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx-deployment</span>
<span class="tok-w">  </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">replicas</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">3</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">matchLabels</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx</span>
<span class="tok-w">  </span><span class="tok-nt">template</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx</span>
<span class="tok-w">    </span><span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx</span>
<span class="tok-w">        </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx:1.21</span>
<span class="tok-w">        </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">containerPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span></code></pre>
</div>
</div>
</li>
<li>
<p>Despliega el Deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>nginx-deployment.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Observa cómo se crean los Pods:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-w<span class="tok-w">  </span><span class="tok-c1"># Observar cambios en tiempo real</span></code></pre>
</div>
</div>
</li>
<li>
<p>Visualiza el estado del Deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>deployment
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>deployment<span class="tok-w"> </span>nginx-deployment</code></pre>
</div>
</div>
</li>
<li>
<p>Elimina un Pod manualmente y observa cómo Kubernetes lo recrea:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w">  </span><span class="tok-c1"># Anota el nombre de un pod</span>
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>&lt;nombre-del-pod&gt;
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-w<span class="tok-w">  </span><span class="tok-c1"># Observa cómo aparece uno nuevo</span></code></pre>
</div>
</div>
</li>
<li>
<p>Escala el Deployment a 5 réplicas:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>scale<span class="tok-w"> </span>deployment<span class="tok-w"> </span>nginx-deployment<span class="tok-w"> </span>--replicas<span class="tok-o">=</span><span class="tok-m">5</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods</code></pre>
</div>
</div>
</li>
<li>
<p>Reduce nuevamente a 3 réplicas:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>scale<span class="tok-w"> </span>deployment<span class="tok-w"> </span>nginx-deployment<span class="tok-w"> </span>--replicas<span class="tok-o">=</span><span class="tok-m">3</span></code></pre>
</div>
</div>
</li>
<li>
<p>Elimina el Deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>deployment<span class="tok-w"> </span>nginx-deployment</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong>
Deberías ver 3 Pods corriendo. Cuando elimines un Pod, debería aparecer automáticamente uno nuevo. El número de réplicas debería cambiar dinámicamente cuando uses <code>scale</code>.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong>
1. ¿Cuál es la diferencia entre un Pod y un Deployment?
2. ¿Qué componente se da cuenta de que una réplica está faltando y crea una nueva?
3. ¿Dónde se almacena el número deseado de réplicas (3, 5, etc.)?
4. Si accidentalmente modificas el YAML para que diga 10 réplicas, ¿qué ocurriría?</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_1_3_crear_un_service_de_tipo_clusterip_para_acceder_a_tus_pods">1.3. Ejercicio 1.3: Crear un Service de tipo ClusterIP para acceder a tus Pods</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Entender cómo los Services actúan como abstracciones estables para acceder a un conjunto de Pods en cambio constante. Comprender cómo kube-proxy implementa las reglas de networking.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Los Pods son efímeros; su IP puede cambiar cuando se reinician. Los Services proporcionan una IP estable y un nombre DNS para acceder a un conjunto de Pods. Un Service ClusterIP es accesible solo dentro del cluster.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Primero, asegúrate de tener un Deployment ejecutándose (reutiliza el de 1.2):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>nginx-deployment.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un archivo YAML llamado <code>nginx-service-clusterip.yaml</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Service</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx-service</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">type</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">ClusterIP</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx</span>
<span class="tok-w">  </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">protocol</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">TCP</span>
<span class="tok-w">    </span><span class="tok-nt">port</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span>
<span class="tok-w">    </span><span class="tok-nt">targetPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea el Service:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>nginx-service-clusterip.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Inspecciona el Service:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>svc
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>svc<span class="tok-w"> </span>nginx-service</code></pre>
</div>
</div>
</li>
<li>
<p>Obtén la IP del ClusterIP (normalmente en rango 10.x.x.x):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>svc<span class="tok-w"> </span>nginx-service<span class="tok-w"> </span>-o<span class="tok-w"> </span>wide</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod de prueba temporal para acceder al service desde dentro del cluster:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>run<span class="tok-w"> </span>-it<span class="tok-w"> </span>debug-pod<span class="tok-w"> </span>--image<span class="tok-o">=</span>busybox<span class="tok-w"> </span>--rm<span class="tok-w"> </span>--<span class="tok-w"> </span>wget<span class="tok-w"> </span>-O-<span class="tok-w"> </span>http://nginx-service</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que DNS resuelve el nombre del service:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>run<span class="tok-w"> </span>-it<span class="tok-w"> </span>debug-pod<span class="tok-w"> </span>--image<span class="tok-o">=</span>busybox<span class="tok-w"> </span>--rm<span class="tok-w"> </span>--<span class="tok-w"> </span>nslookup<span class="tok-w"> </span>nginx-service</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia los recursos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>-f<span class="tok-w"> </span>nginx-service-clusterip.yaml
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>-f<span class="tok-w"> </span>nginx-deployment.yaml</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong>
El Service debería tener una IP estable asignada. Desde un Pod dentro del cluster, deberías poder acceder al service usando tanto la IP como el nombre DNS (nginx-service).</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong>
1. ¿Cómo sabe el Service a qué Pods enviar tráfico?
2. ¿Qué pasa si eliminas uno de los Pods del Deployment? ¿Sigue funcionando el Service?
3. ¿Qué componente del nodo crea las reglas de iptables que hacen posible que el tráfico llegue a los Pods?
4. ¿Por qué ClusterIP no es accesible desde fuera del cluster?</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_1_4_crear_un_service_de_tipo_nodeport_para_acceso_externo">1.4. Ejercicio 1.4: Crear un Service de tipo NodePort para acceso externo</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Entender cómo exponer un Service fuera del cluster usando NodePort.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Mientras que ClusterIP solo es accesible dentro del cluster, NodePort abre un puerto en cada nodo del cluster para que el tráfico externo pueda llegar a tu aplicación.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Asegúrate de tener un Deployment ejecutándose:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>nginx-deployment.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un archivo YAML llamado <code>nginx-service-nodeport.yaml</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Service</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx-nodeport-service</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">type</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">NodePort</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx</span>
<span class="tok-w">  </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">protocol</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">TCP</span>
<span class="tok-w">    </span><span class="tok-nt">port</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span>
<span class="tok-w">    </span><span class="tok-nt">targetPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span>
<span class="tok-w">    </span><span class="tok-nt">nodePort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">30080</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea el Service:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>nginx-service-nodeport.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el Service:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>svc
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>svc<span class="tok-w"> </span>nginx-nodeport-service</code></pre>
</div>
</div>
</li>
<li>
<p>Obtén la IP de uno de los nodos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>nodes<span class="tok-w"> </span>-o<span class="tok-w"> </span>wide</code></pre>
</div>
</div>
</li>
<li>
<p>Accede al servicio desde fuera del cluster:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Si usas Minikube o Docker Desktop</span>
curl<span class="tok-w"> </span>http://localhost:30080

<span class="tok-c1"># Si usas un cluster en la nube, usa la IP pública del nodo</span>
curl<span class="tok-w"> </span>http://&lt;node-ip&gt;:30080</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>-f<span class="tok-w"> </span>nginx-service-nodeport.yaml
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>-f<span class="tok-w"> </span>nginx-deployment.yaml</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong>
Deberías poder acceder a nginx desde tu navegador o con curl en el puerto 30080 desde cualquier máquina que pueda llegar a tu cluster.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong>
1. ¿Cuál es la diferencia entre el puerto 80 y el 30080 en la configuración?
2. ¿Qué ocurre si accedes al puerto 30080 de un nodo donde no hay pods de nginx?
3. ¿Por qué Kubernetes necesita abrir un puerto en todos los nodos?
4. ¿Cuál es la ventaja del Service sobre acceder directamente a la IP del Pod?</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_1_5_entender_resource_requests_y_limits_scheduling">1.5. Ejercicio 1.5: Entender Resource Requests y Limits (Scheduling)</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Comprender cómo el Scheduler de Kubernetes toma decisiones basándose en los recursos solicitados y disponibles en los nodos.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
El Scheduler considera los resource requests para decidir en qué nodo colocar un Pod. Sin resource requests adecuados, el Scheduler puede tomar decisiones pobres y sobrecargar nodos. Los limits previenen que un contenedor consuma demasiados recursos.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un archivo YAML llamado <code>resource-aware-deployment.yaml</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">apps/v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Deployment</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">resource-aware-app</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">replicas</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">3</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">matchLabels</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">resource-aware</span>
<span class="tok-w">  </span><span class="tok-nt">template</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">resource-aware</span>
<span class="tok-w">    </span><span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">        </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx:1.21</span>
<span class="tok-w">        </span><span class="tok-nt">resources</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">requests</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;256Mi&quot;</span>
<span class="tok-w">            </span><span class="tok-nt">cpu</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;100m&quot;</span>
<span class="tok-w">          </span><span class="tok-nt">limits</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;512Mi&quot;</span>
<span class="tok-w">            </span><span class="tok-nt">cpu</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;500m&quot;</span>
<span class="tok-w">        </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">containerPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span></code></pre>
</div>
</div>
</li>
<li>
<p>Despliega el Deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>resource-aware-deployment.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Obtén información sobre los Pods y nodos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-o<span class="tok-w"> </span>wide
kubectl<span class="tok-w"> </span>top<span class="tok-w"> </span>nodes<span class="tok-w">  </span><span class="tok-c1"># Muestra uso actual de recursos</span>
kubectl<span class="tok-w"> </span>top<span class="tok-w"> </span>pods<span class="tok-w">   </span><span class="tok-c1"># Muestra uso actual de recursos</span></code></pre>
</div>
</div>
</li>
<li>
<p>Describe un Pod para ver los recursos asignados:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>pod<span class="tok-w"> </span>&lt;nombre-del-pod&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Intenta crear un Pod con recursos irrazonablemente altos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Pod</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">resource-hungry-pod</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">huge</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx</span>
<span class="tok-w">    </span><span class="tok-nt">resources</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">requests</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;100Gi&quot;</span>
<span class="tok-w">        </span><span class="tok-nt">cpu</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;100&quot;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Aplica este YAML:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>resource-hungry-pod.yaml
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>pod<span class="tok-w"> </span>resource-hungry-pod</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>El Pod debería quedar en estado Pending porque no hay suficientes recursos.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>-f<span class="tok-w"> </span>resource-aware-deployment.yaml
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>-f<span class="tok-w"> </span>resource-hungry-pod.yaml</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong>
Los Pods deberían mostrar sus resource requests cuando los describes. El Pod con recursos irrazonables debería quedar Pending.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong>
1. ¿Quién toma la decisión de no programar el Pod hambriento en un nodo?
2. ¿Cuál es la diferencia entre requests y limits?
3. ¿Qué ocurre si un contenedor intenta usar más memoria que su límite?
4. ¿Cómo saben los Pods qué recursos están disponibles?</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_1_6_trabajar_con_namespaces_y_selectors">1.6. Ejercicio 1.6: Trabajar con Namespaces y Selectors</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Entender cómo los Namespaces proporcionan aislamiento lógico en un cluster. Comprender cómo los Labels y Selectors agrupan recursos.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Los Namespaces son particiones virtuales dentro de un cluster. Los Labels son pares clave-valor que se pueden usar para identificar y seleccionar objetos. Los Selectors usan Labels para filtrar recursos.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un nuevo namespace:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>create<span class="tok-w"> </span>namespace<span class="tok-w"> </span>my-app
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>namespaces</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Deployment en el nuevo namespace:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">apps/v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Deployment</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app-prod</span>
<span class="tok-w">  </span><span class="tok-nt">namespace</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">my-app</span>
<span class="tok-w">  </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">web</span>
<span class="tok-w">    </span><span class="tok-nt">environment</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">production</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">replicas</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">2</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">matchLabels</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">web</span>
<span class="tok-w">      </span><span class="tok-nt">environment</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">production</span>
<span class="tok-w">  </span><span class="tok-nt">template</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">web</span>
<span class="tok-w">        </span><span class="tok-nt">environment</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">production</span>
<span class="tok-w">    </span><span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx</span>
<span class="tok-w">        </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx:1.21</span>
<span class="tok-w">        </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">containerPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span></code></pre>
</div>
</div>
</li>
<li>
<p>Aplica el Deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>app-deployment.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Lista Pods en el namespace específico:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-n<span class="tok-w"> </span>my-app</code></pre>
</div>
</div>
</li>
<li>
<p>Crea otro Deployment con labels diferentes en el mismo namespace:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">apps/v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Deployment</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app-dev</span>
<span class="tok-w">  </span><span class="tok-nt">namespace</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">my-app</span>
<span class="tok-w">  </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">web</span>
<span class="tok-w">    </span><span class="tok-nt">environment</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">development</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">replicas</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">1</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">matchLabels</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">web</span>
<span class="tok-w">      </span><span class="tok-nt">environment</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">development</span>
<span class="tok-w">  </span><span class="tok-nt">template</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">web</span>
<span class="tok-w">        </span><span class="tok-nt">environment</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">development</span>
<span class="tok-w">    </span><span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx</span>
<span class="tok-w">        </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx:1.21</span>
<span class="tok-w">        </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">containerPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span></code></pre>
</div>
</div>
</li>
<li>
<p>Aplica el segundo Deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>app-dev-deployment.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Usa selectors para filtrar Pods:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Todos los pods con label app=web</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-n<span class="tok-w"> </span>my-app<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>web

<span class="tok-c1"># Solo pods de producción</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-n<span class="tok-w"> </span>my-app<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">environment</span><span class="tok-o">=</span>production

<span class="tok-c1"># Pods que NO son development</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-n<span class="tok-w"> </span>my-app<span class="tok-w"> </span>-l<span class="tok-w"> </span>environment!<span class="tok-o">=</span>development</code></pre>
</div>
</div>
</li>
<li>
<p>Describe ambos deployments:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>deployment<span class="tok-w"> </span>app-prod<span class="tok-w"> </span>-n<span class="tok-w"> </span>my-app
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>deployment<span class="tok-w"> </span>app-dev<span class="tok-w"> </span>-n<span class="tok-w"> </span>my-app</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>namespace<span class="tok-w"> </span>my-app</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong>
Deberías ver dos Pods en el namespace <code>my-app</code>, con selectors que te permitan filtrar por labels.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong>
1. ¿Cómo sabe el Deployment qué Pods debe gestionar?
2. ¿Qué ocurriría si tienes dos Deployments con el mismo selector en el mismo namespace?
3. ¿Cuál es la ventaja de usar Labels respecto a los nombres de los Pods?
4. ¿Puedes acceder a Pods en otros namespaces desde el mismo cluster?</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_1_7_implementar_health_checks_liveness_y_readiness_probes">1.7. Ejercicio 1.7: Implementar Health Checks (Liveness y Readiness Probes)</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Entender cómo kubelet monitorea la salud de los contenedores y mantiene la aplicación disponible mediante probes.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Los Liveness Probes detectan si un contenedor está vivo pero bloqueado (para reiniciarlo). Los Readiness Probes detectan si la aplicación está lista para recibir tráfico. Estos son críticos para mantener la alta disponibilidad.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un archivo YAML llamado <code>health-check-deployment.yaml</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">apps/v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Deployment</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">health-check-app</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">replicas</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">2</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">matchLabels</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">health-app</span>
<span class="tok-w">  </span><span class="tok-nt">template</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">health-app</span>
<span class="tok-w">    </span><span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx</span>
<span class="tok-w">        </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx:1.21</span>
<span class="tok-w">        </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">containerPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span>
<span class="tok-w">        </span><span class="tok-nt">livenessProbe</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">httpGet</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-nt">path</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/</span>
<span class="tok-w">            </span><span class="tok-nt">port</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span>
<span class="tok-w">          </span><span class="tok-nt">initialDelaySeconds</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">10</span>
<span class="tok-w">          </span><span class="tok-nt">periodSeconds</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">10</span>
<span class="tok-w">        </span><span class="tok-nt">readinessProbe</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">httpGet</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-nt">path</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/</span>
<span class="tok-w">            </span><span class="tok-nt">port</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span>
<span class="tok-w">          </span><span class="tok-nt">initialDelaySeconds</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">5</span>
<span class="tok-w">          </span><span class="tok-nt">periodSeconds</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">5</span></code></pre>
</div>
</div>
</li>
<li>
<p>Despliega el Deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>health-check-deployment.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Observa los Pods:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods</code></pre>
</div>
</div>
</li>
<li>
<p>Describe un Pod para ver información sobre los probes:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>pod<span class="tok-w"> </span>&lt;nombre-del-pod&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Accede a los logs del contenedor para ver las pruebas de health:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>&lt;nombre-del-pod&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Deployment con un Probe fallido para ver qué ocurre:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">apps/v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Deployment</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">failing-health-app</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">replicas</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">1</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">matchLabels</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">failing-app</span>
<span class="tok-w">  </span><span class="tok-nt">template</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">failing-app</span>
<span class="tok-w">    </span><span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">        </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">busybox</span>
<span class="tok-w">        </span><span class="tok-nt">command</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">[</span><span class="tok-s">&quot;sh&quot;</span><span class="tok-p tok-p-Indicator">,</span><span class="tok-w"> </span><span class="tok-s">&quot;-c&quot;</span><span class="tok-p tok-p-Indicator">,</span><span class="tok-w"> </span><span class="tok-s">&quot;echo</span><span class="tok-nv"> </span><span class="tok-s">&#39;App</span><span class="tok-nv"> </span><span class="tok-s">is</span><span class="tok-nv"> </span><span class="tok-s">running&#39;</span><span class="tok-nv"> </span><span class="tok-s">&amp;&amp;</span><span class="tok-nv"> </span><span class="tok-s">sleep</span><span class="tok-nv"> </span><span class="tok-s">30000&quot;</span><span class="tok-p tok-p-Indicator">]</span>
<span class="tok-w">        </span><span class="tok-nt">livenessProbe</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">exec</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-nt">command</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/bin/sh</span>
<span class="tok-w">            </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">-c</span>
<span class="tok-w">            </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-s">&quot;exit</span><span class="tok-nv"> </span><span class="tok-s">1&quot;</span><span class="tok-w">  </span><span class="tok-c1"># Esto siempre falla</span>
<span class="tok-w">          </span><span class="tok-nt">initialDelaySeconds</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">5</span>
<span class="tok-w">          </span><span class="tok-nt">periodSeconds</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">5</span>
<span class="tok-w">          </span><span class="tok-nt">failureThreshold</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">3</span></code></pre>
</div>
</div>
</li>
<li>
<p>Aplica este Deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>failing-health-app.yaml
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-w<span class="tok-w">  </span><span class="tok-c1"># Observa cómo se reinicia constantemente</span></code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>-f<span class="tok-w"> </span>health-check-deployment.yaml
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>-f<span class="tok-w"> </span>failing-health-app.yaml</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong>
El primer Deployment debería tener Pods Running y Ready. El segundo debería mostrar múltiples reiniciaciones.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong>
1. ¿Cuál es la diferencia entre Liveness y Readiness?
2. ¿Qué componente ejecuta los probes?
3. ¿Qué ocurre si un Pod no pasa el Readiness Probe pero sí el Liveness Probe?
4. ¿Cómo afectan los probes al balanceo de carga del Service?</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_1_8_usar_configmaps_para_externalizar_configuración">1.8. Ejercicio 1.8: Usar ConfigMaps para externalizar configuración</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Entender cómo separar la configuración del código usando ConfigMaps. Aprender sobre la gestión de configuración en Kubernetes.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
ConfigMaps almacenan datos de configuración en pares clave-valor. Esto permite cambiar la configuración sin reconstruir imágenes de contenedor.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un ConfigMap usando kubectl:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>create<span class="tok-w"> </span>configmap<span class="tok-w"> </span>app-config<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--from-literal<span class="tok-o">=</span><span class="tok-nv">APP_NAME</span><span class="tok-o">=</span>MyWebApp<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--from-literal<span class="tok-o">=</span><span class="tok-nv">LOG_LEVEL</span><span class="tok-o">=</span>info<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--from-literal<span class="tok-o">=</span><span class="tok-nv">MAX_CONNECTIONS</span><span class="tok-o">=</span><span class="tok-m">100</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el ConfigMap:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>configmap
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>configmap<span class="tok-w"> </span>app-config
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>configmap<span class="tok-w"> </span>app-config<span class="tok-w"> </span>-o<span class="tok-w"> </span>yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Deployment que use el ConfigMap:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">apps/v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Deployment</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">configmap-demo</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">replicas</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">1</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">matchLabels</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">configmap-app</span>
<span class="tok-w">  </span><span class="tok-nt">template</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">configmap-app</span>
<span class="tok-w">    </span><span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">        </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">busybox</span>
<span class="tok-w">        </span><span class="tok-nt">command</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">[</span><span class="tok-s">&quot;sh&quot;</span><span class="tok-p tok-p-Indicator">,</span><span class="tok-w"> </span><span class="tok-s">&quot;-c&quot;</span><span class="tok-p tok-p-Indicator">,</span><span class="tok-w"> </span><span class="tok-s">&quot;env</span><span class="tok-nv"> </span><span class="tok-s">|</span><span class="tok-nv"> </span><span class="tok-s">grep</span><span class="tok-nv"> </span><span class="tok-s">APP</span><span class="tok-nv"> </span><span class="tok-s">&amp;&amp;</span><span class="tok-nv"> </span><span class="tok-s">sleep</span><span class="tok-nv"> </span><span class="tok-s">30000&quot;</span><span class="tok-p tok-p-Indicator">]</span>
<span class="tok-w">        </span><span class="tok-nt">env</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">APP_NAME</span>
<span class="tok-w">          </span><span class="tok-nt">valueFrom</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-nt">configMapKeyRef</span><span class="tok-p">:</span>
<span class="tok-w">              </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app-config</span>
<span class="tok-w">              </span><span class="tok-nt">key</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">APP_NAME</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">LOG_LEVEL</span>
<span class="tok-w">          </span><span class="tok-nt">valueFrom</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-nt">configMapKeyRef</span><span class="tok-p">:</span>
<span class="tok-w">              </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app-config</span>
<span class="tok-w">              </span><span class="tok-nt">key</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">LOG_LEVEL</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">MAX_CONNECTIONS</span>
<span class="tok-w">          </span><span class="tok-nt">valueFrom</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-nt">configMapKeyRef</span><span class="tok-p">:</span>
<span class="tok-w">              </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app-config</span>
<span class="tok-w">              </span><span class="tok-nt">key</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">MAX_CONNECTIONS</span></code></pre>
</div>
</div>
</li>
<li>
<p>Aplica el Deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>configmap-deployment.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica las variables de entorno:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>&lt;nombre-del-pod&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un ConfigMap a partir de un archivo:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Crea un archivo de configuración</span>
cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>app.properties<span class="tok-w"> </span><span class="tok-s">&lt;&lt; EOF</span>
<span class="tok-s">database.host=localhost</span>
<span class="tok-s">database.port=5432</span>
<span class="tok-s">cache.enabled=true</span>
<span class="tok-s">EOF</span>

<span class="tok-c1"># Crea el ConfigMap</span>
kubectl<span class="tok-w"> </span>create<span class="tok-w"> </span>configmap<span class="tok-w"> </span>app-properties<span class="tok-w"> </span>--from-file<span class="tok-o">=</span>app.properties

<span class="tok-c1"># Verifica</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>configmap<span class="tok-w"> </span>app-properties<span class="tok-w"> </span>-o<span class="tok-w"> </span>yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>deployment<span class="tok-w"> </span>configmap-demo
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>configmap<span class="tok-w"> </span>app-config
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>configmap<span class="tok-w"> </span>app-properties
rm<span class="tok-w"> </span>app.properties</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong>
Los Pods deberían tener las variables de entorno establecidas desde el ConfigMap.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong>
1. ¿Dónde se almacena la información del ConfigMap?
2. ¿Cuándo reciben los Pods la configuración del ConfigMap?
3. ¿Qué ocurre si cambias el ConfigMap después de que el Pod está ejecutándose?
4. ¿Cómo podrías usar ConfigMaps para montar archivos de configuración?</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_1_9_usar_secrets_para_almacenar_datos_sensibles">1.9. Ejercicio 1.9: Usar Secrets para almacenar datos sensibles</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Entender cómo Kubernetes almacena datos sensibles como contraseñas y tokens usando Secrets.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Secrets almacenan datos sensibles de forma segura (aunque por defecto codificados en base64, no encriptados). Se usan para credenciales de base de datos, tokens API, etc.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un Secret usando kubectl:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>create<span class="tok-w"> </span>secret<span class="tok-w"> </span>generic<span class="tok-w"> </span>db-credentials<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--from-literal<span class="tok-o">=</span><span class="tok-nv">username</span><span class="tok-o">=</span>admin<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--from-literal<span class="tok-o">=</span><span class="tok-nv">password</span><span class="tok-o">=</span>supersecretpassword</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el Secret:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>secret
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>secret<span class="tok-w"> </span>db-credentials
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>secret<span class="tok-w"> </span>db-credentials<span class="tok-w"> </span>-o<span class="tok-w"> </span>yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Deployment que use el Secret:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">apps/v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Deployment</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">secret-demo</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">replicas</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">1</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">matchLabels</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">secret-app</span>
<span class="tok-w">  </span><span class="tok-nt">template</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">secret-app</span>
<span class="tok-w">    </span><span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">        </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">busybox</span>
<span class="tok-w">        </span><span class="tok-nt">command</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">[</span><span class="tok-s">&quot;sh&quot;</span><span class="tok-p tok-p-Indicator">,</span><span class="tok-w"> </span><span class="tok-s">&quot;-c&quot;</span><span class="tok-p tok-p-Indicator">,</span><span class="tok-w"> </span><span class="tok-s">&quot;echo</span><span class="tok-nv"> </span><span class="tok-s">&#39;DB</span><span class="tok-nv"> </span><span class="tok-s">User:</span><span class="tok-nv"> </span><span class="tok-s">$DB_USER&#39;</span><span class="tok-nv"> </span><span class="tok-s">&amp;&amp;</span><span class="tok-nv"> </span><span class="tok-s">echo</span><span class="tok-nv"> </span><span class="tok-s">&#39;DB</span><span class="tok-nv"> </span><span class="tok-s">Pass:</span><span class="tok-nv"> </span><span class="tok-s">$DB_PASS&#39;</span><span class="tok-nv"> </span><span class="tok-s">&amp;&amp;</span><span class="tok-nv"> </span><span class="tok-s">sleep</span><span class="tok-nv"> </span><span class="tok-s">30000&quot;</span><span class="tok-p tok-p-Indicator">]</span>
<span class="tok-w">        </span><span class="tok-nt">env</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">DB_USER</span>
<span class="tok-w">          </span><span class="tok-nt">valueFrom</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-nt">secretKeyRef</span><span class="tok-p">:</span>
<span class="tok-w">              </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">db-credentials</span>
<span class="tok-w">              </span><span class="tok-nt">key</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">username</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">DB_PASS</span>
<span class="tok-w">          </span><span class="tok-nt">valueFrom</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-nt">secretKeyRef</span><span class="tok-p">:</span>
<span class="tok-w">              </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">db-credentials</span>
<span class="tok-w">              </span><span class="tok-nt">key</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">password</span></code></pre>
</div>
</div>
</li>
<li>
<p>Aplica el Deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>secret-deployment.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que el Pod tenga acceso a las credenciales:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>&lt;nombre-del-pod&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Secret a partir de archivos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Crea certificados de ejemplo</span>
<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;-----BEGIN CERTIFICATE-----&quot;</span><span class="tok-w"> </span>&gt;<span class="tok-w"> </span>cert.pem
<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;MIIDXTCCAkWgAwIBAgIJAJ...&quot;</span><span class="tok-w"> </span>&gt;&gt;<span class="tok-w"> </span>cert.pem
<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;-----END CERTIFICATE-----&quot;</span><span class="tok-w"> </span>&gt;&gt;<span class="tok-w"> </span>cert.pem

<span class="tok-c1"># Crea el Secret</span>
kubectl<span class="tok-w"> </span>create<span class="tok-w"> </span>secret<span class="tok-w"> </span>tls<span class="tok-w"> </span>tls-secret<span class="tok-w"> </span>--cert<span class="tok-o">=</span>cert.pem<span class="tok-w"> </span>--key<span class="tok-o">=</span>key.pem

<span class="tok-c1"># Verifica</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>secret<span class="tok-w"> </span>tls-secret<span class="tok-w"> </span>-o<span class="tok-w"> </span>yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>deployment<span class="tok-w"> </span>secret-demo
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>secret<span class="tok-w"> </span>db-credentials
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>secret<span class="tok-w"> </span>tls-secret
rm<span class="tok-w"> </span>cert.pem<span class="tok-w"> </span>key.pem</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong>
Los Pods deberían tener acceso a los datos del Secret a través de variables de entorno.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong>
1. ¿Dónde se almacenan los Secrets en el cluster?
2. ¿Son verdaderamente seguros los Secrets por defecto?
3. ¿Cómo se transmiten los Secrets desde el API Server a los Pods?
4. ¿Qué tipos de Secrets existen en Kubernetes?</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_1_10_realizar_rolling_updates_con_deployment">1.10. Ejercicio 1.10: Realizar Rolling Updates con Deployment</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Entender cómo Kubernetes actualiza aplicaciones sin downtime usando Rolling Updates. Comprender cómo el Deployment Controller gestiona estas actualizaciones.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Los Rolling Updates son el mecanismo que usa Kubernetes para actualizar aplicaciones manteniendo disponibilidad. Los Pods se sustituyen gradualmente con la nueva versión.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un Deployment inicial con nginx 1.20:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">apps/v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Deployment</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">rolling-update-demo</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">replicas</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">4</span>
<span class="tok-w">  </span><span class="tok-nt">strategy</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">type</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">RollingUpdate</span>
<span class="tok-w">    </span><span class="tok-nt">rollingUpdate</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">maxSurge</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">1</span>
<span class="tok-w">      </span><span class="tok-nt">maxUnavailable</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">1</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">matchLabels</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">rolling-app</span>
<span class="tok-w">  </span><span class="tok-nt">template</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">rolling-app</span>
<span class="tok-w">      </span><span class="tok-nt">annotations</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">version</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;1.20&quot;</span>
<span class="tok-w">    </span><span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx</span>
<span class="tok-w">        </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx:1.20</span>
<span class="tok-w">        </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">containerPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span></code></pre>
</div>
</div>
</li>
<li>
<p>Despliega el Deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>rolling-update-deployment.yaml
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica la versión actual:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>deployment<span class="tok-w"> </span>rolling-update-demo</code></pre>
</div>
</div>
</li>
<li>
<p>Actualiza la imagen a nginx 1.21:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span><span class="tok-nb">set</span><span class="tok-w"> </span>image<span class="tok-w"> </span>deployment/rolling-update-demo<span class="tok-w"> </span><span class="tok-nv">nginx</span><span class="tok-o">=</span>nginx:1.21</code></pre>
</div>
</div>
</li>
<li>
<p>Observa el progreso de la actualización en tiempo real:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-w</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica los ReplicaSets creados:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>rs
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>rs<span class="tok-w"> </span>&lt;nombre-del-rs&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Revisa el historial de cambios:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>rollout<span class="tok-w"> </span><span class="tok-nb">history</span><span class="tok-w"> </span>deployment<span class="tok-w"> </span>rolling-update-demo</code></pre>
</div>
</div>
</li>
<li>
<p>Si algo sale mal, haz rollback a la versión anterior:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>rollout<span class="tok-w"> </span>undo<span class="tok-w"> </span>deployment<span class="tok-w"> </span>rolling-update-demo
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-w<span class="tok-w">  </span><span class="tok-c1"># Observa cómo vuelve a nginx 1.20</span></code></pre>
</div>
</div>
</li>
<li>
<p>Redeploy a nginx 1.21 nuevamente:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span><span class="tok-nb">set</span><span class="tok-w"> </span>image<span class="tok-w"> </span>deployment/rolling-update-demo<span class="tok-w"> </span><span class="tok-nv">nginx</span><span class="tok-o">=</span>nginx:1.21</code></pre>
</div>
</div>
</li>
<li>
<p>Prueba con una actualización pausada:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>rollout<span class="tok-w"> </span>pause<span class="tok-w"> </span>deployment<span class="tok-w"> </span>rolling-update-demo
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w">  </span><span class="tok-c1"># Algunos estarán en 1.21, otros en 1.20</span></code></pre>
</div>
</div>
</li>
<li>
<p>Resume la actualización:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>rollout<span class="tok-w"> </span>resume<span class="tok-w"> </span>deployment<span class="tok-w"> </span>rolling-update-demo
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-w</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>deployment<span class="tok-w"> </span>rolling-update-demo</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong>
Deberías ver Pods siendo reemplazados gradualmente sin que el servicio se interrumpa. El historial de cambios debería mostrar múltiples revisiones.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong>
1. ¿Qué ocurre con los Pods antiguos cuando actualizas la imagen?
2. ¿Quién gestiona el proceso de Rolling Update?
3. ¿Qué significa <code>maxSurge</code> y <code>maxUnavailable</code>?
4. ¿Cómo sabes si la actualización es segura antes de completarla?
5. ¿Cómo se relaciona el Deployment Controller con los ReplicaSets?
6. ¿Cuántas versiones anteriores se mantienen en el historial?</p>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resumen_de_conceptos">2. Resumen de Conceptos</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Estos ejercicios cubren los aspectos fundamentales del Módulo 1:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Ejercicio 1.1</strong>: Uso básico de kubectl y el flujo Pod → API Server → kubelet → Container Runtime</p>
</li>
<li>
<p><strong>Ejercicio 1.2</strong>: Deployments y el bucle de reconciliación del Controller Manager</p>
</li>
<li>
<p><strong>Ejercicio 1.3</strong>: Services ClusterIP y kube-proxy</p>
</li>
<li>
<p><strong>Ejercicio 1.4</strong>: Services NodePort y acceso externo</p>
</li>
<li>
<p><strong>Ejercicio 1.5</strong>: Scheduler y resource requests/limits</p>
</li>
<li>
<p><strong>Ejercicio 1.6</strong>: Namespaces, Labels y Selectors</p>
</li>
<li>
<p><strong>Ejercicio 1.7</strong>: kubelet health checks (Liveness/Readiness)</p>
</li>
<li>
<p><strong>Ejercicio 1.8</strong>: ConfigMaps para gestión de configuración</p>
</li>
<li>
<p><strong>Ejercicio 1.9</strong>: Secrets para datos sensibles</p>
</li>
<li>
<p><strong>Ejercicio 1.10</strong>: Rolling Updates y Deployment Controller</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_módulo_2_trabajando_con_pods">3. Módulo 2: Trabajando con Pods</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_ejercicio_2_1_pod_multi_contenedor_con_patrón_sidecar_logging">3.1. Ejercicio 2.1: Pod multi-contenedor con patrón Sidecar (Logging)</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Entender cómo ejecutar múltiples contenedores en un mismo Pod compartiendo volúmenes. Implementar el patrón Sidecar para logging.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Crearás un Pod con dos contenedores: uno principal (nginx) que escribe logs en un volumen compartido, y un sidecar que lee esos logs y los procesa. Esto demuestra cómo los contenedores en un Pod comparten el ciclo de vida y los volúmenes.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un archivo YAML llamado <code>sidecar-logging-pod.yaml</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Pod</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx-with-logging-sidecar</span>
<span class="tok-w">  </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">webserver</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-c1"># Volumen compartido entre contenedores</span>
<span class="tok-w">  </span><span class="tok-nt">volumes</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">shared-logs</span>
<span class="tok-w">    </span><span class="tok-nt">emptyDir</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">{}</span>

<span class="tok-w">  </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-c1"># Contenedor principal - servidor web</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx:1.21</span>
<span class="tok-w">    </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">containerPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span>
<span class="tok-w">    </span><span class="tok-c1"># Monta el volumen compartido</span>
<span class="tok-w">    </span><span class="tok-nt">volumeMounts</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">shared-logs</span>
<span class="tok-w">      </span><span class="tok-nt">mountPath</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/var/log/nginx</span>
<span class="tok-w">    </span><span class="tok-c1"># Configuración de nginx para escribir en el volumen</span>
<span class="tok-w">    </span><span class="tok-nt">command</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">sh</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">-c</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">|</span>
<span class="tok-w">      </span><span class="tok-no">cat &gt; /etc/nginx/nginx.conf &lt;&lt;&#39;EOF&#39;</span>
<span class="tok-w">      </span><span class="tok-no">user nginx;</span>
<span class="tok-w">      </span><span class="tok-no">worker_processes auto;</span>
<span class="tok-w">      </span><span class="tok-no">error_log /var/log/nginx/error.log;</span>
<span class="tok-w">      </span><span class="tok-no">pid /var/run/nginx.pid;</span>
<span class="tok-w">      </span><span class="tok-no">events { worker_connections 1024; }</span>
<span class="tok-w">      </span><span class="tok-no">http {</span>
<span class="tok-w">        </span><span class="tok-no">access_log /var/log/nginx/access.log;</span>
<span class="tok-w">        </span><span class="tok-no">server {</span>
<span class="tok-w">          </span><span class="tok-no">listen 80;</span>
<span class="tok-w">          </span><span class="tok-no">location / { return 200 &quot;OK\n&quot;; }</span>
<span class="tok-w">        </span><span class="tok-no">}</span>
<span class="tok-w">      </span><span class="tok-no">}</span>
<span class="tok-w">      </span><span class="tok-no">EOF</span>
<span class="tok-w">      </span><span class="tok-no">nginx -g &#39;daemon off;&#39;</span>

<span class="tok-w">  </span><span class="tok-c1"># Sidecar - procesador de logs</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">log-processor</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">busybox:1.28</span>
<span class="tok-w">    </span><span class="tok-c1"># Lee logs y los muestra continuamente</span>
<span class="tok-w">    </span><span class="tok-nt">command</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">sh</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">-c</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">|</span>
<span class="tok-w">      </span><span class="tok-no">while true; do</span>
<span class="tok-w">        </span><span class="tok-no">if [ -f /var/log/nginx/access.log ]; then</span>
<span class="tok-w">          </span><span class="tok-no">echo &quot;=== Access logs at $(date) ===&quot;</span>
<span class="tok-w">          </span><span class="tok-no">tail -5 /var/log/nginx/access.log</span>
<span class="tok-w">        </span><span class="tok-no">fi</span>
<span class="tok-w">        </span><span class="tok-no">sleep 5</span>
<span class="tok-w">      </span><span class="tok-no">done</span>
<span class="tok-w">    </span><span class="tok-nt">volumeMounts</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">shared-logs</span>
<span class="tok-w">      </span><span class="tok-nt">mountPath</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/var/log/nginx</span>
<span class="tok-w">      </span><span class="tok-nt">readOnly</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span></code></pre>
</div>
</div>
</li>
<li>
<p>Despliega el Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>sidecar-logging-pod.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que ambos contenedores estén corriendo:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pod<span class="tok-w"> </span>nginx-with-logging-sidecar
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>pod<span class="tok-w"> </span>nginx-with-logging-sidecar</code></pre>
</div>
</div>
</li>
<li>
<p>Accede al contenedor nginx y genera tráfico:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>nginx-with-logging-sidecar<span class="tok-w"> </span>-c<span class="tok-w"> </span>nginx<span class="tok-w"> </span>--<span class="tok-w"> </span>bash
<span class="tok-c1"># Dentro del contenedor</span>
curl<span class="tok-w"> </span>localhost
<span class="tok-nb">exit</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica los logs del sidecar:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>nginx-with-logging-sidecar<span class="tok-w"> </span>-c<span class="tok-w"> </span>log-processor</code></pre>
</div>
</div>
</li>
<li>
<p>Ver logs de ambos contenedores por separado:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Logs del contenedor principal</span>
kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>nginx-with-logging-sidecar<span class="tok-w"> </span>-c<span class="tok-w"> </span>nginx

<span class="tok-c1"># Logs del sidecar</span>
kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>nginx-with-logging-sidecar<span class="tok-w"> </span>-c<span class="tok-w"> </span>log-processor</code></pre>
</div>
</div>
</li>
<li>
<p>Ver todos los logs del Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>nginx-with-logging-sidecar</code></pre>
</div>
</div>
</li>
<li>
<p>Elimina el Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>nginx-with-logging-sidecar</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong>
El sidecar debería estar leyendo los logs generados por nginx desde el volumen compartido.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong>
1. ¿Qué ocurre si uno de los contenedores falla?
2. ¿Cómo se comunican los contenedores en un Pod?
3. ¿Por qué no usar un Pod por contenedor?
4. ¿Qué ventajas tiene compartir un volumen vs usar una API de red?</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_2_2_pod_con_init_containers">3.2. Ejercicio 2.2: Pod con Init Containers</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Entender cómo los Init Containers ejecutan antes del contenedor principal y preparan el entorno.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Los Init Containers se ejecutan una sola vez al inicio del Pod, antes de que los contenedores principales comiencen. Se usan para preparar datos, esperar a servicios, etc.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un archivo YAML llamado <code>init-container-pod.yaml</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Pod</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">pod-with-init-container</span>
<span class="tok-w">  </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app-with-init</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">volumes</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">shared-data</span>
<span class="tok-w">    </span><span class="tok-nt">emptyDir</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">{}</span>

<span class="tok-w">  </span><span class="tok-c1"># Init Containers - se ejecutan antes que los contenedores principales</span>
<span class="tok-w">  </span><span class="tok-nt">initContainers</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">init-setup</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">busybox:1.28</span>
<span class="tok-w">    </span><span class="tok-nt">command</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">sh</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">-c</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">|</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;Preparando ambiente...&quot;</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;App initialized at $(date)&quot; &gt; /shared-data/init.log</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;Creando archivo de configuración...&quot;</span>
<span class="tok-w">      </span><span class="tok-no">cat &gt; /shared-data/config.txt &lt;&lt;&#39;EOF&#39;</span>
<span class="tok-w">      </span><span class="tok-no">APP_NAME=MyApp</span>
<span class="tok-w">      </span><span class="tok-no">VERSION=1.0</span>
<span class="tok-w">      </span><span class="tok-no">ENVIRONMENT=production</span>
<span class="tok-w">      </span><span class="tok-no">EOF</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;Init completado!&quot;</span>
<span class="tok-w">    </span><span class="tok-nt">volumeMounts</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">shared-data</span>
<span class="tok-w">      </span><span class="tok-nt">mountPath</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/shared-data</span>

<span class="tok-w">  </span><span class="tok-c1"># Contenedor principal - se ejecuta después de que init containers terminen</span>
<span class="tok-w">  </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">main-app</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">busybox:1.28</span>
<span class="tok-w">    </span><span class="tok-nt">command</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">sh</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">-c</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">|</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;=== App principal iniciando ===&quot;</span>
<span class="tok-w">      </span><span class="tok-no">sleep 2</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;=== Contenido del archivo de init ===&quot;</span>
<span class="tok-w">      </span><span class="tok-no">cat /shared-data/init.log</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;=== Contenido de config ===&quot;</span>
<span class="tok-w">      </span><span class="tok-no">cat /shared-data/config.txt</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;=== App ejecutando ===&quot;</span>
<span class="tok-w">      </span><span class="tok-no">sleep 30000</span>
<span class="tok-w">    </span><span class="tok-nt">volumeMounts</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">shared-data</span>
<span class="tok-w">      </span><span class="tok-nt">mountPath</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/shared-data</span>
<span class="tok-w">      </span><span class="tok-nt">readOnly</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span>

<span class="tok-w">  </span><span class="tok-nt">restartPolicy</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Never</span></code></pre>
</div>
</div>
</li>
<li>
<p>Despliega el Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>init-container-pod.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Observa el Pod - inicialmente estará en Pending mientras el init container se ejecuta:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>pod<span class="tok-w"> </span>pod-with-init-container</code></pre>
</div>
</div>
</li>
<li>
<p>Cuando el init container termine, el contenedor principal iniciará:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-w</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica los logs del init container:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Los logs de init containers no aparecen en &quot;kubectl logs&quot;</span>
<span class="tok-c1"># Deben verse en describe</span>
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>pod<span class="tok-w"> </span>pod-with-init-container<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>-A<span class="tok-w"> </span><span class="tok-m">20</span><span class="tok-w"> </span><span class="tok-s2">&quot;Init Containers&quot;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica los logs del contenedor principal:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>pod-with-init-container</code></pre>
</div>
</div>
</li>
<li>
<p>Accede al contenedor y verifica los archivos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>pod-with-init-container<span class="tok-w"> </span>--<span class="tok-w"> </span>cat<span class="tok-w"> </span>/shared-data/config.txt</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>pod-with-init-container</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong>
El contenedor principal debería ejecutarse solo después de que el init container haya completado exitosamente.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong>
1. ¿Qué ocurre si el init container falla?
2. ¿Cómo se diferencia un init container de un sidecar?
3. ¿En qué casos usarías init containers?
4. ¿Pueden haber múltiples init containers?</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_2_3_pod_con_patrón_ambassador_proxy">3.3. Ejercicio 2.3: Pod con patrón Ambassador (Proxy)</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Implementar el patrón Ambassador para que el contenedor principal se comunique con servicios externos a través de un proxy.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
El patrón Ambassador actúa como intermediario. El contenedor principal se conecta a un servicio en localhost, mientras que el ambassador se conecta con el servicio externo real.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un archivo YAML llamado <code>ambassador-pod.yaml</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Pod</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app-with-ambassador</span>
<span class="tok-w">  </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app-ambassador</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-c1"># Contenedor principal - aplicación</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">application</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">busybox:1.28</span>
<span class="tok-w">    </span><span class="tok-nt">command</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">sh</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">-c</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">|</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;App iniciada, esperando ambassador...&quot;</span>
<span class="tok-w">      </span><span class="tok-no">sleep 2</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;Conectando a localhost:3000 (ambassador)&quot;</span>
<span class="tok-w">      </span><span class="tok-no"># Simula un cliente que se conecta al ambassador</span>
<span class="tok-w">      </span><span class="tok-no">while true; do</span>
<span class="tok-w">        </span><span class="tok-no">echo &quot;Request desde app&quot; | nc localhost 3000 2&gt;/dev/null || echo &quot;No conectado&quot;</span>
<span class="tok-w">        </span><span class="tok-no">sleep 10</span>
<span class="tok-w">      </span><span class="tok-no">done</span>
<span class="tok-w">    </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">containerPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">8080</span>

<span class="tok-w">  </span><span class="tok-c1"># Ambassador - proxy que expone servicios externos en localhost</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">ambassador</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">busybox:1.28</span>
<span class="tok-w">    </span><span class="tok-nt">command</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">sh</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">-c</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">|</span>
<span class="tok-w">      </span><span class="tok-no"># El ambassador expone un servicio en localhost:3000</span>
<span class="tok-w">      </span><span class="tok-no"># Para este ejercicio, usaremos nc para simular un servicio</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;Ambassador iniciado, escuchando en puerto 3000&quot;</span>
<span class="tok-w">      </span><span class="tok-no">while true; do</span>
<span class="tok-w">        </span><span class="tok-no">echo &quot;Response from ambassador at $(date)&quot; | nc -l -p 3000</span>
<span class="tok-w">      </span><span class="tok-no">done</span>
<span class="tok-w">    </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">containerPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">3000</span></code></pre>
</div>
</div>
</li>
<li>
<p>Despliega el Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>ambassador-pod.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el estado del Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pod<span class="tok-w"> </span>app-with-ambassador
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>pod<span class="tok-w"> </span>app-with-ambassador</code></pre>
</div>
</div>
</li>
<li>
<p>Accede al Pod y verifica la comunicación entre contenedores:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Desde el contenedor de aplicación, verifica que pueda alcanzar localhost:3000</span>
kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>app-with-ambassador<span class="tok-w"> </span>-c<span class="tok-w"> </span>application<span class="tok-w"> </span>--<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>sh<span class="tok-w"> </span>-c<span class="tok-w"> </span><span class="tok-s2">&quot;echo &#39;Test&#39; | nc localhost 3000&quot;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Ver logs de ambos contenedores:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>app-with-ambassador<span class="tok-w"> </span>-c<span class="tok-w"> </span>application
kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>app-with-ambassador<span class="tok-w"> </span>-c<span class="tok-w"> </span>ambassador</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>app-with-ambassador</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong>
La aplicación debería poder comunicarse con el ambassador a través de localhost:3000.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong>
1. ¿Cuál es la ventaja del ambassador sobre conectar directamente?
2. ¿Por qué ambos contenedores ven localhost de la misma manera?
3. ¿Cómo se diferencia del patrón Sidecar?
4. ¿En qué casos usarías este patrón?</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_2_4_debugging_de_pods_logs_exec_y_port_forward">3.4. Ejercicio 2.4: Debugging de Pods - Logs, Exec y Port Forward</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Dominar las técnicas de debugging de Pods usando logs, exec, port-forward y describe.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Aprenderás a investigar y solucionar problemas en Pods usando herramientas de debugging incorporadas en kubectl.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un Pod con algunos problemas para debuggear (<code>debug-pod.yaml</code>):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Pod</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">debug-demo</span>
<span class="tok-w">  </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">debug-app</span>
<span class="tok-w">  </span><span class="tok-nt">annotations</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">description</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;Pod</span><span class="tok-nv"> </span><span class="tok-s">para</span><span class="tok-nv"> </span><span class="tok-s">practicar</span><span class="tok-nv"> </span><span class="tok-s">debugging&quot;</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">web-server</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx:1.21</span>
<span class="tok-w">    </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">containerPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span>
<span class="tok-w">      </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">http</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">containerPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">443</span>
<span class="tok-w">      </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">https</span>
<span class="tok-w">    </span><span class="tok-nt">resources</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">requests</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;64Mi&quot;</span>
<span class="tok-w">        </span><span class="tok-nt">cpu</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;100m&quot;</span>
<span class="tok-w">      </span><span class="tok-nt">limits</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;256Mi&quot;</span>
<span class="tok-w">        </span><span class="tok-nt">cpu</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;500m&quot;</span>
<span class="tok-w">    </span><span class="tok-nt">livenessProbe</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">httpGet</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">path</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/</span>
<span class="tok-w">        </span><span class="tok-nt">port</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span>
<span class="tok-w">      </span><span class="tok-nt">initialDelaySeconds</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">10</span>
<span class="tok-w">      </span><span class="tok-nt">periodSeconds</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">10</span>
<span class="tok-w">    </span><span class="tok-nt">readinessProbe</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">httpGet</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">path</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/</span>
<span class="tok-w">        </span><span class="tok-nt">port</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span>
<span class="tok-w">      </span><span class="tok-nt">initialDelaySeconds</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">5</span>
<span class="tok-w">      </span><span class="tok-nt">periodSeconds</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">5</span>
<span class="tok-w">    </span><span class="tok-nt">env</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">NGINX_HOST</span>
<span class="tok-w">      </span><span class="tok-nt">value</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;localhost&quot;</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">NGINX_PORT</span>
<span class="tok-w">      </span><span class="tok-nt">value</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;80&quot;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Despliega el Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>debug-pod.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Obtén información general del Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Lista simple</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pod<span class="tok-w"> </span>debug-demo

<span class="tok-c1"># Lista con más detalles</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pod<span class="tok-w"> </span>debug-demo<span class="tok-w"> </span>-o<span class="tok-w"> </span>wide

<span class="tok-c1"># Describe completo (más información)</span>
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>pod<span class="tok-w"> </span>debug-demo</code></pre>
</div>
</div>
</li>
<li>
<p>Obtén el YAML completo del Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pod<span class="tok-w"> </span>debug-demo<span class="tok-w"> </span>-o<span class="tok-w"> </span>yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Extrae información específica usando JSONPath:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># IP del Pod</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pod<span class="tok-w"> </span>debug-demo<span class="tok-w"> </span>-o<span class="tok-w"> </span><span class="tok-nv">jsonpath</span><span class="tok-o">=</span><span class="tok-s1">&#39;{.status.podIP}&#39;</span>

<span class="tok-c1"># Nombre del nodo</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pod<span class="tok-w"> </span>debug-demo<span class="tok-w"> </span>-o<span class="tok-w"> </span><span class="tok-nv">jsonpath</span><span class="tok-o">=</span><span class="tok-s1">&#39;{.spec.nodeName}&#39;</span>

<span class="tok-c1"># Imagen del contenedor</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pod<span class="tok-w"> </span>debug-demo<span class="tok-w"> </span>-o<span class="tok-w"> </span><span class="tok-nv">jsonpath</span><span class="tok-o">=</span><span class="tok-s1">&#39;{.spec.containers[0].image}&#39;</span>

<span class="tok-c1"># Estado del Pod</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pod<span class="tok-w"> </span>debug-demo<span class="tok-w"> </span>-o<span class="tok-w"> </span><span class="tok-nv">jsonpath</span><span class="tok-o">=</span><span class="tok-s1">&#39;{.status.phase}&#39;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Accede a los logs del contenedor:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Últimas líneas</span>
kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>debug-demo

<span class="tok-c1"># Últimas 20 líneas</span>
kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>debug-demo<span class="tok-w"> </span>--tail<span class="tok-o">=</span><span class="tok-m">20</span>

<span class="tok-c1"># Seguir logs en tiempo real</span>
kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>-f<span class="tok-w"> </span>debug-demo

<span class="tok-c1"># Logs desde hace 1 minuto</span>
kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>debug-demo<span class="tok-w"> </span>--since<span class="tok-o">=</span>1m</code></pre>
</div>
</div>
</li>
<li>
<p>Ejecuta comandos dentro del contenedor (exec):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Ver el contenido del directorio raíz</span>
kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>debug-demo<span class="tok-w"> </span>--<span class="tok-w"> </span>ls<span class="tok-w"> </span>/

<span class="tok-c1"># Ver variables de entorno</span>
kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>debug-demo<span class="tok-w"> </span>--<span class="tok-w"> </span>env<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>NGINX

<span class="tok-c1"># Ver procesos en ejecución</span>
kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>debug-demo<span class="tok-w"> </span>--<span class="tok-w"> </span>ps<span class="tok-w"> </span>aux

<span class="tok-c1"># Shell interactivo</span>
kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>debug-demo<span class="tok-w"> </span>--<span class="tok-w"> </span>/bin/bash
<span class="tok-c1"># Dentro del Pod:</span>
<span class="tok-w">  </span>ps<span class="tok-w"> </span>aux
<span class="tok-w">  </span>netstat<span class="tok-w"> </span>-tlnp
<span class="tok-w">  </span>curl<span class="tok-w"> </span>http://localhost:80
<span class="tok-w">  </span><span class="tok-nb">exit</span></code></pre>
</div>
</div>
</li>
<li>
<p>Port forward - accede a los puertos del Pod desde tu máquina local:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># En una terminal, activa port-forward</span>
kubectl<span class="tok-w"> </span>port-forward<span class="tok-w"> </span>debug-demo<span class="tok-w"> </span><span class="tok-m">8080</span>:80<span class="tok-w"> </span><span class="tok-p">&amp;</span>

<span class="tok-c1"># En otra terminal, accede al servicio</span>
curl<span class="tok-w"> </span>http://localhost:8080

<span class="tok-c1"># Detén el port-forward</span>
pkill<span class="tok-w"> </span>-f<span class="tok-w"> </span><span class="tok-s2">&quot;port-forward&quot;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Copia archivos hacia/desde el Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Copia un archivo del Pod a tu máquina local</span>
kubectl<span class="tok-w"> </span>cp<span class="tok-w"> </span>debug-demo:/etc/nginx/nginx.conf<span class="tok-w"> </span>./nginx.conf

<span class="tok-c1"># Copia un archivo desde tu máquina al Pod</span>
<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;Hello from local&quot;</span><span class="tok-w"> </span>&gt;<span class="tok-w"> </span>test.txt
kubectl<span class="tok-w"> </span>cp<span class="tok-w"> </span>test.txt<span class="tok-w"> </span>debug-demo:/tmp/test.txt

<span class="tok-c1"># Verifica el archivo en el Pod</span>
kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>debug-demo<span class="tok-w"> </span>--<span class="tok-w"> </span>cat<span class="tok-w"> </span>/tmp/test.txt</code></pre>
</div>
</div>
</li>
<li>
<p>Monitorea el Pod en tiempo real:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Watch mode - actualización continua</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pod<span class="tok-w"> </span>debug-demo<span class="tok-w"> </span>-w

<span class="tok-c1"># Ver eventos del cluster</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>events<span class="tok-w"> </span>--sort-by<span class="tok-o">=</span><span class="tok-s1">&#39;.lastTimestamp&#39;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>debug-demo
rm<span class="tok-w"> </span>nginx.conf<span class="tok-w"> </span>test.txt</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong>
Deberías poder acceder a toda la información del Pod y ejecutar comandos dentro del contenedor.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong>
1. ¿Cuál es la diferencia entre <code>logs</code> y <code>describe</code>?
2. ¿Cómo accedes a información sensible en JSONPath?
3. ¿Qué limitaciones tiene <code>exec</code> para debugging?
4. ¿Por qué port-forward es útil para debugging?</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_2_5_pod_con_restart_policy">3.5. Ejercicio 2.5: Pod con Restart Policy</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Entender cómo las políticas de reinicio controlan el comportamiento de los contenedores fallidos.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Crearás Pods con diferentes políticas de reinicio (Always, OnFailure, Never) y observarás cómo Kubernetes maneja los contenedores que fallan.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un Pod que falla inmediatamente (<code>always-restart-pod.yaml</code>):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Pod</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">pod-always-restart</span>
<span class="tok-w">  </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">always-restart</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">restartPolicy</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Always</span><span class="tok-w">  </span><span class="tok-c1"># Siempre reinicia</span>
<span class="tok-w">  </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">failing-app</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">busybox:1.28</span>
<span class="tok-w">    </span><span class="tok-nt">command</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">sh</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">-c</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">|</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;App iniciada&quot;</span>
<span class="tok-w">      </span><span class="tok-no">sleep 2</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;App crasheando...&quot;</span>
<span class="tok-w">      </span><span class="tok-no">exit 1  # Termina con error</span></code></pre>
</div>
</div>
</li>
<li>
<p>Despliega y observa los reinicios:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>always-restart-pod.yaml
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods
sleep<span class="tok-w"> </span><span class="tok-m">5</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w">  </span><span class="tok-c1"># El Pod debería tener más reinicios</span>
sleep<span class="tok-w"> </span><span class="tok-m">5</span>
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>pod<span class="tok-w"> </span>pod-always-restart</code></pre>
</div>
</div>
</li>
<li>
<p>Ver los reinicios en la columna RESTARTS:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-w</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod con política OnFailure (<code>onfailure-restart-pod.yaml</code>):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Pod</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">pod-onfailure-restart</span>
<span class="tok-w">  </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">onfailure-restart</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">restartPolicy</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">OnFailure</span><span class="tok-w">  </span><span class="tok-c1"># Solo reinicia si falla</span>
<span class="tok-w">  </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">task</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">busybox:1.28</span>
<span class="tok-w">    </span><span class="tok-nt">command</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">sh</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">-c</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">|</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;Ejecutando tarea...&quot;</span>
<span class="tok-w">      </span><span class="tok-no">sleep 5</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;Tarea completada&quot;</span>
<span class="tok-w">      </span><span class="tok-no">exit 0  # Termina exitosamente</span></code></pre>
</div>
</div>
</li>
<li>
<p>Despliega y observa:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>onfailure-restart-pod.yaml
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-w
<span class="tok-c1"># Debería completar sin reinicios</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod con política Never (<code>never-restart-pod.yaml</code>):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Pod</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">pod-never-restart</span>
<span class="tok-w">  </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">never-restart</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">restartPolicy</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Never</span><span class="tok-w">  </span><span class="tok-c1"># Nunca reinicia</span>
<span class="tok-w">  </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">one-time-task</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">busybox:1.28</span>
<span class="tok-w">    </span><span class="tok-nt">command</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">sh</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">-c</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">|</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;Ejecutando una sola vez...&quot;</span>
<span class="tok-w">      </span><span class="tok-no">exit 1  # Falla</span></code></pre>
</div>
</div>
</li>
<li>
<p>Despliega y observa que NO reinicia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>never-restart-pod.yaml
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods
<span class="tok-c1"># Quedará en estado Error, sin reinicios</span>
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>pod<span class="tok-w"> </span>pod-never-restart</code></pre>
</div>
</div>
</li>
<li>
<p>Compara los tres Pods:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-o<span class="tok-w"> </span>custom-columns<span class="tok-o">=</span>NAME:.metadata.name,STATUS:.status.phase,RESTARTS:.status.containerStatuses<span class="tok-o">[</span><span class="tok-m">0</span><span class="tok-o">]</span>.restartCount</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>pod-always-restart<span class="tok-w"> </span>pod-onfailure-restart<span class="tok-w"> </span>pod-never-restart</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong>
Deberías ver comportamientos diferentes en cada Pod según su política de reinicio.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong>
1. ¿Cuándo usarías cada política de reinicio?
2. ¿Qué ocurre con los logs después de un reinicio?
3. ¿Cómo afecta restartPolicy a la disponibilidad de la aplicación?
4. ¿Puedes cambiar restartPolicy de un Pod en ejecución?</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_2_6_pod_con_imagepullpolicy">3.6. Ejercicio 2.6: Pod con ImagePullPolicy</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Entender cómo Kubernetes gestiona la descarga y el almacenamiento en caché de imágenes de contenedor.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Aprenderás a controlar cuándo Kubernetes descarga nuevas imágenes usando imagePullPolicy.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un Pod con imagePullPolicy: Always (<code>image-always-pull.yaml</code>):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Pod</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">pod-always-pull</span>
<span class="tok-w">  </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">always-pull</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx:1.21</span>
<span class="tok-w">    </span><span class="tok-nt">imagePullPolicy</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Always</span><span class="tok-w">  </span><span class="tok-c1"># Descarga siempre la imagen más nueva</span>
<span class="tok-w">    </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">containerPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span></code></pre>
</div>
</div>
</li>
<li>
<p>Despliega:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>image-always-pull.yaml
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>pod<span class="tok-w"> </span>pod-always-pull<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>-A<span class="tok-w"> </span><span class="tok-m">5</span><span class="tok-w"> </span><span class="tok-s2">&quot;Image:&quot;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod con imagePullPolicy: IfNotPresent (por defecto):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Pod</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">pod-ifnotpresent</span>
<span class="tok-w">  </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">ifnotpresent</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx:1.21</span>
<span class="tok-w">    </span><span class="tok-nt">imagePullPolicy</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">IfNotPresent</span><span class="tok-w">  </span><span class="tok-c1"># Solo descarga si no existe localmente</span>
<span class="tok-w">    </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">containerPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span></code></pre>
</div>
</div>
</li>
<li>
<p>Despliega:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>image-ifnotpresent.yaml
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod con imagePullPolicy: Never:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Pod</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">pod-never-pull</span>
<span class="tok-w">  </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">never-pull</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx:1.21</span>
<span class="tok-w">    </span><span class="tok-nt">imagePullPolicy</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Never</span><span class="tok-w">  </span><span class="tok-c1"># No intenta descargar, usa caché o falla</span>
<span class="tok-w">    </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">containerPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span></code></pre>
</div>
</div>
</li>
<li>
<p>Despliega:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>image-never-pull.yaml
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods</code></pre>
</div>
</div>
</li>
<li>
<p>Comprueba el estado de cada Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-o<span class="tok-w"> </span>wide
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>pod<span class="tok-w"> </span>pod-always-pull<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>-A<span class="tok-w"> </span><span class="tok-m">10</span><span class="tok-w"> </span><span class="tok-s2">&quot;Events:&quot;</span>
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>pod<span class="tok-w"> </span>pod-ifnotpresent<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>-A<span class="tok-w"> </span><span class="tok-m">10</span><span class="tok-w"> </span><span class="tok-s2">&quot;Events:&quot;</span>
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>pod<span class="tok-w"> </span>pod-never-pull<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>-A<span class="tok-w"> </span><span class="tok-m">10</span><span class="tok-w"> </span><span class="tok-s2">&quot;Events:&quot;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>pod-always-pull<span class="tok-w"> </span>pod-ifnotpresent<span class="tok-w"> </span>pod-never-pull</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong>
Los Pods deberían mostrar comportamientos diferentes en cuanto a descarga de imágenes en sus eventos.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong>
1. ¿Cuándo deberías usar Always vs IfNotPresent?
2. ¿Qué es el image cache?
3. ¿Cuál es la implicación de seguridad de usar IfNotPresent con tags específicas?
4. ¿Cómo afecta imagePullPolicy al tiempo de inicio?</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_2_7_pod_con_securitycontext">3.7. Ejercicio 2.7: Pod con SecurityContext</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Implementar controles de seguridad a nivel de Pod usando SecurityContext.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Los SecurityContexts permiten definir permisos y capacidades de seguridad para Pods y contenedores.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un Pod con SecurityContext a nivel de Pod (<code>security-context-pod.yaml</code>):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Pod</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">pod-with-security-context</span>
<span class="tok-w">  </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">secure-pod</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-c1"># SecurityContext a nivel de Pod</span>
<span class="tok-w">  </span><span class="tok-nt">securityContext</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">runAsNonRoot</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span><span class="tok-w">  </span><span class="tok-c1"># Obliga a ejecutar como usuario no-root</span>
<span class="tok-w">    </span><span class="tok-nt">runAsUser</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">1000</span><span class="tok-w">     </span><span class="tok-c1"># UID específico</span>
<span class="tok-w">    </span><span class="tok-nt">fsGroup</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">2000</span><span class="tok-w">       </span><span class="tok-c1"># Grupo para volúmenes</span>
<span class="tok-w">    </span><span class="tok-nt">seccompProfile</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">type</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">RuntimeDefault</span>

<span class="tok-w">  </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">secure-app</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">busybox:1.28</span>
<span class="tok-w">    </span><span class="tok-nt">command</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">sh</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">-c</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">|</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;ID del usuario actual:&quot;</span>
<span class="tok-w">      </span><span class="tok-no">id</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;ID de grupos:&quot;</span>
<span class="tok-w">      </span><span class="tok-no">groups</span>
<span class="tok-w">      </span><span class="tok-no">sleep 30000</span>
<span class="tok-w">    </span><span class="tok-nt">volumeMounts</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">shared-data</span>
<span class="tok-w">      </span><span class="tok-nt">mountPath</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/data</span>

<span class="tok-w">  </span><span class="tok-nt">volumes</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">shared-data</span>
<span class="tok-w">    </span><span class="tok-nt">emptyDir</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">{}</span></code></pre>
</div>
</div>
</li>
<li>
<p>Despliega el Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>security-context-pod.yaml
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el usuario dentro del contenedor:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>pod-with-security-context<span class="tok-w"> </span>--<span class="tok-w"> </span>id
kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>pod-with-security-context<span class="tok-w"> </span>--<span class="tok-w"> </span>whoami</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod sin SecurityContext (no recomendado):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Pod</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">pod-without-security-context</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">busybox:1.28</span>
<span class="tok-w">    </span><span class="tok-nt">command</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">sh</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">-c</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">|</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;Ejecutando como:&quot;</span>
<span class="tok-w">      </span><span class="tok-no">id</span>
<span class="tok-w">      </span><span class="tok-no">sleep 30000</span></code></pre>
</div>
</div>
</li>
<li>
<p>Despliega y compara:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>no-security-pod.yaml
kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>pod-without-security-context<span class="tok-w"> </span>--<span class="tok-w"> </span>id
<span class="tok-c1"># Este probablemente ejecute como root (UID 0)</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod con SecurityContext en el contenedor:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Pod</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">pod-container-security-context</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">busybox:1.28</span>
<span class="tok-w">    </span><span class="tok-nt">command</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">sh</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">-c</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">|</span>
<span class="tok-w">      </span><span class="tok-no">id</span>
<span class="tok-w">      </span><span class="tok-no">sleep 30000</span>
<span class="tok-w">    </span><span class="tok-c1"># SecurityContext a nivel de contenedor</span>
<span class="tok-w">    </span><span class="tok-nt">securityContext</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">runAsUser</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">2000</span>
<span class="tok-w">      </span><span class="tok-nt">allowPrivilegeEscalation</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">false</span>
<span class="tok-w">      </span><span class="tok-nt">readOnlyRootFilesystem</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span></code></pre>
</div>
</div>
</li>
<li>
<p>Despliega y verifica:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>container-security-pod.yaml
kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>pod-container-security-context<span class="tok-w"> </span>--<span class="tok-w"> </span>id</code></pre>
</div>
</div>
</li>
<li>
<p>Intenta escribir en el filesystem (debería fallar):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>pod-container-security-context<span class="tok-w"> </span>--<span class="tok-w"> </span>touch<span class="tok-w"> </span>/test.txt
<span class="tok-c1"># Error: Read-only file system</span></code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>pod-with-security-context<span class="tok-w"> </span>pod-without-security-context<span class="tok-w"> </span>pod-container-security-context</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong>
Los Pods con SecurityContext deberían ejecutar con el usuario especificado, y el filesystem de solo lectura debería prevenir escrituras.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong>
1. ¿Por qué es importante ejecutar contenedores como non-root?
2. ¿Cuál es la diferencia entre SecurityContext a nivel Pod vs contenedor?
3. ¿Qué es fsGroup?
4. ¿Cómo se relaciona SecurityContext con PodSecurityPolicies?</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_2_8_pod_con_labels_y_selectors_avanzados">3.8. Ejercicio 2.8: Pod con Labels y Selectors avanzados</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Practicar el uso avanzado de Labels y Selectors para organizar y filtrar Pods.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Los Labels son cruciales para organizar recursos en Kubernetes. Aprenderás a crear y usar Labels complejos.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea múltiples Pods con diferentes labels (<code>labeled-pods.yaml</code>):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nn">---</span>
<span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Pod</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">pod-frontend-prod</span>
<span class="tok-w">  </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">myapp</span>
<span class="tok-w">    </span><span class="tok-nt">component</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">frontend</span>
<span class="tok-w">    </span><span class="tok-nt">environment</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">production</span>
<span class="tok-w">    </span><span class="tok-nt">tier</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">web</span>
<span class="tok-w">    </span><span class="tok-nt">version</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;2.0&quot;</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx:1.21</span>

<span class="tok-nn">---</span>
<span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Pod</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">pod-frontend-dev</span>
<span class="tok-w">  </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">myapp</span>
<span class="tok-w">    </span><span class="tok-nt">component</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">frontend</span>
<span class="tok-w">    </span><span class="tok-nt">environment</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">development</span>
<span class="tok-w">    </span><span class="tok-nt">tier</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">web</span>
<span class="tok-w">    </span><span class="tok-nt">version</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;1.9&quot;</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx:1.20</span>

<span class="tok-nn">---</span>
<span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Pod</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">pod-backend-prod</span>
<span class="tok-w">  </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">myapp</span>
<span class="tok-w">    </span><span class="tok-nt">component</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">backend</span>
<span class="tok-w">    </span><span class="tok-nt">environment</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">production</span>
<span class="tok-w">    </span><span class="tok-nt">tier</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">database</span>
<span class="tok-w">    </span><span class="tok-nt">version</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;3.0&quot;</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">busybox:1.28</span>
<span class="tok-w">    </span><span class="tok-nt">command</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">sleep</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-s">&quot;30000&quot;</span>

<span class="tok-nn">---</span>
<span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Pod</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">pod-backend-dev</span>
<span class="tok-w">  </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">myapp</span>
<span class="tok-w">    </span><span class="tok-nt">component</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">backend</span>
<span class="tok-w">    </span><span class="tok-nt">environment</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">development</span>
<span class="tok-w">    </span><span class="tok-nt">tier</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">database</span>
<span class="tok-w">    </span><span class="tok-nt">version</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;2.8&quot;</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">busybox:1.28</span>
<span class="tok-w">    </span><span class="tok-nt">command</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">sleep</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-s">&quot;30000&quot;</span>

<span class="tok-nn">---</span>
<span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Pod</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">pod-other-app</span>
<span class="tok-w">  </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">otherapp</span>
<span class="tok-w">    </span><span class="tok-nt">component</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">frontend</span>
<span class="tok-w">    </span><span class="tok-nt">environment</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">production</span>
<span class="tok-w">    </span><span class="tok-nt">version</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;1.0&quot;</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx:1.21</span></code></pre>
</div>
</div>
</li>
<li>
<p>Despliega todos los Pods:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>labeled-pods.yaml
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>--show-labels</code></pre>
</div>
</div>
</li>
<li>
<p>Filtra con selectors simples:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Todos los pods con label app=myapp</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>myapp

<span class="tok-c1"># Todos los pods con environment=production</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">environment</span><span class="tok-o">=</span>production

<span class="tok-c1"># Todos los pods con component=backend</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">component</span><span class="tok-o">=</span>backend</code></pre>
</div>
</div>
</li>
<li>
<p>Usa operadores de selección:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># NOT equal</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span>environment!<span class="tok-o">=</span>development

<span class="tok-c1"># IN operator</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-s1">&#39;environment in (production,staging)&#39;</span>

<span class="tok-c1"># NOT IN operator</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-s1">&#39;environment notin (development)&#39;</span>

<span class="tok-c1"># Múltiples selectores (AND implícito)</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>myapp,environment<span class="tok-o">=</span>production

<span class="tok-c1"># EXISTS operator</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span>tier</code></pre>
</div>
</div>
</li>
<li>
<p>Filtra por ausencia de labels:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Pods sin el label tier</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-s1">&#39;!tier&#39;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Ver columnas específicas:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>-o<span class="tok-w"> </span>custom-columns<span class="tok-o">=</span>NAME:.metadata.name,<span class="tok-se">\</span>
APP:.metadata.labels.app,<span class="tok-se">\</span>
ENV:.metadata.labels.environment,<span class="tok-se">\</span>
COMPONENT:.metadata.labels.component</code></pre>
</div>
</div>
</li>
<li>
<p>Añade un label a un Pod en ejecución:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>label<span class="tok-w"> </span>pod<span class="tok-w"> </span>pod-frontend-prod<span class="tok-w"> </span><span class="tok-nv">monitored</span><span class="tok-o">=</span><span class="tok-nb">true</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pod<span class="tok-w"> </span>pod-frontend-prod<span class="tok-w"> </span>--show-labels</code></pre>
</div>
</div>
</li>
<li>
<p>Modifica un label:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>label<span class="tok-w"> </span>pod<span class="tok-w"> </span>pod-frontend-prod<span class="tok-w"> </span><span class="tok-nv">environment</span><span class="tok-o">=</span>staging<span class="tok-w"> </span>--overwrite
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pod<span class="tok-w"> </span>pod-frontend-prod<span class="tok-w"> </span>--show-labels</code></pre>
</div>
</div>
</li>
<li>
<p>Elimina un label:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>label<span class="tok-w"> </span>pod<span class="tok-w"> </span>pod-frontend-prod<span class="tok-w"> </span>monitored-
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pod<span class="tok-w"> </span>pod-frontend-prod<span class="tok-w"> </span>--show-labels</code></pre>
</div>
</div>
</li>
<li>
<p>Usa field-selector para filtrar:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Por estatus</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>--field-selector<span class="tok-o">=</span>status.phase<span class="tok-o">=</span>Running

<span class="tok-c1"># Por namespace</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>--field-selector<span class="tok-o">=</span>metadata.namespace<span class="tok-o">=</span>default</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>-f<span class="tok-w"> </span>labeled-pods.yaml</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong>
Deberías poder filtrar los Pods de múltiples formas usando diferentes combinaciones de labels y selectores.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong>
1. ¿Cuál es la diferencia entre Labels y Annotations?
2. ¿Cómo usan los Services los Labels?
3. ¿Qué convenciones de naming se recomiendan para Labels?
4. ¿Por qué no usar names en lugar de Labels?</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_2_9_pod_con_liveness_readiness_y_startup_probes">3.9. Ejercicio 2.9: Pod con Liveness, Readiness y Startup Probes</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Implementar health checks avanzados usando los tres tipos de probes.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Aunque ya tocamos liveness y readiness en el módulo 1, aquí practicaremos los tres tipos de probes con más detalle.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un Pod con los tres tipos de probes (<code>health-checks-complete.yaml</code>):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Pod</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">pod-with-all-probes</span>
<span class="tok-w">  </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">health-check-demo</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app-with-slow-startup</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">busybox:1.28</span>
<span class="tok-w">    </span><span class="tok-nt">command</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">sh</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">-c</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">|</span>
<span class="tok-w">      </span><span class="tok-no"># Simula una app con startup lento</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;App iniciando...&quot;</span>
<span class="tok-w">      </span><span class="tok-no">sleep 15  # Tarda 15s en estar lista</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;App lista para servir requests&quot;</span>

<span class="tok-w">      </span><span class="tok-no"># Simula servidor HTTP en puerto 8080</span>
<span class="tok-w">      </span><span class="tok-no">while true; do</span>
<span class="tok-w">        </span><span class="tok-no">{ echo -ne &quot;HTTP/1.1 200 OK\r\nContent-Length: 2\r\n\r\nOK&quot;; } | nc -l -p 8080 -q 1</span>
<span class="tok-w">      </span><span class="tok-no">done</span>

<span class="tok-w">    </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">containerPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">8080</span>

<span class="tok-w">    </span><span class="tok-c1"># Startup Probe - espera a que la app esté lista (máximo 60s)</span>
<span class="tok-w">    </span><span class="tok-nt">startupProbe</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">tcpSocket</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">port</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">8080</span>
<span class="tok-w">      </span><span class="tok-nt">initialDelaySeconds</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">0</span>
<span class="tok-w">      </span><span class="tok-nt">periodSeconds</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">5</span>
<span class="tok-w">      </span><span class="tok-nt">failureThreshold</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">12</span><span class="tok-w">  </span><span class="tok-c1"># 12 * 5s = 60s máximo para startup</span>
<span class="tok-w">      </span><span class="tok-nt">successThreshold</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">1</span>

<span class="tok-w">    </span><span class="tok-c1"># Readiness Probe - verifica si puede servir requests</span>
<span class="tok-w">    </span><span class="tok-nt">readinessProbe</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">httpGet</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">path</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/</span>
<span class="tok-w">        </span><span class="tok-nt">port</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">8080</span>
<span class="tok-w">      </span><span class="tok-nt">initialDelaySeconds</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">0</span>
<span class="tok-w">      </span><span class="tok-nt">periodSeconds</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">5</span>
<span class="tok-w">      </span><span class="tok-nt">timeoutSeconds</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">1</span>
<span class="tok-w">      </span><span class="tok-nt">failureThreshold</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">2</span>

<span class="tok-w">    </span><span class="tok-c1"># Liveness Probe - verifica si está viva</span>
<span class="tok-w">    </span><span class="tok-nt">livenessProbe</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">httpGet</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">path</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/</span>
<span class="tok-w">        </span><span class="tok-nt">port</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">8080</span>
<span class="tok-w">      </span><span class="tok-nt">initialDelaySeconds</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">20</span>
<span class="tok-w">      </span><span class="tok-nt">periodSeconds</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">10</span>
<span class="tok-w">      </span><span class="tok-nt">timeoutSeconds</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">1</span>
<span class="tok-w">      </span><span class="tok-nt">failureThreshold</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">3</span></code></pre>
</div>
</div>
</li>
<li>
<p>Despliega el Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>health-checks-complete.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Observa cómo el Pod pasa a través de las fases:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Initially, startupProbe is failing</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-w

<span class="tok-c1"># Después de 15 segundos, el Pod debería pasar a Ready</span></code></pre>
</div>
</div>
</li>
<li>
<p>Describe el Pod para ver detalles de los probes:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>pod<span class="tok-w"> </span>pod-with-all-probes<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>-A<span class="tok-w"> </span><span class="tok-m">15</span><span class="tok-w"> </span><span class="tok-s2">&quot;Liveness\|Readiness\|Startup&quot;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod que falla el readiness pero no el liveness:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Pod</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">pod-readiness-failing</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">busybox:1.28</span>
<span class="tok-w">    </span><span class="tok-nt">command</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">sh</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">-c</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">|</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;App ejecutando pero no lista...&quot;</span>
<span class="tok-w">      </span><span class="tok-no">sleep 30000</span>

<span class="tok-w">    </span><span class="tok-c1"># Liveness: siempre pasa</span>
<span class="tok-w">    </span><span class="tok-nt">livenessProbe</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">exec</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">command</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">sh</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">-c</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-s">&quot;exit</span><span class="tok-nv"> </span><span class="tok-s">0&quot;</span><span class="tok-w">  </span><span class="tok-c1"># Siempre exitoso</span>
<span class="tok-w">      </span><span class="tok-nt">initialDelaySeconds</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">5</span>
<span class="tok-w">      </span><span class="tok-nt">periodSeconds</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">10</span>

<span class="tok-w">    </span><span class="tok-c1"># Readiness: siempre falla</span>
<span class="tok-w">    </span><span class="tok-nt">readinessProbe</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">exec</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">command</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">sh</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">-c</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-s">&quot;exit</span><span class="tok-nv"> </span><span class="tok-s">1&quot;</span><span class="tok-w">  </span><span class="tok-c1"># Siempre falla</span>
<span class="tok-w">      </span><span class="tok-nt">initialDelaySeconds</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">5</span>
<span class="tok-w">      </span><span class="tok-nt">periodSeconds</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">5</span></code></pre>
</div>
</div>
</li>
<li>
<p>Despliega:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>readiness-failing-pod.yaml
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods
<span class="tok-c1"># Pod estará Running pero 0/1 Ready</span></code></pre>
</div>
</div>
</li>
<li>
<p>Describe para entender el estado:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>pod<span class="tok-w"> </span>pod-readiness-failing
<span class="tok-c1"># Verás que Liveness es OK pero Readiness está fallando</span></code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>pod-with-all-probes<span class="tok-w"> </span>pod-readiness-failing</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong>
El primer Pod debería convertirse en Ready después de su período de startup. El segundo Pod debería estar Running pero no Ready.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong>
1. ¿Cuál es la diferencia entre los tres tipos de probes?
2. ¿Qué ocurre si readiness falla pero liveness pasa?
3. ¿Cuándo es importante startup probe?
4. ¿Cómo afecta la readiness probe al Service?</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_2_10_pod_con_volumes_emptydir_y_resourcequotas">3.10. Ejercicio 2.10: Pod con Volumes emptyDir y resourceQuotas</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Entender cómo los Pods comparten datos usando volúmenes compartidos.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Los volúmenes emptyDir proporcionan almacenamiento temporal compartido entre contenedores en un Pod.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un Pod con volumen emptyDir (<code>emptydir-volume-pod.yaml</code>):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Pod</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">pod-with-emptydir-volume</span>
<span class="tok-w">  </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">volume-demo</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-c1"># Volúmenes disponibles para todos los contenedores</span>
<span class="tok-w">  </span><span class="tok-nt">volumes</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">shared-storage</span>
<span class="tok-w">    </span><span class="tok-nt">emptyDir</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">{}</span><span class="tok-w">  </span><span class="tok-c1"># Volumen temporal, se elimina cuando el Pod muere</span>

<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">cache-storage</span>
<span class="tok-w">    </span><span class="tok-nt">emptyDir</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">medium</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Memory</span><span class="tok-w">  </span><span class="tok-c1"># Almacenado en memoria (tmpfs)</span>
<span class="tok-w">      </span><span class="tok-nt">sizeLimit</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">128Mi</span><span class="tok-w">  </span><span class="tok-c1"># Límite de 128MB</span>

<span class="tok-w">  </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-c1"># Contenedor 1 - productor de datos</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">producer</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">busybox:1.28</span>
<span class="tok-w">    </span><span class="tok-nt">command</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">sh</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">-c</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">|</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;Productor iniciado&quot;</span>
<span class="tok-w">      </span><span class="tok-no">for i in $(seq 1 10); do</span>
<span class="tok-w">        </span><span class="tok-no">echo &quot;Datos generados en segundo $i: $(date)&quot; &gt;&gt; /shared/data.log</span>
<span class="tok-w">        </span><span class="tok-no">sleep 2</span>
<span class="tok-w">      </span><span class="tok-no">done</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;Productor terminado&quot;</span>
<span class="tok-w">    </span><span class="tok-nt">volumeMounts</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">shared-storage</span>
<span class="tok-w">      </span><span class="tok-nt">mountPath</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/shared</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">cache-storage</span>
<span class="tok-w">      </span><span class="tok-nt">mountPath</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/cache</span>

<span class="tok-w">  </span><span class="tok-c1"># Contenedor 2 - consumidor de datos</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">consumer</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">busybox:1.28</span>
<span class="tok-w">    </span><span class="tok-nt">command</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">sh</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">-c</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">|</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;Consumidor iniciado&quot;</span>
<span class="tok-w">      </span><span class="tok-no">sleep 5  # Espera a que el productor genere datos</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;=== Datos del productor ===&quot;</span>
<span class="tok-w">      </span><span class="tok-no">if [ -f /shared/data.log ]; then</span>
<span class="tok-w">        </span><span class="tok-no">cat /shared/data.log</span>
<span class="tok-w">      </span><span class="tok-no">else</span>
<span class="tok-w">        </span><span class="tok-no">echo &quot;No hay datos aún&quot;</span>
<span class="tok-w">      </span><span class="tok-no">fi</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;Esperando más datos...&quot;</span>
<span class="tok-w">      </span><span class="tok-no">sleep 10</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;=== Datos finales ===&quot;</span>
<span class="tok-w">      </span><span class="tok-no">cat /shared/data.log</span>

<span class="tok-w">      </span><span class="tok-no">echo &quot;=== Cache storage ===&quot;</span>
<span class="tok-w">      </span><span class="tok-no">ls -la /cache</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;Cache vacío&quot; &gt; /cache/status.txt</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;Consumidor terminado&quot;</span>
<span class="tok-w">    </span><span class="tok-nt">volumeMounts</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">shared-storage</span>
<span class="tok-w">      </span><span class="tok-nt">mountPath</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/shared</span>
<span class="tok-w">      </span><span class="tok-nt">readOnly</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">false</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">cache-storage</span>
<span class="tok-w">      </span><span class="tok-nt">mountPath</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/cache</span></code></pre>
</div>
</div>
</li>
<li>
<p>Despliega el Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>emptydir-volume-pod.yaml
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods</code></pre>
</div>
</div>
</li>
<li>
<p>Observa los logs de ambos contenedores:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Logs del productor</span>
kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>pod-with-emptydir-volume<span class="tok-w"> </span>-c<span class="tok-w"> </span>producer

<span class="tok-c1"># Logs del consumidor</span>
kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>pod-with-emptydir-volume<span class="tok-w"> </span>-c<span class="tok-w"> </span>consumer</code></pre>
</div>
</div>
</li>
<li>
<p>Accede al Pod y verifica los archivos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>pod-with-emptydir-volume<span class="tok-w"> </span>-c<span class="tok-w"> </span>producer<span class="tok-w"> </span>--<span class="tok-w"> </span>cat<span class="tok-w"> </span>/shared/data.log
kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>pod-with-emptydir-volume<span class="tok-w"> </span>-c<span class="tok-w"> </span>consumer<span class="tok-w"> </span>--<span class="tok-w"> </span>ls<span class="tok-w"> </span>-la<span class="tok-w"> </span>/shared</code></pre>
</div>
</div>
</li>
<li>
<p>Ver detalles del Pod incluyendo volúmenes:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pod<span class="tok-w"> </span>pod-with-emptydir-volume<span class="tok-w"> </span>-o<span class="tok-w"> </span>yaml<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>-A<span class="tok-w"> </span><span class="tok-m">20</span><span class="tok-w"> </span><span class="tok-s2">&quot;volumes:&quot;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod con un volumen que tiene límite de tamaño:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Pod</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">pod-with-limited-volume</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">volumes</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">limited-storage</span>
<span class="tok-w">    </span><span class="tok-nt">emptyDir</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">sizeLimit</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">10Mi</span><span class="tok-w">  </span><span class="tok-c1"># Máximo 10MB</span>

<span class="tok-w">  </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">busybox:1.28</span>
<span class="tok-w">    </span><span class="tok-nt">command</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">sh</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">-c</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">|</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;Intentando escribir datos...&quot;</span>
<span class="tok-w">      </span><span class="tok-no"># Intenta escribir más de 10MB</span>
<span class="tok-w">      </span><span class="tok-no">dd if=/dev/zero of=/data/bigfile bs=1M count=20</span>
<span class="tok-w">    </span><span class="tok-nt">volumeMounts</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">limited-storage</span>
<span class="tok-w">      </span><span class="tok-nt">mountPath</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/data</span></code></pre>
</div>
</div>
</li>
<li>
<p>Despliega e intenta sobrepasar el límite:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>limited-volume-pod.yaml
kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>pod-with-limited-volume
<span class="tok-c1"># Debería fallar al intentar escribir más de 10MB</span></code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>pod-with-emptydir-volume<span class="tok-w"> </span>pod-with-limited-volume</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong>
El consumidor debería poder leer los datos escritos por el productor. El Pod con límite de volumen debería fallar al exceder su límite.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong>
1. ¿Qué ocurre con los datos de un emptyDir cuando el Pod muere?
2. ¿Cuál es la diferencia entre emptyDir normal y emptyDir con medium: Memory?
3. ¿Cómo se comporta un volumen compartido con múltiples contenedores?
4. ¿Qué alternativas hay a emptyDir para almacenamiento persistente?</p>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resumen_de_conceptos_2">4. Resumen de Conceptos</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Estos ejercicios del Módulo 2 cubren:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Ejercicio 2.1</strong>: Pods multi-contenedor con patrón Sidecar</p>
</li>
<li>
<p><strong>Ejercicio 2.2</strong>: Init Containers para inicialización</p>
</li>
<li>
<p><strong>Ejercicio 2.3</strong>: Patrón Ambassador para proxying</p>
</li>
<li>
<p><strong>Ejercicio 2.4</strong>: Debugging avanzado de Pods</p>
</li>
<li>
<p><strong>Ejercicio 2.5</strong>: Políticas de reinicio de contenedores</p>
</li>
<li>
<p><strong>Ejercicio 2.6</strong>: Control de descarga de imágenes</p>
</li>
<li>
<p><strong>Ejercicio 2.7</strong>: SecurityContext para controles de seguridad</p>
</li>
<li>
<p><strong>Ejercicio 2.8</strong>: Labels y Selectors avanzados</p>
</li>
<li>
<p><strong>Ejercicio 2.9</strong>: Health checks (Liveness, Readiness, Startup)</p>
</li>
<li>
<p><strong>Ejercicio 2.10</strong>: Volúmenes compartidos (emptyDir)</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_módulo_3_controllers_y_workloads">5. Módulo 3: Controllers y Workloads</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_ejercicio_3_1_crear_y_gestionar_un_replicaset_básico">5.1. Ejercicio 3.1: Crear y gestionar un ReplicaSet básico</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Entender cómo los ReplicaSets mantienen un número específico de Pods en ejecución y crean/eliminan Pods automáticamente.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Crearás un ReplicaSet que gestiona 3 réplicas de nginx. Experimentarás cómo ReplicaSet se auto-recupera cuando eliminas Pods.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un archivo YAML llamado <code>replicaset-basic.yaml</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">apps/v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">ReplicaSet</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx-replicaset</span>
<span class="tok-w">  </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">replicas</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">3</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">matchLabels</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx</span>
<span class="tok-w">  </span><span class="tok-nt">template</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx</span>
<span class="tok-w">    </span><span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx</span>
<span class="tok-w">        </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx:1.21</span>
<span class="tok-w">        </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">containerPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea el ReplicaSet:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>replicaset-basic.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que se crearon 3 Pods:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>replicaset
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>nginx
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>rs<span class="tok-w"> </span>nginx-replicaset</code></pre>
</div>
</div>
</li>
<li>
<p>Observa los Pods en tiempo real:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>nginx<span class="tok-w"> </span>-w</code></pre>
</div>
</div>
</li>
<li>
<p>Elimina manualmente un Pod y observa cómo ReplicaSet lo recrea:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># En otra terminal, ejecuta:</span>
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>&lt;nombre-del-pod&gt;

<span class="tok-c1"># En la primera terminal (con -w), observa cómo se crea uno nuevo automáticamente</span></code></pre>
</div>
</div>
</li>
<li>
<p>Ver información completa del ReplicaSet:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>rs<span class="tok-w"> </span>nginx-replicaset<span class="tok-w"> </span>-o<span class="tok-w"> </span>yaml
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>rs<span class="tok-w"> </span>nginx-replicaset</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>rs<span class="tok-w"> </span>nginx-replicaset</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong>
Deberías ver 3 Pods en ejecución, y cuando elimines uno, ReplicaSet automáticamente crea uno nuevo.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong>
1. ¿Cómo sabe ReplicaSet qué Pods gestiona?
2. ¿Qué ocurre si cambias manualmente el label de un Pod?
3. ¿Por qué deberías usar Deployments en lugar de ReplicaSets directamente?</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_3_2_escalar_un_replicaset">5.2. Ejercicio 3.2: Escalar un ReplicaSet</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Aprender a cambiar dinámicamente el número de réplicas en un ReplicaSet.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Crearás un ReplicaSet y lo escalarás a diferentes números de réplicas observando cómo se crean/eliminan Pods.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un archivo YAML llamado <code>replicaset-scalable.yaml</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">apps/v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">ReplicaSet</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app-replicaset</span>
<span class="tok-w">  </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">myapp</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">replicas</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">2</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">matchLabels</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">myapp</span>
<span class="tok-w">  </span><span class="tok-nt">template</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">myapp</span>
<span class="tok-w">    </span><span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">        </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">busybox:1.28</span>
<span class="tok-w">        </span><span class="tok-nt">command</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">[</span><span class="tok-s">&quot;sleep&quot;</span><span class="tok-p tok-p-Indicator">,</span><span class="tok-w"> </span><span class="tok-s">&quot;3600&quot;</span><span class="tok-p tok-p-Indicator">]</span>
<span class="tok-w">        </span><span class="tok-nt">resources</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">requests</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-nt">cpu</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;50m&quot;</span>
<span class="tok-w">            </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;64Mi&quot;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea el ReplicaSet:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>replicaset-scalable.yaml
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>myapp</code></pre>
</div>
</div>
</li>
<li>
<p>Escala a 5 réplicas usando kubectl scale:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>scale<span class="tok-w"> </span>rs<span class="tok-w"> </span>app-replicaset<span class="tok-w"> </span>--replicas<span class="tok-o">=</span><span class="tok-m">5</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>myapp<span class="tok-w"> </span>-w<span class="tok-w">  </span><span class="tok-c1"># Observa cómo se crean 3 Pods más</span></code></pre>
</div>
</div>
</li>
<li>
<p>Escala a 10 réplicas:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>scale<span class="tok-w"> </span>rs<span class="tok-w"> </span>app-replicaset<span class="tok-w"> </span>--replicas<span class="tok-o">=</span><span class="tok-m">10</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>myapp<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>wc<span class="tok-w"> </span>-l<span class="tok-w">  </span><span class="tok-c1"># Cuenta los Pods</span></code></pre>
</div>
</div>
</li>
<li>
<p>Reduce a 3 réplicas:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>scale<span class="tok-w"> </span>rs<span class="tok-w"> </span>app-replicaset<span class="tok-w"> </span>--replicas<span class="tok-o">=</span><span class="tok-m">3</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>myapp<span class="tok-w"> </span>-w<span class="tok-w">  </span><span class="tok-c1"># Observa cómo se eliminan Pods</span></code></pre>
</div>
</div>
</li>
<li>
<p>Escala a 0 para parar todos los Pods:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>scale<span class="tok-w"> </span>rs<span class="tok-w"> </span>app-replicaset<span class="tok-w"> </span>--replicas<span class="tok-o">=</span><span class="tok-m">0</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>myapp<span class="tok-w">  </span><span class="tok-c1"># No debe haber Pods</span></code></pre>
</div>
</div>
</li>
<li>
<p>Escala nuevamente a 2:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>scale<span class="tok-w"> </span>rs<span class="tok-w"> </span>app-replicaset<span class="tok-w"> </span>--replicas<span class="tok-o">=</span><span class="tok-m">2</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>myapp</code></pre>
</div>
</div>
</li>
<li>
<p>Alterna el número de réplicas varias veces:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>scale<span class="tok-w"> </span>rs<span class="tok-w"> </span>app-replicaset<span class="tok-w"> </span>--replicas<span class="tok-o">=</span><span class="tok-m">7</span>
sleep<span class="tok-w"> </span><span class="tok-m">3</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>rs<span class="tok-w"> </span>app-replicaset
kubectl<span class="tok-w"> </span>scale<span class="tok-w"> </span>rs<span class="tok-w"> </span>app-replicaset<span class="tok-w"> </span>--replicas<span class="tok-o">=</span><span class="tok-m">4</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>rs<span class="tok-w"> </span>app-replicaset</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>rs<span class="tok-w"> </span>app-replicaset</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong>
El número de Pods debería cambiar dinámicamente según los valores que especifiques.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong>
1. ¿Cuánto tiempo tarda en crear/eliminar Pods?
2. ¿Qué ocurre si intentas escalar a un número muy alto?
3. ¿Cómo podrías hacer que el escalado sea automático basado en métricas?</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_3_3_crear_un_deployment_simple">5.3. Ejercicio 3.3: Crear un Deployment simple</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Entender la diferencia entre ReplicaSets y Deployments. Los Deployments proporcionan actualizaciones declarativas.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Crearás un Deployment que gestiona automáticamente un ReplicaSet. Verás que los Deployments son la forma recomendada de trabajar.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un archivo YAML llamado <code>deployment-basic.yaml</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">apps/v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Deployment</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">web-deployment</span>
<span class="tok-w">  </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">web</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">replicas</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">3</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">matchLabels</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">web</span>
<span class="tok-w">  </span><span class="tok-nt">template</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">web</span>
<span class="tok-w">    </span><span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx</span>
<span class="tok-w">        </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx:1.21</span>
<span class="tok-w">        </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">containerPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span>
<span class="tok-w">        </span><span class="tok-nt">resources</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">requests</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-nt">cpu</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;100m&quot;</span>
<span class="tok-w">            </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;128Mi&quot;</span>
<span class="tok-w">          </span><span class="tok-nt">limits</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-nt">cpu</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;200m&quot;</span>
<span class="tok-w">            </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;256Mi&quot;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea el Deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>deployment-basic.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el Deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>deployment
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>rs<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>web<span class="tok-w">  </span><span class="tok-c1"># Verifica que Deployment creó un ReplicaSet</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>web</code></pre>
</div>
</div>
</li>
<li>
<p>Describe el Deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>deployment<span class="tok-w"> </span>web-deployment</code></pre>
</div>
</div>
</li>
<li>
<p>Ver el YAML completo:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>deployment<span class="tok-w"> </span>web-deployment<span class="tok-w"> </span>-o<span class="tok-w"> </span>yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Escala el Deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>scale<span class="tok-w"> </span>deployment<span class="tok-w"> </span>web-deployment<span class="tok-w"> </span>--replicas<span class="tok-o">=</span><span class="tok-m">5</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>web</code></pre>
</div>
</div>
</li>
<li>
<p>Ver ReplicaSets asociados:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>rs<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>web<span class="tok-w">  </span><span class="tok-c1"># Debe haber un ReplicaSet</span></code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>deployment<span class="tok-w"> </span>web-deployment</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong>
El Deployment debería crear un ReplicaSet que a su vez crea los Pods.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong>
1. ¿Cuál es la relación entre Deployment y ReplicaSet?
2. ¿Qué ocurre con el ReplicaSet cuando eliminas el Deployment?
3. ¿Por qué los Deployments son preferibles a ReplicaSets?</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_3_4_rolling_updates_actualizar_imagen_de_deployment">5.4. Ejercicio 3.4: Rolling Updates - Actualizar imagen de Deployment</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Entender cómo los Deployments actualizan aplicaciones sin downtime usando Rolling Updates.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Crearás un Deployment y actualizarás su imagen a una versión más nueva, observando cómo ReplicaSet maneja la transición.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un archivo YAML llamado <code>deployment-rolling.yaml</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">apps/v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Deployment</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app-deployment</span>
<span class="tok-w">  </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">replicas</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">4</span>
<span class="tok-w">  </span><span class="tok-nt">strategy</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">type</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">RollingUpdate</span>
<span class="tok-w">    </span><span class="tok-nt">rollingUpdate</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">maxSurge</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">1</span><span class="tok-w">          </span><span class="tok-c1"># Máximo 1 Pod extra durante actualización</span>
<span class="tok-w">      </span><span class="tok-nt">maxUnavailable</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">1</span><span class="tok-w">    </span><span class="tok-c1"># Máximo 1 Pod puede estar no disponible</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">matchLabels</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">  </span><span class="tok-nt">template</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">    </span><span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx</span>
<span class="tok-w">        </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx:1.21</span>
<span class="tok-w">        </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">containerPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea el Deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>deployment-rolling.yaml
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>app</code></pre>
</div>
</div>
</li>
<li>
<p>Ver historial de despliegues:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>rollout<span class="tok-w"> </span><span class="tok-nb">history</span><span class="tok-w"> </span>deployment/app-deployment</code></pre>
</div>
</div>
</li>
<li>
<p>Actualiza la imagen a una versión más nueva:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span><span class="tok-nb">set</span><span class="tok-w"> </span>image<span class="tok-w"> </span>deployment/app-deployment<span class="tok-w"> </span><span class="tok-nv">nginx</span><span class="tok-o">=</span>nginx:1.22<span class="tok-w"> </span>--record</code></pre>
</div>
</div>
</li>
<li>
<p>Monitorea la actualización en tiempo real:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># En una terminal:</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>app<span class="tok-w"> </span>-w

<span class="tok-c1"># En otra terminal:</span>
kubectl<span class="tok-w"> </span>rollout<span class="tok-w"> </span>status<span class="tok-w"> </span>deployment/app-deployment<span class="tok-w"> </span>-w</code></pre>
</div>
</div>
</li>
<li>
<p>Ver ReplicaSets durante la actualización:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>rs<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>app<span class="tok-w">  </span><span class="tok-c1"># Deberías ver 2 ReplicaSets</span></code></pre>
</div>
</div>
</li>
<li>
<p>Cuando termine la actualización, verifica que todos los Pods están en la nueva versión:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>app<span class="tok-w"> </span>-o<span class="tok-w"> </span>wide
kubectl<span class="tok-w"> </span>rollout<span class="tok-w"> </span>status<span class="tok-w"> </span>deployment/app-deployment</code></pre>
</div>
</div>
</li>
<li>
<p>Actualiza nuevamente a otra versión:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span><span class="tok-nb">set</span><span class="tok-w"> </span>image<span class="tok-w"> </span>deployment/app-deployment<span class="tok-w"> </span><span class="tok-nv">nginx</span><span class="tok-o">=</span>nginx:1.23<span class="tok-w"> </span>--record
kubectl<span class="tok-w"> </span>rollout<span class="tok-w"> </span>status<span class="tok-w"> </span>deployment/app-deployment<span class="tok-w"> </span>-w</code></pre>
</div>
</div>
</li>
<li>
<p>Ver historial actualizado:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>rollout<span class="tok-w"> </span><span class="tok-nb">history</span><span class="tok-w"> </span>deployment/app-deployment</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>deployment<span class="tok-w"> </span>app-deployment</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong>
Deberías ver Pods siendo reemplazados gradualmente sin que el servicio se interrumpa.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong>
1. ¿Cuántos Pods están corriendo durante la actualización?
2. ¿Qué significa maxSurge y maxUnavailable?
3. ¿Cómo se relacionan los ReplicaSets antiguos y nuevos?</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_3_5_rollback_a_versión_anterior">5.5. Ejercicio 3.5: Rollback a versión anterior</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Aprender a revertir a una versión anterior de un Deployment rápidamente.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Crearás un Deployment, actualizarás varias veces y practicarás rollbacks.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un archivo YAML llamado <code>deployment-versions.yaml</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">apps/v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Deployment</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">versioned-app</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">replicas</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">3</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">matchLabels</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">  </span><span class="tok-nt">template</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">    </span><span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx</span>
<span class="tok-w">        </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx:1.20</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea el Deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>deployment-versions.yaml
kubectl<span class="tok-w"> </span>rollout<span class="tok-w"> </span><span class="tok-nb">history</span><span class="tok-w"> </span>deployment/versioned-app
<span class="tok-c1"># REVISION  CHANGE-CAUSE</span>
<span class="tok-c1"># 1         &lt;none&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Actualiza a versión 1.21:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span><span class="tok-nb">set</span><span class="tok-w"> </span>image<span class="tok-w"> </span>deployment/versioned-app<span class="tok-w"> </span><span class="tok-nv">nginx</span><span class="tok-o">=</span>nginx:1.21<span class="tok-w"> </span>--record
kubectl<span class="tok-w"> </span>rollout<span class="tok-w"> </span>status<span class="tok-w"> </span>deployment/versioned-app</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el historial:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>rollout<span class="tok-w"> </span><span class="tok-nb">history</span><span class="tok-w"> </span>deployment/versioned-app
<span class="tok-c1"># REVISION  CHANGE-CAUSE</span>
<span class="tok-c1"># 1         &lt;none&gt;</span>
<span class="tok-c1"># 2         kubectl set image deployment/versioned-app nginx=nginx:1.21 --record</span></code></pre>
</div>
</div>
</li>
<li>
<p>Actualiza a versión 1.22:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span><span class="tok-nb">set</span><span class="tok-w"> </span>image<span class="tok-w"> </span>deployment/versioned-app<span class="tok-w"> </span><span class="tok-nv">nginx</span><span class="tok-o">=</span>nginx:1.22<span class="tok-w"> </span>--record
kubectl<span class="tok-w"> </span>rollout<span class="tok-w"> </span>status<span class="tok-w"> </span>deployment/versioned-app</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el historial:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>rollout<span class="tok-w"> </span><span class="tok-nb">history</span><span class="tok-w"> </span>deployment/versioned-app</code></pre>
</div>
</div>
</li>
<li>
<p>Haz rollback a la revisión anterior (1.21):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>rollout<span class="tok-w"> </span>undo<span class="tok-w"> </span>deployment/versioned-app
kubectl<span class="tok-w"> </span>rollout<span class="tok-w"> </span>status<span class="tok-w"> </span>deployment/versioned-app</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que volvió a 1.21:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>deployment<span class="tok-w"> </span>versioned-app<span class="tok-w"> </span>-o<span class="tok-w"> </span><span class="tok-nv">jsonpath</span><span class="tok-o">=</span><span class="tok-s1">&#39;{.spec.template.spec.containers[0].image}&#39;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Haz rollback a una revisión específica (revisión 1):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>rollout<span class="tok-w"> </span>undo<span class="tok-w"> </span>deployment/versioned-app<span class="tok-w"> </span>--to-revision<span class="tok-o">=</span><span class="tok-m">1</span>
kubectl<span class="tok-w"> </span>rollout<span class="tok-w"> </span>status<span class="tok-w"> </span>deployment/versioned-app</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que volvió a 1.20:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>deployment<span class="tok-w"> </span>versioned-app<span class="tok-w"> </span>-o<span class="tok-w"> </span><span class="tok-nv">jsonpath</span><span class="tok-o">=</span><span class="tok-s1">&#39;{.spec.template.spec.containers[0].image}&#39;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Ver todos los ReplicaSets creados:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>rs<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>app</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>deployment<span class="tok-w"> </span>versioned-app</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong>
Deberías poder hacer rollback a cualquier versión anterior y los Pods deberían actualizarse automáticamente.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong>
1. ¿Cuántas revisiones se guardan por defecto?
2. ¿Cuántos ReplicaSets se crean?
3. ¿Qué ocurre con los datos si haces rollback?</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_3_6_pausa_y_reanuda_de_deployments">5.6. Ejercicio 3.6: Pausa y reanuda de Deployments</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Aprender a pausar un despliegue, hacer cambios, y reanudar para aplicarlos todos a la vez.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Practicarás pausar un Deployment, realizar múltiples cambios, y luego reanudar para que se apliquen conjuntamente.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un Deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">apps/v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Deployment</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">pause-demo</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">replicas</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">3</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">matchLabels</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">  </span><span class="tok-nt">template</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">    </span><span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx</span>
<span class="tok-w">        </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx:1.21</span>
<span class="tok-w">        </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">containerPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span></code></pre>
</div>
</div>
</li>
<li>
<p>Despliega:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>pause-demo.yaml
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>app</code></pre>
</div>
</div>
</li>
<li>
<p>Pausa el Deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>rollout<span class="tok-w"> </span>pause<span class="tok-w"> </span>deployment/pause-demo</code></pre>
</div>
</div>
</li>
<li>
<p>Realiza varios cambios mientras está pausado:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Cambio 1: Actualizar imagen</span>
kubectl<span class="tok-w"> </span><span class="tok-nb">set</span><span class="tok-w"> </span>image<span class="tok-w"> </span>deployment/pause-demo<span class="tok-w"> </span><span class="tok-nv">nginx</span><span class="tok-o">=</span>nginx:1.22

<span class="tok-c1"># Cambio 2: Escalar a 5 réplicas</span>
kubectl<span class="tok-w"> </span>scale<span class="tok-w"> </span>deployment/pause-demo<span class="tok-w"> </span>--replicas<span class="tok-o">=</span><span class="tok-m">5</span>

<span class="tok-c1"># Cambio 3: Agregar recurso limite</span>
kubectl<span class="tok-w"> </span><span class="tok-nb">set</span><span class="tok-w"> </span>resources<span class="tok-w"> </span>deployment/pause-demo<span class="tok-w"> </span>--limits<span class="tok-o">=</span><span class="tok-nv">cpu</span><span class="tok-o">=</span>200m,memory<span class="tok-o">=</span>256Mi</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el estado durante pausa:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>app<span class="tok-w">  </span><span class="tok-c1"># Debería seguir siendo 3 Pods (sin cambios)</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>deployment<span class="tok-w"> </span>pause-demo<span class="tok-w">  </span><span class="tok-c1"># Status debe mostrar &quot;PAUSED&quot;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Reanuda el Deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>rollout<span class="tok-w"> </span>resume<span class="tok-w"> </span>deployment/pause-demo</code></pre>
</div>
</div>
</li>
<li>
<p>Monitorea cómo se aplican todos los cambios:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>app<span class="tok-w"> </span>-w<span class="tok-w">  </span><span class="tok-c1"># Verás escalado a 5 y actualización de imagen</span>
kubectl<span class="tok-w"> </span>rollout<span class="tok-w"> </span>status<span class="tok-w"> </span>deployment/pause-demo<span class="tok-w"> </span>-w</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica los cambios finales:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>deployment<span class="tok-w"> </span>pause-demo
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>app<span class="tok-w">  </span><span class="tok-c1"># Debe haber 5 Pods</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>deployment<span class="tok-w"> </span>pause-demo<span class="tok-w"> </span>-o<span class="tok-w"> </span><span class="tok-nv">jsonpath</span><span class="tok-o">=</span><span class="tok-s1">&#39;{.spec.template.spec.containers[0].image}&#39;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>deployment<span class="tok-w"> </span>pause-demo</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong>
Todos los cambios deberían aplicarse cuando reanudir, no durante la pausa.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong>
1. ¿Por qué es útil pausar despliegues?
2. ¿Qué ocurre si intentas cambios mientras está pausado?
3. ¿Cómo combinarías pausa con el monitoreo de métricas?</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_3_7_statefulset_básico">5.7. Ejercicio 3.7: StatefulSet básico</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Entender cómo los StatefulSets proporcionan identidades estables a los Pods a diferencia de Deployments.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Crearás un StatefulSet y observarás cómo sus Pods tienen nombres ordenados y estables, a diferencia de los Deployments.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un archivo YAML llamado <code>statefulset-basic.yaml</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Service</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">web-headless</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">clusterIP</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">None</span><span class="tok-w">  </span><span class="tok-c1"># Headless Service</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">web</span>
<span class="tok-w">  </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">port</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span>
<span class="tok-w">    </span><span class="tok-nt">targetPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span>

<span class="tok-nn">---</span>
<span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">apps/v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">StatefulSet</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">web-statefulset</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">serviceName</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">web-headless</span><span class="tok-w">  </span><span class="tok-c1"># Requerido para StatefulSet</span>
<span class="tok-w">  </span><span class="tok-nt">replicas</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">3</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">matchLabels</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">web</span>
<span class="tok-w">  </span><span class="tok-nt">template</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">web</span>
<span class="tok-w">    </span><span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx</span>
<span class="tok-w">        </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx:1.21</span>
<span class="tok-w">        </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">containerPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea el StatefulSet:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>statefulset-basic.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que se crearon los Pods con nombres ordenados:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>statefulset
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w">  </span><span class="tok-c1"># Deberías ver: web-statefulset-0, web-statefulset-1, web-statefulset-2</span></code></pre>
</div>
</div>
</li>
<li>
<p>Compara con un Deployment (los Pods tendrían nombres aleatorios):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Para comparación, crea un Deployment:</span>
kubectl<span class="tok-w"> </span>create<span class="tok-w"> </span>deployment<span class="tok-w"> </span>comparison<span class="tok-w"> </span>--image<span class="tok-o">=</span>nginx:1.21<span class="tok-w"> </span>--replicas<span class="tok-o">=</span><span class="tok-m">3</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w">  </span><span class="tok-c1"># Verás nombres como comparison-xyz789, comparison-abc123, etc.</span></code></pre>
</div>
</div>
</li>
<li>
<p>Elimina un Pod del StatefulSet y observa que se recrea con el mismo nombre:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>web-statefulset-1
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w">  </span><span class="tok-c1"># web-statefulset-1 debería recrearse</span></code></pre>
</div>
</div>
</li>
<li>
<p>Escala el StatefulSet:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>scale<span class="tok-w"> </span>statefulset<span class="tok-w"> </span>web-statefulset<span class="tok-w"> </span>--replicas<span class="tok-o">=</span><span class="tok-m">5</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w">  </span><span class="tok-c1"># Deberías ver web-statefulset-3 y web-statefulset-4</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica la identidad ordenada:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Los Pods se crean en orden</span>
<span class="tok-c1"># Reducir también es en orden inverso</span>
kubectl<span class="tok-w"> </span>scale<span class="tok-w"> </span>statefulset<span class="tok-w"> </span>web-statefulset<span class="tok-w"> </span>--replicas<span class="tok-o">=</span><span class="tok-m">2</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w">  </span><span class="tok-c1"># Quedarán web-statefulset-0 y web-statefulset-1</span></code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>statefulset<span class="tok-w"> </span>web-statefulset
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>service<span class="tok-w"> </span>web-headless
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>deployment<span class="tok-w"> </span>comparison</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong>
Los Pods del StatefulSet deben tener nombres como <code>web-statefulset-0</code>, <code>web-statefulset-1</code>, etc.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong>
1. ¿Por qué es importante la identidad estable?
2. ¿Cuál es el rol del Headless Service?
3. ¿Cuándo usarías StatefulSet vs Deployment?</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_3_8_statefulset_con_volumeclaimtemplates">5.8. Ejercicio 3.8: StatefulSet con volumeClaimTemplates</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Entender cómo StatefulSets proporcionan almacenamiento persistente único para cada Pod.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Crearás un StatefulSet con volumeClaimTemplates que crea un PVC por cada Pod.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un archivo YAML llamado <code>statefulset-storage.yaml</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Service</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">mysql-headless</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">clusterIP</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">None</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">mysql</span>
<span class="tok-w">  </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">port</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">3306</span>

<span class="tok-nn">---</span>
<span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">apps/v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">StatefulSet</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">mysql</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">serviceName</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">mysql-headless</span>
<span class="tok-w">  </span><span class="tok-nt">replicas</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">3</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">matchLabels</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">mysql</span>
<span class="tok-w">  </span><span class="tok-nt">template</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">mysql</span>
<span class="tok-w">    </span><span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">mysql</span>
<span class="tok-w">        </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">mysql:5.7</span>
<span class="tok-w">        </span><span class="tok-nt">env</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">MYSQL_ROOT_PASSWORD</span>
<span class="tok-w">          </span><span class="tok-nt">value</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;password&quot;</span>
<span class="tok-w">        </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">containerPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">3306</span>
<span class="tok-w">        </span><span class="tok-nt">volumeMounts</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">data</span>
<span class="tok-w">          </span><span class="tok-nt">mountPath</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/var/lib/mysql</span>
<span class="tok-w">  </span><span class="tok-nt">volumeClaimTemplates</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">data</span>
<span class="tok-w">    </span><span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">accessModes</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">[</span><span class="tok-w"> </span><span class="tok-s">&quot;ReadWriteOnce&quot;</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">]</span>
<span class="tok-w">      </span><span class="tok-nt">resources</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">requests</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">storage</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">1Gi</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea el StatefulSet:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>statefulset-storage.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica los Pods creados:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>statefulset
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>mysql</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que se crearon PVCs:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pvc<span class="tok-w">  </span><span class="tok-c1"># Deberías ver: data-mysql-0, data-mysql-1, data-mysql-2</span>
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>pvc<span class="tok-w"> </span>data-mysql-0</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que cada Pod tiene su PVC montado:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>pod<span class="tok-w"> </span>mysql-0<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>-A<span class="tok-w"> </span><span class="tok-m">5</span><span class="tok-w"> </span><span class="tok-s2">&quot;Mounts&quot;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Escala el StatefulSet a 5 réplicas:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>scale<span class="tok-w"> </span>statefulset<span class="tok-w"> </span>mysql<span class="tok-w"> </span>--replicas<span class="tok-o">=</span><span class="tok-m">5</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>mysql
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pvc<span class="tok-w">  </span><span class="tok-c1"># Deberías ver data-mysql-0 a data-mysql-4</span></code></pre>
</div>
</div>
</li>
<li>
<p>Elimina un Pod y verifica que el PVC persiste:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>mysql-2
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>mysql<span class="tok-w">  </span><span class="tok-c1"># Se recrea mysql-2</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pvc<span class="tok-w">  </span><span class="tok-c1"># data-mysql-2 sigue existiendo</span></code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>statefulset<span class="tok-w"> </span>mysql
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>service<span class="tok-w"> </span>mysql-headless
<span class="tok-c1"># Nota: Los PVCs no se eliminan automáticamente</span>
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pvc<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>mysql</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong>
Deberías ver PVCs creados con nombres como <code>data-mysql-0</code>, <code>data-mysql-1</code>, etc.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong>
1. ¿Qué ocurre con los datos si eliminas un Pod?
2. ¿Por qué los PVCs no se eliminan automáticamente?
3. ¿Cuándo necesitarías volumeClaimTemplates?</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_3_9_estrategias_de_actualización_en_statefulset">5.9. Ejercicio 3.9: Estrategias de actualización en StatefulSet</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Entender cómo StatefulSets actualiza Pods de forma ordenada (en orden inverso).</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Crearás un StatefulSet y actualizarás su imagen, observando cómo se actualiza de forma ordenada.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un archivo YAML llamado <code>statefulset-update.yaml</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Service</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app-headless</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">clusterIP</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">None</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">  </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">port</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">8080</span>

<span class="tok-nn">---</span>
<span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">apps/v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">StatefulSet</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">serviceName</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app-headless</span>
<span class="tok-w">  </span><span class="tok-nt">replicas</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">3</span>
<span class="tok-w">  </span><span class="tok-nt">updateStrategy</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">type</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">RollingUpdate</span>
<span class="tok-w">    </span><span class="tok-nt">rollingUpdate</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">partition</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">0</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">matchLabels</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">  </span><span class="tok-nt">template</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">    </span><span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">        </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">busybox:1.28</span>
<span class="tok-w">        </span><span class="tok-nt">command</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">[</span><span class="tok-s">&quot;sleep&quot;</span><span class="tok-p tok-p-Indicator">,</span><span class="tok-w"> </span><span class="tok-s">&quot;3600&quot;</span><span class="tok-p tok-p-Indicator">]</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea el StatefulSet:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>statefulset-update.yaml
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>app</code></pre>
</div>
</div>
</li>
<li>
<p>Actualiza la imagen:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span><span class="tok-nb">set</span><span class="tok-w"> </span>image<span class="tok-w"> </span>statefulset/app<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>busybox:1.35</code></pre>
</div>
</div>
</li>
<li>
<p>Monitorea la actualización (es lenta, ordenada):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>app<span class="tok-w"> </span>-w<span class="tok-w">  </span><span class="tok-c1"># Verás actualizarse: app-2 → app-1 → app-0</span></code></pre>
</div>
</div>
</li>
<li>
<p>Durante la actualización, verifica qué Pod se está actualizando:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>statefulset<span class="tok-w"> </span>app<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>-A<span class="tok-w"> </span><span class="tok-m">10</span><span class="tok-w"> </span><span class="tok-s2">&quot;Update Strategy&quot;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Una vez terminada, verifica que todos tienen la nueva imagen:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>app<span class="tok-w"> </span>-o<span class="tok-w"> </span><span class="tok-nv">jsonpath</span><span class="tok-o">=</span><span class="tok-s1">&#39;{range .items[*]}{.metadata.name}: {.spec.containers[0].image}{&quot;\n&quot;}{end}&#39;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Ahora prueba una actualización Canary con partition:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Cambiar imagen nuevamente</span>
kubectl<span class="tok-w"> </span><span class="tok-nb">set</span><span class="tok-w"> </span>image<span class="tok-w"> </span>statefulset/app<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>busybox:1.32

<span class="tok-c1"># Pausar solo actualizando app-2 (partition: 2)</span>
kubectl<span class="tok-w"> </span>patch<span class="tok-w"> </span>statefulset<span class="tok-w"> </span>app<span class="tok-w"> </span>-p<span class="tok-w"> </span><span class="tok-s1">&#39;{&quot;spec&quot;:{&quot;updateStrategy&quot;:{&quot;rollingUpdate&quot;:{&quot;partition&quot;:2}}}}&#39;</span>

<span class="tok-c1"># Solo se actualizará app-2</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>app<span class="tok-w"> </span>-w</code></pre>
</div>
</div>
</li>
<li>
<p>Cuando esté listo, actualizar el resto (partition: 0):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>patch<span class="tok-w"> </span>statefulset<span class="tok-w"> </span>app<span class="tok-w"> </span>-p<span class="tok-w"> </span><span class="tok-s1">&#39;{&quot;spec&quot;:{&quot;updateStrategy&quot;:{&quot;rollingUpdate&quot;:{&quot;partition&quot;:0}}}}&#39;</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>app<span class="tok-w"> </span>-w<span class="tok-w">  </span><span class="tok-c1"># Se actualizan app-1 y app-0</span></code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>statefulset<span class="tok-w"> </span>app
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>service<span class="tok-w"> </span>app-headless</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong>
La actualización debería proceder en orden inverso (del Pod más alto al más bajo).</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong>
1. ¿Por qué StatefulSet actualiza en orden inverso?
2. ¿Cómo se relaciona partition con canary deployments?
3. ¿Cuál es la ventaja de actualizar ordenadamente?</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_3_10_headless_service_para_statefulset">5.10. Ejercicio 3.10: Headless Service para StatefulSet</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Entender cómo los Headless Services permiten DNS predecible para cada Pod del StatefulSet.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Crearás un Headless Service con StatefulSet y probarás la resolución DNS de cada Pod.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un archivo YAML llamado <code>statefulset-headless.yaml</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Service</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">postgres-headless</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">clusterIP</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">None</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">postgres</span>
<span class="tok-w">  </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">port</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">5432</span>
<span class="tok-w">    </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">postgres</span>

<span class="tok-nn">---</span>
<span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">apps/v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">StatefulSet</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">postgres</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">serviceName</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">postgres-headless</span>
<span class="tok-w">  </span><span class="tok-nt">replicas</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">3</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">matchLabels</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">postgres</span>
<span class="tok-w">  </span><span class="tok-nt">template</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">postgres</span>
<span class="tok-w">    </span><span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">postgres</span>
<span class="tok-w">        </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">postgres:13</span>
<span class="tok-w">        </span><span class="tok-nt">env</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">POSTGRES_PASSWORD</span>
<span class="tok-w">          </span><span class="tok-nt">value</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;password&quot;</span>
<span class="tok-w">        </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">containerPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">5432</span>
<span class="tok-w">        </span><span class="tok-nt">command</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">sleep</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-s">&quot;3600&quot;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea el StatefulSet y Headless Service:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>statefulset-headless.yaml
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>postgres
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>service<span class="tok-w"> </span>postgres-headless</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod de prueba para hacer consultas DNS:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>run<span class="tok-w"> </span>-it<span class="tok-w"> </span>dnstools<span class="tok-w"> </span>--image<span class="tok-o">=</span>busybox:1.28<span class="tok-w"> </span>--rm<span class="tok-w"> </span>--<span class="tok-w"> </span>sh</code></pre>
</div>
</div>
</li>
<li>
<p>Dentro del Pod de prueba, consulta el DNS:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Resolver el Headless Service</span>
nslookup<span class="tok-w"> </span>postgres-headless

<span class="tok-c1"># Debería retornar IPs de todos los Pods:</span>
<span class="tok-c1"># postgres-0.postgres-headless.default.svc.cluster.local</span>
<span class="tok-c1"># postgres-1.postgres-headless.default.svc.cluster.local</span>
<span class="tok-c1"># postgres-2.postgres-headless.default.svc.cluster.local</span>

<span class="tok-c1"># Resolver un Pod específico</span>
nslookup<span class="tok-w"> </span>postgres-0.postgres-headless

<span class="tok-c1"># Resolver un Service normal (para comparación)</span>
nslookup<span class="tok-w"> </span>postgres-headless

<span class="tok-c1"># Salir</span>
<span class="tok-nb">exit</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica los registros DNS desde la línea de comandos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Crear un Pod temporal para resolver DNS</span>
kubectl<span class="tok-w"> </span>run<span class="tok-w"> </span>-it<span class="tok-w"> </span>dns-test<span class="tok-w"> </span>--image<span class="tok-o">=</span>busybox:1.28<span class="tok-w"> </span>--rm<span class="tok-w"> </span>--restart<span class="tok-o">=</span>Never<span class="tok-w"> </span>--<span class="tok-w"> </span>nslookup<span class="tok-w"> </span>postgres-headless</code></pre>
</div>
</div>
</li>
<li>
<p>Compara con un Service normal:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Crear Service normal (con ClusterIP)</span>
kubectl<span class="tok-w"> </span>expose<span class="tok-w"> </span>statefulset<span class="tok-w"> </span>postgres<span class="tok-w"> </span>--name<span class="tok-o">=</span>postgres-service<span class="tok-w"> </span>--port<span class="tok-o">=</span><span class="tok-m">5432</span>

<span class="tok-c1"># Consultar ambos servicios</span>
kubectl<span class="tok-w"> </span>run<span class="tok-w"> </span>-it<span class="tok-w"> </span>dns-comparison<span class="tok-w"> </span>--image<span class="tok-o">=</span>busybox:1.28<span class="tok-w"> </span>--rm<span class="tok-w"> </span>--restart<span class="tok-o">=</span>Never<span class="tok-w"> </span>--<span class="tok-w"> </span>sh<span class="tok-w"> </span>-c<span class="tok-w"> </span><span class="tok-s2">&quot;nslookup postgres-service &amp;&amp; nslookup postgres-headless&quot;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica qué se obtiene de cada uno:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Service normal: retorna una sola IP (ClusterIP)</span>
<span class="tok-c1"># Headless Service: retorna todas las IPs de los Pods</span></code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>statefulset<span class="tok-w"> </span>postgres
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>service<span class="tok-w"> </span>postgres-headless<span class="tok-w"> </span>postgres-service</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong>
El Headless Service debería retornar múltiples IPs (una por cada Pod), mientras que un Service normal retorna una sola IP.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong>
1. ¿Cuál es la diferencia entre un Service normal y un Headless Service?
2. ¿Por qué un StatefulSet necesita un Headless Service?
3. ¿Cómo usarías los DNS de Pod específicos?</p>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resumen_de_conceptos_3">6. Resumen de Conceptos</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Estos ejercicios del Módulo 3 cubren:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Ejercicio 3.1</strong>: ReplicaSets y auto-recuperación</p>
</li>
<li>
<p><strong>Ejercicio 3.2</strong>: Escalado manual de ReplicaSets</p>
</li>
<li>
<p><strong>Ejercicio 3.3</strong>: Deployments básicos</p>
</li>
<li>
<p><strong>Ejercicio 3.4</strong>: Rolling Updates en Deployments</p>
</li>
<li>
<p><strong>Ejercicio 3.5</strong>: Rollbacks de versiones</p>
</li>
<li>
<p><strong>Ejercicio 3.6</strong>: Pausa y reanuda de despliegues</p>
</li>
<li>
<p><strong>Ejercicio 3.7</strong>: StatefulSets básicos</p>
</li>
<li>
<p><strong>Ejercicio 3.8</strong>: Almacenamiento persistente con volumeClaimTemplates</p>
</li>
<li>
<p><strong>Ejercicio 3.9</strong>: Estrategias de actualización en StatefulSet</p>
</li>
<li>
<p><strong>Ejercicio 3.10</strong>: Headless Services para StatefulSet</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_módulo_4_servicios_y_redes">7. Módulo 4: Servicios y Redes</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_ejercicio_4_1_comunicación_pod_to_pod_directa">7.1. Ejercicio 4.1: Comunicación Pod-to-Pod directa</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Entender cómo los Pods pueden comunicarse directamente entre sí sin necesidad de un Service, usando IPs de Pods.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Crearás dos Pods que se comunicarán directamente entre sí usando sus IPs de Pod, sin la intermediación de un Service.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un Deployment con un servidor nginx (<code>pod-server.yaml</code>):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">apps/v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Deployment</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">server-deployment</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">replicas</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">1</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">matchLabels</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">server</span>
<span class="tok-w">  </span><span class="tok-nt">template</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">server</span>
<span class="tok-w">    </span><span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx</span>
<span class="tok-w">        </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx:1.21</span>
<span class="tok-w">        </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">containerPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea el servidor:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>pod-server.yaml
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>server<span class="tok-w"> </span>-o<span class="tok-w"> </span>wide<span class="tok-w">  </span><span class="tok-c1"># Anota la IP del Pod</span></code></pre>
</div>
</div>
</li>
<li>
<p>Obtén la IP del servidor:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nv">SERVER_IP</span><span class="tok-o">=</span><span class="tok-k">$(</span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pod<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>server<span class="tok-w"> </span>-o<span class="tok-w"> </span><span class="tok-nv">jsonpath</span><span class="tok-o">=</span><span class="tok-s1">&#39;{.items[0].status.podIP}&#39;</span><span class="tok-k">)</span>
<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;IP del servidor: </span><span class="tok-nv">$SERVER_IP</span><span class="tok-s2">&quot;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod cliente que se conectará al servidor:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>run<span class="tok-w"> </span>client<span class="tok-w"> </span>--image<span class="tok-o">=</span>busybox:1.28<span class="tok-w"> </span>--rm<span class="tok-w"> </span>-it<span class="tok-w"> </span>--restart<span class="tok-o">=</span>Never<span class="tok-w"> </span>--<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>wget<span class="tok-w"> </span>-O-<span class="tok-w"> </span>http://<span class="tok-nv">$SERVER_IP</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que el cliente puede acceder al servidor:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># La respuesta debería ser la página de nginx</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod cliente persistente para más pruebas:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>run<span class="tok-w"> </span>test-client<span class="tok-w"> </span>--image<span class="tok-o">=</span>nicolaka/netshoot<span class="tok-w"> </span>-it<span class="tok-w"> </span>--rm<span class="tok-w"> </span>--restart<span class="tok-o">=</span>Never<span class="tok-w"> </span>--<span class="tok-w"> </span>bash</code></pre>
</div>
</div>
</li>
<li>
<p>Dentro del cliente, prueba comunicación:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Resuelve el nombre del servidor (por IP)</span>
ping<span class="tok-w"> </span><span class="tok-nv">$SERVER_IP</span>

<span class="tok-c1"># Accede al servidor</span>
curl<span class="tok-w"> </span>http://<span class="tok-nv">$SERVER_IP</span>

<span class="tok-c1"># Salir</span>
<span class="tok-nb">exit</span></code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>deployment<span class="tok-w"> </span>server-deployment</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong>
El cliente debería poder alcanzar el servidor usando su IP de Pod directamente.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong>
1. ¿Cuál es el problema de usar IPs de Pods directamente?
2. ¿Qué ocurre si el servidor Pod muere y se recrea?
3. ¿Cómo se comunican los Pods entre diferentes nodos?</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_4_2_crear_un_service_clusterip_básico">7.2. Ejercicio 4.2: Crear un Service ClusterIP básico</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Crear un Service ClusterIP que proporciona una dirección IP estable para acceder a Pods.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Crearás un Deployment con varios Pods y un Service ClusterIP que actúa como intermediario.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un Deployment (<code>web-deployment.yaml</code>):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">apps/v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Deployment</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">web</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">replicas</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">3</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">matchLabels</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">web</span>
<span class="tok-w">  </span><span class="tok-nt">template</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">web</span>
<span class="tok-w">    </span><span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx</span>
<span class="tok-w">        </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx:1.21</span>
<span class="tok-w">        </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">containerPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Service ClusterIP (<code>web-service.yaml</code>):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Service</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">web</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">type</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">ClusterIP</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">web</span>
<span class="tok-w">  </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">protocol</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">TCP</span>
<span class="tok-w">    </span><span class="tok-nt">port</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span>
<span class="tok-w">    </span><span class="tok-nt">targetPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span></code></pre>
</div>
</div>
</li>
<li>
<p>Despliega ambos recursos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>web-deployment.yaml
kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>web-service.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el Service:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>svc<span class="tok-w"> </span>web
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>svc<span class="tok-w"> </span>web</code></pre>
</div>
</div>
</li>
<li>
<p>Obtén la IP del Service:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nv">SERVICE_IP</span><span class="tok-o">=</span><span class="tok-k">$(</span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>svc<span class="tok-w"> </span>web<span class="tok-w"> </span>-o<span class="tok-w"> </span><span class="tok-nv">jsonpath</span><span class="tok-o">=</span><span class="tok-s1">&#39;{.status.clusterIP}&#39;</span><span class="tok-k">)</span>
<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;IP del Service: </span><span class="tok-nv">$SERVICE_IP</span><span class="tok-s2">&quot;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica los Endpoints (Pods detrás del Service):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>endpoints<span class="tok-w"> </span>web
<span class="tok-c1"># Debería mostrar 3 IPs de Pods</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod cliente y accede al Service:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>run<span class="tok-w"> </span>client<span class="tok-w"> </span>--image<span class="tok-o">=</span>busybox:1.28<span class="tok-w"> </span>--rm<span class="tok-w"> </span>-it<span class="tok-w"> </span>--restart<span class="tok-o">=</span>Never<span class="tok-w"> </span>--<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>wget<span class="tok-w"> </span>-O-<span class="tok-w"> </span>http://<span class="tok-nv">$SERVICE_IP</span></code></pre>
</div>
</div>
</li>
<li>
<p>Accede múltiples veces para ver el balanceo de carga:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-k">for</span><span class="tok-w"> </span>i<span class="tok-w"> </span><span class="tok-k">in</span><span class="tok-w"> </span><span class="tok-o">{</span><span class="tok-m">1</span>..5<span class="tok-o">}</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-k">do</span>
<span class="tok-w">  </span>kubectl<span class="tok-w"> </span>run<span class="tok-w"> </span>client-<span class="tok-nv">$i</span><span class="tok-w"> </span>--image<span class="tok-o">=</span>busybox:1.28<span class="tok-w"> </span>--rm<span class="tok-w"> </span>--restart<span class="tok-o">=</span>Never<span class="tok-w"> </span>--<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">    </span>wget<span class="tok-w"> </span>-q<span class="tok-w"> </span>-O-<span class="tok-w"> </span>http://web<span class="tok-w"> </span><span class="tok-m">2</span>&gt;/dev/null
<span class="tok-k">done</span></code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>deployment<span class="tok-w"> </span>web
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>service<span class="tok-w"> </span>web</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong>
El Service debería tener una IP estable y los Endpoints deberían listar todos los Pods.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong>
1. ¿Por qué es importante la IP estable del Service?
2. ¿Cómo el Service sabe a qué Pods enviar tráfico?
3. ¿Qué ocurre si eliminas un Pod?</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_4_3_service_nodeport_para_acceso_externo">7.3. Ejercicio 4.3: Service NodePort para acceso externo</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Exponer un Service externamente usando NodePort.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Crearás un Service NodePort que abre un puerto en cada nodo del cluster.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un Deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">apps/v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Deployment</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">replicas</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">2</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">matchLabels</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">  </span><span class="tok-nt">template</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">    </span><span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">        </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx:1.21</span>
<span class="tok-w">        </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">containerPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Service NodePort (<code>nodeport-service.yaml</code>):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Service</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app-nodeport</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">type</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">NodePort</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">  </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">protocol</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">TCP</span>
<span class="tok-w">    </span><span class="tok-nt">port</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span>
<span class="tok-w">    </span><span class="tok-nt">targetPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span>
<span class="tok-w">    </span><span class="tok-nt">nodePort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">30080</span><span class="tok-w">  </span><span class="tok-c1"># Puerto fijo en los nodos</span></code></pre>
</div>
</div>
</li>
<li>
<p>Despliega:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>app-deployment.yaml
kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>nodeport-service.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el Service:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>svc<span class="tok-w"> </span>app-nodeport
<span class="tok-c1"># Debería mostrar port 80:30080/TCP</span></code></pre>
</div>
</div>
</li>
<li>
<p>Obtén la IP de un nodo:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Para Minikube o Docker Desktop:</span>
<span class="tok-nv">NODE_IP</span><span class="tok-o">=</span><span class="tok-k">$(</span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>nodes<span class="tok-w"> </span>-o<span class="tok-w"> </span><span class="tok-nv">jsonpath</span><span class="tok-o">=</span><span class="tok-s1">&#39;{.items[0].status.addresses[0].address}&#39;</span><span class="tok-k">)</span>
<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;IP del nodo: </span><span class="tok-nv">$NODE_IP</span><span class="tok-s2">&quot;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Accede desde fuera del cluster:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Si estás en la máquina local:</span>
curl<span class="tok-w"> </span>http://localhost:30080

<span class="tok-c1"># O usando kubectl port-forward:</span>
kubectl<span class="tok-w"> </span>port-forward<span class="tok-w"> </span>svc/app-nodeport<span class="tok-w"> </span><span class="tok-m">8080</span>:80<span class="tok-w"> </span><span class="tok-p">&amp;</span>
curl<span class="tok-w"> </span>http://localhost:8080
pkill<span class="tok-w"> </span>-f<span class="tok-w"> </span><span class="tok-s2">&quot;port-forward&quot;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica Endpoints:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>endpoints<span class="tok-w"> </span>app-nodeport</code></pre>
</div>
</div>
</li>
<li>
<p>Elimina un Pod y verifica que el Service sigue disponible:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>app
<span class="tok-c1"># El Service debería seguir disponible con los Pods restantes</span>
curl<span class="tok-w"> </span>http://localhost:30080</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>deployment<span class="tok-w"> </span>app
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>service<span class="tok-w"> </span>app-nodeport</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong>
Deberías poder acceder al servicio desde fuera del cluster usando <code>&lt;node-ip&gt;:30080</code>.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong>
1. ¿Cuál es la diferencia entre ClusterIP y NodePort?
2. ¿En qué rango están los puertos NodePort?
3. ¿Por qué NodePort no se usa en producción típicamente?</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_4_4_load_balancing_y_distribución_de_tráfico">7.4. Ejercicio 4.4: Load balancing y distribución de tráfico</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Observar cómo el Service distribuye el tráfico entre múltiples Pods.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Crearás un Deployment con múltiples Pods que pueden ser identificados, y verás cómo el tráfico se distribuye.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un Deployment con un Pod que identifica su hostname (<code>lb-deployment.yaml</code>):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">apps/v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Deployment</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">web-lb</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">replicas</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">3</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">matchLabels</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">web</span>
<span class="tok-w">  </span><span class="tok-nt">template</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">web</span>
<span class="tok-w">    </span><span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">        </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx:1.21</span>
<span class="tok-w">        </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">containerPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span>
<span class="tok-w">        </span><span class="tok-nt">lifecycle</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">postStart</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-nt">exec</span><span class="tok-p">:</span>
<span class="tok-w">              </span><span class="tok-nt">command</span><span class="tok-p">:</span>
<span class="tok-w">              </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">sh</span>
<span class="tok-w">              </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">-c</span>
<span class="tok-w">              </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">echo &quot;Server</span><span class="tok-p tok-p-Indicator">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">$(hostname)&quot; &gt; /usr/share/nginx/html/index.html</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Service:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Service</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">web-lb</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">type</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">ClusterIP</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">web</span>
<span class="tok-w">  </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">protocol</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">TCP</span>
<span class="tok-w">    </span><span class="tok-nt">port</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span>
<span class="tok-w">    </span><span class="tok-nt">targetPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span></code></pre>
</div>
</div>
</li>
<li>
<p>Despliega:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>lb-deployment.yaml
kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>web-lb-service.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod cliente para enviar múltiples requests:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>run<span class="tok-w"> </span>client<span class="tok-w"> </span>--image<span class="tok-o">=</span>busybox:1.28<span class="tok-w"> </span>--rm<span class="tok-w"> </span>-it<span class="tok-w"> </span>--restart<span class="tok-o">=</span>Never<span class="tok-w"> </span>--<span class="tok-w"> </span>sh</code></pre>
</div>
</div>
</li>
<li>
<p>Dentro del cliente, envía múltiples requests:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Envía 10 requests y observa qué servidor responde</span>
<span class="tok-k">for</span><span class="tok-w"> </span>i<span class="tok-w"> </span><span class="tok-k">in</span><span class="tok-w"> </span><span class="tok-o">{</span><span class="tok-m">1</span>..10<span class="tok-o">}</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-k">do</span>
<span class="tok-w">  </span>wget<span class="tok-w"> </span>-q<span class="tok-w"> </span>-O-<span class="tok-w"> </span>http://web-lb
<span class="tok-w">  </span><span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;&quot;</span>
<span class="tok-k">done</span>

<span class="tok-c1"># Debería mostrar diferentes &quot;Server: web-lb-xxxx&quot; alternando</span>
<span class="tok-nb">exit</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica los Pods y sus IPs:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>web<span class="tok-w"> </span>-o<span class="tok-w"> </span>wide</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica los Endpoints:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>endpoints<span class="tok-w"> </span>web-lb</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>deployment<span class="tok-w"> </span>web-lb
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>service<span class="tok-w"> </span>web-lb</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong>
Deberías ver que los requests se distribuyen entre los diferentes Pods (round-robin).</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong>
1. ¿Cuál es el algoritmo de balanceo que usa el Service?
2. ¿Cómo se distribuye el tráfico?
3. ¿Cómo funciona esto a nivel de red?</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_4_5_session_affinity_clientip">7.5. Ejercicio 4.5: Session Affinity (ClientIP)</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Aprender cómo usar Session Affinity para "pegar" un cliente a un Pod específico.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Crearás un Service con Session Affinity para que un cliente siempre vaya al mismo Pod.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un Deployment con Pods identificables (<code>affinity-deployment.yaml</code>):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">apps/v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Deployment</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app-affinity</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">replicas</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">3</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">matchLabels</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">  </span><span class="tok-nt">template</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">    </span><span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">        </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx:1.21</span>
<span class="tok-w">        </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">containerPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span>
<span class="tok-w">        </span><span class="tok-nt">lifecycle</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">postStart</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-nt">exec</span><span class="tok-p">:</span>
<span class="tok-w">              </span><span class="tok-nt">command</span><span class="tok-p">:</span>
<span class="tok-w">              </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">sh</span>
<span class="tok-w">              </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">-c</span>
<span class="tok-w">              </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">echo &quot;Pod</span><span class="tok-p tok-p-Indicator">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">$(hostname)&quot; &gt; /usr/share/nginx/html/index.html</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Service con Session Affinity (<code>affinity-service.yaml</code>):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Service</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app-affinity</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">type</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">ClusterIP</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">  </span><span class="tok-nt">sessionAffinity</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">ClientIP</span><span class="tok-w">  </span><span class="tok-c1"># Pega cliente a Pod</span>
<span class="tok-w">  </span><span class="tok-nt">sessionAffinityConfig</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">clientIP</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">timeoutSeconds</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">3600</span><span class="tok-w">   </span><span class="tok-c1"># 1 hora</span>
<span class="tok-w">  </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">protocol</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">TCP</span>
<span class="tok-w">    </span><span class="tok-nt">port</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span>
<span class="tok-w">    </span><span class="tok-nt">targetPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span></code></pre>
</div>
</div>
</li>
<li>
<p>Despliega:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>affinity-deployment.yaml
kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>affinity-service.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod cliente y envía múltiples requests:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>run<span class="tok-w"> </span>client<span class="tok-w"> </span>--image<span class="tok-o">=</span>busybox:1.28<span class="tok-w"> </span>--rm<span class="tok-w"> </span>-it<span class="tok-w"> </span>--restart<span class="tok-o">=</span>Never<span class="tok-w"> </span>--<span class="tok-w"> </span>sh</code></pre>
</div>
</div>
</li>
<li>
<p>Dentro del cliente, envía requests:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Envía múltiples requests y observa que siempre va al mismo Pod</span>
<span class="tok-k">for</span><span class="tok-w"> </span>i<span class="tok-w"> </span><span class="tok-k">in</span><span class="tok-w"> </span><span class="tok-o">{</span><span class="tok-m">1</span>..5<span class="tok-o">}</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-k">do</span>
<span class="tok-w">  </span><span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;Request </span><span class="tok-nv">$i</span><span class="tok-s2">:&quot;</span>
<span class="tok-w">  </span>wget<span class="tok-w"> </span>-q<span class="tok-w"> </span>-O-<span class="tok-w"> </span>http://app-affinity
<span class="tok-w">  </span><span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;&quot;</span>
<span class="tok-k">done</span>

<span class="tok-c1"># Todos deberían mostrar el mismo &quot;Pod: app-affinity-xxxx&quot;</span>
<span class="tok-nb">exit</span></code></pre>
</div>
</div>
</li>
<li>
<p>Para comparar, crea un segundo cliente:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>run<span class="tok-w"> </span>client2<span class="tok-w"> </span>--image<span class="tok-o">=</span>busybox:1.28<span class="tok-w"> </span>--rm<span class="tok-w"> </span>-it<span class="tok-w"> </span>--restart<span class="tok-o">=</span>Never<span class="tok-w"> </span>--<span class="tok-w"> </span>sh</code></pre>
</div>
</div>
</li>
<li>
<p>Dentro del segundo cliente:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Este cliente debería estar &quot;pegado&quot; a un Pod diferente</span>
<span class="tok-k">for</span><span class="tok-w"> </span>i<span class="tok-w"> </span><span class="tok-k">in</span><span class="tok-w"> </span><span class="tok-o">{</span><span class="tok-m">1</span>..3<span class="tok-o">}</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-k">do</span>
<span class="tok-w">  </span>wget<span class="tok-w"> </span>-q<span class="tok-w"> </span>-O-<span class="tok-w"> </span>http://app-affinity
<span class="tok-w">  </span><span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;&quot;</span>
<span class="tok-k">done</span>
<span class="tok-nb">exit</span></code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>deployment<span class="tok-w"> </span>app-affinity
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>service<span class="tok-w"> </span>app-affinity</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong>
El mismo cliente debería siempre ir al mismo Pod, pero clientes diferentes pueden ir a Pods diferentes.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong>
1. ¿Por qué usar Session Affinity?
2. ¿Cuáles son los problemas potenciales?
3. ¿Cuáles son mejores alternativas?</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_4_6_multi_port_services">7.6. Ejercicio 4.6: Multi-port Services</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Entender cómo un Service puede exponer múltiples puertos simultáneamente.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Crearás un Service que expone múltiples puertos para diferentes protocolos/servicios.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un Deployment que expone múltiples puertos (<code>multiport-deployment.yaml</code>):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">apps/v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Deployment</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">multiport-app</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">replicas</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">1</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">matchLabels</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">multiport</span>
<span class="tok-w">  </span><span class="tok-nt">template</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">multiport</span>
<span class="tok-w">    </span><span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">        </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx:1.21</span>
<span class="tok-w">        </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">containerPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span>
<span class="tok-w">          </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">http</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">containerPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">443</span>
<span class="tok-w">          </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">https</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">containerPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">8080</span>
<span class="tok-w">          </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">metrics</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Service con múltiples puertos (<code>multiport-service.yaml</code>):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Service</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">multiport</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">type</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">ClusterIP</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">multiport</span>
<span class="tok-w">  </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">http</span>
<span class="tok-w">    </span><span class="tok-nt">protocol</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">TCP</span>
<span class="tok-w">    </span><span class="tok-nt">port</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span>
<span class="tok-w">    </span><span class="tok-nt">targetPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">https</span>
<span class="tok-w">    </span><span class="tok-nt">protocol</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">TCP</span>
<span class="tok-w">    </span><span class="tok-nt">port</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">443</span>
<span class="tok-w">    </span><span class="tok-nt">targetPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">443</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">metrics</span>
<span class="tok-w">    </span><span class="tok-nt">protocol</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">TCP</span>
<span class="tok-w">    </span><span class="tok-nt">port</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">9090</span>
<span class="tok-w">    </span><span class="tok-nt">targetPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">8080</span></code></pre>
</div>
</div>
</li>
<li>
<p>Despliega:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>multiport-deployment.yaml
kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>multiport-service.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el Service:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>svc<span class="tok-w"> </span>multiport
<span class="tok-c1"># Debería mostrar: 80/TCP, 443/TCP, 9090/TCP</span></code></pre>
</div>
</div>
</li>
<li>
<p>Describe el Service:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>svc<span class="tok-w"> </span>multiport</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un cliente y accede a diferentes puertos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>run<span class="tok-w"> </span>client<span class="tok-w"> </span>--image<span class="tok-o">=</span>nicolaka/netshoot<span class="tok-w"> </span>--rm<span class="tok-w"> </span>-it<span class="tok-w"> </span>--restart<span class="tok-o">=</span>Never<span class="tok-w"> </span>--<span class="tok-w"> </span>bash</code></pre>
</div>
</div>
</li>
<li>
<p>Dentro del cliente, prueba conectar a diferentes puertos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Acceder al puerto http</span>
curl<span class="tok-w"> </span>-v<span class="tok-w"> </span>http://multiport:80

<span class="tok-c1"># Acceder al puerto https (sin verificación)</span>
curl<span class="tok-w"> </span>-v<span class="tok-w"> </span>-k<span class="tok-w"> </span>https://multiport:443

<span class="tok-c1"># Acceder al puerto metrics</span>
curl<span class="tok-w"> </span>-v<span class="tok-w"> </span>http://multiport:9090

<span class="tok-c1"># Resolver el Service</span>
nslookup<span class="tok-w"> </span>multiport

<span class="tok-c1"># Salir</span>
<span class="tok-nb">exit</span></code></pre>
</div>
</div>
</li>
<li>
<p>Accede por nombre de puerto:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Para Deployments que hacen referencia por nombre de puerto</span>
<span class="tok-c1"># (típicamente usado en Istio/service mesh)</span></code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>deployment<span class="tok-w"> </span>multiport-app
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>service<span class="tok-w"> </span>multiport</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong>
El Service debería estar escuchando en múltiples puertos simultáneamente.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong>
1. ¿Por qué nombrar los puertos?
2. ¿Cuándo usarías múltiples puertos en un Service?
3. ¿Cómo se relaciona con los nombres de puerto en Deployments?</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_4_7_dns_en_kubernetes">7.7. Ejercicio 4.7: DNS en Kubernetes</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Entender cómo funciona la resolución DNS de Services y Pods en Kubernetes.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Crearás Pods y Services y probarás la resolución DNS usando diferentes FQDNs.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un Deployment y un Service:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">apps/v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Deployment</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">dns-demo</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">replicas</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">1</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">matchLabels</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">dns-demo</span>
<span class="tok-w">  </span><span class="tok-nt">template</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">dns-demo</span>
<span class="tok-w">    </span><span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">        </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx:1.21</span>
<span class="tok-w">        </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">containerPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span>

<span class="tok-nn">---</span>
<span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Service</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">dns-service</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">type</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">ClusterIP</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">dns-demo</span>
<span class="tok-w">  </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">protocol</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">TCP</span>
<span class="tok-w">    </span><span class="tok-nt">port</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span>
<span class="tok-w">    </span><span class="tok-nt">targetPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span></code></pre>
</div>
</div>
</li>
<li>
<p>Despliega:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>dns-demo.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod cliente con herramientas de DNS:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>run<span class="tok-w"> </span>dns-client<span class="tok-w"> </span>--image<span class="tok-o">=</span>nicolaka/netshoot<span class="tok-w"> </span>--rm<span class="tok-w"> </span>-it<span class="tok-w"> </span>--restart<span class="tok-o">=</span>Never<span class="tok-w"> </span>--<span class="tok-w"> </span>bash</code></pre>
</div>
</div>
</li>
<li>
<p>Dentro del cliente, prueba diferentes tipos de resolución:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Ver configuración DNS del Pod</span>
cat<span class="tok-w"> </span>/etc/resolv.conf

<span class="tok-c1"># Resolver por nombre corto (mismo namespace)</span>
nslookup<span class="tok-w"> </span>dns-service

<span class="tok-c1"># Resolver por FQDN completo</span>
nslookup<span class="tok-w"> </span>dns-service.default.svc.cluster.local

<span class="tok-c1"># Resolver un Pod por nombre</span>
<span class="tok-nv">POD_NAME</span><span class="tok-o">=</span><span class="tok-k">$(</span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>dns-demo<span class="tok-w"> </span>-o<span class="tok-w"> </span><span class="tok-nv">jsonpath</span><span class="tok-o">=</span><span class="tok-s1">&#39;{.items[0].metadata.name}&#39;</span><span class="tok-k">)</span>
<span class="tok-nv">POD_IP</span><span class="tok-o">=</span><span class="tok-k">$(</span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>dns-demo<span class="tok-w"> </span>-o<span class="tok-w"> </span><span class="tok-nv">jsonpath</span><span class="tok-o">=</span><span class="tok-s1">&#39;{.items[0].status.podIP}&#39;</span><span class="tok-k">)</span>

<span class="tok-c1"># Nota: Los Pods también tienen DNS si el dominio es correcto</span>
nslookup<span class="tok-w"> </span><span class="tok-nv">$POD_NAME</span>.default.pod.cluster.local

<span class="tok-c1"># Acceder por nombre</span>
wget<span class="tok-w"> </span>http://dns-service

<span class="tok-c1"># Salir</span>
<span class="tok-nb">exit</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el CoreDNS del cluster:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-n<span class="tok-w"> </span>kube-system<span class="tok-w"> </span>-l<span class="tok-w"> </span>k8s-app<span class="tok-o">=</span>kube-dns
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>svc<span class="tok-w"> </span>-n<span class="tok-w"> </span>kube-system<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>dns</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod en un namespace diferente:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>create<span class="tok-w"> </span>namespace<span class="tok-w"> </span>test-ns
kubectl<span class="tok-w"> </span>run<span class="tok-w"> </span>test-app<span class="tok-w"> </span>--image<span class="tok-o">=</span>nginx:1.21<span class="tok-w"> </span>--labels<span class="tok-o">=</span><span class="tok-nv">app</span><span class="tok-o">=</span><span class="tok-nb">test</span><span class="tok-w"> </span>-n<span class="tok-w"> </span>test-ns
kubectl<span class="tok-w"> </span>expose<span class="tok-w"> </span>pod<span class="tok-w"> </span>test-app<span class="tok-w"> </span>--port<span class="tok-o">=</span><span class="tok-m">80</span><span class="tok-w"> </span>-n<span class="tok-w"> </span>test-ns</code></pre>
</div>
</div>
</li>
<li>
<p>Desde el cliente original, accede al Service en otro namespace:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>run<span class="tok-w"> </span>dns-client2<span class="tok-w"> </span>--image<span class="tok-o">=</span>nicolaka/netshoot<span class="tok-w"> </span>--rm<span class="tok-w"> </span>-it<span class="tok-w"> </span>--restart<span class="tok-o">=</span>Never<span class="tok-w"> </span>--<span class="tok-w"> </span>bash</code></pre>
</div>
</div>
</li>
<li>
<p>Dentro del cliente2:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Nombre corto no funciona desde otro namespace</span>
wget<span class="tok-w"> </span>http://test-app

<span class="tok-c1"># FQDN completo funciona</span>
wget<span class="tok-w"> </span>http://test-app.test-ns.svc.cluster.local

<span class="tok-c1"># O explícitamente:</span>
nslookup<span class="tok-w"> </span>test-app.test-ns

<span class="tok-nb">exit</span></code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>deployment<span class="tok-w"> </span>dns-demo
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>service<span class="tok-w"> </span>dns-service
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>namespace<span class="tok-w"> </span>test-ns</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong>
Deberías poder resolver Services por diferentes nombres (corto, FQDN).</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong>
1. ¿Cómo funciona la búsqueda DNS con search domains?
2. ¿Por qué necesitas FQDN para acceder a otro namespace?
3. ¿Cuál es el servicio DNS que proporciona Kubernetes?</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_4_8_ingress_básico">7.8. Ejercicio 4.8: Ingress básico</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Crear un Ingress básico para enrutar tráfico HTTP basado en hostname.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Crearás un Ingress que enruta tráfico de diferentes hostnames a diferentes Services.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea dos Deployments (<code>ingress-demo.yaml</code>):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nn">---</span>
<span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">apps/v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Deployment</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">web-app</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">replicas</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">1</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">matchLabels</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">web</span>
<span class="tok-w">  </span><span class="tok-nt">template</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">web</span>
<span class="tok-w">    </span><span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">        </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx:1.21</span>
<span class="tok-w">        </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">containerPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span>
<span class="tok-w">        </span><span class="tok-nt">lifecycle</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">postStart</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-nt">exec</span><span class="tok-p">:</span>
<span class="tok-w">              </span><span class="tok-nt">command</span><span class="tok-p">:</span>
<span class="tok-w">              </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">sh</span>
<span class="tok-w">              </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">-c</span>
<span class="tok-w">              </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">echo &quot;Web Application&quot; &gt; /usr/share/nginx/html/index.html</span>

<span class="tok-nn">---</span>
<span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">apps/v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Deployment</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">api-app</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">replicas</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">1</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">matchLabels</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">api</span>
<span class="tok-w">  </span><span class="tok-nt">template</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">api</span>
<span class="tok-w">    </span><span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">        </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx:1.21</span>
<span class="tok-w">        </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">containerPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span>
<span class="tok-w">        </span><span class="tok-nt">lifecycle</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">postStart</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-nt">exec</span><span class="tok-p">:</span>
<span class="tok-w">              </span><span class="tok-nt">command</span><span class="tok-p">:</span>
<span class="tok-w">              </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">sh</span>
<span class="tok-w">              </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">-c</span>
<span class="tok-w">              </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">echo &quot;API Application&quot; &gt; /usr/share/nginx/html/index.html</span>

<span class="tok-nn">---</span>
<span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Service</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">web-service</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">type</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">ClusterIP</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">web</span>
<span class="tok-w">  </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">protocol</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">TCP</span>
<span class="tok-w">    </span><span class="tok-nt">port</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span>
<span class="tok-w">    </span><span class="tok-nt">targetPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span>

<span class="tok-nn">---</span>
<span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Service</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">api-service</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">type</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">ClusterIP</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">api</span>
<span class="tok-w">  </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">protocol</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">TCP</span>
<span class="tok-w">    </span><span class="tok-nt">port</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span>
<span class="tok-w">    </span><span class="tok-nt">targetPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Ingress (<code>my-ingress.yaml</code>):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Ingress</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">my-ingress</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">rules</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">host</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">web.local</span>
<span class="tok-w">    </span><span class="tok-nt">http</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">paths</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">path</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/</span>
<span class="tok-w">        </span><span class="tok-nt">pathType</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Prefix</span>
<span class="tok-w">        </span><span class="tok-nt">backend</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">service</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">web-service</span>
<span class="tok-w">            </span><span class="tok-nt">port</span><span class="tok-p">:</span>
<span class="tok-w">              </span><span class="tok-nt">number</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">host</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">api.local</span>
<span class="tok-w">    </span><span class="tok-nt">http</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">paths</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">path</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/</span>
<span class="tok-w">        </span><span class="tok-nt">pathType</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Prefix</span>
<span class="tok-w">        </span><span class="tok-nt">backend</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">service</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">api-service</span>
<span class="tok-w">            </span><span class="tok-nt">port</span><span class="tok-p">:</span>
<span class="tok-w">              </span><span class="tok-nt">number</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span></code></pre>
</div>
</div>
</li>
<li>
<p>Despliega todo:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>ingress-demo.yaml
kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>my-ingress.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el Ingress:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>ingress
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>ingress<span class="tok-w"> </span>my-ingress</code></pre>
</div>
</div>
</li>
<li>
<p>Obtén la IP del Ingress Controller:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Si tienes NGINX Ingress Controller instalado:</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>svc<span class="tok-w"> </span>-n<span class="tok-w"> </span>ingress-nginx<span class="tok-w"> </span>ingress-nginx-controller

<span class="tok-c1"># O usa port-forward:</span>
kubectl<span class="tok-w"> </span>port-forward<span class="tok-w"> </span>svc/my-ingress<span class="tok-w"> </span><span class="tok-m">8080</span>:80<span class="tok-w"> </span><span class="tok-p">&amp;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Prueba acceso con curl:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Opción 1: Añade a /etc/hosts (si tienes IP real)</span>
<span class="tok-c1"># 127.0.0.1 web.local</span>
<span class="tok-c1"># 127.0.0.1 api.local</span>

<span class="tok-c1"># Opción 2: Usa curl con Host header</span>
curl<span class="tok-w"> </span>-H<span class="tok-w"> </span><span class="tok-s2">&quot;Host: web.local&quot;</span><span class="tok-w"> </span>http://localhost:8080
curl<span class="tok-w"> </span>-H<span class="tok-w"> </span><span class="tok-s2">&quot;Host: api.local&quot;</span><span class="tok-w"> </span>http://localhost:8080

<span class="tok-c1"># Opción 3: Usa port-forward a un Pod del Ingress Controller</span></code></pre>
</div>
</div>
</li>
<li>
<p>Detén port-forward:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>pkill<span class="tok-w"> </span>-f<span class="tok-w"> </span><span class="tok-s2">&quot;port-forward&quot;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>ingress<span class="tok-w"> </span>my-ingress
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>-f<span class="tok-w"> </span>ingress-demo.yaml</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong>
Diferentes hosts deberían enrutarse a diferentes Services.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong>
1. ¿Qué es un Ingress Controller?
2. ¿Cuál es la diferencia entre Service e Ingress?
3. ¿Cómo funciona el enrutamiento basado en hostname?</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_4_9_ingress_con_path_based_routing">7.9. Ejercicio 4.9: Ingress con path-based routing</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Crear un Ingress que enruta basado en paths de URLs.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Crearás un Ingress que enruta diferentes paths a diferentes Services.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea múltiples Deployments y Services (<code>path-routing.yaml</code>):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nn">---</span>
<span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">apps/v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Deployment</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">home-app</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">replicas</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">1</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">matchLabels</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">home</span>
<span class="tok-w">  </span><span class="tok-nt">template</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">home</span>
<span class="tok-w">    </span><span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">        </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx:1.21</span>
<span class="tok-w">        </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">containerPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span>
<span class="tok-w">        </span><span class="tok-nt">lifecycle</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">postStart</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-nt">exec</span><span class="tok-p">:</span>
<span class="tok-w">              </span><span class="tok-nt">command</span><span class="tok-p">:</span>
<span class="tok-w">              </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">sh</span>
<span class="tok-w">              </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">-c</span>
<span class="tok-w">              </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">echo &quot;Home Page&quot; &gt; /usr/share/nginx/html/index.html</span>

<span class="tok-nn">---</span>
<span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">apps/v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Deployment</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">api-v1-app</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">replicas</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">1</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">matchLabels</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">api-v1</span>
<span class="tok-w">  </span><span class="tok-nt">template</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">api-v1</span>
<span class="tok-w">    </span><span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">        </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx:1.21</span>
<span class="tok-w">        </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">containerPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span>
<span class="tok-w">        </span><span class="tok-nt">lifecycle</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">postStart</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-nt">exec</span><span class="tok-p">:</span>
<span class="tok-w">              </span><span class="tok-nt">command</span><span class="tok-p">:</span>
<span class="tok-w">              </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">sh</span>
<span class="tok-w">              </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">-c</span>
<span class="tok-w">              </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">echo &quot;API v1&quot; &gt; /usr/share/nginx/html/index.html</span>

<span class="tok-nn">---</span>
<span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">apps/v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Deployment</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">api-v2-app</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">replicas</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">1</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">matchLabels</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">api-v2</span>
<span class="tok-w">  </span><span class="tok-nt">template</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">api-v2</span>
<span class="tok-w">    </span><span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">        </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx:1.21</span>
<span class="tok-w">        </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">containerPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span>
<span class="tok-w">        </span><span class="tok-nt">lifecycle</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">postStart</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-nt">exec</span><span class="tok-p">:</span>
<span class="tok-w">              </span><span class="tok-nt">command</span><span class="tok-p">:</span>
<span class="tok-w">              </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">sh</span>
<span class="tok-w">              </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">-c</span>
<span class="tok-w">              </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">echo &quot;API v2&quot; &gt; /usr/share/nginx/html/index.html</span>

<span class="tok-nn">---</span>
<span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Service</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">home-service</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">home</span>
<span class="tok-w">  </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">protocol</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">TCP</span>
<span class="tok-w">    </span><span class="tok-nt">port</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span>
<span class="tok-w">    </span><span class="tok-nt">targetPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span>

<span class="tok-nn">---</span>
<span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Service</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">api-v1-service</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">api-v1</span>
<span class="tok-w">  </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">protocol</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">TCP</span>
<span class="tok-w">    </span><span class="tok-nt">port</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span>
<span class="tok-w">    </span><span class="tok-nt">targetPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span>

<span class="tok-nn">---</span>
<span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Service</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">api-v2-service</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">api-v2</span>
<span class="tok-w">  </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">protocol</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">TCP</span>
<span class="tok-w">    </span><span class="tok-nt">port</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span>
<span class="tok-w">    </span><span class="tok-nt">targetPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Ingress con path routing (<code>path-ingress.yaml</code>):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Ingress</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">path-ingress</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">rules</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">host</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">example.local</span>
<span class="tok-w">    </span><span class="tok-nt">http</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">paths</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">path</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/</span>
<span class="tok-w">        </span><span class="tok-nt">pathType</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Prefix</span>
<span class="tok-w">        </span><span class="tok-nt">backend</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">service</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">home-service</span>
<span class="tok-w">            </span><span class="tok-nt">port</span><span class="tok-p">:</span>
<span class="tok-w">              </span><span class="tok-nt">number</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">path</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/api/v1</span>
<span class="tok-w">        </span><span class="tok-nt">pathType</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Prefix</span>
<span class="tok-w">        </span><span class="tok-nt">backend</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">service</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">api-v1-service</span>
<span class="tok-w">            </span><span class="tok-nt">port</span><span class="tok-p">:</span>
<span class="tok-w">              </span><span class="tok-nt">number</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">path</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/api/v2</span>
<span class="tok-w">        </span><span class="tok-nt">pathType</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Prefix</span>
<span class="tok-w">        </span><span class="tok-nt">backend</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">service</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">api-v2-service</span>
<span class="tok-w">            </span><span class="tok-nt">port</span><span class="tok-p">:</span>
<span class="tok-w">              </span><span class="tok-nt">number</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span></code></pre>
</div>
</div>
</li>
<li>
<p>Despliega:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>path-routing.yaml
kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>path-ingress.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el Ingress:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>ingress<span class="tok-w"> </span>path-ingress
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>ingress<span class="tok-w"> </span>path-ingress</code></pre>
</div>
</div>
</li>
<li>
<p>Prueba path-based routing:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Inicia port-forward</span>
kubectl<span class="tok-w"> </span>port-forward<span class="tok-w"> </span>svc/home-service<span class="tok-w"> </span><span class="tok-m">8080</span>:80<span class="tok-w"> </span><span class="tok-p">&amp;</span>

<span class="tok-c1"># Prueba diferentes paths</span>
curl<span class="tok-w"> </span>-H<span class="tok-w"> </span><span class="tok-s2">&quot;Host: example.local&quot;</span><span class="tok-w"> </span>http://localhost:8080/
curl<span class="tok-w"> </span>-H<span class="tok-w"> </span><span class="tok-s2">&quot;Host: example.local&quot;</span><span class="tok-w"> </span>http://localhost:8080/api/v1
curl<span class="tok-w"> </span>-H<span class="tok-w"> </span><span class="tok-s2">&quot;Host: example.local&quot;</span><span class="tok-w"> </span>http://localhost:8080/api/v2

<span class="tok-c1"># Detén port-forward</span>
pkill<span class="tok-w"> </span>-f<span class="tok-w"> </span><span class="tok-s2">&quot;port-forward&quot;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Observa cómo diferentes paths van a diferentes Services:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>endpoints<span class="tok-w"> </span>home-service<span class="tok-w"> </span>api-v1-service<span class="tok-w"> </span>api-v2-service</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>ingress<span class="tok-w"> </span>path-ingress
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>-f<span class="tok-w"> </span>path-routing.yaml</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong>
Diferentes paths deberían enrutarse a diferentes Services.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong>
1. ¿Cómo funciona el path-based routing?
2. ¿Cuál es la diferencia entre <code>Prefix</code> y <code>Exact</code> pathType?
3. ¿Cuándo usarías path-based vs host-based routing?</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_4_10_externalname_service">7.10. Ejercicio 4.10: ExternalName Service</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Usar ExternalName Service para acceder a servicios externos desde dentro del cluster.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Crearás un ExternalName Service que actúa como alias a un servicio externo.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un ExternalName Service (<code>external-service.yaml</code>):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Service</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">external-db</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">type</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">ExternalName</span>
<span class="tok-w">  </span><span class="tok-nt">externalName</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">example.com</span>
<span class="tok-w">  </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">protocol</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">TCP</span>
<span class="tok-w">    </span><span class="tok-nt">port</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">443</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea otro ExternalName para un DNS externo:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Service</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">google-dns</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">type</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">ExternalName</span>
<span class="tok-w">  </span><span class="tok-nt">externalName</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">8.8.8.8</span>
<span class="tok-w">  </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">protocol</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">TCP</span>
<span class="tok-w">    </span><span class="tok-nt">port</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">53</span></code></pre>
</div>
</div>
</li>
<li>
<p>Despliega los Services:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>external-service.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica los Services:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>svc<span class="tok-w"> </span>external-db<span class="tok-w"> </span>google-dns
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>svc<span class="tok-w"> </span>external-db</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod cliente y prueba la resolución:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>run<span class="tok-w"> </span>client<span class="tok-w"> </span>--image<span class="tok-o">=</span>nicolaka/netshoot<span class="tok-w"> </span>--rm<span class="tok-w"> </span>-it<span class="tok-w"> </span>--restart<span class="tok-o">=</span>Never<span class="tok-w"> </span>--<span class="tok-w"> </span>bash</code></pre>
</div>
</div>
</li>
<li>
<p>Dentro del cliente:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Resuelve el ExternalName Service</span>
nslookup<span class="tok-w"> </span>external-db

<span class="tok-c1"># Debería resolver a example.com</span>

<span class="tok-c1"># Intenta acceder</span>
curl<span class="tok-w"> </span>-v<span class="tok-w"> </span>https://external-db

<span class="tok-c1"># Prueba el otro Service</span>
nslookup<span class="tok-w"> </span>google-dns

<span class="tok-c1"># Salir</span>
<span class="tok-nb">exit</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que no hay endpoints locales:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>endpoints<span class="tok-w"> </span>external-db
<span class="tok-c1"># Debería estar vacío</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea un caso de uso práctico - conectar a una base de datos externa:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Service</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">production-db</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">type</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">ExternalName</span>
<span class="tok-w">  </span><span class="tok-nt">externalName</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">db.production.example.com</span>
<span class="tok-w">  </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">postgres</span>
<span class="tok-w">    </span><span class="tok-nt">protocol</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">TCP</span>
<span class="tok-w">    </span><span class="tok-nt">port</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">5432</span>
<span class="tok-w">    </span><span class="tok-nt">targetPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">5432</span></code></pre>
</div>
</div>
</li>
<li>
<p>Un Deployment podría usar este Service:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">apps/v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Deployment</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">replicas</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">1</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">matchLabels</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">  </span><span class="tok-nt">template</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">    </span><span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">        </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">myapp:latest</span>
<span class="tok-w">        </span><span class="tok-nt">env</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">DATABASE_HOST</span>
<span class="tok-w">          </span><span class="tok-nt">value</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">production-db.default.svc.cluster.local</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">DATABASE_PORT</span>
<span class="tok-w">          </span><span class="tok-nt">value</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;5432&quot;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>service<span class="tok-w"> </span>external-db<span class="tok-w"> </span>google-dns<span class="tok-w"> </span>production-db</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong>
El ExternalName Service debería actuar como CNAME a un servicio externo.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong>
1. ¿Cuándo usarías ExternalName?
2. ¿Cómo se diferencia de otros tipos de Services?
3. ¿Qué ventajas proporciona al usar ExternalName?</p>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resumen_de_conceptos_4">8. Resumen de Conceptos</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Estos ejercicios del Módulo 4 cubren:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Ejercicio 4.1</strong>: Comunicación Pod-to-Pod directa</p>
</li>
<li>
<p><strong>Ejercicio 4.2</strong>: Service ClusterIP básico</p>
</li>
<li>
<p><strong>Ejercicio 4.3</strong>: Service NodePort</p>
</li>
<li>
<p><strong>Ejercicio 4.4</strong>: Load balancing y distribución</p>
</li>
<li>
<p><strong>Ejercicio 4.5</strong>: Session Affinity</p>
</li>
<li>
<p><strong>Ejercicio 4.6</strong>: Multi-port Services</p>
</li>
<li>
<p><strong>Ejercicio 4.7</strong>: DNS en Kubernetes</p>
</li>
<li>
<p><strong>Ejercicio 4.8</strong>: Ingress básico</p>
</li>
<li>
<p><strong>Ejercicio 4.9</strong>: Ingress path-based routing</p>
</li>
<li>
<p><strong>Ejercicio 4.10</strong>: ExternalName Service</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_próximos_pasos">9. Próximos Pasos</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Una vez completes estos ejercicios, estarás listo para:
* Módulo 5: Almacenamiento persistente (PersistentVolumes, PersistentVolumeClaims)
* Módulo 6: RBAC y seguridad
* Módulo 7: Networking avanzado
* Y módulos posteriores&#8230;&#8203;</p>
</div>
<hr>
</div>
</div>
<div class="sect1">
<h2 id="_módulo_5_almacenamiento">10. Módulo 5: Almacenamiento</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_ejercicio_5_1_pod_multi_contenedor_con_emptydir">10.1. Ejercicio 5.1: Pod Multi-Contenedor con emptyDir</h3>
<div class="paragraph">
<p><strong>Objetivo:</strong> Compartir datos entre contenedores usando volúmenes emptyDir.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong></p>
</div>
<div class="paragraph">
<p>Crea un Pod con dos contenedores que comparten un volumen emptyDir. Un contenedor escribe datos periódicamente, y el otro los lee.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un archivo <code>multi-container-pod.yaml</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Pod</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">data-sharer</span>
<span class="tok-w">  </span><span class="tok-nt">namespace</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">default</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-c1"># Contenedor que escribe datos</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">writer</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">busybox</span>
<span class="tok-w">    </span><span class="tok-nt">command</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">[</span><span class="tok-s">&quot;sh&quot;</span><span class="tok-p tok-p-Indicator">,</span><span class="tok-w"> </span><span class="tok-s">&quot;-c&quot;</span><span class="tok-p tok-p-Indicator">]</span>
<span class="tok-w">    </span><span class="tok-nt">args</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">|</span>
<span class="tok-w">      </span><span class="tok-no">counter=0</span>
<span class="tok-w">      </span><span class="tok-no">while true; do</span>
<span class="tok-w">        </span><span class="tok-no">counter=$((counter+1))</span>
<span class="tok-w">        </span><span class="tok-no">echo &quot;[$(date &#39;+%H:%M:%S&#39;)] Generated data $counter&quot; &gt;&gt; /shared/data.txt</span>
<span class="tok-w">        </span><span class="tok-no">sleep 3</span>
<span class="tok-w">      </span><span class="tok-no">done</span>
<span class="tok-w">    </span><span class="tok-nt">volumeMounts</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">shared</span>
<span class="tok-w">      </span><span class="tok-nt">mountPath</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/shared</span>
<span class="tok-w">  </span><span class="tok-c1"># Contenedor que lee datos</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">reader</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">busybox</span>
<span class="tok-w">    </span><span class="tok-nt">command</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">[</span><span class="tok-s">&quot;sh&quot;</span><span class="tok-p tok-p-Indicator">,</span><span class="tok-w"> </span><span class="tok-s">&quot;-c&quot;</span><span class="tok-p tok-p-Indicator">]</span>
<span class="tok-w">    </span><span class="tok-nt">args</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">|</span>
<span class="tok-w">      </span><span class="tok-no">sleep 2</span>
<span class="tok-w">      </span><span class="tok-no">while true; do</span>
<span class="tok-w">        </span><span class="tok-no">echo &quot;=== Data Available ===&quot;</span>
<span class="tok-w">        </span><span class="tok-no">cat /shared/data.txt</span>
<span class="tok-w">        </span><span class="tok-no">echo &quot;&quot;</span>
<span class="tok-w">        </span><span class="tok-no">sleep 5</span>
<span class="tok-w">      </span><span class="tok-no">done</span>
<span class="tok-w">    </span><span class="tok-nt">volumeMounts</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">shared</span>
<span class="tok-w">      </span><span class="tok-nt">mountPath</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/shared</span>
<span class="tok-w">      </span><span class="tok-nt">readOnly</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span>
<span class="tok-w">  </span><span class="tok-c1"># Definición del volumen compartido</span>
<span class="tok-w">  </span><span class="tok-nt">volumes</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">shared</span>
<span class="tok-w">    </span><span class="tok-nt">emptyDir</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">sizeLimit</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">10Mi</span></code></pre>
</div>
</div>
</li>
<li>
<p>Aplica el Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>multi-container-pod.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que el Pod está corriendo:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-w</code></pre>
</div>
</div>
</li>
<li>
<p>Observa los logs del contenedor writer:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>data-sharer<span class="tok-w"> </span>-c<span class="tok-w"> </span>writer<span class="tok-w"> </span>--tail<span class="tok-o">=</span><span class="tok-m">10</span><span class="tok-w"> </span>-f</code></pre>
</div>
</div>
</li>
<li>
<p>Observa los logs del contenedor reader:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>data-sharer<span class="tok-w"> </span>-c<span class="tok-w"> </span>reader<span class="tok-w"> </span>--tail<span class="tok-o">=</span><span class="tok-m">10</span><span class="tok-w"> </span>-f</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el volumen dentro del Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>data-sharer<span class="tok-w"> </span>-c<span class="tok-w"> </span>reader<span class="tok-w"> </span>--<span class="tok-w"> </span>ls<span class="tok-w"> </span>-lh<span class="tok-w"> </span>/shared</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>data-sharer</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong></p>
</div>
<div class="paragraph">
<p>El contenedor reader debería mostrar datos actualizados del writer mediante el volumen compartido.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Qué ocurre con los datos del volumen cuando se elimina el Pod?</p>
</li>
<li>
<p>¿Cuál es el propósito del readOnly: true en el contenedor reader?</p>
</li>
<li>
<p>¿Cómo cambiaría el ejercicio si necesitaras persistencia después de eliminar el Pod?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_5_2_acceso_a_sistema_host_con_hostpath">10.2. Ejercicio 5.2: Acceso a Sistema Host con hostPath</h3>
<div class="paragraph">
<p><strong>Objetivo:</strong> Usar volúmenes hostPath para acceder a datos del nodo.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong></p>
</div>
<div class="paragraph">
<p>Crea un Pod que acceda a información del sistema del nodo host mediante volúmenes hostPath.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un archivo <code>hostpath-pod.yaml</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Pod</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">system-monitor</span>
<span class="tok-w">  </span><span class="tok-nt">namespace</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">default</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">monitor</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">busybox</span>
<span class="tok-w">    </span><span class="tok-nt">command</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">[</span><span class="tok-s">&quot;sh&quot;</span><span class="tok-p tok-p-Indicator">,</span><span class="tok-w"> </span><span class="tok-s">&quot;-c&quot;</span><span class="tok-p tok-p-Indicator">]</span>
<span class="tok-w">    </span><span class="tok-nt">args</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">|</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;=== Host Information ===&quot;</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;Hostname: $(cat /host-etc/hostname)&quot;</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;&quot;</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;=== CPU Info (first 10 lines) ===&quot;</span>
<span class="tok-w">      </span><span class="tok-no">head -10 /host-proc/cpuinfo</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;&quot;</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;=== Memory Info ===&quot;</span>
<span class="tok-w">      </span><span class="tok-no">grep -E &quot;MemTotal|MemAvailable&quot; /host-proc/meminfo</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;&quot;</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;Monitoring every 10 seconds...&quot;</span>
<span class="tok-w">      </span><span class="tok-no">while true; do</span>
<span class="tok-w">        </span><span class="tok-no">echo &quot;[$(date &#39;+%H:%M:%S&#39;)] System uptime:&quot;</span>
<span class="tok-w">        </span><span class="tok-no">uptime</span>
<span class="tok-w">        </span><span class="tok-no">sleep 10</span>
<span class="tok-w">      </span><span class="tok-no">done</span>
<span class="tok-w">    </span><span class="tok-nt">volumeMounts</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">host-proc</span>
<span class="tok-w">      </span><span class="tok-nt">mountPath</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/host-proc</span>
<span class="tok-w">      </span><span class="tok-nt">readOnly</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">host-etc</span>
<span class="tok-w">      </span><span class="tok-nt">mountPath</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/host-etc</span>
<span class="tok-w">      </span><span class="tok-nt">readOnly</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">host-sys</span>
<span class="tok-w">      </span><span class="tok-nt">mountPath</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/host-sys</span>
<span class="tok-w">      </span><span class="tok-nt">readOnly</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span>
<span class="tok-w">  </span><span class="tok-nt">volumes</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">host-proc</span>
<span class="tok-w">    </span><span class="tok-nt">hostPath</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">path</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/proc</span>
<span class="tok-w">      </span><span class="tok-nt">type</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Directory</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">host-etc</span>
<span class="tok-w">    </span><span class="tok-nt">hostPath</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">path</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/etc</span>
<span class="tok-w">      </span><span class="tok-nt">type</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Directory</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">host-sys</span>
<span class="tok-w">    </span><span class="tok-nt">hostPath</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">path</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/sys</span>
<span class="tok-w">      </span><span class="tok-nt">type</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Directory</span></code></pre>
</div>
</div>
</li>
<li>
<p>Aplica el Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>hostpath-pod.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que el Pod está corriendo:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pod<span class="tok-w"> </span>system-monitor</code></pre>
</div>
</div>
</li>
<li>
<p>Observa los logs del Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>system-monitor<span class="tok-w"> </span>-f</code></pre>
</div>
</div>
</li>
<li>
<p>Accede al contenedor interactivamente:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>system-monitor<span class="tok-w"> </span>--<span class="tok-w"> </span>sh
<span class="tok-c1"># Dentro del contenedor:</span>
<span class="tok-c1"># ls -la /host-proc/</span>
<span class="tok-c1"># cat /host-etc/hostname</span>
<span class="tok-c1"># exit</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica en qué nodo está ejecutándose el Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pod<span class="tok-w"> </span>system-monitor<span class="tok-w"> </span>-o<span class="tok-w"> </span>wide</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>system-monitor</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong></p>
</div>
<div class="paragraph">
<p>El Pod debe mostrar información real del nodo host (CPU, memoria, hostname).</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Por qué es importante usar readOnly: true con hostPath?</p>
</li>
<li>
<p>¿Qué riesgos de seguridad presenta hostPath?</p>
</li>
<li>
<p>¿Cuándo usarías hostPath en lugar de otros tipos de volúmenes?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_5_3_configmap_como_volumen">10.3. Ejercicio 5.3: ConfigMap como Volumen</h3>
<div class="paragraph">
<p><strong>Objetivo:</strong> Inyectar archivos de configuración usando ConfigMaps como volúmenes.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong></p>
</div>
<div class="paragraph">
<p>Crea una aplicación que lee su configuración desde archivos inyectados por un ConfigMap montado como volumen.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un ConfigMap con archivos de configuración:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>create<span class="tok-w"> </span>configmap<span class="tok-w"> </span>app-config<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--from-literal<span class="tok-o">=</span>app.properties<span class="tok-o">=</span><span class="tok-s2">&quot;APP_NAME=MyApp</span>
<span class="tok-s2">APP_VERSION=1.0</span>
<span class="tok-s2">LOG_LEVEL=INFO</span>
<span class="tok-s2">DATABASE_POOL_SIZE=20&quot;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--from-literal<span class="tok-o">=</span>nginx.conf<span class="tok-o">=</span><span class="tok-s2">&quot;server {</span>
<span class="tok-s2">    listen 8080;</span>
<span class="tok-s2">    location / {</span>
<span class="tok-s2">      return 200 &#39;App is running&#39;;</span>
<span class="tok-s2">    }</span>
<span class="tok-s2">  }&quot;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que el ConfigMap fue creado:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>configmap<span class="tok-w"> </span>app-config<span class="tok-w"> </span>-o<span class="tok-w"> </span>yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un archivo <code>app-with-config.yaml</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Pod</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app-with-config</span>
<span class="tok-w">  </span><span class="tok-nt">namespace</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">default</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">busybox</span>
<span class="tok-w">    </span><span class="tok-nt">command</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">[</span><span class="tok-s">&quot;sh&quot;</span><span class="tok-p tok-p-Indicator">,</span><span class="tok-w"> </span><span class="tok-s">&quot;-c&quot;</span><span class="tok-p tok-p-Indicator">]</span>
<span class="tok-w">    </span><span class="tok-nt">args</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">|</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;=== Application Configuration ===&quot;</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;&quot;</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;--- app.properties ---&quot;</span>
<span class="tok-w">      </span><span class="tok-no">cat /etc/config/app.properties</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;&quot;</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;--- nginx.conf ---&quot;</span>
<span class="tok-w">      </span><span class="tok-no">cat /etc/config/nginx.conf</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;&quot;</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;Configuration loaded successfully!&quot;</span>
<span class="tok-w">      </span><span class="tok-no">sleep infinity</span>
<span class="tok-w">    </span><span class="tok-nt">volumeMounts</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">config</span>
<span class="tok-w">      </span><span class="tok-nt">mountPath</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/etc/config</span>
<span class="tok-w">      </span><span class="tok-nt">readOnly</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span>
<span class="tok-w">  </span><span class="tok-nt">volumes</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">config</span>
<span class="tok-w">    </span><span class="tok-nt">configMap</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app-config</span>
<span class="tok-w">      </span><span class="tok-nt">defaultMode</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">0444</span><span class="tok-w">  </span><span class="tok-c1"># Permisos de solo lectura</span></code></pre>
</div>
</div>
</li>
<li>
<p>Aplica el Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>app-with-config.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica los logs:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>app-with-config</code></pre>
</div>
</div>
</li>
<li>
<p>Accede al contenedor y verifica los archivos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>app-with-config<span class="tok-w"> </span>--<span class="tok-w"> </span>ls<span class="tok-w"> </span>-la<span class="tok-w"> </span>/etc/config/
kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>app-with-config<span class="tok-w"> </span>--<span class="tok-w"> </span>cat<span class="tok-w"> </span>/etc/config/app.properties</code></pre>
</div>
</div>
</li>
<li>
<p>Modifica el ConfigMap:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>patch<span class="tok-w"> </span>configmap<span class="tok-w"> </span>app-config<span class="tok-w"> </span>-p<span class="tok-w"> </span><span class="tok-s1">&#39;{&quot;data&quot;:{&quot;app.properties&quot;:&quot;APP_NAME=MyApp\nAPP_VERSION=1.1\nLOG_LEVEL=DEBUG&quot;}}&#39;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que el archivo se actualizó en el Pod (puede tomar algunos segundos):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>app-with-config<span class="tok-w"> </span>--<span class="tok-w"> </span>cat<span class="tok-w"> </span>/etc/config/app.properties</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>app-with-config
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>configmap<span class="tok-w"> </span>app-config</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong></p>
</div>
<div class="paragraph">
<p>El Pod debe mostrar la configuración del ConfigMap montada como archivos en <code>/etc/config/</code>.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Cuál es la ventaja de usar ConfigMap como volumen vs. variables de entorno?</p>
</li>
<li>
<p>¿Cuánto tiempo tarda Kubernetes en actualizar un archivo montado desde ConfigMap?</p>
</li>
<li>
<p>¿Por qué es importante el parámetro defaultMode?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_5_4_secret_como_volumen">10.4. Ejercicio 5.4: Secret como Volumen</h3>
<div class="paragraph">
<p><strong>Objetivo:</strong> Montar secretos como volúmenes para acceso seguro a credenciales.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong></p>
</div>
<div class="paragraph">
<p>Crea una aplicación que lee credenciales de base de datos desde un Secret montado como volumen.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un Secret con credenciales:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>create<span class="tok-w"> </span>secret<span class="tok-w"> </span>generic<span class="tok-w"> </span>db-credentials<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--from-literal<span class="tok-o">=</span><span class="tok-nv">username</span><span class="tok-o">=</span>admin<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--from-literal<span class="tok-o">=</span><span class="tok-nv">password</span><span class="tok-o">=</span>P@ssw0rd123!<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--from-literal<span class="tok-o">=</span><span class="tok-nv">host</span><span class="tok-o">=</span>postgres.default.svc.cluster.local<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--from-literal<span class="tok-o">=</span><span class="tok-nv">port</span><span class="tok-o">=</span><span class="tok-m">5432</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el Secret (sin ver valores):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>secret<span class="tok-w"> </span>db-credentials</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un archivo <code>app-with-secrets.yaml</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Pod</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">db-app</span>
<span class="tok-w">  </span><span class="tok-nt">namespace</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">default</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">busybox</span>
<span class="tok-w">    </span><span class="tok-nt">command</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">[</span><span class="tok-s">&quot;sh&quot;</span><span class="tok-p tok-p-Indicator">,</span><span class="tok-w"> </span><span class="tok-s">&quot;-c&quot;</span><span class="tok-p tok-p-Indicator">]</span>
<span class="tok-w">    </span><span class="tok-nt">args</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">|</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;=== Database Credentials ===&quot;</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;Username: $(cat /etc/db-secrets/username)&quot;</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;Host: $(cat /etc/db-secrets/host)&quot;</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;Port: $(cat /etc/db-secrets/port)&quot;</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;&quot;</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;=== Testing Database Connection ===&quot;</span>
<span class="tok-w">      </span><span class="tok-no">DB_USER=$(cat /etc/db-secrets/username)</span>
<span class="tok-w">      </span><span class="tok-no">DB_PASS=$(cat /etc/db-secrets/password)</span>
<span class="tok-w">      </span><span class="tok-no">DB_HOST=$(cat /etc/db-secrets/host)</span>
<span class="tok-w">      </span><span class="tok-no">DB_PORT=$(cat /etc/db-secrets/port)</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;Would connect to: $DB_HOST:$DB_PORT as $DB_USER&quot;</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;&quot;</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;File permissions (secure):&quot;</span>
<span class="tok-w">      </span><span class="tok-no">ls -la /etc/db-secrets/</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;&quot;</span>
<span class="tok-w">      </span><span class="tok-no">sleep infinity</span>
<span class="tok-w">    </span><span class="tok-nt">volumeMounts</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">db-secret</span>
<span class="tok-w">      </span><span class="tok-nt">mountPath</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/etc/db-secrets</span>
<span class="tok-w">      </span><span class="tok-nt">readOnly</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span>
<span class="tok-w">  </span><span class="tok-nt">volumes</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">db-secret</span>
<span class="tok-w">    </span><span class="tok-nt">secret</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">secretName</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">db-credentials</span>
<span class="tok-w">      </span><span class="tok-nt">defaultMode</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">0400</span><span class="tok-w">  </span><span class="tok-c1"># Solo lectura, solo para owner</span></code></pre>
</div>
</div>
</li>
<li>
<p>Aplica el Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>app-with-secrets.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica los logs:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>db-app</code></pre>
</div>
</div>
</li>
<li>
<p>Accede al contenedor y verifica las credenciales:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>db-app<span class="tok-w"> </span>--<span class="tok-w"> </span>cat<span class="tok-w"> </span>/etc/db-secrets/username
kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>db-app<span class="tok-w"> </span>--<span class="tok-w"> </span>cat<span class="tok-w"> </span>/etc/db-secrets/password</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que el archivo tiene permisos restrictivos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>db-app<span class="tok-w"> </span>--<span class="tok-w"> </span>ls<span class="tok-w"> </span>-la<span class="tok-w"> </span>/etc/db-secrets/</code></pre>
</div>
</div>
</li>
<li>
<p>Intenta sobrescribir el archivo (debe fallar):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>db-app<span class="tok-w"> </span>--<span class="tok-w"> </span>sh<span class="tok-w"> </span>-c<span class="tok-w"> </span><span class="tok-s1">&#39;echo newpass &gt; /etc/db-secrets/password&#39;</span>
<span class="tok-c1"># Debería fallar: Read-only file system</span></code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>db-app
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>secret<span class="tok-w"> </span>db-credentials</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong></p>
</div>
<div class="paragraph">
<p>El Pod debe mostrar las credenciales del Secret y los archivos deben ser de solo lectura.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Por qué se debe usar readOnly: true con Secrets?</p>
</li>
<li>
<p>¿Cuál es la diferencia de seguridad entre inyectar credenciales via Secret vs. ConfigMap?</p>
</li>
<li>
<p>¿Cómo se sincroniza el Secret cuando se modifica?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_5_5_creando_persistentvolume_y_persistentvolumeclaim">10.5. Ejercicio 5.5: Creando PersistentVolume y PersistentVolumeClaim</h3>
<div class="paragraph">
<p><strong>Objetivo:</strong> Crear y usar PersistentVolumes con PersistentVolumeClaims.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong></p>
</div>
<div class="paragraph">
<p>Crea un PersistentVolume usando almacenamiento local, luego solicita una porción con PersistentVolumeClaim y úsalo en un Pod.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un directorio en el nodo para simular almacenamiento:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Crear directorio (como si fuera administrador del cluster)</span>
sudo<span class="tok-w"> </span>mkdir<span class="tok-w"> </span>-p<span class="tok-w"> </span>/mnt/data/pv1
sudo<span class="tok-w"> </span>chmod<span class="tok-w"> </span><span class="tok-m">777</span><span class="tok-w"> </span>/mnt/data/pv1
<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;Kubernetes Storage Data&quot;</span><span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>sudo<span class="tok-w"> </span>tee<span class="tok-w"> </span>/mnt/data/pv1/README.txt</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un archivo <code>pv-pvc.yaml</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">PersistentVolume</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">local-pv-1</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">capacity</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">storage</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">5Gi</span>
<span class="tok-w">  </span><span class="tok-nt">accessModes</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">ReadWriteOnce</span>
<span class="tok-w">  </span><span class="tok-nt">persistentVolumeReclaimPolicy</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Retain</span>
<span class="tok-w">  </span><span class="tok-nt">hostPath</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">path</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/mnt/data/pv1</span>
<span class="tok-w">    </span><span class="tok-nt">type</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">DirectoryOrCreate</span>
<span class="tok-nn">---</span>
<span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">PersistentVolumeClaim</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">my-pvc</span>
<span class="tok-w">  </span><span class="tok-nt">namespace</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">default</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">accessModes</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">ReadWriteOnce</span>
<span class="tok-w">  </span><span class="tok-nt">storageClassName</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;&quot;</span><span class="tok-w">  </span><span class="tok-c1"># No StorageClass, usar PV manual</span>
<span class="tok-w">  </span><span class="tok-nt">resources</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">requests</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">storage</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">2Gi</span></code></pre>
</div>
</div>
</li>
<li>
<p>Aplica los recursos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>pv-pvc.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el PersistentVolume:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pv
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>pv<span class="tok-w"> </span>local-pv-1</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el PersistentVolumeClaim:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pvc
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>pvc<span class="tok-w"> </span>my-pvc
<span class="tok-c1"># Debería estar &quot;Bound&quot; a local-pv-1</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod que use la PVC:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Pod</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">storage-consumer</span>
<span class="tok-w">  </span><span class="tok-nt">namespace</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">default</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">busybox</span>
<span class="tok-w">    </span><span class="tok-nt">command</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">[</span><span class="tok-s">&quot;sh&quot;</span><span class="tok-p tok-p-Indicator">,</span><span class="tok-w"> </span><span class="tok-s">&quot;-c&quot;</span><span class="tok-p tok-p-Indicator">]</span>
<span class="tok-w">    </span><span class="tok-nt">args</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">|</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;=== Persistent Volume Information ===&quot;</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;Mounted at: /data&quot;</span>
<span class="tok-w">      </span><span class="tok-no">ls -la /data</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;&quot;</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;=== Writing persistent data ===&quot;</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;This data persists across Pod restarts!&quot; &gt; /data/persistent-file.txt</span>
<span class="tok-w">      </span><span class="tok-no">cat /data/persistent-file.txt</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;&quot;</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;Pod ID: $HOSTNAME&quot; &gt;&gt; /data/pod-ids.log</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;Time: $(date)&quot; &gt;&gt; /data/pod-ids.log</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;&quot;</span>
<span class="tok-w">      </span><span class="tok-no">echo &quot;Pod is running...&quot;</span>
<span class="tok-w">      </span><span class="tok-no">sleep infinity</span>
<span class="tok-w">    </span><span class="tok-nt">volumeMounts</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">storage</span>
<span class="tok-w">      </span><span class="tok-nt">mountPath</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/data</span>
<span class="tok-w">  </span><span class="tok-nt">volumes</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">storage</span>
<span class="tok-w">    </span><span class="tok-nt">persistentVolumeClaim</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">claimName</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">my-pvc</span></code></pre>
</div>
</div>
</li>
<li>
<p>Aplica el Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;EOF</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: storage-consumer</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      echo &quot;First write...&quot;</span>
<span class="tok-s">      echo &quot;Data from $(date)&quot; &gt; /data/persistent-file.txt</span>
<span class="tok-s">      cat /data/persistent-file.txt</span>
<span class="tok-s">      sleep infinity</span>
<span class="tok-s">    volumeMounts:</span>
<span class="tok-s">    - name: storage</span>
<span class="tok-s">      mountPath: /data</span>
<span class="tok-s">  volumes:</span>
<span class="tok-s">  - name: storage</span>
<span class="tok-s">    persistentVolumeClaim:</span>
<span class="tok-s">      claimName: my-pvc</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica los datos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>storage-consumer<span class="tok-w"> </span>--<span class="tok-w"> </span>cat<span class="tok-w"> </span>/data/persistent-file.txt</code></pre>
</div>
</div>
</li>
<li>
<p>Elimina el Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>storage-consumer</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un nuevo Pod que use la misma PVC:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;EOF</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: storage-consumer-2</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      echo &quot;=== Data from previous Pod ===&quot;</span>
<span class="tok-s">      cat /data/persistent-file.txt</span>
<span class="tok-s">      echo &quot;&quot;</span>
<span class="tok-s">      echo &quot;Pod running as: $HOSTNAME&quot;</span>
<span class="tok-s">      sleep infinity</span>
<span class="tok-s">    volumeMounts:</span>
<span class="tok-s">    - name: storage</span>
<span class="tok-s">      mountPath: /data</span>
<span class="tok-s">  volumes:</span>
<span class="tok-s">  - name: storage</span>
<span class="tok-s">    persistentVolumeClaim:</span>
<span class="tok-s">      claimName: my-pvc</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que los datos persisten:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>storage-consumer-2<span class="tok-w"> </span>--<span class="tok-w"> </span>cat<span class="tok-w"> </span>/data/persistent-file.txt</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>storage-consumer-2
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pvc<span class="tok-w"> </span>my-pvc
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pv<span class="tok-w"> </span>local-pv-1</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong></p>
</div>
<div class="paragraph">
<p>Los datos en el PersistentVolume deben persister después de eliminar el Pod original.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Cuál es la diferencia entre PV y volumen normal?</p>
</li>
<li>
<p>¿Qué ocurre con el PV cuando se elimina la PVC?</p>
</li>
<li>
<p>¿Por qué se usa persistentVolumeReclaimPolicy: Retain?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_5_6_storageclass_y_dynamic_provisioning">10.6. Ejercicio 5.6: StorageClass y Dynamic Provisioning</h3>
<div class="paragraph">
<p><strong>Objetivo:</strong> Crear un StorageClass para aprovisionamiento dinámico de almacenamiento.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong></p>
</div>
<div class="paragraph">
<p>Crea un StorageClass que provisione automáticamente PersistentVolumes cuando se crea una PVC.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un archivo <code>storageclass.yaml</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">storage.k8s.io/v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">StorageClass</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">local-storage</span>
<span class="tok-nt">provisioner</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">kubernetes.io/no-provisioner</span><span class="tok-w">  </span><span class="tok-c1"># Para almacenamiento local</span>
<span class="tok-nt">allowVolumeExpansion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span>
<span class="tok-nt">volumeBindingMode</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">WaitForFirstConsumer</span></code></pre>
</div>
</div>
</li>
<li>
<p>Aplica el StorageClass:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>storageclass.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el StorageClass:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>storageclass</code></pre>
</div>
</div>
</li>
<li>
<p>Crea una PVC que use el StorageClass:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;EOF</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: PersistentVolumeClaim</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: dynamic-pvc</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  accessModes:</span>
<span class="tok-s">  - ReadWriteOnce</span>
<span class="tok-s">  storageClassName: local-storage</span>
<span class="tok-s">  resources:</span>
<span class="tok-s">    requests:</span>
<span class="tok-s">      storage: 3Gi</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el estado de la PVC:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pvc<span class="tok-w"> </span>dynamic-pvc
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>pvc<span class="tok-w"> </span>dynamic-pvc
<span class="tok-c1"># Puede estar en Pending si no hay PV disponible</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea un PV que matchee con la PVC:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>sudo<span class="tok-w"> </span>mkdir<span class="tok-w"> </span>-p<span class="tok-w"> </span>/mnt/data/pv2
sudo<span class="tok-w"> </span>chmod<span class="tok-w"> </span><span class="tok-m">777</span><span class="tok-w"> </span>/mnt/data/pv2

kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;EOF</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: PersistentVolume</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: local-pv-2</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  capacity:</span>
<span class="tok-s">    storage: 5Gi</span>
<span class="tok-s">  accessModes:</span>
<span class="tok-s">  - ReadWriteOnce</span>
<span class="tok-s">  persistentVolumeReclaimPolicy: Delete</span>
<span class="tok-s">  storageClassName: local-storage</span>
<span class="tok-s">  hostPath:</span>
<span class="tok-s">    path: /mnt/data/pv2</span>
<span class="tok-s">    type: DirectoryOrCreate</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que la PVC se vinculó:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pvc<span class="tok-w"> </span>dynamic-pvc
<span class="tok-c1"># Debería estar &quot;Bound&quot;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod que use la PVC:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;EOF</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: dynamic-storage-pod</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      echo &quot;Storage class: local-storage&quot;</span>
<span class="tok-s">      echo &quot;Mounted PVC: dynamic-pvc&quot;</span>
<span class="tok-s">      echo &quot;Writing dynamic data...&quot;</span>
<span class="tok-s">      echo &quot;Dynamic provisioning works!&quot; &gt; /storage/data.txt</span>
<span class="tok-s">      cat /storage/data.txt</span>
<span class="tok-s">      sleep infinity</span>
<span class="tok-s">    volumeMounts:</span>
<span class="tok-s">    - name: storage</span>
<span class="tok-s">      mountPath: /storage</span>
<span class="tok-s">  volumes:</span>
<span class="tok-s">  - name: storage</span>
<span class="tok-s">    persistentVolumeClaim:</span>
<span class="tok-s">      claimName: dynamic-pvc</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods
kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>dynamic-storage-pod</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>dynamic-storage-pod
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pvc<span class="tok-w"> </span>dynamic-pvc
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pv<span class="tok-w"> </span>local-pv-2
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>storageclass<span class="tok-w"> </span>local-storage</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong></p>
</div>
<div class="paragraph">
<p>El Pod debe montarse exitosamente usando la PVC creada con el StorageClass.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Cuál es la ventaja de usar StorageClass vs. crear PVs manualmente?</p>
</li>
<li>
<p>¿Qué es volumeBindingMode: WaitForFirstConsumer?</p>
</li>
<li>
<p>¿Cuándo usarías provisioner: kubernetes.io/no-provisioner vs. un provisioner cloud?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_5_7_pvc_con_múltiples_contenedores">10.7. Ejercicio 5.7: PVC con Múltiples Contenedores</h3>
<div class="paragraph">
<p><strong>Objetivo:</strong> Compartir una PVC entre múltiples contenedores en el mismo Pod.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong></p>
</div>
<div class="paragraph">
<p>Crea un Pod con múltiples contenedores que comparten el mismo PersistentVolumeClaim.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea una PVC:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;EOF</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: PersistentVolumeClaim</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: shared-storage</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  accessModes:</span>
<span class="tok-s">  - ReadWriteOnce</span>
<span class="tok-s">  resources:</span>
<span class="tok-s">    requests:</span>
<span class="tok-s">      storage: 2Gi</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea un PV para la PVC (si es necesario):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>sudo<span class="tok-w"> </span>mkdir<span class="tok-w"> </span>-p<span class="tok-w"> </span>/mnt/data/pv3
sudo<span class="tok-w"> </span>chmod<span class="tok-w"> </span><span class="tok-m">777</span><span class="tok-w"> </span>/mnt/data/pv3

kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;EOF</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: PersistentVolume</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: local-pv-3</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  capacity:</span>
<span class="tok-s">    storage: 5Gi</span>
<span class="tok-s">  accessModes:</span>
<span class="tok-s">  - ReadWriteOnce</span>
<span class="tok-s">  persistentVolumeReclaimPolicy: Delete</span>
<span class="tok-s">  hostPath:</span>
<span class="tok-s">    path: /mnt/data/pv3</span>
<span class="tok-s">    type: DirectoryOrCreate</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod con múltiples contenedores usando la misma PVC:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Pod</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">multi-container-storage</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-c1"># Contenedor que escribe en storage</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">writer</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">busybox</span>
<span class="tok-w">    </span><span class="tok-nt">command</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">[</span><span class="tok-s">&quot;sh&quot;</span><span class="tok-p tok-p-Indicator">,</span><span class="tok-w"> </span><span class="tok-s">&quot;-c&quot;</span><span class="tok-p tok-p-Indicator">]</span>
<span class="tok-w">    </span><span class="tok-nt">args</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">|</span>
<span class="tok-w">      </span><span class="tok-no">counter=1</span>
<span class="tok-w">      </span><span class="tok-no">while true; do</span>
<span class="tok-w">        </span><span class="tok-no">echo &quot;[$(date &#39;+%H:%M:%S&#39;)] Event $counter&quot; &gt;&gt; /shared/events.log</span>
<span class="tok-w">        </span><span class="tok-no">counter=$((counter+1))</span>
<span class="tok-w">        </span><span class="tok-no">sleep 2</span>
<span class="tok-w">      </span><span class="tok-no">done</span>
<span class="tok-w">    </span><span class="tok-nt">volumeMounts</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">shared</span>
<span class="tok-w">      </span><span class="tok-nt">mountPath</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/shared</span>
<span class="tok-w">  </span><span class="tok-c1"># Contenedor que lee del storage</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">reader</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">busybox</span>
<span class="tok-w">    </span><span class="tok-nt">command</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">[</span><span class="tok-s">&quot;sh&quot;</span><span class="tok-p tok-p-Indicator">,</span><span class="tok-w"> </span><span class="tok-s">&quot;-c&quot;</span><span class="tok-p tok-p-Indicator">]</span>
<span class="tok-w">    </span><span class="tok-nt">args</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">|</span>
<span class="tok-w">      </span><span class="tok-no">sleep 1</span>
<span class="tok-w">      </span><span class="tok-no">while true; do</span>
<span class="tok-w">        </span><span class="tok-no">echo &quot;=== Events Log ===&quot;</span>
<span class="tok-w">        </span><span class="tok-no">tail -5 /shared/events.log</span>
<span class="tok-w">        </span><span class="tok-no">sleep 5</span>
<span class="tok-w">      </span><span class="tok-no">done</span>
<span class="tok-w">    </span><span class="tok-nt">volumeMounts</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">shared</span>
<span class="tok-w">      </span><span class="tok-nt">mountPath</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/shared</span>
<span class="tok-w">      </span><span class="tok-nt">readOnly</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span>
<span class="tok-w">  </span><span class="tok-c1"># Contenedor que analiza el storage</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">analyzer</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">busybox</span>
<span class="tok-w">    </span><span class="tok-nt">command</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">[</span><span class="tok-s">&quot;sh&quot;</span><span class="tok-p tok-p-Indicator">,</span><span class="tok-w"> </span><span class="tok-s">&quot;-c&quot;</span><span class="tok-p tok-p-Indicator">]</span>
<span class="tok-w">    </span><span class="tok-nt">args</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">|</span>
<span class="tok-w">      </span><span class="tok-no">sleep 2</span>
<span class="tok-w">      </span><span class="tok-no">while true; do</span>
<span class="tok-w">        </span><span class="tok-no">echo &quot;=== Log Analysis ===&quot;</span>
<span class="tok-w">        </span><span class="tok-no">wc -l /shared/events.log</span>
<span class="tok-w">        </span><span class="tok-no">echo &quot;Storage usage:&quot;</span>
<span class="tok-w">        </span><span class="tok-no">du -sh /shared/</span>
<span class="tok-w">        </span><span class="tok-no">sleep 10</span>
<span class="tok-w">      </span><span class="tok-no">done</span>
<span class="tok-w">    </span><span class="tok-nt">volumeMounts</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">shared</span>
<span class="tok-w">      </span><span class="tok-nt">mountPath</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">/shared</span>
<span class="tok-w">      </span><span class="tok-nt">readOnly</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">true</span>
<span class="tok-w">  </span><span class="tok-c1"># Volumen compartido</span>
<span class="tok-w">  </span><span class="tok-nt">volumes</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">shared</span>
<span class="tok-w">    </span><span class="tok-nt">persistentVolumeClaim</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">claimName</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">shared-storage</span></code></pre>
</div>
</div>
</li>
<li>
<p>Aplica el Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: multi-container-storage</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: writer</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      counter=1</span>
<span class="tok-s">      while true; do</span>
<span class="tok-s">        echo &quot;[$(date &#39;+%H:%M:%S&#39;)] Event $counter&quot; &gt;&gt; /shared/events.log</span>
<span class="tok-s">        counter=$((counter+1))</span>
<span class="tok-s">        sleep 2</span>
<span class="tok-s">      done</span>
<span class="tok-s">    volumeMounts:</span>
<span class="tok-s">    - name: shared</span>
<span class="tok-s">      mountPath: /shared</span>
<span class="tok-s">  - name: reader</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      sleep 1</span>
<span class="tok-s">      while true; do</span>
<span class="tok-s">        echo &quot;=== Events Log ===&quot;</span>
<span class="tok-s">        tail -5 /shared/events.log</span>
<span class="tok-s">        sleep 5</span>
<span class="tok-s">      done</span>
<span class="tok-s">    volumeMounts:</span>
<span class="tok-s">    - name: shared</span>
<span class="tok-s">      mountPath: /shared</span>
<span class="tok-s">      readOnly: true</span>
<span class="tok-s">  volumes:</span>
<span class="tok-s">  - name: shared</span>
<span class="tok-s">    persistentVolumeClaim:</span>
<span class="tok-s">      claimName: shared-storage</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pod<span class="tok-w"> </span>multi-container-storage</code></pre>
</div>
</div>
</li>
<li>
<p>Observa los logs del writer:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>multi-container-storage<span class="tok-w"> </span>-c<span class="tok-w"> </span>writer<span class="tok-w"> </span>--tail<span class="tok-o">=</span><span class="tok-m">5</span></code></pre>
</div>
</div>
</li>
<li>
<p>Observa los logs del reader:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>multi-container-storage<span class="tok-w"> </span>-c<span class="tok-w"> </span>reader<span class="tok-w"> </span>--tail<span class="tok-o">=</span><span class="tok-m">5</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el contenido del storage:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>multi-container-storage<span class="tok-w"> </span>-c<span class="tok-w"> </span>reader<span class="tok-w"> </span>--<span class="tok-w"> </span>cat<span class="tok-w"> </span>/shared/events.log</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>multi-container-storage
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pvc<span class="tok-w"> </span>shared-storage
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pv<span class="tok-w"> </span>local-pv-3</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong></p>
</div>
<div class="paragraph">
<p>Todos los contenedores deben acceder y compartir datos correctamente a través de la PVC.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Por qué todos los contenedores pueden usar la misma PVC?</p>
</li>
<li>
<p>¿Cuál es la diferencia entre emptyDir y PVC para este caso de uso?</p>
</li>
<li>
<p>¿Qué ocurriría si cambiamos accessModes a ReadOnlyMany?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_5_8_statefulset_con_volumeclaimtemplates">10.8. Ejercicio 5.8: StatefulSet con volumeClaimTemplates</h3>
<div class="paragraph">
<p><strong>Objetivo:</strong> Crear un StatefulSet que aprovisione automáticamente PVCs para cada Pod.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong></p>
</div>
<div class="paragraph">
<p>Crea un StatefulSet que genere automáticamente PersistentVolumeClaims para cada réplica usando volumeClaimTemplates.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un StorageClass (si no existe):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;EOF</span>
<span class="tok-s">apiVersion: storage.k8s.io/v1</span>
<span class="tok-s">kind: StorageClass</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: stateful-storage</span>
<span class="tok-s">provisioner: kubernetes.io/no-provisioner</span>
<span class="tok-s">volumeBindingMode: WaitForFirstConsumer</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Headless Service para el StatefulSet:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;EOF</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Service</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: mysql-db</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  clusterIP: None  # Headless Service</span>
<span class="tok-s">  selector:</span>
<span class="tok-s">    app: mysql</span>
<span class="tok-s">  ports:</span>
<span class="tok-s">  - port: 3306</span>
<span class="tok-s">    targetPort: 3306</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea el StatefulSet:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: apps/v1</span>
<span class="tok-s">kind: StatefulSet</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: mysql-db</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  serviceName: mysql-db</span>
<span class="tok-s">  replicas: 3</span>
<span class="tok-s">  selector:</span>
<span class="tok-s">    matchLabels:</span>
<span class="tok-s">      app: mysql</span>
<span class="tok-s">  template:</span>
<span class="tok-s">    metadata:</span>
<span class="tok-s">      labels:</span>
<span class="tok-s">        app: mysql</span>
<span class="tok-s">    spec:</span>
<span class="tok-s">      containers:</span>
<span class="tok-s">      - name: mysql</span>
<span class="tok-s">        image: busybox  # Simulamos MySQL con busybox</span>
<span class="tok-s">        command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">        args:</span>
<span class="tok-s">        - |</span>
<span class="tok-s">          echo &quot;MySQL Replica: $HOSTNAME&quot; &gt; /var/lib/mysql/identity.txt</span>
<span class="tok-s">          echo &quot;Started at: $(date)&quot; &gt;&gt; /var/lib/mysql/identity.txt</span>
<span class="tok-s">          echo &quot;&quot;</span>
<span class="tok-s">          echo &quot;Storage mounted at /var/lib/mysql&quot;</span>
<span class="tok-s">          echo &quot;Displaying identity:&quot;</span>
<span class="tok-s">          cat /var/lib/mysql/identity.txt</span>
<span class="tok-s">          sleep infinity</span>
<span class="tok-s">        volumeMounts:</span>
<span class="tok-s">        - name: mysql-data</span>
<span class="tok-s">          mountPath: /var/lib/mysql</span>
<span class="tok-s">        ports:</span>
<span class="tok-s">        - containerPort: 3306</span>
<span class="tok-s">  # Templates de PVC automáticas</span>
<span class="tok-s">  volumeClaimTemplates:</span>
<span class="tok-s">  - metadata:</span>
<span class="tok-s">      name: mysql-data</span>
<span class="tok-s">    spec:</span>
<span class="tok-s">      accessModes: [ &quot;ReadWriteOnce&quot; ]</span>
<span class="tok-s">      storageClassName: stateful-storage</span>
<span class="tok-s">      resources:</span>
<span class="tok-s">        requests:</span>
<span class="tok-s">          storage: 2Gi</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el StatefulSet:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>statefulset<span class="tok-w"> </span>mysql-db</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que se crearon los Pods en orden:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>mysql<span class="tok-w"> </span>-w</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica las PVCs creadas automáticamente:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pvc
<span class="tok-c1"># Debería mostrar: mysql-data-mysql-db-0, mysql-data-mysql-db-1, mysql-data-mysql-db-2</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica los datos en cada Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>mysql-db-0
kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>mysql-db-1</code></pre>
</div>
</div>
</li>
<li>
<p>Accede a un Pod y verifica su almacenamiento:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>mysql-db-0<span class="tok-w"> </span>--<span class="tok-w"> </span>cat<span class="tok-w"> </span>/var/lib/mysql/identity.txt</code></pre>
</div>
</div>
</li>
<li>
<p>Elimina un Pod y verifica que mantiene su volumen:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>mysql-db-0
<span class="tok-c1"># El StatefulSet lo recrea</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>mysql
<span class="tok-c1"># Espera a que mysql-db-0 esté Running</span>
kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>mysql-db-0<span class="tok-w"> </span>--<span class="tok-w"> </span>cat<span class="tok-w"> </span>/var/lib/mysql/identity.txt
<span class="tok-c1"># Los datos deberían ser los mismos</span></code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>statefulset<span class="tok-w"> </span>mysql-db
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>service<span class="tok-w"> </span>mysql-db
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>storageclass<span class="tok-w"> </span>stateful-storage</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong></p>
</div>
<div class="paragraph">
<p>Cada Pod del StatefulSet debe tener su propio PVC automáticamente creado con datos persistentes.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Cuándo se crea la PVC en un StatefulSet?</p>
</li>
<li>
<p>¿Por qué es importante usar Headless Services con StatefulSets?</p>
</li>
<li>
<p>¿Qué ocurre con los PVCs cuando se elimina el StatefulSet?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_5_9_expansión_de_volúmenes">10.9. Ejercicio 5.9: Expansión de Volúmenes</h3>
<div class="paragraph">
<p><strong>Objetivo:</strong> Expandir dinámicamente el tamaño de un PersistentVolumeClaim.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong></p>
</div>
<div class="paragraph">
<p>Crea una PVC y luego expande su capacidad dinámicamente sin eliminar el Pod.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un StorageClass con allowVolumeExpansion:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;EOF</span>
<span class="tok-s">apiVersion: storage.k8s.io/v1</span>
<span class="tok-s">kind: StorageClass</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: expandable-storage</span>
<span class="tok-s">provisioner: kubernetes.io/no-provisioner</span>
<span class="tok-s">allowVolumeExpansion: true</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea una PVC inicial de 1Gi:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;EOF</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: PersistentVolumeClaim</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: expandable-pvc</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  accessModes:</span>
<span class="tok-s">  - ReadWriteOnce</span>
<span class="tok-s">  storageClassName: expandable-storage</span>
<span class="tok-s">  resources:</span>
<span class="tok-s">    requests:</span>
<span class="tok-s">      storage: 1Gi</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea un PV que soporte esta PVC:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>sudo<span class="tok-w"> </span>mkdir<span class="tok-w"> </span>-p<span class="tok-w"> </span>/mnt/data/pv4
sudo<span class="tok-w"> </span>chmod<span class="tok-w"> </span><span class="tok-m">777</span><span class="tok-w"> </span>/mnt/data/pv4

kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;EOF</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: PersistentVolume</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: local-pv-4</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  capacity:</span>
<span class="tok-s">    storage: 10Gi  # Suficientemente grande para expansión</span>
<span class="tok-s">  accessModes:</span>
<span class="tok-s">  - ReadWriteOnce</span>
<span class="tok-s">  persistentVolumeReclaimPolicy: Delete</span>
<span class="tok-s">  storageClassName: expandable-storage</span>
<span class="tok-s">  hostPath:</span>
<span class="tok-s">    path: /mnt/data/pv4</span>
<span class="tok-s">    type: DirectoryOrCreate</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica la PVC:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pvc<span class="tok-w"> </span>expandable-pvc
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>pvc<span class="tok-w"> </span>expandable-pvc</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod que use la PVC:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;EOF</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: expansion-test</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      echo &quot;Initial size: 1Gi&quot;</span>
<span class="tok-s">      df -h /data | head -2</span>
<span class="tok-s">      echo &quot;&quot;</span>
<span class="tok-s">      echo &quot;Waiting for expansion...&quot;</span>
<span class="tok-s">      sleep infinity</span>
<span class="tok-s">    volumeMounts:</span>
<span class="tok-s">    - name: storage</span>
<span class="tok-s">      mountPath: /data</span>
<span class="tok-s">  volumes:</span>
<span class="tok-s">  - name: storage</span>
<span class="tok-s">    persistentVolumeClaim:</span>
<span class="tok-s">      claimName: expandable-pvc</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el tamaño actual:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>expansion-test<span class="tok-w"> </span>--<span class="tok-w"> </span>df<span class="tok-w"> </span>-h<span class="tok-w"> </span>/data</code></pre>
</div>
</div>
</li>
<li>
<p>Expande la PVC de 1Gi a 2Gi:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>patch<span class="tok-w"> </span>pvc<span class="tok-w"> </span>expandable-pvc<span class="tok-w"> </span>-p<span class="tok-w"> </span><span class="tok-s1">&#39;{&quot;spec&quot;:{&quot;resources&quot;:{&quot;requests&quot;:{&quot;storage&quot;:&quot;2Gi&quot;}}}}&#39;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que la expansión comenzó:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pvc<span class="tok-w"> </span>expandable-pvc
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>pvc<span class="tok-w"> </span>expandable-pvc
<span class="tok-c1"># Debería mostrar: &quot;Persistently Expanded&quot;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Espera a que se complete y verifica el tamaño:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>sleep<span class="tok-w"> </span><span class="tok-m">3</span>
kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>expansion-test<span class="tok-w"> </span>--<span class="tok-w"> </span>df<span class="tok-w"> </span>-h<span class="tok-w"> </span>/data</code></pre>
</div>
</div>
</li>
<li>
<p>Expande nuevamente a 5Gi:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>patch<span class="tok-w"> </span>pvc<span class="tok-w"> </span>expandable-pvc<span class="tok-w"> </span>-p<span class="tok-w"> </span><span class="tok-s1">&#39;{&quot;spec&quot;:{&quot;resources&quot;:{&quot;requests&quot;:{&quot;storage&quot;:&quot;5Gi&quot;}}}}&#39;</span>
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>pvc<span class="tok-w"> </span>expandable-pvc
kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>expansion-test<span class="tok-w"> </span>--<span class="tok-w"> </span>df<span class="tok-w"> </span>-h<span class="tok-w"> </span>/data</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>expansion-test
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pvc<span class="tok-w"> </span>expandable-pvc
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pv<span class="tok-w"> </span>local-pv-4
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>storageclass<span class="tok-w"> </span>expandable-storage</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong></p>
</div>
<div class="paragraph">
<p>El volumen debe expandirse sin interrumpir el Pod.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Por qué allowVolumeExpansion debe ser true en el StorageClass?</p>
</li>
<li>
<p>¿Puedes reducir el tamaño de un volumen?</p>
</li>
<li>
<p>¿Cuál es la ventaja de poder expandir volúmenes sin eliminar Pods?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_5_10_subpath_para_múltiples_montes">10.10. Ejercicio 5.10: subPath para Múltiples Montes</h3>
<div class="paragraph">
<p><strong>Objetivo:</strong> Montar diferentes subcarpetas del mismo volumen en diferentes rutas del contenedor.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong></p>
</div>
<div class="paragraph">
<p>Crea un Pod que monta diferentes subcarpetas de un mismo volumen en diferentes rutas usando subPath.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea una PVC:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;EOF</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: PersistentVolumeClaim</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: multi-mount-pvc</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  accessModes:</span>
<span class="tok-s">  - ReadWriteOnce</span>
<span class="tok-s">  resources:</span>
<span class="tok-s">    requests:</span>
<span class="tok-s">      storage: 2Gi</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea un PV:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>sudo<span class="tok-w"> </span>mkdir<span class="tok-w"> </span>-p<span class="tok-w"> </span>/mnt/data/pv5
sudo<span class="tok-w"> </span>chmod<span class="tok-w"> </span><span class="tok-m">777</span><span class="tok-w"> </span>/mnt/data/pv5

kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;EOF</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: PersistentVolume</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: local-pv-5</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  capacity:</span>
<span class="tok-s">    storage: 5Gi</span>
<span class="tok-s">  accessModes:</span>
<span class="tok-s">  - ReadWriteOnce</span>
<span class="tok-s">  persistentVolumeReclaimPolicy: Delete</span>
<span class="tok-s">  hostPath:</span>
<span class="tok-s">    path: /mnt/data/pv5</span>
<span class="tok-s">    type: DirectoryOrCreate</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod con múltiples subPath mounts:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: subpath-pod</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  initContainers:</span>
<span class="tok-s">  # Init container para preparar la estructura</span>
<span class="tok-s">  - name: setup</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      mkdir -p /setup/logs /setup/cache /setup/config</span>
<span class="tok-s">      echo &quot;Logs directory&quot; &gt; /setup/logs/README.txt</span>
<span class="tok-s">      echo &quot;Cache directory&quot; &gt; /setup/cache/README.txt</span>
<span class="tok-s">      echo &quot;Config directory&quot; &gt; /setup/config/README.txt</span>
<span class="tok-s">    volumeMounts:</span>
<span class="tok-s">    - name: storage</span>
<span class="tok-s">      mountPath: /setup</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      echo &quot;=== Application Storage Structure ===&quot;</span>
<span class="tok-s">      echo &quot;&quot;</span>
<span class="tok-s">      echo &quot;--- /app/logs ---&quot;</span>
<span class="tok-s">      ls -la /app/logs</span>
<span class="tok-s">      echo &quot;&quot;</span>
<span class="tok-s">      echo &quot;--- /app/cache ---&quot;</span>
<span class="tok-s">      ls -la /app/cache</span>
<span class="tok-s">      echo &quot;&quot;</span>
<span class="tok-s">      echo &quot;--- /app/config ---&quot;</span>
<span class="tok-s">      ls -la /app/config</span>
<span class="tok-s">      echo &quot;&quot;</span>
<span class="tok-s">      echo &quot;Writing to different paths...&quot;</span>
<span class="tok-s">      echo &quot;Log entry 1&quot; &gt; /app/logs/app.log</span>
<span class="tok-s">      echo &quot;Cache data&quot; &gt; /app/cache/session.cache</span>
<span class="tok-s">      echo &quot;App config&quot; &gt; /app/config/app.ini</span>
<span class="tok-s">      echo &quot;&quot;</span>
<span class="tok-s">      echo &quot;Verifying files:&quot;</span>
<span class="tok-s">      echo &quot;Logs:&quot;</span>
<span class="tok-s">      cat /app/logs/app.log</span>
<span class="tok-s">      echo &quot;Cache:&quot;</span>
<span class="tok-s">      cat /app/cache/session.cache</span>
<span class="tok-s">      echo &quot;Config:&quot;</span>
<span class="tok-s">      cat /app/config/app.ini</span>
<span class="tok-s">      sleep infinity</span>
<span class="tok-s">    volumeMounts:</span>
<span class="tok-s">    # Múltiples subPath mounts del mismo volumen</span>
<span class="tok-s">    - name: storage</span>
<span class="tok-s">      mountPath: /app/logs</span>
<span class="tok-s">      subPath: logs</span>
<span class="tok-s">    - name: storage</span>
<span class="tok-s">      mountPath: /app/cache</span>
<span class="tok-s">      subPath: cache</span>
<span class="tok-s">    - name: storage</span>
<span class="tok-s">      mountPath: /app/config</span>
<span class="tok-s">      subPath: config</span>
<span class="tok-s">  volumes:</span>
<span class="tok-s">  - name: storage</span>
<span class="tok-s">    persistentVolumeClaim:</span>
<span class="tok-s">      claimName: multi-mount-pvc</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pod<span class="tok-w"> </span>subpath-pod
kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>subpath-pod</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que los archivos están en el lugar correcto:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>subpath-pod<span class="tok-w"> </span>--<span class="tok-w"> </span>ls<span class="tok-w"> </span>-la<span class="tok-w"> </span>/app/logs
kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>subpath-pod<span class="tok-w"> </span>--<span class="tok-w"> </span>cat<span class="tok-w"> </span>/app/logs/app.log</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica la estructura en el volumen físico:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>ls<span class="tok-w"> </span>-la<span class="tok-w"> </span>/mnt/data/pv5/
ls<span class="tok-w"> </span>-la<span class="tok-w"> </span>/mnt/data/pv5/logs/</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un segundo Pod con la misma PVC para compartir datos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: subpath-reader</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: reader</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      sleep 2</span>
<span class="tok-s">      echo &quot;=== Reading shared data ===&quot;</span>
<span class="tok-s">      echo &quot;From logs:&quot;</span>
<span class="tok-s">      cat /data/logs/app.log</span>
<span class="tok-s">      echo &quot;From cache:&quot;</span>
<span class="tok-s">      cat /data/cache/session.cache</span>
<span class="tok-s">      echo &quot;From config:&quot;</span>
<span class="tok-s">      cat /data/config/app.ini</span>
<span class="tok-s">      sleep infinity</span>
<span class="tok-s">    volumeMounts:</span>
<span class="tok-s">    - name: shared</span>
<span class="tok-s">      mountPath: /data/logs</span>
<span class="tok-s">      subPath: logs</span>
<span class="tok-s">      readOnly: true</span>
<span class="tok-s">    - name: shared</span>
<span class="tok-s">      mountPath: /data/cache</span>
<span class="tok-s">      subPath: cache</span>
<span class="tok-s">      readOnly: true</span>
<span class="tok-s">    - name: shared</span>
<span class="tok-s">      mountPath: /data/config</span>
<span class="tok-s">      subPath: config</span>
<span class="tok-s">      readOnly: true</span>
<span class="tok-s">  volumes:</span>
<span class="tok-s">  - name: shared</span>
<span class="tok-s">    persistentVolumeClaim:</span>
<span class="tok-s">      claimName: multi-mount-pvc</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que el reader puede acceder a los datos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>subpath-reader</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>subpath-pod
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>subpath-reader
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pvc<span class="tok-w"> </span>multi-mount-pvc
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pv<span class="tok-w"> </span>local-pv-5</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong></p>
</div>
<div class="paragraph">
<p>Ambos Pods deben poder acceder a diferentes partes del mismo volumen mediante subPath.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Cuál es la ventaja de usar subPath vs. crear múltiples PVCs?</p>
</li>
<li>
<p>¿Por qué es importante el init container en este ejercicio?</p>
</li>
<li>
<p>¿Cómo podrías usar subPath en una aplicación real?</p>
</li>
</ol>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resumen_de_conceptos_5">11. Resumen de Conceptos</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Estos ejercicios del Módulo 5 cubren:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Ejercicio 5.1</strong>: emptyDir para compartir datos entre contenedores</p>
</li>
<li>
<p><strong>Ejercicio 5.2</strong>: hostPath para acceso al sistema host</p>
</li>
<li>
<p><strong>Ejercicio 5.3</strong>: ConfigMaps montados como volúmenes</p>
</li>
<li>
<p><strong>Ejercicio 5.4</strong>: Secrets montados como volúmenes</p>
</li>
<li>
<p><strong>Ejercicio 5.5</strong>: PersistentVolumes y PersistentVolumeClaims</p>
</li>
<li>
<p><strong>Ejercicio 5.6</strong>: StorageClass y aprovisionamiento dinámico</p>
</li>
<li>
<p><strong>Ejercicio 5.7</strong>: PVCs compartidas entre contenedores</p>
</li>
<li>
<p><strong>Ejercicio 5.8</strong>: StatefulSets con volumeClaimTemplates</p>
</li>
<li>
<p><strong>Ejercicio 5.9</strong>: Expansión dinámica de volúmenes</p>
</li>
<li>
<p><strong>Ejercicio 5.10</strong>: subPath para múltiples montes</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_próximos_pasos_2">12. Próximos Pasos</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Una vez completes estos ejercicios, estarás listo para:
* Módulo 6: Configuración y Secrets
* Módulo 7: Seguridad
* Módulo 8: Observabilidad
* Y módulos posteriores&#8230;&#8203;</p>
</div>
<hr>
</div>
</div>
<div class="sect1">
<h2 id="_módulo_6_configuración_y_secrets">13. Módulo 6: Configuración y Secrets</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_ejercicio_6_1_configmap_básico_con_literales">13.1. Ejercicio 6.1: ConfigMap Básico con Literales</h3>
<div class="paragraph">
<p><strong>Objetivo:</strong> Crear un ConfigMap con datos literales e inyectarlos en un Pod.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong></p>
</div>
<div class="paragraph">
<p>Crea un ConfigMap que almacene parámetros de configuración y úsalos en un Pod mediante variables de entorno.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un ConfigMap con literales:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>create<span class="tok-w"> </span>configmap<span class="tok-w"> </span>app-config<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--from-literal<span class="tok-o">=</span>app.name<span class="tok-o">=</span>MyApp<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--from-literal<span class="tok-o">=</span>app.version<span class="tok-o">=</span><span class="tok-m">1</span>.0.0<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--from-literal<span class="tok-o">=</span>database.host<span class="tok-o">=</span>localhost<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--from-literal<span class="tok-o">=</span>database.port<span class="tok-o">=</span><span class="tok-m">5432</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--from-literal<span class="tok-o">=</span>log.level<span class="tok-o">=</span>INFO</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que el ConfigMap fue creado:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>configmap<span class="tok-w"> </span>app-config
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>configmap<span class="tok-w"> </span>app-config<span class="tok-w"> </span>-o<span class="tok-w"> </span>yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod que use el ConfigMap:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;EOF</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: app-with-config</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      echo &quot;=== Application Configuration ===&quot;</span>
<span class="tok-s">      echo &quot;App Name: \$APP_NAME&quot;</span>
<span class="tok-s">      echo &quot;App Version: \$APP_VERSION&quot;</span>
<span class="tok-s">      echo &quot;Database Host: \$DB_HOST&quot;</span>
<span class="tok-s">      echo &quot;Database Port: \$DB_PORT&quot;</span>
<span class="tok-s">      echo &quot;Log Level: \$LOG_LEVEL&quot;</span>
<span class="tok-s">      sleep infinity</span>
<span class="tok-s">    env:</span>
<span class="tok-s">    - name: APP_NAME</span>
<span class="tok-s">      valueFrom:</span>
<span class="tok-s">        configMapKeyRef:</span>
<span class="tok-s">          name: app-config</span>
<span class="tok-s">          key: app.name</span>
<span class="tok-s">    - name: APP_VERSION</span>
<span class="tok-s">      valueFrom:</span>
<span class="tok-s">        configMapKeyRef:</span>
<span class="tok-s">          name: app-config</span>
<span class="tok-s">          key: app.version</span>
<span class="tok-s">    - name: DB_HOST</span>
<span class="tok-s">      valueFrom:</span>
<span class="tok-s">        configMapKeyRef:</span>
<span class="tok-s">          name: app-config</span>
<span class="tok-s">          key: database.host</span>
<span class="tok-s">    - name: DB_PORT</span>
<span class="tok-s">      valueFrom:</span>
<span class="tok-s">        configMapKeyRef:</span>
<span class="tok-s">          name: app-config</span>
<span class="tok-s">          key: database.port</span>
<span class="tok-s">    - name: LOG_LEVEL</span>
<span class="tok-s">      valueFrom:</span>
<span class="tok-s">        configMapKeyRef:</span>
<span class="tok-s">          name: app-config</span>
<span class="tok-s">          key: log.level</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que el Pod está corriendo:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pod<span class="tok-w"> </span>app-with-config</code></pre>
</div>
</div>
</li>
<li>
<p>Observa los logs del Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>app-with-config</code></pre>
</div>
</div>
</li>
<li>
<p>Accede al contenedor y verifica las variables:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>app-with-config<span class="tok-w"> </span>--<span class="tok-w"> </span>env<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>-E<span class="tok-w"> </span><span class="tok-s2">&quot;APP|DB|LOG&quot;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Modifica el ConfigMap:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>patch<span class="tok-w"> </span>configmap<span class="tok-w"> </span>app-config<span class="tok-w"> </span>-p<span class="tok-w"> </span><span class="tok-s1">&#39;{&quot;data&quot;:{&quot;app.version&quot;:&quot;1.1.0&quot;}}&#39;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que la variable no se actualizó (sin reiniciar el Pod):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>app-with-config
<span class="tok-c1"># Debería mostrar versión antigua 1.0.0</span></code></pre>
</div>
</div>
</li>
<li>
<p>Reinicia el Pod para obtener nuevos valores:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>app-with-config
kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;EOF</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: app-with-config</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      echo &quot;=== Application Configuration ===&quot;</span>
<span class="tok-s">      echo &quot;App Version: \$APP_VERSION&quot;</span>
<span class="tok-s">      sleep infinity</span>
<span class="tok-s">    env:</span>
<span class="tok-s">    - name: APP_VERSION</span>
<span class="tok-s">      valueFrom:</span>
<span class="tok-s">        configMapKeyRef:</span>
<span class="tok-s">          name: app-config</span>
<span class="tok-s">          key: app.version</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>app-with-config
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>configmap<span class="tok-w"> </span>app-config</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong></p>
</div>
<div class="paragraph">
<p>El Pod debe mostrar los valores del ConfigMap inyectados como variables de entorno.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Por qué no se actualizaron automáticamente las variables cuando modificaste el ConfigMap?</p>
</li>
<li>
<p>¿Cuál es la diferencia entre usar literales vs. archivos?</p>
</li>
<li>
<p>¿Cómo podrías hacer que los cambios se propaguen automáticamente?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_6_2_configmap_desde_archivos">13.2. Ejercicio 6.2: ConfigMap desde Archivos</h3>
<div class="paragraph">
<p><strong>Objetivo:</strong> Crear un ConfigMap desde archivos de configuración.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong></p>
</div>
<div class="paragraph">
<p>Crea archivos de configuración y úsalos para crear un ConfigMap que se monte como volumen en un Pod.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea archivos de configuración:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>mkdir<span class="tok-w"> </span>-p<span class="tok-w"> </span>/tmp/config
cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>/tmp/config/app.properties<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">server.port=8080</span>
<span class="tok-s">server.host=0.0.0.0</span>
<span class="tok-s">app.name=myapp</span>
<span class="tok-s">app.debug=false</span>
<span class="tok-s">EOF</span>

cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>/tmp/config/database.yaml<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">host: db-server</span>
<span class="tok-s">port: 5432</span>
<span class="tok-s">username: appuser</span>
<span class="tok-s">database: mydb</span>
<span class="tok-s">pool_size: 20</span>
<span class="tok-s">EOF</span>

cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>/tmp/config/nginx.conf<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">server {</span>
<span class="tok-s">  listen 80;</span>
<span class="tok-s">  server_name _;</span>
<span class="tok-s">  location / {</span>
<span class="tok-s">    proxy_pass http://localhost:8080;</span>
<span class="tok-s">  }</span>
<span class="tok-s">}</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea un ConfigMap desde los archivos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>create<span class="tok-w"> </span>configmap<span class="tok-w"> </span>app-files<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--from-file<span class="tok-o">=</span>/tmp/config/app.properties<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--from-file<span class="tok-o">=</span>/tmp/config/database.yaml<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--from-file<span class="tok-o">=</span>/tmp/config/nginx.conf</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el ConfigMap:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>configmap<span class="tok-w"> </span>app-files<span class="tok-w"> </span>-o<span class="tok-w"> </span>yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod que monte el ConfigMap como volumen:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: app-with-files</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      echo &quot;=== Configuration Files ===&quot;</span>
<span class="tok-s">      ls -la /etc/config/</span>
<span class="tok-s">      echo &quot;&quot;</span>
<span class="tok-s">      echo &quot;=== app.properties ===&quot;</span>
<span class="tok-s">      cat /etc/config/app.properties</span>
<span class="tok-s">      echo &quot;&quot;</span>
<span class="tok-s">      echo &quot;=== database.yaml ===&quot;</span>
<span class="tok-s">      cat /etc/config/database.yaml</span>
<span class="tok-s">      echo &quot;&quot;</span>
<span class="tok-s">      echo &quot;=== nginx.conf ===&quot;</span>
<span class="tok-s">      cat /etc/config/nginx.conf</span>
<span class="tok-s">      sleep infinity</span>
<span class="tok-s">    volumeMounts:</span>
<span class="tok-s">    - name: config</span>
<span class="tok-s">      mountPath: /etc/config</span>
<span class="tok-s">      readOnly: true</span>
<span class="tok-s">  volumes:</span>
<span class="tok-s">  - name: config</span>
<span class="tok-s">    configMap:</span>
<span class="tok-s">      name: app-files</span>
<span class="tok-s">      defaultMode: 0444</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pod<span class="tok-w"> </span>app-with-files
kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>app-with-files</code></pre>
</div>
</div>
</li>
<li>
<p>Accede al contenedor y verifica los archivos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>app-with-files<span class="tok-w"> </span>--<span class="tok-w"> </span>ls<span class="tok-w"> </span>-la<span class="tok-w"> </span>/etc/config/
kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>app-with-files<span class="tok-w"> </span>--<span class="tok-w"> </span>cat<span class="tok-w"> </span>/etc/config/app.properties</code></pre>
</div>
</div>
</li>
<li>
<p>Intenta modificar un archivo (debe fallar):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>app-with-files<span class="tok-w"> </span>--<span class="tok-w"> </span>sh<span class="tok-w"> </span>-c<span class="tok-w"> </span><span class="tok-s1">&#39;echo newvalue &gt; /etc/config/app.properties&#39;</span>
<span class="tok-c1"># Debería fallar: Read-only file system</span></code></pre>
</div>
</div>
</li>
<li>
<p>Modifica el ConfigMap (solo un archivo):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>patch<span class="tok-w"> </span>configmap<span class="tok-w"> </span>app-files<span class="tok-w"> </span>-p<span class="tok-w"> </span><span class="tok-s1">&#39;{&quot;data&quot;:{&quot;app.properties&quot;:&quot;server.port=9090\napp.name=updated&quot;}}&#39;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que el archivo se actualizó en el Pod (espera algunos segundos):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>sleep<span class="tok-w"> </span><span class="tok-m">3</span>
kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>app-with-files<span class="tok-w"> </span>--<span class="tok-w"> </span>cat<span class="tok-w"> </span>/etc/config/app.properties</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>app-with-files
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>configmap<span class="tok-w"> </span>app-files
rm<span class="tok-w"> </span>-rf<span class="tok-w"> </span>/tmp/config</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong></p>
</div>
<div class="paragraph">
<p>El Pod debe mostrar los archivos del ConfigMap y reflejar cambios cuando se modifica.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Cuál es la ventaja de montar ConfigMap como volumen en lugar de variables de entorno?</p>
</li>
<li>
<p>¿Cuánto tiempo tarda en propagarse el cambio?</p>
</li>
<li>
<p>¿Qué otros tipos de archivos podrías almacenar en un ConfigMap?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_6_3_envfrom_inyección_bulk">13.3. Ejercicio 6.3: envFrom - Inyección Bulk</h3>
<div class="paragraph">
<p><strong>Objetivo:</strong> Usar envFrom para inyectar múltiples variables de entorno desde ConfigMap de una vez.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong></p>
</div>
<div class="paragraph">
<p>Crea un ConfigMap y úsalo con envFrom para inyectar todas las claves como variables de entorno automáticamente.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un ConfigMap con múltiples claves:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>create<span class="tok-w"> </span>configmap<span class="tok-w"> </span>bulk-config<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--from-literal<span class="tok-o">=</span><span class="tok-nv">DATABASE_HOST</span><span class="tok-o">=</span>db-server<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--from-literal<span class="tok-o">=</span><span class="tok-nv">DATABASE_PORT</span><span class="tok-o">=</span><span class="tok-m">5432</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--from-literal<span class="tok-o">=</span><span class="tok-nv">CACHE_HOST</span><span class="tok-o">=</span>redis-server<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--from-literal<span class="tok-o">=</span><span class="tok-nv">CACHE_PORT</span><span class="tok-o">=</span><span class="tok-m">6379</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--from-literal<span class="tok-o">=</span><span class="tok-nv">API_TIMEOUT</span><span class="tok-o">=</span><span class="tok-m">30</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--from-literal<span class="tok-o">=</span><span class="tok-nv">MAX_CONNECTIONS</span><span class="tok-o">=</span><span class="tok-m">100</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod usando envFrom:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: app-bulk-env</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      echo &quot;=== All Environment Variables ===&quot;</span>
<span class="tok-s">      env | sort</span>
<span class="tok-s">      echo &quot;&quot;</span>
<span class="tok-s">      echo &quot;=== From ConfigMap ===&quot;</span>
<span class="tok-s">      env | grep -E &quot;DATABASE|CACHE|API|MAX&quot;</span>
<span class="tok-s">      sleep infinity</span>
<span class="tok-s">    envFrom:</span>
<span class="tok-s">    - configMapRef:</span>
<span class="tok-s">        name: bulk-config</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pod<span class="tok-w"> </span>app-bulk-env</code></pre>
</div>
</div>
</li>
<li>
<p>Observa los logs:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>app-bulk-env</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica variables específicas:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>app-bulk-env<span class="tok-w"> </span>--<span class="tok-w"> </span>sh<span class="tok-w"> </span>-c<span class="tok-w"> </span><span class="tok-s1">&#39;echo $DATABASE_HOST&#39;</span>
kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>app-bulk-env<span class="tok-w"> </span>--<span class="tok-w"> </span>sh<span class="tok-w"> </span>-c<span class="tok-w"> </span><span class="tok-s1">&#39;echo $CACHE_PORT&#39;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea otro Pod con prefijo en las variables:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: app-prefixed-env</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      echo &quot;=== Variables with PREFIX ===&quot;</span>
<span class="tok-s">      env | grep MYAPP</span>
<span class="tok-s">      sleep infinity</span>
<span class="tok-s">    envFrom:</span>
<span class="tok-s">    - configMapRef:</span>
<span class="tok-s">        name: bulk-config</span>
<span class="tok-s">        prefix: MYAPP_</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el prefijo:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>app-prefixed-env</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica variables con prefijo:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>app-prefixed-env<span class="tok-w"> </span>--<span class="tok-w"> </span>sh<span class="tok-w"> </span>-c<span class="tok-w"> </span><span class="tok-s1">&#39;echo $MYAPP_DATABASE_HOST&#39;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>app-bulk-env
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>app-prefixed-env
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>configmap<span class="tok-w"> </span>bulk-config</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong></p>
</div>
<div class="paragraph">
<p>Todas las claves del ConfigMap deben inyectarse como variables de entorno automáticamente.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Cuál es la ventaja de envFrom vs. inyectar variables individuales?</p>
</li>
<li>
<p>¿Cómo se convierten los nombres de claves a nombres de variables?</p>
</li>
<li>
<p>¿Cuándo usarías prefix en envFrom?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_6_4_secret_básico">13.4. Ejercicio 6.4: Secret Básico</h3>
<div class="paragraph">
<p><strong>Objetivo:</strong> Crear un Secret y usarlo en un Pod para almacenar datos sensibles.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong></p>
</div>
<div class="paragraph">
<p>Crea un Secret con credenciales y úsalas en un Pod para simular una conexión a base de datos.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un Secret con credenciales:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>create<span class="tok-w"> </span>secret<span class="tok-w"> </span>generic<span class="tok-w"> </span>db-credentials<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--from-literal<span class="tok-o">=</span><span class="tok-nv">username</span><span class="tok-o">=</span>dbuser<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--from-literal<span class="tok-o">=</span><span class="tok-nv">password</span><span class="tok-o">=</span>SuperSecret123!<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--from-literal<span class="tok-o">=</span><span class="tok-nv">host</span><span class="tok-o">=</span>postgres.default.svc.cluster.local<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--from-literal<span class="tok-o">=</span><span class="tok-nv">port</span><span class="tok-o">=</span><span class="tok-m">5432</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--from-literal<span class="tok-o">=</span><span class="tok-nv">database</span><span class="tok-o">=</span>myappdb</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que el Secret existe (sin mostrar valores):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>secret<span class="tok-w"> </span>db-credentials
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>secret<span class="tok-w"> </span>db-credentials<span class="tok-w"> </span>-o<span class="tok-w"> </span>yaml
<span class="tok-c1"># Los valores están en base64, no en claro</span></code></pre>
</div>
</div>
</li>
<li>
<p>Decodifica un valor para entender base64:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Ver valor base64</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>secret<span class="tok-w"> </span>db-credentials<span class="tok-w"> </span>-o<span class="tok-w"> </span>yaml<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>password

<span class="tok-c1"># Decodificar</span>
<span class="tok-nb">echo</span><span class="tok-w"> </span>-n<span class="tok-w"> </span><span class="tok-s2">&quot;U3VwZXJTZWNyZXQxMjMh&quot;</span><span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>base64<span class="tok-w"> </span>-d
<span class="tok-c1"># Debería mostrar: SuperSecret123!</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod que use el Secret con variables de entorno:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: db-app</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      echo &quot;=== Database Connection ===&quot;</span>
<span class="tok-s">      echo &quot;Host: $DB_HOST&quot;</span>
<span class="tok-s">      echo &quot;Port: $DB_PORT&quot;</span>
<span class="tok-s">      echo &quot;Database: $DB_NAME&quot;</span>
<span class="tok-s">      echo &quot;User: $DB_USER&quot;</span>
<span class="tok-s">      echo &quot;&quot;</span>
<span class="tok-s">      echo &quot;Full Connection String:&quot;</span>
<span class="tok-s">      echo &quot;postgresql://$DB_USER:$DB_PASSWORD@$DB_HOST:$DB_PORT/$DB_NAME&quot;</span>
<span class="tok-s">      echo &quot;&quot;</span>
<span class="tok-s">      echo &quot;Attempting connection (simulated)...&quot;</span>
<span class="tok-s">      sleep infinity</span>
<span class="tok-s">    env:</span>
<span class="tok-s">    - name: DB_HOST</span>
<span class="tok-s">      valueFrom:</span>
<span class="tok-s">        secretKeyRef:</span>
<span class="tok-s">          name: db-credentials</span>
<span class="tok-s">          key: host</span>
<span class="tok-s">    - name: DB_PORT</span>
<span class="tok-s">      valueFrom:</span>
<span class="tok-s">        secretKeyRef:</span>
<span class="tok-s">          name: db-credentials</span>
<span class="tok-s">          key: port</span>
<span class="tok-s">    - name: DB_USER</span>
<span class="tok-s">      valueFrom:</span>
<span class="tok-s">        secretKeyRef:</span>
<span class="tok-s">          name: db-credentials</span>
<span class="tok-s">          key: username</span>
<span class="tok-s">    - name: DB_PASSWORD</span>
<span class="tok-s">      valueFrom:</span>
<span class="tok-s">        secretKeyRef:</span>
<span class="tok-s">          name: db-credentials</span>
<span class="tok-s">          key: password</span>
<span class="tok-s">    - name: DB_NAME</span>
<span class="tok-s">      valueFrom:</span>
<span class="tok-s">        secretKeyRef:</span>
<span class="tok-s">          name: db-credentials</span>
<span class="tok-s">          key: database</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pod<span class="tok-w"> </span>db-app
kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>db-app</code></pre>
</div>
</div>
</li>
<li>
<p>Accede al contenedor y verifica las variables:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>db-app<span class="tok-w"> </span>--<span class="tok-w"> </span>sh<span class="tok-w"> </span>-c<span class="tok-w"> </span><span class="tok-s1">&#39;echo $DB_PASSWORD&#39;</span>
kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>db-app<span class="tok-w"> </span>--<span class="tok-w"> </span>sh<span class="tok-w"> </span>-c<span class="tok-w"> </span><span class="tok-s1">&#39;echo $DB_USER&#39;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que las variables están en el ambiente:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>db-app<span class="tok-w"> </span>--<span class="tok-w"> </span>env<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>DB_</code></pre>
</div>
</div>
</li>
<li>
<p>Modifica el Secret:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>patch<span class="tok-w"> </span>secret<span class="tok-w"> </span>db-credentials<span class="tok-w"> </span>-p<span class="tok-w"> </span><span class="tok-s1">&#39;{&quot;data&quot;:{&quot;password&quot;:&quot;NewPassword456!&quot;}}&#39;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Reinicia el Pod para obtener el nuevo Secret:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>db-app
kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: db-app</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      echo &quot;Updated Password: $DB_PASSWORD&quot;</span>
<span class="tok-s">      sleep infinity</span>
<span class="tok-s">    env:</span>
<span class="tok-s">    - name: DB_PASSWORD</span>
<span class="tok-s">      valueFrom:</span>
<span class="tok-s">        secretKeyRef:</span>
<span class="tok-s">          name: db-credentials</span>
<span class="tok-s">          key: password</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que tiene la nueva contraseña:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>db-app</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>db-app
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>secret<span class="tok-w"> </span>db-credentials</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong></p>
</div>
<div class="paragraph">
<p>El Pod debe acceder a las credenciales del Secret sin mostrarlas en claro.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Por qué está bien usar variables de entorno con Secrets?</p>
</li>
<li>
<p>¿Cuál es la diferencia entre base64 y encriptación?</p>
</li>
<li>
<p>¿Cómo se protegen mejor los Secrets en Kubernetes?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_6_5_secret_como_volumen_más_seguro">13.5. Ejercicio 6.5: Secret como Volumen (Más Seguro)</h3>
<div class="paragraph">
<p><strong>Objetivo:</strong> Montar un Secret como volumen para mayor seguridad.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong></p>
</div>
<div class="paragraph">
<p>Crea un Secret y monta como volumen con permisos restrictivos en lugar de variables de entorno.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un Secret:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>create<span class="tok-w"> </span>secret<span class="tok-w"> </span>generic<span class="tok-w"> </span>api-keys<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--from-literal<span class="tok-o">=</span><span class="tok-nv">api_key_prod</span><span class="tok-o">=</span>sk-live-abc123xyz789<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--from-literal<span class="tok-o">=</span><span class="tok-nv">api_key_staging</span><span class="tok-o">=</span>sk-test-def456uvw012<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--from-literal<span class="tok-o">=</span><span class="tok-nv">webhook_secret</span><span class="tok-o">=</span>webhook_secret_xyz123</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod que monte el Secret como volumen:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: secure-app</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      echo &quot;=== API Keys (mounted as files) ===&quot;</span>
<span class="tok-s">      echo &quot;&quot;</span>
<span class="tok-s">      echo &quot;Files available:&quot;</span>
<span class="tok-s">      ls -la /etc/api-secrets/</span>
<span class="tok-s">      echo &quot;&quot;</span>
<span class="tok-s">      echo &quot;=== Production API Key ===&quot;</span>
<span class="tok-s">      cat /etc/api-secrets/api_key_prod</span>
<span class="tok-s">      echo &quot;&quot;</span>
<span class="tok-s">      echo &quot;=== File Permissions ===&quot;</span>
<span class="tok-s">      stat /etc/api-secrets/api_key_prod</span>
<span class="tok-s">      echo &quot;&quot;</span>
<span class="tok-s">      sleep infinity</span>
<span class="tok-s">    volumeMounts:</span>
<span class="tok-s">    - name: api-keys</span>
<span class="tok-s">      mountPath: /etc/api-secrets</span>
<span class="tok-s">      readOnly: true</span>
<span class="tok-s">  volumes:</span>
<span class="tok-s">  - name: api-keys</span>
<span class="tok-s">    secret:</span>
<span class="tok-s">      secretName: api-keys</span>
<span class="tok-s">      defaultMode: 0400  # Permisos restrictivos</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pod<span class="tok-w"> </span>secure-app
kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>secure-app</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica los permisos del archivo:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>secure-app<span class="tok-w"> </span>--<span class="tok-w"> </span>ls<span class="tok-w"> </span>-la<span class="tok-w"> </span>/etc/api-secrets/</code></pre>
</div>
</div>
</li>
<li>
<p>Intenta leer un secreto:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>secure-app<span class="tok-w"> </span>--<span class="tok-w"> </span>cat<span class="tok-w"> </span>/etc/api-secrets/api_key_prod</code></pre>
</div>
</div>
</li>
<li>
<p>Intenta modificar un secreto (debe fallar):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>secure-app<span class="tok-w"> </span>--<span class="tok-w"> </span>sh<span class="tok-w"> </span>-c<span class="tok-w"> </span><span class="tok-s1">&#39;echo newkey &gt; /etc/api-secrets/api_key_prod&#39;</span>
<span class="tok-c1"># Debería fallar: Read-only file system</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea otro Pod que monte el Secret con opción items:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: selective-app</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      echo &quot;=== Selected Secret Keys ===&quot;</span>
<span class="tok-s">      ls -la /etc/secrets/</span>
<span class="tok-s">      echo &quot;&quot;</span>
<span class="tok-s">      echo &quot;Prod Key location:&quot;</span>
<span class="tok-s">      cat /etc/secrets/production-key</span>
<span class="tok-s">      sleep infinity</span>
<span class="tok-s">    volumeMounts:</span>
<span class="tok-s">    - name: selected-keys</span>
<span class="tok-s">      mountPath: /etc/secrets</span>
<span class="tok-s">      readOnly: true</span>
<span class="tok-s">  volumes:</span>
<span class="tok-s">  - name: selected-keys</span>
<span class="tok-s">    secret:</span>
<span class="tok-s">      secretName: api-keys</span>
<span class="tok-s">      defaultMode: 0400</span>
<span class="tok-s">      items:</span>
<span class="tok-s">      - key: api_key_prod</span>
<span class="tok-s">        path: production-key  # Renombrar archivo</span>
<span class="tok-s">      - key: webhook_secret</span>
<span class="tok-s">        path: webhook-config</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que solo se montaron los keys seleccionados:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>selective-app</code></pre>
</div>
</div>
</li>
<li>
<p>Modifica el Secret:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>patch<span class="tok-w"> </span>secret<span class="tok-w"> </span>api-keys<span class="tok-w"> </span>-p<span class="tok-w"> </span><span class="tok-s1">&#39;{&quot;data&quot;:{&quot;api_key_prod&quot;:&quot;sk-live-newkey123abc&quot;}}&#39;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que el archivo se actualizó en el volumen (automático):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>sleep<span class="tok-w"> </span><span class="tok-m">2</span>
kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>secure-app<span class="tok-w"> </span>--<span class="tok-w"> </span>cat<span class="tok-w"> </span>/etc/api-secrets/api_key_prod</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>secure-app
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>selective-app
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>secret<span class="tok-w"> </span>api-keys</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong></p>
</div>
<div class="paragraph">
<p>Los Secrets deben estar montados como archivos con permisos restrictivos de solo lectura.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Por qué es mejor montar Secrets como volumen que como variables de entorno?</p>
</li>
<li>
<p>¿Cómo se actualizan automáticamente los archivos cuando cambia el Secret?</p>
</li>
<li>
<p>¿Qué significa defaultMode: 0400?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_6_6_secret_yaml_declarativo">13.6. Ejercicio 6.6: Secret YAML Declarativo</h3>
<div class="paragraph">
<p><strong>Objetivo:</strong> Crear un Secret usando YAML declarativo con base64.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong></p>
</div>
<div class="paragraph">
<p>Crea un Secret definiendo valores en base64 directamente en el YAML.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Genera valores base64 para credenciales:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">echo</span><span class="tok-w"> </span>-n<span class="tok-w"> </span><span class="tok-s2">&quot;admin&quot;</span><span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>base64
<span class="tok-c1"># YWRtaW4=</span>

<span class="tok-nb">echo</span><span class="tok-w"> </span>-n<span class="tok-w"> </span><span class="tok-s2">&quot;P@ssw0rd123!&quot;</span><span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>base64
<span class="tok-c1"># UEBzc3cwcmQxMjMh</span>

<span class="tok-nb">echo</span><span class="tok-w"> </span>-n<span class="tok-w"> </span><span class="tok-s2">&quot;mongodb://localhost:27017&quot;</span><span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>base64
<span class="tok-c1"># bW9uZ29kYjovL2xvY2FsaG9zdDoyNzAxNw==</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Secret YAML:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Secret</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: mongo-credentials</span>
<span class="tok-s">  namespace: default</span>
<span class="tok-s">type: Opaque</span>
<span class="tok-s">data:</span>
<span class="tok-s">  username: YWRtaW4=</span>
<span class="tok-s">  password: UEBzc3cwcmQxMjMh</span>
<span class="tok-s">  connection-string: bW9uZ29kYjovL2xvY2FsaG9zdDoyNzAxNw==</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el Secret:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>secret<span class="tok-w"> </span>mongo-credentials
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>secret<span class="tok-w"> </span>mongo-credentials<span class="tok-w"> </span>-o<span class="tok-w"> </span>yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Decodifica los valores para verificar:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>secret<span class="tok-w"> </span>mongo-credentials<span class="tok-w"> </span>-o<span class="tok-w"> </span><span class="tok-nv">jsonpath</span><span class="tok-o">=</span><span class="tok-s1">&#39;{.data.username}&#39;</span><span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>base64<span class="tok-w"> </span>-d
<span class="tok-c1"># Debería mostrar: admin</span>

kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>secret<span class="tok-w"> </span>mongo-credentials<span class="tok-w"> </span>-o<span class="tok-w"> </span><span class="tok-nv">jsonpath</span><span class="tok-o">=</span><span class="tok-s1">&#39;{.data.password}&#39;</span><span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>base64<span class="tok-w"> </span>-d
<span class="tok-c1"># Debería mostrar: P@ssw0rd123!</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod que use el Secret:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: mongo-client</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: mongo</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      MONGO_USER=$(cat /etc/mongo/username)</span>
<span class="tok-s">      MONGO_PASS=$(cat /etc/mongo/password)</span>
<span class="tok-s">      MONGO_URL=$(cat /etc/mongo/connection-string)</span>
<span class="tok-s">      echo &quot;=== MongoDB Connection ===&quot;</span>
<span class="tok-s">      echo &quot;User: $MONGO_USER&quot;</span>
<span class="tok-s">      echo &quot;URL: $MONGO_URL&quot;</span>
<span class="tok-s">      echo &quot;Connecting...&quot;</span>
<span class="tok-s">      sleep infinity</span>
<span class="tok-s">    volumeMounts:</span>
<span class="tok-s">    - name: mongo-creds</span>
<span class="tok-s">      mountPath: /etc/mongo</span>
<span class="tok-s">      readOnly: true</span>
<span class="tok-s">  volumes:</span>
<span class="tok-s">  - name: mongo-creds</span>
<span class="tok-s">    secret:</span>
<span class="tok-s">      secretName: mongo-credentials</span>
<span class="tok-s">      defaultMode: 0400</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pod<span class="tok-w"> </span>mongo-client
kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>mongo-client</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Secret alternativo usando stringData (no base64):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Secret</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: alternate-mongo</span>
<span class="tok-s">type: Opaque</span>
<span class="tok-s">stringData:  # No requiere base64</span>
<span class="tok-s">  username: admin</span>
<span class="tok-s">  password: P@ssw0rd123!</span>
<span class="tok-s">  url: mongodb://localhost:27017</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que ambos Secrets contienen lo mismo:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>secret<span class="tok-w"> </span>mongo-credentials<span class="tok-w"> </span>-o<span class="tok-w"> </span><span class="tok-nv">jsonpath</span><span class="tok-o">=</span><span class="tok-s1">&#39;{.data.username}&#39;</span><span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>base64<span class="tok-w"> </span>-d
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>secret<span class="tok-w"> </span>alternate-mongo<span class="tok-w"> </span>-o<span class="tok-w"> </span><span class="tok-nv">jsonpath</span><span class="tok-o">=</span><span class="tok-s1">&#39;{.data.username}&#39;</span><span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>base64<span class="tok-w"> </span>-d
<span class="tok-c1"># Ambos muestran: admin</span></code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>mongo-client
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>secret<span class="tok-w"> </span>mongo-credentials
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>secret<span class="tok-w"> </span>alternate-mongo</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong></p>
</div>
<div class="paragraph">
<p>El Secret YAML debe crear credenciales correctamente con valores base64.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Cuál es la diferencia entre <code>data</code> y <code>stringData</code> en un Secret?</p>
</li>
<li>
<p>¿Por qué se requiere base64 en <code>data</code>?</p>
</li>
<li>
<p>¿Es seguro guardar base64 en control de versiones?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_6_7_downward_api">13.7. Ejercicio 6.7: Downward API</h3>
<div class="paragraph">
<p><strong>Objetivo:</strong> Usar Downward API para inyectar información del Pod sin ConfigMaps/Secrets.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong></p>
</div>
<div class="paragraph">
<p>Crea un Pod que inyecte información sobre sí mismo (nombre, namespace, labels) usando Downward API.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un Pod con Downward API en variables de entorno:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: info-pod</span>
<span class="tok-s">  namespace: default</span>
<span class="tok-s">  labels:</span>
<span class="tok-s">    app: myapp</span>
<span class="tok-s">    version: v1.0</span>
<span class="tok-s">  annotations:</span>
<span class="tok-s">    description: &quot;Test pod for Downward API&quot;</span>
<span class="tok-s">    team: platform</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      echo &quot;=== Pod Information (Downward API) ===&quot;</span>
<span class="tok-s">      echo &quot;&quot;</span>
<span class="tok-s">      echo &quot;=== Metadata ===&quot;</span>
<span class="tok-s">      echo &quot;Pod Name: $POD_NAME&quot;</span>
<span class="tok-s">      echo &quot;Pod Namespace: $POD_NAMESPACE&quot;</span>
<span class="tok-s">      echo &quot;Pod UID: $POD_UID&quot;</span>
<span class="tok-s">      echo &quot;&quot;</span>
<span class="tok-s">      echo &quot;=== Networking ===&quot;</span>
<span class="tok-s">      echo &quot;Pod IP: $POD_IP&quot;</span>
<span class="tok-s">      echo &quot;Node Name: $NODE_NAME&quot;</span>
<span class="tok-s">      echo &quot;&quot;</span>
<span class="tok-s">      echo &quot;=== Labels ===&quot;</span>
<span class="tok-s">      echo &quot;App Label: $POD_APP&quot;</span>
<span class="tok-s">      echo &quot;Version Label: $POD_VERSION&quot;</span>
<span class="tok-s">      echo &quot;&quot;</span>
<span class="tok-s">      echo &quot;=== Resources ===&quot;</span>
<span class="tok-s">      echo &quot;Memory Limit: $MEMORY_LIMIT&quot;</span>
<span class="tok-s">      echo &quot;CPU Request: $CPU_REQUEST&quot;</span>
<span class="tok-s">      echo &quot;&quot;</span>
<span class="tok-s">      sleep infinity</span>
<span class="tok-s">    env:</span>
<span class="tok-s">    # Metadata</span>
<span class="tok-s">    - name: POD_NAME</span>
<span class="tok-s">      valueFrom:</span>
<span class="tok-s">        fieldRef:</span>
<span class="tok-s">          fieldPath: metadata.name</span>
<span class="tok-s">    - name: POD_NAMESPACE</span>
<span class="tok-s">      valueFrom:</span>
<span class="tok-s">        fieldRef:</span>
<span class="tok-s">          fieldPath: metadata.namespace</span>
<span class="tok-s">    - name: POD_UID</span>
<span class="tok-s">      valueFrom:</span>
<span class="tok-s">        fieldRef:</span>
<span class="tok-s">          fieldPath: metadata.uid</span>
<span class="tok-s">    # Networking</span>
<span class="tok-s">    - name: POD_IP</span>
<span class="tok-s">      valueFrom:</span>
<span class="tok-s">        fieldRef:</span>
<span class="tok-s">          fieldPath: status.podIP</span>
<span class="tok-s">    - name: NODE_NAME</span>
<span class="tok-s">      valueFrom:</span>
<span class="tok-s">        fieldRef:</span>
<span class="tok-s">          fieldPath: spec.nodeName</span>
<span class="tok-s">    # Labels (si existen)</span>
<span class="tok-s">    - name: POD_APP</span>
<span class="tok-s">      valueFrom:</span>
<span class="tok-s">        fieldRef:</span>
<span class="tok-s">          fieldPath: metadata.labels[&#39;app&#39;]</span>
<span class="tok-s">    - name: POD_VERSION</span>
<span class="tok-s">      valueFrom:</span>
<span class="tok-s">        fieldRef:</span>
<span class="tok-s">          fieldPath: metadata.labels[&#39;version&#39;]</span>
<span class="tok-s">    # Resources</span>
<span class="tok-s">    - name: MEMORY_LIMIT</span>
<span class="tok-s">      valueFrom:</span>
<span class="tok-s">        resourceFieldRef:</span>
<span class="tok-s">          containerName: app</span>
<span class="tok-s">          resource: limits.memory</span>
<span class="tok-s">    - name: CPU_REQUEST</span>
<span class="tok-s">      valueFrom:</span>
<span class="tok-s">        resourceFieldRef:</span>
<span class="tok-s">          containerName: app</span>
<span class="tok-s">          resource: requests.cpu</span>
<span class="tok-s">    resources:</span>
<span class="tok-s">      requests:</span>
<span class="tok-s">        memory: &quot;32Mi&quot;</span>
<span class="tok-s">        cpu: &quot;10m&quot;</span>
<span class="tok-s">      limits:</span>
<span class="tok-s">        memory: &quot;128Mi&quot;</span>
<span class="tok-s">        cpu: &quot;100m&quot;</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pod<span class="tok-w"> </span>info-pod</code></pre>
</div>
</div>
</li>
<li>
<p>Observa los logs:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>info-pod</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica variables específicas:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>info-pod<span class="tok-w"> </span>--<span class="tok-w"> </span>sh<span class="tok-w"> </span>-c<span class="tok-w"> </span><span class="tok-s1">&#39;echo $POD_NAME&#39;</span>
kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>info-pod<span class="tok-w"> </span>--<span class="tok-w"> </span>sh<span class="tok-w"> </span>-c<span class="tok-w"> </span><span class="tok-s1">&#39;echo $POD_NAMESPACE&#39;</span>
kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>info-pod<span class="tok-w"> </span>--<span class="tok-w"> </span>sh<span class="tok-w"> </span>-c<span class="tok-w"> </span><span class="tok-s1">&#39;echo $POD_IP&#39;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod con Downward API como volumen:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: downward-volume-pod</span>
<span class="tok-s">  labels:</span>
<span class="tok-s">    tier: backend</span>
<span class="tok-s">    version: v2</span>
<span class="tok-s">  annotations:</span>
<span class="tok-s">    owner: platform-team</span>
<span class="tok-s">    environment: test</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      echo &quot;=== Pod Information (Downward API Volume) ===&quot;</span>
<span class="tok-s">      echo &quot;&quot;</span>
<span class="tok-s">      echo &quot;=== Files ===&quot;</span>
<span class="tok-s">      ls -la /etc/podinfo/</span>
<span class="tok-s">      echo &quot;&quot;</span>
<span class="tok-s">      echo &quot;=== Name ===&quot;</span>
<span class="tok-s">      cat /etc/podinfo/name</span>
<span class="tok-s">      echo &quot;&quot;</span>
<span class="tok-s">      echo &quot;=== Namespace ===&quot;</span>
<span class="tok-s">      cat /etc/podinfo/namespace</span>
<span class="tok-s">      echo &quot;&quot;</span>
<span class="tok-s">      echo &quot;=== Labels ===&quot;</span>
<span class="tok-s">      cat /etc/podinfo/labels</span>
<span class="tok-s">      echo &quot;&quot;</span>
<span class="tok-s">      echo &quot;=== Annotations ===&quot;</span>
<span class="tok-s">      cat /etc/podinfo/annotations</span>
<span class="tok-s">      echo &quot;&quot;</span>
<span class="tok-s">      sleep infinity</span>
<span class="tok-s">    volumeMounts:</span>
<span class="tok-s">    - name: podinfo</span>
<span class="tok-s">      mountPath: /etc/podinfo</span>
<span class="tok-s">  volumes:</span>
<span class="tok-s">  - name: podinfo</span>
<span class="tok-s">    downwardAPI:</span>
<span class="tok-s">      items:</span>
<span class="tok-s">      - path: &quot;name&quot;</span>
<span class="tok-s">        fieldRef:</span>
<span class="tok-s">          fieldPath: metadata.name</span>
<span class="tok-s">      - path: &quot;namespace&quot;</span>
<span class="tok-s">        fieldRef:</span>
<span class="tok-s">          fieldPath: metadata.namespace</span>
<span class="tok-s">      - path: &quot;labels&quot;</span>
<span class="tok-s">        fieldRef:</span>
<span class="tok-s">          fieldPath: metadata.labels</span>
<span class="tok-s">      - path: &quot;annotations&quot;</span>
<span class="tok-s">        fieldRef:</span>
<span class="tok-s">          fieldPath: metadata.annotations</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>downward-volume-pod</code></pre>
</div>
</div>
</li>
<li>
<p>Accede al contenedor y verifica los archivos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>downward-volume-pod<span class="tok-w"> </span>--<span class="tok-w"> </span>cat<span class="tok-w"> </span>/etc/podinfo/name
kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>downward-volume-pod<span class="tok-w"> </span>--<span class="tok-w"> </span>cat<span class="tok-w"> </span>/etc/podinfo/labels</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>info-pod
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>downward-volume-pod</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong></p>
</div>
<div class="paragraph">
<p>El Pod debe acceder a su propia información mediante Downward API sin necesidad de ConfigMaps o Secrets.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Cuándo usarías Downward API en lugar de hardcodear valores?</p>
</li>
<li>
<p>¿Qué información está disponible mediante Downward API?</p>
</li>
<li>
<p>¿Cómo puede una aplicación usar esta información?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_6_8_configmap_multi_archivo_desde_directorio">13.8. Ejercicio 6.8: ConfigMap multi-archivo desde directorio</h3>
<div class="paragraph">
<p><strong>Objetivo:</strong> Crear un ConfigMap desde un directorio completo con múltiples archivos.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong></p>
</div>
<div class="paragraph">
<p>Crea una estructura de directorios con archivos de configuración y úsalos en un ConfigMap.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea una estructura de directorios de configuración:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>mkdir<span class="tok-w"> </span>-p<span class="tok-w"> </span>/tmp/app-config/<span class="tok-o">{</span>services,db,logging<span class="tok-o">}</span>

cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>/tmp/app-config/services/api.conf<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">listen_port 8080</span>
<span class="tok-s">max_connections 1000</span>
<span class="tok-s">timeout 30</span>
<span class="tok-s">enable_compression true</span>
<span class="tok-s">EOF</span>

cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>/tmp/app-config/services/queue.conf<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">broker rabbitmq://localhost</span>
<span class="tok-s">workers 10</span>
<span class="tok-s">prefetch 2</span>
<span class="tok-s">EOF</span>

cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>/tmp/app-config/db/postgres.conf<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">host db-server</span>
<span class="tok-s">port 5432</span>
<span class="tok-s">pool_size 20</span>
<span class="tok-s">ssl true</span>
<span class="tok-s">EOF</span>

cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>/tmp/app-config/logging/main.conf<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">level INFO</span>
<span class="tok-s">format json</span>
<span class="tok-s">output stdout</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea un ConfigMap desde el directorio:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>create<span class="tok-w"> </span>configmap<span class="tok-w"> </span>app-config-dir<span class="tok-w"> </span>--from-file<span class="tok-o">=</span>/tmp/app-config/</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica la estructura del ConfigMap:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>configmap<span class="tok-w"> </span>app-config-dir<span class="tok-w"> </span>-o<span class="tok-w"> </span>yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod que monte el ConfigMap preservando la estructura:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: app-with-config-dir</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      echo &quot;=== Config Directory Structure ===&quot;</span>
<span class="tok-s">      find /etc/app-config -type f | sort</span>
<span class="tok-s">      echo &quot;&quot;</span>
<span class="tok-s">      echo &quot;=== services/api.conf ===&quot;</span>
<span class="tok-s">      cat /etc/app-config/services/api.conf</span>
<span class="tok-s">      echo &quot;&quot;</span>
<span class="tok-s">      echo &quot;=== db/postgres.conf ===&quot;</span>
<span class="tok-s">      cat /etc/app-config/db/postgres.conf</span>
<span class="tok-s">      echo &quot;&quot;</span>
<span class="tok-s">      echo &quot;=== logging/main.conf ===&quot;</span>
<span class="tok-s">      cat /etc/app-config/logging/main.conf</span>
<span class="tok-s">      sleep infinity</span>
<span class="tok-s">    volumeMounts:</span>
<span class="tok-s">    - name: config</span>
<span class="tok-s">      mountPath: /etc/app-config</span>
<span class="tok-s">      readOnly: true</span>
<span class="tok-s">  volumes:</span>
<span class="tok-s">  - name: config</span>
<span class="tok-s">    configMap:</span>
<span class="tok-s">      name: app-config-dir</span>
<span class="tok-s">      defaultMode: 0444</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>app-with-config-dir</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica la estructura dentro del Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>app-with-config-dir<span class="tok-w"> </span>--<span class="tok-w"> </span>find<span class="tok-w"> </span>/etc/app-config<span class="tok-w"> </span>-type<span class="tok-w"> </span>f</code></pre>
</div>
</div>
</li>
<li>
<p>Accede a archivos específicos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>app-with-config-dir<span class="tok-w"> </span>--<span class="tok-w"> </span>cat<span class="tok-w"> </span>/etc/app-config/db/postgres.conf</code></pre>
</div>
</div>
</li>
<li>
<p>Modifica un archivo específico en el ConfigMap:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>patch<span class="tok-w"> </span>configmap<span class="tok-w"> </span>app-config-dir<span class="tok-w"> </span>-p<span class="tok-w"> </span><span class="tok-s1">&#39;{&quot;data&quot;:{&quot;db/postgres.conf&quot;:&quot;host db-server\nport 5432\npool_size 50\nssl true&quot;}}&#39;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que el cambio se propagó:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>sleep<span class="tok-w"> </span><span class="tok-m">2</span>
kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>app-with-config-dir<span class="tok-w"> </span>--<span class="tok-w"> </span>cat<span class="tok-w"> </span>/etc/app-config/db/postgres.conf</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>app-with-config-dir
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>configmap<span class="tok-w"> </span>app-config-dir
rm<span class="tok-w"> </span>-rf<span class="tok-w"> </span>/tmp/app-config</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong></p>
</div>
<div class="paragraph">
<p>El ConfigMap debe preservar la estructura de directorios del archivo original.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Cómo mantiene Kubernetes la estructura de directorios?</p>
</li>
<li>
<p>¿Qué ventajas tiene crear ConfigMap desde directorio?</p>
</li>
<li>
<p>¿Hay límite de tamaño para un ConfigMap?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_6_9_combinando_configmap_y_secret_en_un_pod">13.9. Ejercicio 6.9: Combinando ConfigMap y Secret en un Pod</h3>
<div class="paragraph">
<p><strong>Objetivo:</strong> Usar múltiples ConfigMaps y Secrets en el mismo Pod.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong></p>
</div>
<div class="paragraph">
<p>Crea un Pod que combine tanto datos de configuración (ConfigMap) como datos sensibles (Secret).</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un ConfigMap con configuración no sensible:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>create<span class="tok-w"> </span>configmap<span class="tok-w"> </span>app-config<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--from-literal<span class="tok-o">=</span>app.name<span class="tok-o">=</span>ProductionApp<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--from-literal<span class="tok-o">=</span>app.version<span class="tok-o">=</span><span class="tok-m">2</span>.1.0<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--from-literal<span class="tok-o">=</span>log.level<span class="tok-o">=</span>INFO<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--from-literal<span class="tok-o">=</span>server.port<span class="tok-o">=</span><span class="tok-m">8080</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Secret con datos sensibles:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>create<span class="tok-w"> </span>secret<span class="tok-w"> </span>generic<span class="tok-w"> </span>app-secrets<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--from-literal<span class="tok-o">=</span><span class="tok-nv">api_key</span><span class="tok-o">=</span>sk-live-prod-12345<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--from-literal<span class="tok-o">=</span><span class="tok-nv">jwt_secret</span><span class="tok-o">=</span>jwt_very_secret_key_xyz<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--from-literal<span class="tok-o">=</span><span class="tok-nv">db_password</span><span class="tok-o">=</span>DbP@ssw0rd123!</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod que use ambos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: combined-config-app</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      echo &quot;=== Configuration (Non-sensitive) ===&quot;</span>
<span class="tok-s">      echo &quot;App: $APP_NAME v$APP_VERSION&quot;</span>
<span class="tok-s">      echo &quot;Log Level: $LOG_LEVEL&quot;</span>
<span class="tok-s">      echo &quot;Server Port: $SERVER_PORT&quot;</span>
<span class="tok-s">      echo &quot;&quot;</span>
<span class="tok-s">      echo &quot;=== Secrets (Sensitive) ===&quot;</span>
<span class="tok-s">      echo &quot;API Key: $API_KEY&quot;</span>
<span class="tok-s">      echo &quot;JWT Secret: $JWT_SECRET&quot;</span>
<span class="tok-s">      echo &quot;&quot;</span>
<span class="tok-s">      echo &quot;=== Combined Setup ===&quot;</span>
<span class="tok-s">      echo &quot;Application &#39;$APP_NAME&#39; with:&quot;</span>
<span class="tok-s">      echo &quot;- API Key: $API_KEY&quot;</span>
<span class="tok-s">      echo &quot;- DB Password: $DB_PASSWORD&quot;</span>
<span class="tok-s">      echo &quot;- Server running on port $SERVER_PORT&quot;</span>
<span class="tok-s">      sleep infinity</span>
<span class="tok-s">    env:</span>
<span class="tok-s">    # ConfigMap variables</span>
<span class="tok-s">    - name: APP_NAME</span>
<span class="tok-s">      valueFrom:</span>
<span class="tok-s">        configMapKeyRef:</span>
<span class="tok-s">          name: app-config</span>
<span class="tok-s">          key: app.name</span>
<span class="tok-s">    - name: APP_VERSION</span>
<span class="tok-s">      valueFrom:</span>
<span class="tok-s">        configMapKeyRef:</span>
<span class="tok-s">          name: app-config</span>
<span class="tok-s">          key: app.version</span>
<span class="tok-s">    - name: LOG_LEVEL</span>
<span class="tok-s">      valueFrom:</span>
<span class="tok-s">        configMapKeyRef:</span>
<span class="tok-s">          name: app-config</span>
<span class="tok-s">          key: log.level</span>
<span class="tok-s">    - name: SERVER_PORT</span>
<span class="tok-s">      valueFrom:</span>
<span class="tok-s">        configMapKeyRef:</span>
<span class="tok-s">          name: app-config</span>
<span class="tok-s">          key: server.port</span>
<span class="tok-s">    # Secret variables</span>
<span class="tok-s">    - name: API_KEY</span>
<span class="tok-s">      valueFrom:</span>
<span class="tok-s">        secretKeyRef:</span>
<span class="tok-s">          name: app-secrets</span>
<span class="tok-s">          key: api_key</span>
<span class="tok-s">    - name: JWT_SECRET</span>
<span class="tok-s">      valueFrom:</span>
<span class="tok-s">        secretKeyRef:</span>
<span class="tok-s">          name: app-secrets</span>
<span class="tok-s">          key: jwt_secret</span>
<span class="tok-s">    - name: DB_PASSWORD</span>
<span class="tok-s">      valueFrom:</span>
<span class="tok-s">        secretKeyRef:</span>
<span class="tok-s">          name: app-secrets</span>
<span class="tok-s">          key: db_password</span>
<span class="tok-s">    # ConfigMap volume</span>
<span class="tok-s">    volumeMounts:</span>
<span class="tok-s">    - name: config-files</span>
<span class="tok-s">      mountPath: /etc/config</span>
<span class="tok-s">      readOnly: true</span>
<span class="tok-s">    - name: secret-files</span>
<span class="tok-s">      mountPath: /etc/secrets</span>
<span class="tok-s">      readOnly: true</span>
<span class="tok-s">  volumes:</span>
<span class="tok-s">  - name: config-files</span>
<span class="tok-s">    configMap:</span>
<span class="tok-s">      name: app-config</span>
<span class="tok-s">  - name: secret-files</span>
<span class="tok-s">    secret:</span>
<span class="tok-s">      secretName: app-secrets</span>
<span class="tok-s">      defaultMode: 0400</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pod<span class="tok-w"> </span>combined-config-app
kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>combined-config-app</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica variables de entorno:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>combined-config-app<span class="tok-w"> </span>--<span class="tok-w"> </span>env<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>-E<span class="tok-w"> </span><span class="tok-s2">&quot;APP|LOG|SERVER|API|JWT|DB&quot;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica archivos montados:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>combined-config-app<span class="tok-w"> </span>--<span class="tok-w"> </span>ls<span class="tok-w"> </span>-la<span class="tok-w"> </span>/etc/config/
kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>combined-config-app<span class="tok-w"> </span>--<span class="tok-w"> </span>ls<span class="tok-w"> </span>-la<span class="tok-w"> </span>/etc/secrets/</code></pre>
</div>
</div>
</li>
<li>
<p>Modifica ambos y reinicia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>patch<span class="tok-w"> </span>configmap<span class="tok-w"> </span>app-config<span class="tok-w"> </span>-p<span class="tok-w"> </span><span class="tok-s1">&#39;{&quot;data&quot;:{&quot;app.version&quot;:&quot;2.2.0&quot;}}&#39;</span>
kubectl<span class="tok-w"> </span>patch<span class="tok-w"> </span>secret<span class="tok-w"> </span>app-secrets<span class="tok-w"> </span>-p<span class="tok-w"> </span><span class="tok-s1">&#39;{&quot;data&quot;:{&quot;api_key&quot;:&quot;sk-live-prod-updated&quot;}}&#39;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Elimina y recrea el Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>combined-config-app
kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: combined-config-app</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      echo &quot;Updated Version: $APP_VERSION&quot;</span>
<span class="tok-s">      echo &quot;Updated API Key: $API_KEY&quot;</span>
<span class="tok-s">      sleep infinity</span>
<span class="tok-s">    env:</span>
<span class="tok-s">    - name: APP_VERSION</span>
<span class="tok-s">      valueFrom:</span>
<span class="tok-s">        configMapKeyRef:</span>
<span class="tok-s">          name: app-config</span>
<span class="tok-s">          key: app.version</span>
<span class="tok-s">    - name: API_KEY</span>
<span class="tok-s">      valueFrom:</span>
<span class="tok-s">        secretKeyRef:</span>
<span class="tok-s">          name: app-secrets</span>
<span class="tok-s">          key: api_key</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica los cambios:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>combined-config-app</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>combined-config-app
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>configmap<span class="tok-w"> </span>app-config
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>secret<span class="tok-w"> </span>app-secrets</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong></p>
</div>
<div class="paragraph">
<p>El Pod debe tener acceso tanto a ConfigMaps como a Secrets en variables y volúmenes.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Por qué separar ConfigMap y Secret en lugar de meter todo en un Secret?</p>
</li>
<li>
<p>¿Cómo manejarías la rotación de Secrets?</p>
</li>
<li>
<p>¿Qué estrategia usarías para diferentes ambientes (dev, staging, prod)?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_6_10_docker_registry_secret_para_imagepullsecrets">13.10. Ejercicio 6.10: Docker Registry Secret para ImagePullSecrets</h3>
<div class="paragraph">
<p><strong>Objetivo:</strong> Crear un Secret para autenticarse con un registro Docker privado.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong></p>
</div>
<div class="paragraph">
<p>Crea un Secret Docker Registry y úsalo en un Pod para descargar imágenes de un registro privado.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un Secret para Docker Registry (simulado):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>create<span class="tok-w"> </span>secret<span class="tok-w"> </span>docker-registry<span class="tok-w"> </span>regcred<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--docker-server<span class="tok-o">=</span>docker.example.com<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--docker-username<span class="tok-o">=</span>myuser<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--docker-password<span class="tok-o">=</span>mypassword123<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--docker-email<span class="tok-o">=</span>myuser@example.com</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el Secret:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>secret<span class="tok-w"> </span>regcred
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>secret<span class="tok-w"> </span>regcred<span class="tok-w"> </span>-o<span class="tok-w"> </span>yaml<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>head<span class="tok-w"> </span>-20</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el contenido del Secret:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># El Secret contiene .dockerconfigjson en base64</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>secret<span class="tok-w"> </span>regcred<span class="tok-w"> </span>-o<span class="tok-w"> </span><span class="tok-nv">jsonpath</span><span class="tok-o">=</span><span class="tok-s1">&#39;{.data.\.dockerconfigjson}&#39;</span><span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>base64<span class="tok-w"> </span>-d<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>head<span class="tok-w"> </span>-20</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod que usa ImagePullSecrets:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: private-image-pod</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  imagePullSecrets:</span>
<span class="tok-s">  - name: regcred  # Referencia al Secret Docker</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: docker.example.com/myapp:latest</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      echo &quot;Pod running with private registry image&quot;</span>
<span class="tok-s">      echo &quot;Image: $IMAGE&quot;</span>
<span class="tok-s">      sleep infinity</span>
<span class="tok-s">    env:</span>
<span class="tok-s">    - name: IMAGE</span>
<span class="tok-s">      value: docker.example.com/myapp:latest</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Observa el Pod (probablemente esté en ImagePullBackOff):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pod<span class="tok-w"> </span>private-image-pod
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>pod<span class="tok-w"> </span>private-image-pod
<span class="tok-c1"># Debería mostrar error de imagen no encontrada (expected)</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod alternativo que sí use una imagen válida pero muestra el concepto:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: config-with-auth</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  imagePullSecrets:</span>
<span class="tok-s">  - name: regcred</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: busybox:latest  # Imagen pública para demo</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      echo &quot;=== ImagePullSecret Demo ===&quot;</span>
<span class="tok-s">      echo &quot;&quot;</span>
<span class="tok-s">      echo &quot;Este Pod está configurado para:&quot;</span>
<span class="tok-s">      echo &quot;- Usar Secret &#39;regcred&#39; para autenticación&quot;</span>
<span class="tok-s">      echo &quot;- Descargar desde: docker.example.com&quot;</span>
<span class="tok-s">      echo &quot;&quot;</span>
<span class="tok-s">      echo &quot;En producción:&quot;</span>
<span class="tok-s">      echo &quot;1. Secret contiene credenciales de registro privado&quot;</span>
<span class="tok-s">      echo &quot;2. Kubelet usa Secret para autenticarse&quot;</span>
<span class="tok-s">      echo &quot;3. Solo así puede descargar imágenes privadas&quot;</span>
<span class="tok-s">      sleep infinity</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>config-with-auth</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que el Secret se usó correctamente:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>pod<span class="tok-w"> </span>config-with-auth<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>-i<span class="tok-w"> </span>secret</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Secret alternativo usando kubectl:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Crear manualmente</span>
mkdir<span class="tok-w"> </span>-p<span class="tok-w"> </span>~/.docker
cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>~/.docker/config.json<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">{</span>
<span class="tok-s">  &quot;auths&quot;: {</span>
<span class="tok-s">    &quot;docker.example.com&quot;: {</span>
<span class="tok-s">      &quot;username&quot;: &quot;myuser&quot;,</span>
<span class="tok-s">      &quot;password&quot;: &quot;mypassword123&quot;,</span>
<span class="tok-s">      &quot;email&quot;: &quot;myuser@example.com&quot;,</span>
<span class="tok-s">      &quot;auth&quot;: &quot;bXl1c2VyOm15cGFzc3dvcmQxMjM=&quot;</span>
<span class="tok-s">    }</span>
<span class="tok-s">  }</span>
<span class="tok-s">}</span>
<span class="tok-s">EOF</span>

<span class="tok-c1"># Crear Secret desde el archivo</span>
kubectl<span class="tok-w"> </span>create<span class="tok-w"> </span>secret<span class="tok-w"> </span>generic<span class="tok-w"> </span>dockerconfig-secret<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--from-file<span class="tok-o">=</span>.dockerconfigjson<span class="tok-o">=</span>~/.docker/config.json<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--type<span class="tok-o">=</span>kubernetes.io/dockerconfigjson

<span class="tok-c1"># Verifica</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>secret<span class="tok-w"> </span>dockerconfig-secret<span class="tok-w"> </span>-o<span class="tok-w"> </span>yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>private-image-pod
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>config-with-auth
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>secret<span class="tok-w"> </span>regcred
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>secret<span class="tok-w"> </span>dockerconfig-secret
rm<span class="tok-w"> </span>-rf<span class="tok-w"> </span>~/.docker/config.json</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong></p>
</div>
<div class="paragraph">
<p>El Secret debe contener credenciales para autenticar con registro Docker privado.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Por qué necesitas ImagePullSecrets para registros privados?</p>
</li>
<li>
<p>¿Cómo Kubernetes utiliza las credenciales?</p>
</li>
<li>
<p>¿Cuál es la diferencia entre .dockerconfig y .dockerconfigjson?</p>
</li>
</ol>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resumen_de_conceptos_6">14. Resumen de Conceptos</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Estos ejercicios del Módulo 6 cubren:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Ejercicio 6.1</strong>: ConfigMap básico con literales</p>
</li>
<li>
<p><strong>Ejercicio 6.2</strong>: ConfigMap desde archivos</p>
</li>
<li>
<p><strong>Ejercicio 6.3</strong>: envFrom para inyección bulk</p>
</li>
<li>
<p><strong>Ejercicio 6.4</strong>: Secret básico</p>
</li>
<li>
<p><strong>Ejercicio 6.5</strong>: Secret como volumen (más seguro)</p>
</li>
<li>
<p><strong>Ejercicio 6.6</strong>: Secret YAML declarativo</p>
</li>
<li>
<p><strong>Ejercicio 6.7</strong>: Downward API</p>
</li>
<li>
<p><strong>Ejercicio 6.8</strong>: ConfigMap multi-archivo desde directorio</p>
</li>
<li>
<p><strong>Ejercicio 6.9</strong>: Combinando ConfigMap y Secret</p>
</li>
<li>
<p><strong>Ejercicio 6.10</strong>: Docker Registry Secret (ImagePullSecrets)</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_próximos_pasos_3">15. Próximos Pasos</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Una vez completes estos ejercicios, estarás listo para:
* Módulo 7: Seguridad (RBAC, NetworkPolicies, Pod Security)
* Módulo 8: Observabilidad (Logging, Monitoring)
* Módulo 9: Escalado y Performance
* Y módulos posteriores&#8230;&#8203;</p>
</div>
<hr>
</div>
</div>
<div class="sect1">
<h2 id="_módulo_7_seguridad">16. Módulo 7: Seguridad</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_ejercicio_7_1_creación_de_service_account">16.1. Ejercicio 7.1: Creación de Service Account</h3>
<div class="paragraph">
<p><strong>Objetivo:</strong> Crear y configurar un Service Account en Kubernetes.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong></p>
</div>
<div class="paragraph">
<p>Crea un Service Account y verifica que se genera automáticamente un token JWT para autenticación.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un Service Account declarativamente:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: ServiceAccount</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: myapp-sa</span>
<span class="tok-s">  namespace: default</span>
<span class="tok-s">  annotations:</span>
<span class="tok-s">    description: &quot;Service account for myapp&quot;</span>
<span class="tok-s">automountServiceAccountToken: true</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que el Service Account fue creado:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>serviceaccount
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>sa<span class="tok-w"> </span>myapp-sa<span class="tok-w"> </span>-o<span class="tok-w"> </span>yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que se creó automáticamente un Secret con el token:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>secrets<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>myapp-sa
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>secret<span class="tok-w"> </span>&lt;myapp-sa-token-xxx&gt;<span class="tok-w"> </span>-o<span class="tok-w"> </span>yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Extrae y decodifica el token:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Obtener nombre del secret</span>
<span class="tok-nv">TOKEN_SECRET</span><span class="tok-o">=</span><span class="tok-k">$(</span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>sa<span class="tok-w"> </span>myapp-sa<span class="tok-w"> </span>-o<span class="tok-w"> </span><span class="tok-nv">jsonpath</span><span class="tok-o">=</span><span class="tok-s1">&#39;{.secrets[0].name}&#39;</span><span class="tok-k">)</span>
<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;Token Secret: </span><span class="tok-nv">$TOKEN_SECRET</span><span class="tok-s2">&quot;</span>

<span class="tok-c1"># Obtener token en base64</span>
<span class="tok-nv">TOKEN_B64</span><span class="tok-o">=</span><span class="tok-k">$(</span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>secret<span class="tok-w"> </span><span class="tok-nv">$TOKEN_SECRET</span><span class="tok-w"> </span>-o<span class="tok-w"> </span><span class="tok-nv">jsonpath</span><span class="tok-o">=</span><span class="tok-s1">&#39;{.data.token}&#39;</span><span class="tok-k">)</span>

<span class="tok-c1"># Decodificar</span>
<span class="tok-nv">TOKEN</span><span class="tok-o">=</span><span class="tok-k">$(</span><span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-nv">$TOKEN_B64</span><span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>base64<span class="tok-w"> </span>-d<span class="tok-k">)</span>
<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;Token: </span><span class="tok-nv">$TOKEN</span><span class="tok-s2">&quot;</span>

<span class="tok-c1"># Decodificar payload del JWT (segunda parte)</span>
<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-nv">$TOKEN</span><span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>cut<span class="tok-w"> </span>-d.<span class="tok-w"> </span>-f2<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>base64<span class="tok-w"> </span>-d<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>head<span class="tok-w"> </span>-c<span class="tok-w"> </span><span class="tok-m">100</span>
<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;&quot;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod que use este Service Account:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: myapp-pod</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  serviceAccountName: myapp-sa</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      echo &quot;=== Service Account Information ===&quot;</span>
<span class="tok-s">      echo &quot;Service Account: $(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace)&quot;</span>
<span class="tok-s">      echo &quot;&quot;</span>
<span class="tok-s">      echo &quot;=== Token Available ===&quot;</span>
<span class="tok-s">      TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)</span>
<span class="tok-s">      echo &quot;Token (first 50 chars): ${TOKEN:0:50}...&quot;</span>
<span class="tok-s">      echo &quot;&quot;</span>
<span class="tok-s">      echo &quot;=== CA Certificate Available ===&quot;</span>
<span class="tok-s">      ls -la /var/run/secrets/kubernetes.io/serviceaccount/</span>
<span class="tok-s">      sleep infinity</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que el token está disponible en el Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>myapp-pod
kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>myapp-pod<span class="tok-w"> </span>--<span class="tok-w"> </span>cat<span class="tok-w"> </span>/var/run/secrets/kubernetes.io/serviceaccount/namespace</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Service Account sin automountaje:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: ServiceAccount</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: notoken-sa</span>
<span class="tok-s">automountServiceAccountToken: false</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod con automountaje deshabilitado:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: notoken-pod</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  serviceAccountName: notoken-sa</span>
<span class="tok-s">  automountServiceAccountToken: false</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      echo &quot;Token directory:&quot;</span>
<span class="tok-s">      ls -la /var/run/secrets/kubernetes.io/serviceaccount/ 2&gt;&amp;1</span>
<span class="tok-s">      echo &quot;Result: Token NO está montado&quot;</span>
<span class="tok-s">      sleep infinity</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que no hay token:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>notoken-pod</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>myapp-pod
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>notoken-pod
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>sa<span class="tok-w"> </span>myapp-sa
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>sa<span class="tok-w"> </span>notoken-sa</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong></p>
</div>
<div class="paragraph">
<p>El Service Account debe tener un token JWT automáticamente creado y disponible en los Pods.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Por qué cada Service Account necesita un token?</p>
</li>
<li>
<p>¿Cuándo deshabilitarías automountServiceAccountToken?</p>
</li>
<li>
<p>¿Cómo se autentica un Pod con la API de Kubernetes?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_7_2_role_y_rolebinding_básico">16.2. Ejercicio 7.2: Role y RoleBinding básico</h3>
<div class="paragraph">
<p><strong>Objetivo:</strong> Crear un Role con permisos limitados y vincularlo a un Service Account.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong></p>
</div>
<div class="paragraph">
<p>Crea un Role que permite solo leer Pods y un RoleBinding que vincula ese Role a un Service Account.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un Role con permisos de solo lectura:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: rbac.authorization.k8s.io/v1</span>
<span class="tok-s">kind: Role</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: pod-reader</span>
<span class="tok-s">  namespace: default</span>
<span class="tok-s">rules:</span>
<span class="tok-s"># Regla 1: Permite leer pods</span>
<span class="tok-s">- apiGroups: [&quot;&quot;]</span>
<span class="tok-s">  resources: [&quot;pods&quot;]</span>
<span class="tok-s">  verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;]</span>
<span class="tok-s"># Regla 2: Permite leer logs</span>
<span class="tok-s">- apiGroups: [&quot;&quot;]</span>
<span class="tok-s">  resources: [&quot;pods/log&quot;]</span>
<span class="tok-s">  verbs: [&quot;get&quot;]</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que el Role fue creado:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>role
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>role<span class="tok-w"> </span>pod-reader<span class="tok-w"> </span>-o<span class="tok-w"> </span>yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Service Account:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>create<span class="tok-w"> </span>serviceaccount<span class="tok-w"> </span>pod-reader-sa</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un RoleBinding que vincula Role a Service Account:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: rbac.authorization.k8s.io/v1</span>
<span class="tok-s">kind: RoleBinding</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: read-pods</span>
<span class="tok-s">  namespace: default</span>
<span class="tok-s">roleRef:</span>
<span class="tok-s">  apiGroup: rbac.authorization.k8s.io</span>
<span class="tok-s">  kind: Role</span>
<span class="tok-s">  name: pod-reader</span>
<span class="tok-s">subjects:</span>
<span class="tok-s">- kind: ServiceAccount</span>
<span class="tok-s">  name: pod-reader-sa</span>
<span class="tok-s">  namespace: default</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que el RoleBinding fue creado:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>rolebinding
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>rolebinding<span class="tok-w"> </span>read-pods</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod que use el Service Account y acceda a la API:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: api-client</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  serviceAccountName: pod-reader-sa</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: client</span>
<span class="tok-s">    image: curlimages/curl:latest</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      # Leer credenciales</span>
<span class="tok-s">      TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)</span>
<span class="tok-s">      CA=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span>
<span class="tok-s">      NS=$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace)</span>

<span class="tok-s">      echo &quot;=== Service Account Permissions ===&quot;</span>
<span class="tok-s">      echo &quot;Namespace: $NS&quot;</span>
<span class="tok-s">      echo &quot;Token: ${TOKEN:0:50}...&quot;</span>
<span class="tok-s">      echo &quot;&quot;</span>
<span class="tok-s">      echo &quot;=== Testing API Access ===&quot;</span>
<span class="tok-s">      echo &quot;Listing Pods (permitted):&quot;</span>
<span class="tok-s">      curl -s -H &quot;Authorization: Bearer $TOKEN&quot; \</span>
<span class="tok-s">        --cacert $CA \</span>
<span class="tok-s">        https://kubernetes.default.svc.cluster.local/api/v1/namespaces/$NS/pods | grep &#39;&quot;name&quot;&#39; | head -3</span>

<span class="tok-s">      sleep infinity</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que el Pod puede acceder a Pods:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>-f<span class="tok-w"> </span>api-client</code></pre>
</div>
</div>
</li>
<li>
<p>Intenta crear un Pod que trate de crear recursos (debe fallar):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: api-create-attempt</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  serviceAccountName: pod-reader-sa</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: client</span>
<span class="tok-s">    image: curlimages/curl:latest</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)</span>
<span class="tok-s">      CA=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span>
<span class="tok-s">      NS=$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace)</span>

<span class="tok-s">      echo &quot;=== Attempting to CREATE Pod (should fail) ===&quot;</span>
<span class="tok-s">      curl -s -X POST \</span>
<span class="tok-s">        -H &quot;Authorization: Bearer $TOKEN&quot; \</span>
<span class="tok-s">        -H &quot;Content-Type: application/json&quot; \</span>
<span class="tok-s">        --cacert $CA \</span>
<span class="tok-s">        https://kubernetes.default.svc.cluster.local/api/v1/namespaces/$NS/pods \</span>
<span class="tok-s">        -d &#39;{&quot;apiVersion&quot;:&quot;v1&quot;,&quot;kind&quot;:&quot;Pod&quot;,&quot;metadata&quot;:{&quot;name&quot;:&quot;test&quot;}}&#39; | jq .</span>

<span class="tok-s">      sleep infinity</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el error de permiso:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>api-create-attempt<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>-i<span class="tok-w"> </span><span class="tok-s2">&quot;forbidden\|error&quot;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>api-client
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>api-create-attempt
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>rolebinding<span class="tok-w"> </span>read-pods
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>role<span class="tok-w"> </span>pod-reader
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>sa<span class="tok-w"> </span>pod-reader-sa</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong></p>
</div>
<div class="paragraph">
<p>El Pod debe poder leer Pods pero no crearlos.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Cuál es la diferencia entre Role y ClusterRole?</p>
</li>
<li>
<p>¿Por qué necesitas vincular un Role a través de RoleBinding?</p>
</li>
<li>
<p>¿Qué pasaría si no especificaras namespace en el RoleBinding?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_7_3_clusterrole_y_clusterrolebinding">16.3. Ejercicio 7.3: ClusterRole y ClusterRoleBinding</h3>
<div class="paragraph">
<p><strong>Objetivo:</strong> Crear un ClusterRole que se aplique a todo el cluster.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong></p>
</div>
<div class="paragraph">
<p>Crea un ClusterRole que permite leer Pods en todos los namespaces y vincularlo a un Service Account.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un ClusterRole:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: rbac.authorization.k8s.io/v1</span>
<span class="tok-s">kind: ClusterRole</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: pod-viewer</span>
<span class="tok-s">rules:</span>
<span class="tok-s">- apiGroups: [&quot;&quot;]</span>
<span class="tok-s">  resources: [&quot;pods&quot;]</span>
<span class="tok-s">  verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;]</span>
<span class="tok-s">- apiGroups: [&quot;&quot;]</span>
<span class="tok-s">  resources: [&quot;pods/log&quot;]</span>
<span class="tok-s">  verbs: [&quot;get&quot;]</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que el ClusterRole fue creado:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>clusterrole<span class="tok-w"> </span>pod-viewer<span class="tok-w"> </span>-o<span class="tok-w"> </span>yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Service Account:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>create<span class="tok-w"> </span>serviceaccount<span class="tok-w"> </span>cluster-viewer-sa</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un ClusterRoleBinding:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: rbac.authorization.k8s.io/v1</span>
<span class="tok-s">kind: ClusterRoleBinding</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: view-all-pods</span>
<span class="tok-s">roleRef:</span>
<span class="tok-s">  apiGroup: rbac.authorization.k8s.io</span>
<span class="tok-s">  kind: ClusterRole</span>
<span class="tok-s">  name: pod-viewer</span>
<span class="tok-s">subjects:</span>
<span class="tok-s">- kind: ServiceAccount</span>
<span class="tok-s">  name: cluster-viewer-sa</span>
<span class="tok-s">  namespace: default</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea otro namespace para probar:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>create<span class="tok-w"> </span>namespace<span class="tok-w"> </span>test-ns</code></pre>
</div>
</div>
</li>
<li>
<p>Crea Pods en ambos namespaces:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>run<span class="tok-w"> </span>pod-default<span class="tok-w"> </span>--image<span class="tok-o">=</span>busybox<span class="tok-w"> </span>--command<span class="tok-w"> </span>--<span class="tok-w"> </span>sleep<span class="tok-w"> </span><span class="tok-m">3600</span>
kubectl<span class="tok-w"> </span>run<span class="tok-w"> </span>pod-test<span class="tok-w"> </span>--image<span class="tok-o">=</span>busybox<span class="tok-w"> </span>-n<span class="tok-w"> </span>test-ns<span class="tok-w"> </span>--command<span class="tok-w"> </span>--<span class="tok-w"> </span>sleep<span class="tok-w"> </span><span class="tok-m">3600</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod en el namespace default que liste Pods en TODOS los namespaces:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: cluster-reader</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  serviceAccountName: cluster-viewer-sa</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: reader</span>
<span class="tok-s">    image: curlimages/curl:latest</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)</span>
<span class="tok-s">      CA=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span>

<span class="tok-s">      echo &quot;=== ClusterRole Access ===&quot;</span>
<span class="tok-s">      echo &quot;Listing Pods in default namespace:&quot;</span>
<span class="tok-s">      curl -s -H &quot;Authorization: Bearer $TOKEN&quot; \</span>
<span class="tok-s">        --cacert $CA \</span>
<span class="tok-s">        https://kubernetes.default.svc.cluster.local/api/v1/pods | jq &#39;.items[] | .metadata | {name, namespace}&#39; | head -10</span>

<span class="tok-s">      echo &quot;&quot;</span>
<span class="tok-s">      echo &quot;Listing Pods in test-ns namespace:&quot;</span>
<span class="tok-s">      curl -s -H &quot;Authorization: Bearer $TOKEN&quot; \</span>
<span class="tok-s">        --cacert $CA \</span>
<span class="tok-s">        https://kubernetes.default.svc.cluster.local/api/v1/namespaces/test-ns/pods | jq &#39;.items[] | .metadata | {name, namespace}&#39; | head -5</span>

<span class="tok-s">      sleep infinity</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica acceso a múltiples namespaces:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>cluster-reader</code></pre>
</div>
</div>
</li>
<li>
<p>Compara con un Role normal (solo un namespace):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: rbac.authorization.k8s.io/v1</span>
<span class="tok-s">kind: Role</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: namespace-viewer</span>
<span class="tok-s">  namespace: default</span>
<span class="tok-s">rules:</span>
<span class="tok-s">- apiGroups: [&quot;&quot;]</span>
<span class="tok-s">  resources: [&quot;pods&quot;]</span>
<span class="tok-s">  verbs: [&quot;get&quot;, &quot;list&quot;]</span>
<span class="tok-s">---</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: ServiceAccount</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: namespace-viewer-sa</span>
<span class="tok-s">  namespace: default</span>
<span class="tok-s">---</span>
<span class="tok-s">apiVersion: rbac.authorization.k8s.io/v1</span>
<span class="tok-s">kind: RoleBinding</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: view-ns-pods</span>
<span class="tok-s">  namespace: default</span>
<span class="tok-s">roleRef:</span>
<span class="tok-s">  apiGroup: rbac.authorization.k8s.io</span>
<span class="tok-s">  kind: Role</span>
<span class="tok-s">  name: namespace-viewer</span>
<span class="tok-s">subjects:</span>
<span class="tok-s">- kind: ServiceAccount</span>
<span class="tok-s">  name: namespace-viewer-sa</span>
<span class="tok-s">  namespace: default</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>cluster-reader
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>pod-default
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>pod-test<span class="tok-w"> </span>-n<span class="tok-w"> </span>test-ns
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>clusterrolebinding<span class="tok-w"> </span>view-all-pods
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>clusterrole<span class="tok-w"> </span>pod-viewer
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>sa<span class="tok-w"> </span>cluster-viewer-sa
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>rolebinding<span class="tok-w"> </span>view-ns-pods<span class="tok-w"> </span>-n<span class="tok-w"> </span>default
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>role<span class="tok-w"> </span>namespace-viewer<span class="tok-w"> </span>-n<span class="tok-w"> </span>default
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>sa<span class="tok-w"> </span>namespace-viewer-sa<span class="tok-w"> </span>-n<span class="tok-w"> </span>default
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>namespace<span class="tok-w"> </span>test-ns</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong></p>
</div>
<div class="paragraph">
<p>El ClusterRole debe permitir acceso a Pods en todos los namespaces.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Cuándo usarías ClusterRole en lugar de Role?</p>
</li>
<li>
<p>¿Qué riesgos de seguridad tiene un ClusterRole muy permisivo?</p>
</li>
<li>
<p>¿Cómo limitarías un ClusterRole para solo leer?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_7_4_rbac_con_usuarios_y_grupos">16.4. Ejercicio 7.4: RBAC con Usuarios y Grupos</h3>
<div class="paragraph">
<p><strong>Objetivo:</strong> Usar RBAC no solo para Service Accounts sino también para usuarios humanos.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong></p>
</div>
<div class="paragraph">
<p>Crea un RoleBinding que otorgue permisos a un usuario específico y a un grupo.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un Role:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: rbac.authorization.k8s.io/v1</span>
<span class="tok-s">kind: Role</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: developer-role</span>
<span class="tok-s">  namespace: default</span>
<span class="tok-s">rules:</span>
<span class="tok-s">- apiGroups: [&quot;&quot;]</span>
<span class="tok-s">  resources: [&quot;pods&quot;, &quot;services&quot;]</span>
<span class="tok-s">  verbs: [&quot;get&quot;, &quot;list&quot;, &quot;create&quot;, &quot;update&quot;, &quot;patch&quot;]</span>
<span class="tok-s">- apiGroups: [&quot;apps&quot;]</span>
<span class="tok-s">  resources: [&quot;deployments&quot;]</span>
<span class="tok-s">  verbs: [&quot;get&quot;, &quot;list&quot;]</span>
<span class="tok-s">- apiGroups: [&quot;&quot;]</span>
<span class="tok-s">  resources: [&quot;pods/log&quot;]</span>
<span class="tok-s">  verbs: [&quot;get&quot;]</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea un RoleBinding para un usuario específico:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: rbac.authorization.k8s.io/v1</span>
<span class="tok-s">kind: RoleBinding</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: developer-access</span>
<span class="tok-s">  namespace: default</span>
<span class="tok-s">roleRef:</span>
<span class="tok-s">  apiGroup: rbac.authorization.k8s.io</span>
<span class="tok-s">  kind: Role</span>
<span class="tok-s">  name: developer-role</span>
<span class="tok-s">subjects:</span>
<span class="tok-s"># Usuario específico</span>
<span class="tok-s">- kind: User</span>
<span class="tok-s">  name: alice@example.com</span>
<span class="tok-s">  apiGroup: rbac.authorization.k8s.io</span>
<span class="tok-s"># Grupo de usuarios</span>
<span class="tok-s">- kind: Group</span>
<span class="tok-s">  name: developers</span>
<span class="tok-s">  apiGroup: rbac.authorization.k8s.io</span>
<span class="tok-s"># También un Service Account</span>
<span class="tok-s">- kind: ServiceAccount</span>
<span class="tok-s">  name: dev-sa</span>
<span class="tok-s">  namespace: default</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el RoleBinding:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>rolebinding<span class="tok-w"> </span>developer-access<span class="tok-w"> </span>-o<span class="tok-w"> </span>yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Service Account para la prueba:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>create<span class="tok-w"> </span>serviceaccount<span class="tok-w"> </span>dev-sa</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod con el Service Account dev-sa:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: dev-pod</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  serviceAccountName: dev-sa</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: dev</span>
<span class="tok-s">    image: curlimages/curl:latest</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)</span>
<span class="tok-s">      CA=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span>
<span class="tok-s">      NS=$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace)</span>

<span class="tok-s">      echo &quot;=== Developer Permissions ===&quot;</span>
<span class="tok-s">      echo &quot;Listing Pods (allowed):&quot;</span>
<span class="tok-s">      curl -s -H &quot;Authorization: Bearer $TOKEN&quot; \</span>
<span class="tok-s">        --cacert $CA \</span>
<span class="tok-s">        https://kubernetes.default.svc.cluster.local/api/v1/namespaces/$NS/pods | jq &#39;.items | length&#39;</span>

<span class="tok-s">      echo &quot;Pods listed successfully&quot;</span>
<span class="tok-s">      sleep infinity</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica los permisos del Service Account:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>dev-pod</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un segundo Role más restrictivo:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: rbac.authorization.k8s.io/v1</span>
<span class="tok-s">kind: Role</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: viewer-role</span>
<span class="tok-s">  namespace: default</span>
<span class="tok-s">rules:</span>
<span class="tok-s">- apiGroups: [&quot;&quot;]</span>
<span class="tok-s">  resources: [&quot;pods&quot;]</span>
<span class="tok-s">  verbs: [&quot;get&quot;, &quot;list&quot;]</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea un RoleBinding que solo otorgue permisos de lectura:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: rbac.authorization.k8s.io/v1</span>
<span class="tok-s">kind: RoleBinding</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: viewer-access</span>
<span class="tok-s">  namespace: default</span>
<span class="tok-s">roleRef:</span>
<span class="tok-s">  apiGroup: rbac.authorization.k8s.io</span>
<span class="tok-s">  kind: Role</span>
<span class="tok-s">  name: viewer-role</span>
<span class="tok-s">subjects:</span>
<span class="tok-s">- kind: Group</span>
<span class="tok-s">  name: viewers</span>
<span class="tok-s">  apiGroup: rbac.authorization.k8s.io</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica ambos bindings:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>rolebinding
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>rolebinding<span class="tok-w"> </span>developer-access
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>rolebinding<span class="tok-w"> </span>viewer-access</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>dev-pod
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>rolebinding<span class="tok-w"> </span>developer-access<span class="tok-w"> </span>viewer-access
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>role<span class="tok-w"> </span>developer-role<span class="tok-w"> </span>viewer-role
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>sa<span class="tok-w"> </span>dev-sa</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong></p>
</div>
<div class="paragraph">
<p>El RoleBinding debe permitir acceso a usuarios, grupos y Service Accounts.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Cómo se mapean los usuarios en Kubernetes con identidades reales?</p>
</li>
<li>
<p>¿Cuál es la diferencia entre User y Group en RBAC?</p>
</li>
<li>
<p>¿Cómo implementarías la rotación de usuarios?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_7_5_security_context_ejecutar_como_usuario_no_root">16.5. Ejercicio 7.5: Security Context - Ejecutar como usuario no-root</h3>
<div class="paragraph">
<p><strong>Objetivo:</strong> Usar Security Context para ejecutar contenedores como usuario no-root.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong></p>
</div>
<div class="paragraph">
<p>Crea un Pod con Security Context que ejecuta el contenedor con UID específico, no como root.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un Pod con Security Context a nivel de Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: non-root-pod</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  securityContext:</span>
<span class="tok-s">    runAsUser: 1000      # UID</span>
<span class="tok-s">    runAsGroup: 3000     # GID</span>
<span class="tok-s">    fsGroup: 2000        # Grupo para volúmenes</span>

<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      echo &quot;=== Security Context Information ===&quot;</span>
<span class="tok-s">      echo &quot;Current UID: $(id -u)&quot;</span>
<span class="tok-s">      echo &quot;Current GID: $(id -g)&quot;</span>
<span class="tok-s">      echo &quot;Current User: $(id)&quot;</span>
<span class="tok-s">      echo &quot;&quot;</span>
<span class="tok-s">      echo &quot;=== File System Group ===&quot;</span>
<span class="tok-s">      echo &quot;fsGroup setting: Afecta permisos de volúmenes&quot;</span>
<span class="tok-s">      sleep infinity</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el usuario ejecutando:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>non-root-pod</code></pre>
</div>
</div>
</li>
<li>
<p>Accede al Pod y verifica identidad:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>non-root-pod<span class="tok-w"> </span>--<span class="tok-w"> </span>id
kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>non-root-pod<span class="tok-w"> </span>--<span class="tok-w"> </span>whoami</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod con Security Context a nivel de contenedor:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: container-security-pod</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    securityContext:</span>
<span class="tok-s">      runAsUser: 2000</span>
<span class="tok-s">      readOnlyRootFilesystem: true</span>
<span class="tok-s">    volumeMounts:</span>
<span class="tok-s">    - name: writable</span>
<span class="tok-s">      mountPath: /tmp</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      echo &quot;=== Container Security Context ===&quot;</span>
<span class="tok-s">      echo &quot;UID: $(id -u)&quot;</span>
<span class="tok-s">      echo &quot;Root filesystem is read-only&quot;</span>
<span class="tok-s">      echo &quot;Only /tmp is writable&quot;</span>
<span class="tok-s">      echo &quot;&quot;</span>
<span class="tok-s">      echo &quot;Test write to /tmp:&quot;</span>
<span class="tok-s">      echo &quot;test data&quot; &gt; /tmp/test.txt &amp;&amp; cat /tmp/test.txt</span>
<span class="tok-s">      sleep infinity</span>

<span class="tok-s">  volumes:</span>
<span class="tok-s">  - name: writable</span>
<span class="tok-s">    emptyDir: {}</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>container-security-pod</code></pre>
</div>
</div>
</li>
<li>
<p>Intenta escribir en raíz (debe fallar):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>container-security-pod<span class="tok-w"> </span>--<span class="tok-w"> </span>sh<span class="tok-w"> </span>-c<span class="tok-w"> </span><span class="tok-s1">&#39;echo test &gt; /test.txt&#39;</span>
<span class="tok-c1"># Debería fallar: Read-only file system</span></code></pre>
</div>
</div>
</li>
<li>
<p>Escribe en /tmp (debe funcionar):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>container-security-pod<span class="tok-w"> </span>--<span class="tok-w"> </span>sh<span class="tok-w"> </span>-c<span class="tok-w"> </span><span class="tok-s1">&#39;echo test &gt; /tmp/test.txt &amp;&amp; cat /tmp/test.txt&#39;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod que intenta ejecutarse como root (inseguro):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: root-pod</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      echo &quot;=== Running as root (INSECURE) ===&quot;</span>
<span class="tok-s">      echo &quot;UID: $(id -u)&quot;</span>
<span class="tok-s">      echo &quot;GID: $(id -g)&quot;</span>
<span class="tok-s">      sleep infinity</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que corre como root:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>root-pod</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>non-root-pod
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>container-security-pod
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>root-pod</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong></p>
</div>
<div class="paragraph">
<p>El Pod debe ejecutarse con el UID especificado, no como root.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Por qué es importante ejecutar como no-root?</p>
</li>
<li>
<p>¿Cuál es la diferencia entre runAsUser y fsGroup?</p>
</li>
<li>
<p>¿Qué es readOnlyRootFilesystem?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_7_6_capabilities_de_linux_en_security_context">16.6. Ejercicio 7.6: Capabilities de Linux en Security Context</h3>
<div class="paragraph">
<p><strong>Objetivo:</strong> Usar Security Context para limitar capabilities de Linux.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong></p>
</div>
<div class="paragraph">
<p>Crea un Pod con capabilities limitadas para mejorar la seguridad.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un Pod con capabilities limitadas:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: limited-caps-pod</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    securityContext:</span>
<span class="tok-s">      capabilities:</span>
<span class="tok-s">        drop:</span>
<span class="tok-s">        - ALL</span>
<span class="tok-s">        add:</span>
<span class="tok-s">        - NET_BIND_SERVICE</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      echo &quot;=== Capabilities ===&quot;</span>
<span class="tok-s">      echo &quot;Dropped: ALL (excepto las agregadas)&quot;</span>
<span class="tok-s">      echo &quot;Added: NET_BIND_SERVICE&quot;</span>
<span class="tok-s">      echo &quot;&quot;</span>
<span class="tok-s">      echo &quot;Pod puede bindear puertos &lt; 1024&quot;</span>
<span class="tok-s">      echo &quot;Pero no puede hacer otras operaciones privilegiadas&quot;</span>
<span class="tok-s">      sleep infinity</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>limited-caps-pod</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod con privilegios completos (inseguro):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: privileged-pod</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    securityContext:</span>
<span class="tok-s">      privileged: true</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      echo &quot;=== Privileged Container (INSECURE) ===&quot;</span>
<span class="tok-s">      echo &quot;Privileged: true&quot;</span>
<span class="tok-s">      echo &quot;Acceso a todos los dispositivos&quot;</span>
<span class="tok-s">      echo &quot;Acceso sin restricciones al host&quot;</span>
<span class="tok-s">      sleep infinity</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el Pod privilegiado:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>privileged-pod</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod con allowPrivilegeEscalation = false:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: no-escalation-pod</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    securityContext:</span>
<span class="tok-s">      allowPrivilegeEscalation: false</span>
<span class="tok-s">      runAsUser: 1000</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      echo &quot;=== Privilege Escalation Prevention ===&quot;</span>
<span class="tok-s">      echo &quot;allowPrivilegeEscalation: false&quot;</span>
<span class="tok-s">      echo &quot;No puede usar setuid binarios para escalar&quot;</span>
<span class="tok-s">      echo &quot;Running as UID: $(id -u)&quot;</span>
<span class="tok-s">      sleep infinity</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>no-escalation-pod</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod con capabilities específicas:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: custom-caps-pod</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    securityContext:</span>
<span class="tok-s">      capabilities:</span>
<span class="tok-s">        add:</span>
<span class="tok-s">        - NET_BIND_SERVICE</span>
<span class="tok-s">        - NET_RAW</span>
<span class="tok-s">        - CHOWN</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      echo &quot;=== Custom Capabilities ===&quot;</span>
<span class="tok-s">      echo &quot;Added capabilities:&quot;</span>
<span class="tok-s">      echo &quot;- NET_BIND_SERVICE: Bindear puertos &lt; 1024&quot;</span>
<span class="tok-s">      echo &quot;- NET_RAW: Usar raw sockets&quot;</span>
<span class="tok-s">      echo &quot;- CHOWN: Cambiar propietario de archivos&quot;</span>
<span class="tok-s">      sleep infinity</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>custom-caps-pod</code></pre>
</div>
</div>
</li>
<li>
<p>Describe el Pod para ver capabilities:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>pod<span class="tok-w"> </span>limited-caps-pod<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>-A<span class="tok-w"> </span><span class="tok-m">5</span><span class="tok-w"> </span>Securitycontext</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>limited-caps-pod
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>privileged-pod
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>no-escalation-pod
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>custom-caps-pod</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong></p>
</div>
<div class="paragraph">
<p>Los Pods deben ejecutarse con capabilities limitadas.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Cuáles son las capabilities más peligrosas?</p>
</li>
<li>
<p>¿Por qué es importante limitar capabilities?</p>
</li>
<li>
<p>¿Qué capabilities son necesarias para la mayoría de aplicaciones?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_7_7_pod_security_policy_simulada_pod_security_standards">16.7. Ejercicio 7.7: Pod Security Policy simulada (Pod Security Standards)</h3>
<div class="paragraph">
<p><strong>Objetivo:</strong> Entender cómo restringir la ejecución de Pods inseguros.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong></p>
</div>
<div class="paragraph">
<p>Aunque PSP está deprecated, crear Pods que cumplan con Pod Security Standards (restricted).</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un Pod que cumple con el estándar "restricted":</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: secure-pod</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  securityContext:</span>
<span class="tok-s">    runAsNonRoot: true</span>
<span class="tok-s">    runAsUser: 1000</span>
<span class="tok-s">    fsGroup: 2000</span>

<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    securityContext:</span>
<span class="tok-s">      allowPrivilegeEscalation: false</span>
<span class="tok-s">      readOnlyRootFilesystem: true</span>
<span class="tok-s">      capabilities:</span>
<span class="tok-s">        drop:</span>
<span class="tok-s">        - ALL</span>
<span class="tok-s">    volumeMounts:</span>
<span class="tok-s">    - name: tmp</span>
<span class="tok-s">      mountPath: /tmp</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      echo &quot;=== Secure Pod (PSS Restricted) ===&quot;</span>
<span class="tok-s">      echo &quot;✓ Running as non-root (UID: $(id -u))&quot;</span>
<span class="tok-s">      echo &quot;✓ allowPrivilegeEscalation: false&quot;</span>
<span class="tok-s">      echo &quot;✓ readOnlyRootFilesystem: true&quot;</span>
<span class="tok-s">      echo &quot;✓ Drop all capabilities&quot;</span>
<span class="tok-s">      sleep infinity</span>

<span class="tok-s">  volumes:</span>
<span class="tok-s">  - name: tmp</span>
<span class="tok-s">    emptyDir: {}</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el Pod seguro:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>secure-pod
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>pod<span class="tok-w"> </span>secure-pod</code></pre>
</div>
</div>
</li>
<li>
<p>Intenta crear un Pod que no cumple (debería funcionar pero es inseguro):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: insecure-pod</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    securityContext:</span>
<span class="tok-s">      privileged: true</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      echo &quot;=== Insecure Pod ===&quot;</span>
<span class="tok-s">      echo &quot;✗ Running as root&quot;</span>
<span class="tok-s">      echo &quot;✗ Privileged: true&quot;</span>
<span class="tok-s">      echo &quot;✗ No capability restrictions&quot;</span>
<span class="tok-s">      sleep infinity</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el Pod inseguro (será creado):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pod<span class="tok-w"> </span>insecure-pod</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod que cumple estándar "baseline":</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: baseline-pod</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  securityContext:</span>
<span class="tok-s">    runAsNonRoot: true</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      echo &quot;=== Baseline Pod ===&quot;</span>
<span class="tok-s">      echo &quot;Running as non-root but with some flexibility&quot;</span>
<span class="tok-s">      sleep infinity</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>baseline-pod</code></pre>
</div>
</div>
</li>
<li>
<p>Compara configuraciones:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;=== Secure Pod ===&quot;</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pod<span class="tok-w"> </span>secure-pod<span class="tok-w"> </span>-o<span class="tok-w"> </span>yaml<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>-A<span class="tok-w"> </span><span class="tok-m">20</span><span class="tok-w"> </span>securityContext

<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;&quot;</span>
<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;=== Insecure Pod ===&quot;</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pod<span class="tok-w"> </span>insecure-pod<span class="tok-w"> </span>-o<span class="tok-w"> </span>yaml<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>-A<span class="tok-w"> </span><span class="tok-m">20</span><span class="tok-w"> </span>securityContext

<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;&quot;</span>
<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;=== Baseline Pod ===&quot;</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pod<span class="tok-w"> </span>baseline-pod<span class="tok-w"> </span>-o<span class="tok-w"> </span>yaml<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>-A<span class="tok-w"> </span><span class="tok-m">20</span><span class="tok-w"> </span>securityContext</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>secure-pod
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>insecure-pod
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>baseline-pod</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong></p>
</div>
<div class="paragraph">
<p>Los Pods seguros deben cumplir con Pod Security Standards restricted.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Cuáles son los tres niveles de Pod Security Standards?</p>
</li>
<li>
<p>¿Por qué fue deprecated Pod Security Policy?</p>
</li>
<li>
<p>¿Cómo implementarías seguridad similar en un cluster?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_7_8_rbac_con_resources_específicas">16.8. Ejercicio 7.8: RBAC con Resources específicas</h3>
<div class="paragraph">
<p><strong>Objetivo:</strong> Limitar permisos a recursos específicos usando resourceNames.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong></p>
</div>
<div class="paragraph">
<p>Crea un Role que solo permite acceso a Pods/Secrets específicas por nombre.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un Service Account:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>create<span class="tok-w"> </span>serviceaccount<span class="tok-w"> </span>limited-sa</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Role que solo accede a una Secret específica:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: rbac.authorization.k8s.io/v1</span>
<span class="tok-s">kind: Role</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: app-secrets-reader</span>
<span class="tok-s">  namespace: default</span>
<span class="tok-s">rules:</span>
<span class="tok-s"># Solo puede leer secrets específicas</span>
<span class="tok-s">- apiGroups: [&quot;&quot;]</span>
<span class="tok-s">  resources: [&quot;secrets&quot;]</span>
<span class="tok-s">  resourceNames: [&quot;app-secret&quot;, &quot;db-secret&quot;]</span>
<span class="tok-s">  verbs: [&quot;get&quot;]</span>
<span class="tok-s"># Puede listar todos los pods</span>
<span class="tok-s">- apiGroups: [&quot;&quot;]</span>
<span class="tok-s">  resources: [&quot;pods&quot;]</span>
<span class="tok-s">  verbs: [&quot;list&quot;]</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Vincula el Role:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: rbac.authorization.k8s.io/v1</span>
<span class="tok-s">kind: RoleBinding</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: app-access</span>
<span class="tok-s">  namespace: default</span>
<span class="tok-s">roleRef:</span>
<span class="tok-s">  apiGroup: rbac.authorization.k8s.io</span>
<span class="tok-s">  kind: Role</span>
<span class="tok-s">  name: app-secrets-reader</span>
<span class="tok-s">subjects:</span>
<span class="tok-s">- kind: ServiceAccount</span>
<span class="tok-s">  name: limited-sa</span>
<span class="tok-s">  namespace: default</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea algunos Secrets:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>create<span class="tok-w"> </span>secret<span class="tok-w"> </span>generic<span class="tok-w"> </span>app-secret<span class="tok-w"> </span>--from-literal<span class="tok-o">=</span><span class="tok-nv">key</span><span class="tok-o">=</span>value1
kubectl<span class="tok-w"> </span>create<span class="tok-w"> </span>secret<span class="tok-w"> </span>generic<span class="tok-w"> </span>db-secret<span class="tok-w"> </span>--from-literal<span class="tok-o">=</span><span class="tok-nv">key</span><span class="tok-o">=</span>value2
kubectl<span class="tok-w"> </span>create<span class="tok-w"> </span>secret<span class="tok-w"> </span>generic<span class="tok-w"> </span>other-secret<span class="tok-w"> </span>--from-literal<span class="tok-o">=</span><span class="tok-nv">key</span><span class="tok-o">=</span>value3</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod que intenta acceder a todos los Secrets:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: limited-access-pod</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  serviceAccountName: limited-sa</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: client</span>
<span class="tok-s">    image: curlimages/curl:latest</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)</span>
<span class="tok-s">      CA=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span>
<span class="tok-s">      NS=$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace)</span>

<span class="tok-s">      echo &quot;=== Resource-Specific RBAC ===&quot;</span>
<span class="tok-s">      echo &quot;&quot;</span>
<span class="tok-s">      echo &quot;Accessing allowed secret (app-secret):&quot;</span>
<span class="tok-s">      curl -s -H &quot;Authorization: Bearer $TOKEN&quot; \</span>
<span class="tok-s">        --cacert $CA \</span>
<span class="tok-s">        https://kubernetes.default.svc.cluster.local/api/v1/namespaces/$NS/secrets/app-secret | jq &#39;.metadata.name&#39;</span>

<span class="tok-s">      echo &quot;&quot;</span>
<span class="tok-s">      echo &quot;Accessing allowed secret (db-secret):&quot;</span>
<span class="tok-s">      curl -s -H &quot;Authorization: Bearer $TOKEN&quot; \</span>
<span class="tok-s">        --cacert $CA \</span>
<span class="tok-s">        https://kubernetes.default.svc.cluster.local/api/v1/namespaces/$NS/secrets/db-secret | jq &#39;.metadata.name&#39;</span>

<span class="tok-s">      echo &quot;&quot;</span>
<span class="tok-s">      echo &quot;Attempting to access forbidden secret (other-secret):&quot;</span>
<span class="tok-s">      curl -s -H &quot;Authorization: Bearer $TOKEN&quot; \</span>
<span class="tok-s">        --cacert $CA \</span>
<span class="tok-s">        https://kubernetes.default.svc.cluster.local/api/v1/namespaces/$NS/secrets/other-secret | jq &#39;.message&#39;</span>

<span class="tok-s">      sleep infinity</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica acceso:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>-f<span class="tok-w"> </span>limited-access-pod<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>head<span class="tok-w"> </span>-20</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Role que solo puede deletear Pods específicas:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: rbac.authorization.k8s.io/v1</span>
<span class="tok-s">kind: Role</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: pod-deleter</span>
<span class="tok-s">  namespace: default</span>
<span class="tok-s">rules:</span>
<span class="tok-s">- apiGroups: [&quot;&quot;]</span>
<span class="tok-s">  resources: [&quot;pods&quot;]</span>
<span class="tok-s">  resourceNames: [&quot;temporary-pod&quot;]</span>
<span class="tok-s">  verbs: [&quot;delete&quot;]</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que el Role es restrictivo:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>role<span class="tok-w"> </span>pod-deleter<span class="tok-w"> </span>-o<span class="tok-w"> </span>yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>limited-access-pod
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>rolebinding<span class="tok-w"> </span>app-access
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>role<span class="tok-w"> </span>app-secrets-reader<span class="tok-w"> </span>pod-deleter
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>sa<span class="tok-w"> </span>limited-sa
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>secret<span class="tok-w"> </span>app-secret<span class="tok-w"> </span>db-secret<span class="tok-w"> </span>other-secret</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong></p>
</div>
<div class="paragraph">
<p>El Service Account debe acceder solo a recursos específicos.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Cómo se especifican recursos específicos en RBAC?</p>
</li>
<li>
<p>¿Cuándo usarías resourceNames?</p>
</li>
<li>
<p>¿Qué riesgos evita la limitación por resourceNames?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_7_9_auditoría_de_rbac">16.9. Ejercicio 7.9: Auditoría de RBAC</h3>
<div class="paragraph">
<p><strong>Objetivo:</strong> Verificar y auditar permisos RBAC en el cluster.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong></p>
</div>
<div class="paragraph">
<p>Usa herramientas para verificar qué permisos tiene un Service Account.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea varios Service Accounts con diferentes permisos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>create<span class="tok-w"> </span>serviceaccount<span class="tok-w"> </span>viewer-sa
kubectl<span class="tok-w"> </span>create<span class="tok-w"> </span>serviceaccount<span class="tok-w"> </span>editor-sa
kubectl<span class="tok-w"> </span>create<span class="tok-w"> </span>serviceaccount<span class="tok-w"> </span>admin-sa</code></pre>
</div>
</div>
</li>
<li>
<p>Crea Roles y RoleBindings:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: rbac.authorization.k8s.io/v1</span>
<span class="tok-s">kind: Role</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: viewer</span>
<span class="tok-s">rules:</span>
<span class="tok-s">- apiGroups: [&quot;&quot;]</span>
<span class="tok-s">  resources: [&quot;pods&quot;, &quot;services&quot;]</span>
<span class="tok-s">  verbs: [&quot;get&quot;, &quot;list&quot;]</span>
<span class="tok-s">---</span>
<span class="tok-s">apiVersion: rbac.authorization.k8s.io/v1</span>
<span class="tok-s">kind: Role</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: editor</span>
<span class="tok-s">rules:</span>
<span class="tok-s">- apiGroups: [&quot;&quot;]</span>
<span class="tok-s">  resources: [&quot;pods&quot;, &quot;services&quot;]</span>
<span class="tok-s">  verbs: [&quot;get&quot;, &quot;list&quot;, &quot;create&quot;, &quot;update&quot;, &quot;patch&quot;]</span>
<span class="tok-s">---</span>
<span class="tok-s">apiVersion: rbac.authorization.k8s.io/v1</span>
<span class="tok-s">kind: RoleBinding</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: viewer-binding</span>
<span class="tok-s">roleRef:</span>
<span class="tok-s">  apiGroup: rbac.authorization.k8s.io</span>
<span class="tok-s">  kind: Role</span>
<span class="tok-s">  name: viewer</span>
<span class="tok-s">subjects:</span>
<span class="tok-s">- kind: ServiceAccount</span>
<span class="tok-s">  name: viewer-sa</span>
<span class="tok-s">---</span>
<span class="tok-s">apiVersion: rbac.authorization.k8s.io/v1</span>
<span class="tok-s">kind: RoleBinding</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: editor-binding</span>
<span class="tok-s">roleRef:</span>
<span class="tok-s">  apiGroup: rbac.authorization.k8s.io</span>
<span class="tok-s">  kind: Role</span>
<span class="tok-s">  name: editor</span>
<span class="tok-s">subjects:</span>
<span class="tok-s">- kind: ServiceAccount</span>
<span class="tok-s">  name: editor-sa</span>
<span class="tok-s">---</span>
<span class="tok-s">apiVersion: rbac.authorization.k8s.io/v1</span>
<span class="tok-s">kind: ClusterRoleBinding</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: admin-binding</span>
<span class="tok-s">roleRef:</span>
<span class="tok-s">  apiGroup: rbac.authorization.k8s.io</span>
<span class="tok-s">  kind: ClusterRole</span>
<span class="tok-s">  name: cluster-admin</span>
<span class="tok-s">subjects:</span>
<span class="tok-s">- kind: ServiceAccount</span>
<span class="tok-s">  name: admin-sa</span>
<span class="tok-s">  namespace: default</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Lista todos los Roles:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;=== Roles in default namespace ===&quot;</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>roles
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>rolebindings

<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;&quot;</span>
<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;=== ClusterRoles ===&quot;</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>clusterroles<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>-E<span class="tok-w"> </span><span class="tok-s2">&quot;(viewer|editor|admin)&quot;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica qué puede hacer cada Service Account:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;=== viewer-sa permissions ===&quot;</span>
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>rolebinding<span class="tok-w"> </span>viewer-binding

<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;&quot;</span>
<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;=== editor-sa permissions ===&quot;</span>
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>rolebinding<span class="tok-w"> </span>editor-binding

<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;&quot;</span>
<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;=== admin-sa permissions ===&quot;</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>clusterrolebinding<span class="tok-w"> </span>admin-binding<span class="tok-w"> </span>-o<span class="tok-w"> </span>yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Usa <code>kubectl auth</code> para verificar permisos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;=== Check if viewer-sa can get pods ===&quot;</span>
kubectl<span class="tok-w"> </span>auth<span class="tok-w"> </span>can-i<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>--as<span class="tok-o">=</span>system:serviceaccount:default:viewer-sa

<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;=== Check if viewer-sa can create pods ===&quot;</span>
kubectl<span class="tok-w"> </span>auth<span class="tok-w"> </span>can-i<span class="tok-w"> </span>create<span class="tok-w"> </span>pods<span class="tok-w"> </span>--as<span class="tok-o">=</span>system:serviceaccount:default:viewer-sa

<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;=== Check if editor-sa can create pods ===&quot;</span>
kubectl<span class="tok-w"> </span>auth<span class="tok-w"> </span>can-i<span class="tok-w"> </span>create<span class="tok-w"> </span>pods<span class="tok-w"> </span>--as<span class="tok-o">=</span>system:serviceaccount:default:editor-sa

<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;=== Check if admin-sa can delete clusterroles ===&quot;</span>
kubectl<span class="tok-w"> </span>auth<span class="tok-w"> </span>can-i<span class="tok-w"> </span>delete<span class="tok-w"> </span>clusterroles<span class="tok-w"> </span>--as<span class="tok-o">=</span>system:serviceaccount:default:admin-sa</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod para auditar desde dentro:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: audit-pod</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  serviceAccountName: viewer-sa</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: auditor</span>
<span class="tok-s">    image: curlimages/curl:latest</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)</span>
<span class="tok-s">      CA=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span>
<span class="tok-s">      NS=$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace)</span>

<span class="tok-s">      echo &quot;=== Auditing viewer-sa ===&quot;</span>
<span class="tok-s">      echo &quot;Attempting allowed action (list pods):&quot;</span>
<span class="tok-s">      curl -s -H &quot;Authorization: Bearer $TOKEN&quot; \</span>
<span class="tok-s">        --cacert $CA \</span>
<span class="tok-s">        https://kubernetes.default.svc.cluster.local/api/v1/namespaces/$NS/pods | jq &#39;.items | length&#39;</span>

<span class="tok-s">      echo &quot;Attempting forbidden action (create pod):&quot;</span>
<span class="tok-s">      curl -s -X POST \</span>
<span class="tok-s">        -H &quot;Authorization: Bearer $TOKEN&quot; \</span>
<span class="tok-s">        -H &quot;Content-Type: application/json&quot; \</span>
<span class="tok-s">        --cacert $CA \</span>
<span class="tok-s">        https://kubernetes.default.svc.cluster.local/api/v1/namespaces/$NS/pods \</span>
<span class="tok-s">        -d &#39;{&quot;apiVersion&quot;:&quot;v1&quot;,&quot;kind&quot;:&quot;Pod&quot;,&quot;metadata&quot;:{&quot;name&quot;:&quot;test&quot;}}&#39; | jq -r &#39;.message // .reason&#39;</span>

<span class="tok-s">      sleep infinity</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica la salida:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>audit-pod</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>audit-pod
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>serviceaccount<span class="tok-w"> </span>viewer-sa<span class="tok-w"> </span>editor-sa<span class="tok-w"> </span>admin-sa
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>roles<span class="tok-w"> </span>viewer<span class="tok-w"> </span>editor
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>rolebindings<span class="tok-w"> </span>viewer-binding<span class="tok-w"> </span>editor-binding
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>clusterrolebinding<span class="tok-w"> </span>admin-binding</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong></p>
</div>
<div class="paragraph">
<p>Debe ser posible auditar y verificar permisos RBAC en el cluster.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Cómo auditas regularmente los permisos RBAC?</p>
</li>
<li>
<p>¿Cuáles son los riesgos de over-privileging?</p>
</li>
<li>
<p>¿Cómo implementarías una política de menor privilegio?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_7_10_namespace_isolation_con_rbac">16.10. Ejercicio 7.10: Namespace Isolation con RBAC</h3>
<div class="paragraph">
<p><strong>Objetivo:</strong> Aislar aplicaciones por namespace usando RBAC.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong></p>
</div>
<div class="paragraph">
<p>Crea dos namespaces con diferentes aplicaciones y limita acceso usando RBAC.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea dos namespaces:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>create<span class="tok-w"> </span>namespace<span class="tok-w"> </span>app-a
kubectl<span class="tok-w"> </span>create<span class="tok-w"> </span>namespace<span class="tok-w"> </span>app-b</code></pre>
</div>
</div>
</li>
<li>
<p>Crea Service Accounts para cada aplicación:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>create<span class="tok-w"> </span>serviceaccount<span class="tok-w"> </span>app-a-sa<span class="tok-w"> </span>-n<span class="tok-w"> </span>app-a
kubectl<span class="tok-w"> </span>create<span class="tok-w"> </span>serviceaccount<span class="tok-w"> </span>app-b-sa<span class="tok-w"> </span>-n<span class="tok-w"> </span>app-b</code></pre>
</div>
</div>
</li>
<li>
<p>Crea Roles específicos para cada namespace:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s"># Role en app-a namespace</span>
<span class="tok-s">apiVersion: rbac.authorization.k8s.io/v1</span>
<span class="tok-s">kind: Role</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: app-a-role</span>
<span class="tok-s">  namespace: app-a</span>
<span class="tok-s">rules:</span>
<span class="tok-s">- apiGroups: [&quot;&quot;]</span>
<span class="tok-s">  resources: [&quot;pods&quot;, &quot;services&quot;]</span>
<span class="tok-s">  verbs: [&quot;get&quot;, &quot;list&quot;, &quot;create&quot;, &quot;update&quot;]</span>
<span class="tok-s">- apiGroups: [&quot;&quot;]</span>
<span class="tok-s">  resources: [&quot;configmaps&quot;]</span>
<span class="tok-s">  verbs: [&quot;get&quot;, &quot;list&quot;]</span>
<span class="tok-s">---</span>
<span class="tok-s"># Role en app-b namespace</span>
<span class="tok-s">apiVersion: rbac.authorization.k8s.io/v1</span>
<span class="tok-s">kind: Role</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: app-b-role</span>
<span class="tok-s">  namespace: app-b</span>
<span class="tok-s">rules:</span>
<span class="tok-s">- apiGroups: [&quot;&quot;]</span>
<span class="tok-s">  resources: [&quot;pods&quot;, &quot;services&quot;]</span>
<span class="tok-s">  verbs: [&quot;get&quot;, &quot;list&quot;, &quot;create&quot;, &quot;update&quot;]</span>
<span class="tok-s">- apiGroups: [&quot;&quot;]</span>
<span class="tok-s">  resources: [&quot;secrets&quot;]</span>
<span class="tok-s">  verbs: [&quot;get&quot;, &quot;list&quot;]</span>
<span class="tok-s">---</span>
<span class="tok-s"># RoleBinding en app-a</span>
<span class="tok-s">apiVersion: rbac.authorization.k8s.io/v1</span>
<span class="tok-s">kind: RoleBinding</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: app-a-binding</span>
<span class="tok-s">  namespace: app-a</span>
<span class="tok-s">roleRef:</span>
<span class="tok-s">  apiGroup: rbac.authorization.k8s.io</span>
<span class="tok-s">  kind: Role</span>
<span class="tok-s">  name: app-a-role</span>
<span class="tok-s">subjects:</span>
<span class="tok-s">- kind: ServiceAccount</span>
<span class="tok-s">  name: app-a-sa</span>
<span class="tok-s">  namespace: app-a</span>
<span class="tok-s">---</span>
<span class="tok-s"># RoleBinding en app-b</span>
<span class="tok-s">apiVersion: rbac.authorization.k8s.io/v1</span>
<span class="tok-s">kind: RoleBinding</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: app-b-binding</span>
<span class="tok-s">  namespace: app-b</span>
<span class="tok-s">roleRef:</span>
<span class="tok-s">  apiGroup: rbac.authorization.k8s.io</span>
<span class="tok-s">  kind: Role</span>
<span class="tok-s">  name: app-b-role</span>
<span class="tok-s">subjects:</span>
<span class="tok-s">- kind: ServiceAccount</span>
<span class="tok-s">  name: app-b-sa</span>
<span class="tok-s">  namespace: app-b</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea recursos en cada namespace:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>create<span class="tok-w"> </span>configmap<span class="tok-w"> </span>app-a-config<span class="tok-w"> </span>-n<span class="tok-w"> </span>app-a<span class="tok-w"> </span>--from-literal<span class="tok-o">=</span><span class="tok-nv">key</span><span class="tok-o">=</span>value
kubectl<span class="tok-w"> </span>create<span class="tok-w"> </span>secret<span class="tok-w"> </span>generic<span class="tok-w"> </span>app-b-secret<span class="tok-w"> </span>-n<span class="tok-w"> </span>app-b<span class="tok-w"> </span>--from-literal<span class="tok-o">=</span><span class="tok-nv">key</span><span class="tok-o">=</span>value</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod en app-a que intenta leer configmaps y secrets:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: app-a-pod</span>
<span class="tok-s">  namespace: app-a</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  serviceAccountName: app-a-sa</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: curlimages/curl:latest</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)</span>
<span class="tok-s">      CA=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span>
<span class="tok-s">      NS=$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace)</span>

<span class="tok-s">      echo &quot;=== App-A (namespace: $NS) ===&quot;</span>
<span class="tok-s">      echo &quot;Can read configmaps:&quot;</span>
<span class="tok-s">      curl -s -H &quot;Authorization: Bearer $TOKEN&quot; \</span>
<span class="tok-s">        --cacert $CA \</span>
<span class="tok-s">        https://kubernetes.default.svc.cluster.local/api/v1/namespaces/$NS/configmaps | jq &#39;.items | length&#39;</span>

<span class="tok-s">      echo &quot;Cannot read secrets (forbidden):&quot;</span>
<span class="tok-s">      curl -s -H &quot;Authorization: Bearer $TOKEN&quot; \</span>
<span class="tok-s">        --cacert $CA \</span>
<span class="tok-s">        https://kubernetes.default.svc.cluster.local/api/v1/namespaces/$NS/secrets | jq -r &#39;.reason // &quot;Success&quot;&#39;</span>

<span class="tok-s">      sleep infinity</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod en app-b que intenta leer secrets y configmaps:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: app-b-pod</span>
<span class="tok-s">  namespace: app-b</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  serviceAccountName: app-b-sa</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: curlimages/curl:latest</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)</span>
<span class="tok-s">      CA=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span>
<span class="tok-s">      NS=$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace)</span>

<span class="tok-s">      echo &quot;=== App-B (namespace: $NS) ===&quot;</span>
<span class="tok-s">      echo &quot;Can read secrets:&quot;</span>
<span class="tok-s">      curl -s -H &quot;Authorization: Bearer $TOKEN&quot; \</span>
<span class="tok-s">        --cacert $CA \</span>
<span class="tok-s">        https://kubernetes.default.svc.cluster.local/api/v1/namespaces/$NS/secrets | jq &#39;.items | length&#39;</span>

<span class="tok-s">      echo &quot;Cannot read configmaps (forbidden):&quot;</span>
<span class="tok-s">      curl -s -H &quot;Authorization: Bearer $TOKEN&quot; \</span>
<span class="tok-s">        --cacert $CA \</span>
<span class="tok-s">        https://kubernetes.default.svc.cluster.local/api/v1/namespaces/$NS/configmaps | jq -r &#39;.reason // &quot;Success&quot;&#39;</span>

<span class="tok-s">      sleep infinity</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica aislamiento:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;App-A logs:&quot;</span>
kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>app-a-pod<span class="tok-w"> </span>-n<span class="tok-w"> </span>app-a

<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;&quot;</span>
<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;App-B logs:&quot;</span>
kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>app-b-pod<span class="tok-w"> </span>-n<span class="tok-w"> </span>app-b</code></pre>
</div>
</div>
</li>
<li>
<p>Intenta que app-a acceda a app-b (debe fallar):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>auth<span class="tok-w"> </span>can-i<span class="tok-w"> </span>get<span class="tok-w"> </span>secrets<span class="tok-w"> </span>--as<span class="tok-o">=</span>system:serviceaccount:app-a:app-a-sa<span class="tok-w"> </span>-n<span class="tok-w"> </span>app-b</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>app-a-pod<span class="tok-w"> </span>-n<span class="tok-w"> </span>app-a
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>app-b-pod<span class="tok-w"> </span>-n<span class="tok-w"> </span>app-b
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>namespace<span class="tok-w"> </span>app-a<span class="tok-w"> </span>app-b</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong></p>
</div>
<div class="paragraph">
<p>Cada aplicación debe tener acceso solo a sus propios recursos de namespace.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Cómo aislas aplicaciones en un cluster compartido?</p>
</li>
<li>
<p>¿Qué riesgos evita RBAC por namespace?</p>
</li>
<li>
<p>¿Cómo implementarías una política multi-tenant?</p>
</li>
</ol>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resumen_de_conceptos_7">17. Resumen de Conceptos</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Estos ejercicios del Módulo 7 cubren:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Ejercicio 7.1</strong>: Creación de Service Account</p>
</li>
<li>
<p><strong>Ejercicio 7.2</strong>: Role y RoleBinding básico</p>
</li>
<li>
<p><strong>Ejercicio 7.3</strong>: ClusterRole y ClusterRoleBinding</p>
</li>
<li>
<p><strong>Ejercicio 7.4</strong>: RBAC con Usuarios y Grupos</p>
</li>
<li>
<p><strong>Ejercicio 7.5</strong>: Security Context - Usuario no-root</p>
</li>
<li>
<p><strong>Ejercicio 7.6</strong>: Capabilities de Linux</p>
</li>
<li>
<p><strong>Ejercicio 7.7</strong>: Pod Security Standards</p>
</li>
<li>
<p><strong>Ejercicio 7.8</strong>: RBAC con recursos específicas</p>
</li>
<li>
<p><strong>Ejercicio 7.9</strong>: Auditoría de RBAC</p>
</li>
<li>
<p><strong>Ejercicio 7.10</strong>: Namespace Isolation</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_próximos_pasos_4">18. Próximos Pasos</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Una vez completes estos ejercicios, estarás listo para:
* Módulo 8: Observabilidad (Logging, Monitoring)
* Módulo 9: Escalado y Performance
* Módulo 10: Helm y Package Management
* Y módulos posteriores&#8230;&#8203;</p>
</div>
<hr>
</div>
</div>
<div class="sect1">
<h2 id="_módulo_8_observabilidad">19. Módulo 8: Observabilidad</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_ejercicio_8_1_obtener_logs_de_contenedores">19.1. Ejercicio 8.1: Obtener Logs de Contenedores</h3>
<div class="paragraph">
<p><strong>Objetivo:</strong> Acceder y visualizar logs de Pods usando kubectl logs.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong></p>
</div>
<div class="paragraph">
<p>Crea un Pod que genera logs y aprende a consultarlos usando diferentes opciones de kubectl.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un Pod que genera logs continuamente:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: logger-pod</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: logger</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      counter=1</span>
<span class="tok-s">      while true; do</span>
<span class="tok-s">        echo &quot;[INFO] $(date &#39;+%H:%M:%S&#39;) - Log message #$counter&quot;</span>
<span class="tok-s">        counter=$((counter+1))</span>
<span class="tok-s">        sleep 2</span>
<span class="tok-s">      done</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Ver logs del Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>logger-pod</code></pre>
</div>
</div>
</li>
<li>
<p>Ver logs en tiempo real (follow):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>logger-pod<span class="tok-w"> </span>-f
<span class="tok-c1"># Presiona Ctrl+C para detener</span></code></pre>
</div>
</div>
</li>
<li>
<p>Ver últimas 10 líneas:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>logger-pod<span class="tok-w"> </span>--tail<span class="tok-o">=</span><span class="tok-m">10</span></code></pre>
</div>
</div>
</li>
<li>
<p>Ver logs desde hace 1 minuto:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>logger-pod<span class="tok-w"> </span>--since<span class="tok-o">=</span>1m</code></pre>
</div>
</div>
</li>
<li>
<p>Ver logs con timestamps:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>logger-pod<span class="tok-w"> </span>-f</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod que genera logs con errores:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: error-logger-pod</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: logger</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      echo &quot;Starting application...&quot;</span>
<span class="tok-s">      sleep 2</span>
<span class="tok-s">      echo &quot;[ERROR] Database connection failed&quot;</span>
<span class="tok-s">      sleep 1</span>
<span class="tok-s">      echo &quot;[WARN] Retrying connection...&quot;</span>
<span class="tok-s">      sleep 1</span>
<span class="tok-s">      echo &quot;[INFO] Connection established&quot;</span>
<span class="tok-s">      sleep infinity</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Filtra líneas con "ERROR":</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>error-logger-pod<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>ERROR</code></pre>
</div>
</div>
</li>
<li>
<p>Obtén logs con formato específico:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>error-logger-pod<span class="tok-w"> </span>-f<span class="tok-w"> </span>--timestamps<span class="tok-o">=</span><span class="tok-nb">true</span></code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>logger-pod<span class="tok-w"> </span>error-logger-pod</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong></p>
</div>
<div class="paragraph">
<p>Debes poder ver logs del Pod con diferentes opciones (tail, since, follow).</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Dónde se almacenan los logs en el nodo?</p>
</li>
<li>
<p>¿Qué sucede con los logs cuando se elimina un Pod?</p>
</li>
<li>
<p>¿Cómo captura Kubernetes logs de stdout/stderr?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_8_2_logs_en_pods_multi_contenedor">19.2. Ejercicio 8.2: Logs en Pods Multi-Contenedor</h3>
<div class="paragraph">
<p><strong>Objetivo:</strong> Acceder a logs de contenedores específicos en Pods con múltiples contenedores.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong></p>
</div>
<div class="paragraph">
<p>Crea un Pod con múltiples contenedores y aprende a acceder a logs de cada uno.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un Pod con múltiples contenedores:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: multi-container-logger</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      counter=1</span>
<span class="tok-s">      while true; do</span>
<span class="tok-s">        echo &quot;APP: Message #$counter&quot;</span>
<span class="tok-s">        counter=$((counter+1))</span>
<span class="tok-s">        sleep 3</span>
<span class="tok-s">      done</span>

<span class="tok-s">  - name: sidecar</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      counter=1</span>
<span class="tok-s">      while true; do</span>
<span class="tok-s">        echo &quot;SIDECAR: Processing message #$counter&quot;</span>
<span class="tok-s">        counter=$((counter+1))</span>
<span class="tok-s">        sleep 3</span>
<span class="tok-s">      done</span>

<span class="tok-s">  - name: monitor</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      while true; do</span>
<span class="tok-s">        echo &quot;MONITOR: Health check OK at $(date &#39;+%H:%M:%S&#39;)&quot;</span>
<span class="tok-s">        sleep 5</span>
<span class="tok-s">      done</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Ver logs de todos los contenedores:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>multi-container-logger<span class="tok-w"> </span>--all-containers<span class="tok-o">=</span><span class="tok-nb">true</span></code></pre>
</div>
</div>
</li>
<li>
<p>Ver logs de un contenedor específico:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>multi-container-logger<span class="tok-w"> </span>-c<span class="tok-w"> </span>app
kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>multi-container-logger<span class="tok-w"> </span>-c<span class="tok-w"> </span>sidecar
kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>multi-container-logger<span class="tok-w"> </span>-c<span class="tok-w"> </span>monitor</code></pre>
</div>
</div>
</li>
<li>
<p>Ver logs del último contenedor:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>multi-container-logger</code></pre>
</div>
</div>
</li>
<li>
<p>Ver logs en tiempo real de un contenedor:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>multi-container-logger<span class="tok-w"> </span>-c<span class="tok-w"> </span>app<span class="tok-w"> </span>-f</code></pre>
</div>
</div>
</li>
<li>
<p>Ver logs ordenados por timestamp:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>multi-container-logger<span class="tok-w"> </span>-c<span class="tok-w"> </span>sidecar<span class="tok-w"> </span>--timestamps<span class="tok-o">=</span><span class="tok-nb">true</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod con Init container:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: init-container-logger</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  initContainers:</span>
<span class="tok-s">  - name: init</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      echo &quot;INIT: Initializing...&quot;</span>
<span class="tok-s">      sleep 2</span>
<span class="tok-s">      echo &quot;INIT: Ready!&quot;</span>

<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      echo &quot;APP: Starting after init&quot;</span>
<span class="tok-s">      sleep infinity</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Ver logs del init container:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Los init containers solo aparecen en el estado &quot;Init&quot;</span>
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>pod<span class="tok-w"> </span>init-container-logger
kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>init-container-logger<span class="tok-w"> </span>-c<span class="tok-w"> </span>init</code></pre>
</div>
</div>
</li>
<li>
<p>Ver logs de un Pod con un contenedor que ha fallado:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: failing-pod</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      echo &quot;Starting...&quot;</span>
<span class="tok-s">      sleep 1</span>
<span class="tok-s">      echo &quot;ERROR: Fatal error&quot;</span>
<span class="tok-s">      exit 1</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>multi-container-logger<span class="tok-w"> </span>init-container-logger<span class="tok-w"> </span>failing-pod</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong></p>
</div>
<div class="paragraph">
<p>Debes poder acceder a logs de contenedores específicos usando la opción -c.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Cómo ves logs de un init container después de que el Pod está corriendo?</p>
</li>
<li>
<p>¿Qué muestra kubectl logs si el Pod tiene múltiples contenedores?</p>
</li>
<li>
<p>¿Cómo accedes a logs de un contenedor que falló?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_8_3_logs_de_deployments">19.3. Ejercicio 8.3: Logs de Deployments</h3>
<div class="paragraph">
<p><strong>Objetivo:</strong> Ver logs de Deployments y Pods gestionados por controladores.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong></p>
</div>
<div class="paragraph">
<p>Crea un Deployment y aprende a acceder a logs de sus Pods.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un Deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: apps/v1</span>
<span class="tok-s">kind: Deployment</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: app-deployment</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  replicas: 3</span>
<span class="tok-s">  selector:</span>
<span class="tok-s">    matchLabels:</span>
<span class="tok-s">      app: myapp</span>
<span class="tok-s">  template:</span>
<span class="tok-s">    metadata:</span>
<span class="tok-s">      labels:</span>
<span class="tok-s">        app: myapp</span>
<span class="tok-s">    spec:</span>
<span class="tok-s">      containers:</span>
<span class="tok-s">      - name: app</span>
<span class="tok-s">        image: busybox</span>
<span class="tok-s">        command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">        args:</span>
<span class="tok-s">        - |</span>
<span class="tok-s">          POD_NAME=$(hostname)</span>
<span class="tok-s">          counter=1</span>
<span class="tok-s">          while true; do</span>
<span class="tok-s">            echo &quot;[$POD_NAME] Processing request #$counter&quot;</span>
<span class="tok-s">            counter=$((counter+1))</span>
<span class="tok-s">            sleep 2</span>
<span class="tok-s">          done</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica los Pods creados:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>myapp</code></pre>
</div>
</div>
</li>
<li>
<p>Ver logs de todos los Pods del Deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>deployment/app-deployment</code></pre>
</div>
</div>
</li>
<li>
<p>Ver logs de un Pod específico:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nv">POD_NAME</span><span class="tok-o">=</span><span class="tok-k">$(</span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>myapp<span class="tok-w"> </span>-o<span class="tok-w"> </span><span class="tok-nv">jsonpath</span><span class="tok-o">=</span><span class="tok-s1">&#39;{.items[0].metadata.name}&#39;</span><span class="tok-k">)</span>
kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span><span class="tok-nv">$POD_NAME</span></code></pre>
</div>
</div>
</li>
<li>
<p>Ver logs de todos los Pods con label selector:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>myapp<span class="tok-w"> </span>-f</code></pre>
</div>
</div>
</li>
<li>
<p>Ver logs ordenados:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>myapp<span class="tok-w"> </span>--all-containers<span class="tok-o">=</span><span class="tok-nb">true</span><span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>head<span class="tok-w"> </span>-20</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Deployment que genera errores:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: apps/v1</span>
<span class="tok-s">kind: Deployment</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: error-deployment</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  replicas: 2</span>
<span class="tok-s">  selector:</span>
<span class="tok-s">    matchLabels:</span>
<span class="tok-s">      app: error-app</span>
<span class="tok-s">  template:</span>
<span class="tok-s">    metadata:</span>
<span class="tok-s">      labels:</span>
<span class="tok-s">        app: error-app</span>
<span class="tok-s">    spec:</span>
<span class="tok-s">      containers:</span>
<span class="tok-s">      - name: app</span>
<span class="tok-s">        image: busybox</span>
<span class="tok-s">        command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">        args:</span>
<span class="tok-s">        - |</span>
<span class="tok-s">          echo &quot;Starting...&quot;</span>
<span class="tok-s">          sleep 2</span>
<span class="tok-s">          echo &quot;ERROR: Connection failed&quot;</span>
<span class="tok-s">          sleep 2</span>
<span class="tok-s">          echo &quot;Retrying...&quot;</span>
<span class="tok-s">          sleep 1</span>
<span class="tok-s">          echo &quot;SUCCESS: Connected&quot;</span>
<span class="tok-s">          sleep infinity</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Filtra logs por línea que contenga ERROR:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>error-app<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>ERROR</code></pre>
</div>
</div>
</li>
<li>
<p>Cuenta cuántas veces aparece ERROR:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>error-app<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>-c<span class="tok-w"> </span>ERROR</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>deployment<span class="tok-w"> </span>app-deployment<span class="tok-w"> </span>error-deployment</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong></p>
</div>
<div class="paragraph">
<p>Debes poder ver logs de Deployments y filtrar por contenido.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Cómo accedes a logs de todos los Pods de un Deployment?</p>
</li>
<li>
<p>¿Qué sucede si especificas múltiples labels?</p>
</li>
<li>
<p>¿Cómo filtras logs de todos los Pods juntos?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_8_4_eventos_del_cluster">19.4. Ejercicio 8.4: Eventos del Cluster</h3>
<div class="paragraph">
<p><strong>Objetivo:</strong> Monitorear eventos de Kubernetes para debugging.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong></p>
</div>
<div class="paragraph">
<p>Aprende a usar eventos de Kubernetes para entender qué sucede en el cluster.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Ver todos los eventos del namespace:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>events</code></pre>
</div>
</div>
</li>
<li>
<p>Ver eventos en tiempo real:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>events<span class="tok-w"> </span>-w
<span class="tok-c1"># Presiona Ctrl+C para detener</span></code></pre>
</div>
</div>
</li>
<li>
<p>Ver eventos detallados de un Pod específico:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: event-demo-pod</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      echo &quot;Running...&quot;</span>
<span class="tok-s">      sleep 10</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Describe el Pod para ver eventos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>pod<span class="tok-w"> </span>event-demo-pod
<span class="tok-c1"># Los eventos aparecen al final</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod que falla para ver eventos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: failing-pod</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: nonexistent-image:latest</span>
<span class="tok-s">    imagePullPolicy: Always</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Observa los eventos del Pod fallido:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>pod<span class="tok-w"> </span>failing-pod
<span class="tok-c1"># Verás eventos como ImagePullBackOff</span></code></pre>
</div>
</div>
</li>
<li>
<p>Ver eventos de un Deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: apps/v1</span>
<span class="tok-s">kind: Deployment</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: events-test-deployment</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  replicas: 1</span>
<span class="tok-s">  selector:</span>
<span class="tok-s">    matchLabels:</span>
<span class="tok-s">      app: test</span>
<span class="tok-s">  template:</span>
<span class="tok-s">    metadata:</span>
<span class="tok-s">      labels:</span>
<span class="tok-s">        app: test</span>
<span class="tok-s">    spec:</span>
<span class="tok-s">      containers:</span>
<span class="tok-s">      - name: app</span>
<span class="tok-s">        image: busybox</span>
<span class="tok-s">        command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">        args:</span>
<span class="tok-s">        - |</span>
<span class="tok-s">          sleep infinity</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Ver eventos del Deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>deployment<span class="tok-w"> </span>events-test-deployment</code></pre>
</div>
</div>
</li>
<li>
<p>Ordena eventos por timestamp:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>events<span class="tok-w"> </span>--sort-by<span class="tok-o">=</span><span class="tok-s1">&#39;.lastTimestamp&#39;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>event-demo-pod<span class="tok-w"> </span>failing-pod
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>deployment<span class="tok-w"> </span>events-test-deployment</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong></p>
</div>
<div class="paragraph">
<p>Debes poder ver eventos del cluster y entender qué sucede en los Pods.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Cuál es la diferencia entre logs y eventos?</p>
</li>
<li>
<p>¿Cuánto tiempo se retienen los eventos?</p>
</li>
<li>
<p>¿Cómo usas eventos para debugging?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_8_5_métricas_con_kubectl_top">19.5. Ejercicio 8.5: Métricas con kubectl top</h3>
<div class="paragraph">
<p><strong>Objetivo:</strong> Monitorear uso de recursos (CPU y memoria) usando kubectl top.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong></p>
</div>
<div class="paragraph">
<p>Usa kubectl top para visualizar métricas de Pods y Nodos.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Verifica que Metrics Server está instalado:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>deployment<span class="tok-w"> </span>metrics-server<span class="tok-w"> </span>-n<span class="tok-w"> </span>kube-system</code></pre>
</div>
</div>
</li>
<li>
<p>Si no está instalado, instálalo:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Ver uso de nodos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>top<span class="tok-w"> </span>nodes</code></pre>
</div>
</div>
</li>
<li>
<p>Ver uso detallado de un nodo:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nv">FIRST_NODE</span><span class="tok-o">=</span><span class="tok-k">$(</span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>nodes<span class="tok-w"> </span>-o<span class="tok-w"> </span><span class="tok-nv">jsonpath</span><span class="tok-o">=</span><span class="tok-s1">&#39;{.items[0].metadata.name}&#39;</span><span class="tok-k">)</span>
kubectl<span class="tok-w"> </span>top<span class="tok-w"> </span>node<span class="tok-w"> </span><span class="tok-nv">$FIRST_NODE</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea Pods que consumen recursos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: apps/v1</span>
<span class="tok-s">kind: Deployment</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: resource-hog</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  replicas: 2</span>
<span class="tok-s">  selector:</span>
<span class="tok-s">    matchLabels:</span>
<span class="tok-s">      app: hog</span>
<span class="tok-s">  template:</span>
<span class="tok-s">    metadata:</span>
<span class="tok-s">      labels:</span>
<span class="tok-s">        app: hog</span>
<span class="tok-s">    spec:</span>
<span class="tok-s">      containers:</span>
<span class="tok-s">      - name: cpu-user</span>
<span class="tok-s">        image: busybox</span>
<span class="tok-s">        resources:</span>
<span class="tok-s">          requests:</span>
<span class="tok-s">            cpu: 100m</span>
<span class="tok-s">            memory: 64Mi</span>
<span class="tok-s">          limits:</span>
<span class="tok-s">            cpu: 200m</span>
<span class="tok-s">            memory: 128Mi</span>
<span class="tok-s">        command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">        args:</span>
<span class="tok-s">        - |</span>
<span class="tok-s">          while true; do</span>
<span class="tok-s">            dd if=/dev/zero bs=1M count=50 2&gt;/dev/null | md5sum &gt; /dev/null</span>
<span class="tok-s">          done</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Espera un momento para que se generen métricas:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>sleep<span class="tok-w"> </span><span class="tok-m">30</span></code></pre>
</div>
</div>
</li>
<li>
<p>Ver uso de Pods:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>top<span class="tok-w"> </span>pods</code></pre>
</div>
</div>
</li>
<li>
<p>Ver uso de Pods en todos los namespaces:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>top<span class="tok-w"> </span>pods<span class="tok-w"> </span>-A</code></pre>
</div>
</div>
</li>
<li>
<p>Ordena Pods por CPU:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>top<span class="tok-w"> </span>pods<span class="tok-w"> </span>--sort-by<span class="tok-o">=</span>cpu</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>deployment<span class="tok-w"> </span>resource-hog</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong></p>
</div>
<div class="paragraph">
<p>Debes poder ver métricas de CPU y memoria de Pods y Nodos.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿De dónde obtiene Metrics Server las métricas?</p>
</li>
<li>
<p>¿Con qué frecuencia se actualizan las métricas?</p>
</li>
<li>
<p>¿Cuánto tiempo tarda en aparecer un Pod en kubectl top?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_8_6_monitoreo_de_recursos_con_resource_limits">19.6. Ejercicio 8.6: Monitoreo de Recursos con Resource Limits</h3>
<div class="paragraph">
<p><strong>Objetivo:</strong> Establecer limites de recursos y observar el comportamiento.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong></p>
</div>
<div class="paragraph">
<p>Crea Pods con resource requests y limits, y observa qué sucede cuando los exceden.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un Pod con requests apropiados:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: well-configured-pod</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    resources:</span>
<span class="tok-s">      requests:</span>
<span class="tok-s">        cpu: 100m</span>
<span class="tok-s">        memory: 64Mi</span>
<span class="tok-s">      limits:</span>
<span class="tok-s">        cpu: 200m</span>
<span class="tok-s">        memory: 128Mi</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      echo &quot;Running with requested resources&quot;</span>
<span class="tok-s">      sleep infinity</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Ver métricas después de 30 segundos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>sleep<span class="tok-w"> </span><span class="tok-m">30</span>
kubectl<span class="tok-w"> </span>top<span class="tok-w"> </span>pod<span class="tok-w"> </span>well-configured-pod</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod que intenta usar más memoria que el límite:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: memory-limit-pod</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    resources:</span>
<span class="tok-s">      requests:</span>
<span class="tok-s">        memory: 64Mi</span>
<span class="tok-s">      limits:</span>
<span class="tok-s">        memory: 128Mi</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      echo &quot;Allocating memory...&quot;</span>
<span class="tok-s">      # Intenta asignar más memoria que el límite</span>
<span class="tok-s">      dd if=/dev/zero bs=1M count=200 of=/dev/null 2&gt;&amp;1 &amp;</span>
<span class="tok-s">      sleep infinity</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Observa los eventos del Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>pod<span class="tok-w"> </span>memory-limit-pod
<span class="tok-c1"># Debería mostrar OOMKilled si excede memoria</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod sin límites (para comparar):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: unlimited-pod</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      echo &quot;No resource limits&quot;</span>
<span class="tok-s">      sleep infinity</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Compara métricas después de 30 segundos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>sleep<span class="tok-w"> </span><span class="tok-m">30</span>
kubectl<span class="tok-w"> </span>top<span class="tok-w"> </span>pods</code></pre>
</div>
</div>
</li>
<li>
<p>Ver descripción de Pods para ver limits:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>pod<span class="tok-w"> </span>well-configured-pod<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>-A<span class="tok-w"> </span><span class="tok-m">5</span><span class="tok-w"> </span><span class="tok-s2">&quot;Limits\|Requests&quot;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Deployment con resource requests:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: apps/v1</span>
<span class="tok-s">kind: Deployment</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: resource-aware-deployment</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  replicas: 3</span>
<span class="tok-s">  selector:</span>
<span class="tok-s">    matchLabels:</span>
<span class="tok-s">      app: resource-aware</span>
<span class="tok-s">  template:</span>
<span class="tok-s">    metadata:</span>
<span class="tok-s">      labels:</span>
<span class="tok-s">        app: resource-aware</span>
<span class="tok-s">    spec:</span>
<span class="tok-s">      containers:</span>
<span class="tok-s">      - name: app</span>
<span class="tok-s">        image: busybox</span>
<span class="tok-s">        resources:</span>
<span class="tok-s">          requests:</span>
<span class="tok-s">            cpu: 50m</span>
<span class="tok-s">            memory: 32Mi</span>
<span class="tok-s">          limits:</span>
<span class="tok-s">            cpu: 100m</span>
<span class="tok-s">            memory: 64Mi</span>
<span class="tok-s">        command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">        args:</span>
<span class="tok-s">        - |</span>
<span class="tok-s">          sleep infinity</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Ver métricas del Deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>sleep<span class="tok-w"> </span><span class="tok-m">30</span>
kubectl<span class="tok-w"> </span>top<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>resource-aware</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>well-configured-pod<span class="tok-w"> </span>memory-limit-pod<span class="tok-w"> </span>unlimited-pod
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>deployment<span class="tok-w"> </span>resource-aware-deployment</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong></p>
</div>
<div class="paragraph">
<p>Los Pods deben mostrar métricas de uso real vs. recursos solicitados/limitados.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Qué sucede cuando un Pod excede su memory limit?</p>
</li>
<li>
<p>¿Por qué es importante establecer requests?</p>
</li>
<li>
<p>¿Cómo afecta esto al scheduler?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_8_7_logging_con_sidecar_pattern">19.7. Ejercicio 8.7: Logging con Sidecar Pattern</h3>
<div class="paragraph">
<p><strong>Objetivo:</strong> Implementar el patrón sidecar para logging.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong></p>
</div>
<div class="paragraph">
<p>Crea un Pod con un contenedor que genera logs en archivo y un sidecar que lo procesa.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un Pod con patrón sidecar de logging:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: sidecar-logger-pod</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  # Contenedor principal</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    volumeMounts:</span>
<span class="tok-s">    - name: log-volume</span>
<span class="tok-s">      mountPath: /var/log/app</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      counter=1</span>
<span class="tok-s">      while true; do</span>
<span class="tok-s">        echo &quot;[INFO] $(date &#39;+%H:%M:%S&#39;) - Application event #$counter&quot; &gt;&gt; /var/log/app/app.log</span>
<span class="tok-s">        counter=$((counter+1))</span>
<span class="tok-s">        sleep 2</span>
<span class="tok-s">      done</span>

<span class="tok-s">  # Sidecar que procesa los logs</span>
<span class="tok-s">  - name: log-processor</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    volumeMounts:</span>
<span class="tok-s">    - name: log-volume</span>
<span class="tok-s">      mountPath: /var/log/app</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      echo &quot;Log processor sidecar started&quot;</span>
<span class="tok-s">      while true; do</span>
<span class="tok-s">        if [ -f /var/log/app/app.log ]; then</span>
<span class="tok-s">          echo &quot;=== Latest logs at $(date &#39;+%H:%M:%S&#39;) ===&quot;</span>
<span class="tok-s">          tail -3 /var/log/app/app.log</span>
<span class="tok-s">          echo &quot;&quot;</span>
<span class="tok-s">        fi</span>
<span class="tok-s">        sleep 5</span>
<span class="tok-s">      done</span>

<span class="tok-s">  volumes:</span>
<span class="tok-s">  - name: log-volume</span>
<span class="tok-s">    emptyDir: {}</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Ver logs del contenedor app:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>sidecar-logger-pod<span class="tok-w"> </span>-c<span class="tok-w"> </span>app</code></pre>
</div>
</div>
</li>
<li>
<p>Ver logs del contenedor sidecar:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>sidecar-logger-pod<span class="tok-w"> </span>-c<span class="tok-w"> </span>log-processor<span class="tok-w"> </span>-f</code></pre>
</div>
</div>
</li>
<li>
<p>Accede directamente al contenedor app:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span><span class="tok-nb">exec</span><span class="tok-w"> </span>-it<span class="tok-w"> </span>sidecar-logger-pod<span class="tok-w"> </span>-c<span class="tok-w"> </span>app<span class="tok-w"> </span>--<span class="tok-w"> </span>cat<span class="tok-w"> </span>/var/log/app/app.log</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod con sidecar que envía logs a stdout:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: sidecar-forwarder-pod</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    volumeMounts:</span>
<span class="tok-s">    - name: log-volume</span>
<span class="tok-s">      mountPath: /var/log/app</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      counter=1</span>
<span class="tok-s">      while true; do</span>
<span class="tok-s">        echo &quot;[APP] Event #$counter at $(date &#39;+%H:%M:%S&#39;)&quot; &gt;&gt; /var/log/app/app.log</span>
<span class="tok-s">        counter=$((counter+1))</span>
<span class="tok-s">        sleep 1</span>
<span class="tok-s">      done</span>

<span class="tok-s">  - name: log-forwarder</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    volumeMounts:</span>
<span class="tok-s">    - name: log-volume</span>
<span class="tok-s">      mountPath: /var/log/app</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      while true; do</span>
<span class="tok-s">        if [ -f /var/log/app/app.log ]; then</span>
<span class="tok-s">          tail -n +1 /var/log/app/app.log</span>
<span class="tok-s">          &gt; /var/log/app/app.log  # Limpia el archivo</span>
<span class="tok-s">        fi</span>
<span class="tok-s">        sleep 3</span>
<span class="tok-s">      done</span>

<span class="tok-s">  volumes:</span>
<span class="tok-s">  - name: log-volume</span>
<span class="tok-s">    emptyDir: {}</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Ver logs del forwarder:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>sidecar-forwarder-pod<span class="tok-w"> </span>-c<span class="tok-w"> </span>log-forwarder<span class="tok-w"> </span>-f</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod con múltiples sidecars:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: multi-sidecar-pod</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    volumeMounts:</span>
<span class="tok-s">    - name: app-logs</span>
<span class="tok-s">      mountPath: /var/log/app</span>
<span class="tok-s">    - name: access-logs</span>
<span class="tok-s">      mountPath: /var/log/access</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      counter=1</span>
<span class="tok-s">      while true; do</span>
<span class="tok-s">        echo &quot;[APP] Event #$counter&quot; &gt;&gt; /var/log/app/app.log</span>
<span class="tok-s">        echo &quot;GET /api/users HTTP/1.1 200&quot; &gt;&gt; /var/log/access/access.log</span>
<span class="tok-s">        counter=$((counter+1))</span>
<span class="tok-s">        sleep 1</span>
<span class="tok-s">      done</span>

<span class="tok-s">  - name: app-log-processor</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    volumeMounts:</span>
<span class="tok-s">    - name: app-logs</span>
<span class="tok-s">      mountPath: /var/log/app</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      while true; do</span>
<span class="tok-s">        echo &quot;[APP-PROCESSOR] $(date &#39;+%H:%M:%S&#39;): Processing app logs&quot;</span>
<span class="tok-s">        sleep 5</span>
<span class="tok-s">      done</span>

<span class="tok-s">  - name: access-log-processor</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    volumeMounts:</span>
<span class="tok-s">    - name: access-logs</span>
<span class="tok-s">      mountPath: /var/log/access</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      while true; do</span>
<span class="tok-s">        echo &quot;[ACCESS-PROCESSOR] $(date &#39;+%H:%M:%S&#39;): Processing access logs&quot;</span>
<span class="tok-s">        sleep 5</span>
<span class="tok-s">      done</span>

<span class="tok-s">  volumes:</span>
<span class="tok-s">  - name: app-logs</span>
<span class="tok-s">    emptyDir: {}</span>
<span class="tok-s">  - name: access-logs</span>
<span class="tok-s">    emptyDir: {}</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Ver logs de cada sidecar:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>multi-sidecar-pod<span class="tok-w"> </span>-c<span class="tok-w"> </span>app-log-processor<span class="tok-w"> </span>-f</code></pre>
</div>
</div>
</li>
<li>
<p>Describe el Pod para ver estructura:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>pod<span class="tok-w"> </span>multi-sidecar-pod</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>sidecar-logger-pod<span class="tok-w"> </span>sidecar-forwarder-pod<span class="tok-w"> </span>multi-sidecar-pod</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong></p>
</div>
<div class="paragraph">
<p>Los sidecars deben procesar logs del contenedor principal.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Cuál es la ventaja del patrón sidecar?</p>
</li>
<li>
<p>¿Cómo se comunican contenedores en el mismo Pod?</p>
</li>
<li>
<p>¿Cuándo usarías un sidecar de logging?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_8_8_exposición_de_métricas_de_aplicación">19.8. Ejercicio 8.8: Exposición de Métricas de Aplicación</h3>
<div class="paragraph">
<p><strong>Objetivo:</strong> Crear una aplicación que expone métricas para Prometheus.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong></p>
</div>
<div class="paragraph">
<p>Crea un Pod con una aplicación que expone métricas en el formato de Prometheus.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un Pod que simula exponer métricas:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: metrics-app</span>
<span class="tok-s">  annotations:</span>
<span class="tok-s">    prometheus.io/scrape: &quot;true&quot;</span>
<span class="tok-s">    prometheus.io/port: &quot;8000&quot;</span>
<span class="tok-s">    prometheus.io/path: &quot;/metrics&quot;</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    ports:</span>
<span class="tok-s">    - name: metrics</span>
<span class="tok-s">      containerPort: 8000</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      # Simula un servidor que expone métricas</span>
<span class="tok-s">      while true; do</span>
<span class="tok-s">        {</span>
<span class="tok-s">          echo &quot;HTTP/1.1 200 OK&quot;</span>
<span class="tok-s">          echo &quot;Content-Type: text/plain&quot;</span>
<span class="tok-s">          echo &quot;&quot;</span>
<span class="tok-s">          echo &quot;# HELP requests_total Total number of requests&quot;</span>
<span class="tok-s">          echo &quot;# TYPE requests_total counter&quot;</span>
<span class="tok-s">          echo &quot;requests_total{method=\&quot;GET\&quot;} 100&quot;</span>
<span class="tok-s">          echo &quot;requests_total{method=\&quot;POST\&quot;} 50&quot;</span>
<span class="tok-s">          echo &quot;&quot;</span>
<span class="tok-s">          echo &quot;# HELP request_duration_seconds Request latency&quot;</span>
<span class="tok-s">          echo &quot;# TYPE request_duration_seconds histogram&quot;</span>
<span class="tok-s">          echo &quot;request_duration_seconds_bucket{le=\&quot;0.1\&quot;} 50&quot;</span>
<span class="tok-s">          echo &quot;request_duration_seconds_bucket{le=\&quot;0.5\&quot;} 90&quot;</span>
<span class="tok-s">          echo &quot;request_duration_seconds_bucket{le=\&quot;1\&quot;} 100&quot;</span>
<span class="tok-s">          echo &quot;&quot;</span>
<span class="tok-s">          echo &quot;# HELP memory_bytes Memory usage in bytes&quot;</span>
<span class="tok-s">          echo &quot;# TYPE memory_bytes gauge&quot;</span>
<span class="tok-s">          echo &quot;memory_bytes 1024000&quot;</span>
<span class="tok-s">        } | nc -l -p 8000 -q 1</span>
<span class="tok-s">      done</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que el Pod está corriendo:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pod<span class="tok-w"> </span>metrics-app</code></pre>
</div>
</div>
</li>
<li>
<p>Accede al endpoint de métricas desde otro Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>run<span class="tok-w"> </span>-it<span class="tok-w"> </span>curl-pod<span class="tok-w"> </span>--image<span class="tok-o">=</span>curlimages/curl<span class="tok-w"> </span>--rm<span class="tok-w"> </span>--restart<span class="tok-o">=</span>Never<span class="tok-w"> </span>--<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>curl<span class="tok-w"> </span>http://metrics-app:8000/metrics</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod con Deployment y métricas:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: apps/v1</span>
<span class="tok-s">kind: Deployment</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: metrics-deployment</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  replicas: 2</span>
<span class="tok-s">  selector:</span>
<span class="tok-s">    matchLabels:</span>
<span class="tok-s">      app: metrics</span>
<span class="tok-s">  template:</span>
<span class="tok-s">    metadata:</span>
<span class="tok-s">      labels:</span>
<span class="tok-s">        app: metrics</span>
<span class="tok-s">      annotations:</span>
<span class="tok-s">        prometheus.io/scrape: &quot;true&quot;</span>
<span class="tok-s">        prometheus.io/port: &quot;8000&quot;</span>
<span class="tok-s">        prometheus.io/path: &quot;/metrics&quot;</span>
<span class="tok-s">    spec:</span>
<span class="tok-s">      containers:</span>
<span class="tok-s">      - name: app</span>
<span class="tok-s">        image: busybox</span>
<span class="tok-s">        ports:</span>
<span class="tok-s">        - name: metrics</span>
<span class="tok-s">          containerPort: 8000</span>
<span class="tok-s">        command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">        args:</span>
<span class="tok-s">        - |</span>
<span class="tok-s">          counter=0</span>
<span class="tok-s">          while true; do</span>
<span class="tok-s">            counter=$((counter+1))</span>
<span class="tok-s">            {</span>
<span class="tok-s">              echo &quot;HTTP/1.1 200 OK&quot;</span>
<span class="tok-s">              echo &quot;Content-Type: text/plain&quot;</span>
<span class="tok-s">              echo &quot;&quot;</span>
<span class="tok-s">              echo &quot;# Pod metrics&quot;</span>
<span class="tok-s">              echo &quot;pod_requests{pod=\&quot;$(hostname)\&quot;} $counter&quot;</span>
<span class="tok-s">              echo &quot;pod_uptime_seconds $((RANDOM % 3600))&quot;</span>
<span class="tok-s">            } | nc -l -p 8000 -q 1</span>
<span class="tok-s">            sleep 1</span>
<span class="tok-s">          done</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica los Pods del Deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>metrics</code></pre>
</div>
</div>
</li>
<li>
<p>Accede a métricas de un Pod específico:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nv">POD_NAME</span><span class="tok-o">=</span><span class="tok-k">$(</span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>metrics<span class="tok-w"> </span>-o<span class="tok-w"> </span><span class="tok-nv">jsonpath</span><span class="tok-o">=</span><span class="tok-s1">&#39;{.items[0].metadata.name}&#39;</span><span class="tok-k">)</span>
kubectl<span class="tok-w"> </span>port-forward<span class="tok-w"> </span><span class="tok-nv">$POD_NAME</span><span class="tok-w"> </span><span class="tok-m">8000</span>:8000<span class="tok-w"> </span><span class="tok-p">&amp;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Consulta desde otro terminal:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>sleep<span class="tok-w"> </span><span class="tok-m">2</span>
curl<span class="tok-w"> </span>localhost:8000/metrics</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Service para acceder a las métricas:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>expose<span class="tok-w"> </span>deployment<span class="tok-w"> </span>metrics-deployment<span class="tok-w"> </span>--port<span class="tok-o">=</span><span class="tok-m">8000</span><span class="tok-w"> </span>--target-port<span class="tok-o">=</span><span class="tok-m">8000</span></code></pre>
</div>
</div>
</li>
<li>
<p>Consulta las métricas a través del Service:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>run<span class="tok-w"> </span>-it<span class="tok-w"> </span>curl-pod<span class="tok-w"> </span>--image<span class="tok-o">=</span>curlimages/curl<span class="tok-w"> </span>--rm<span class="tok-w"> </span>--restart<span class="tok-o">=</span>Never<span class="tok-w"> </span>--<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>curl<span class="tok-w"> </span>http://metrics-deployment:8000/metrics</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>pkill<span class="tok-w"> </span>-f<span class="tok-w"> </span><span class="tok-s2">&quot;port-forward&quot;</span>
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>metrics-app
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>deployment<span class="tok-w"> </span>metrics-deployment
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>service<span class="tok-w"> </span>metrics-deployment</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong></p>
</div>
<div class="paragraph">
<p>La aplicación debe exponer métricas en formato Prometheus.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Cuál es el formato de métricas de Prometheus?</p>
</li>
<li>
<p>¿Cómo sabe Prometheus dónde encontrar las métricas?</p>
</li>
<li>
<p>¿Qué tipos de métricas existen (counter, gauge, histogram)?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_8_9_análisis_de_logs_con_herramientas">19.9. Ejercicio 8.9: Análisis de Logs con Herramientas</h3>
<div class="paragraph">
<p><strong>Objetivo:</strong> Usar herramientas para analizar y filtrar logs.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong></p>
</div>
<div class="paragraph">
<p>Aprende técnicas avanzadas de búsqueda y análisis de logs.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un Pod que genera logs variados:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: analysis-pod</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      counter=1</span>
<span class="tok-s">      while true; do</span>
<span class="tok-s">        case $((counter % 5)) in</span>
<span class="tok-s">          1) echo &quot;[INFO] User login from 192.168.1.100&quot; ;;</span>
<span class="tok-s">          2) echo &quot;[ERROR] Database connection timeout&quot; ;;</span>
<span class="tok-s">          3) echo &quot;[WARN] Memory usage at 85%&quot; ;;</span>
<span class="tok-s">          4) echo &quot;[INFO] API request completed in 150ms&quot; ;;</span>
<span class="tok-s">          0) echo &quot;[DEBUG] Cache hit for key user:123&quot; ;;</span>
<span class="tok-s">        esac</span>
<span class="tok-s">        counter=$((counter+1))</span>
<span class="tok-s">        sleep 1</span>
<span class="tok-s">      done</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Captura 100 líneas de logs:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>analysis-pod<span class="tok-w"> </span>--tail<span class="tok-o">=</span><span class="tok-m">100</span><span class="tok-w"> </span>&gt;<span class="tok-w"> </span>/tmp/logs.txt</code></pre>
</div>
</div>
</li>
<li>
<p>Cuenta mensajes por nivel:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>analysis-pod<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>-o<span class="tok-w"> </span><span class="tok-s2">&quot;\[.*\]&quot;</span><span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>sort<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>uniq<span class="tok-w"> </span>-c</code></pre>
</div>
</div>
</li>
<li>
<p>Filtra solo errores:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>analysis-pod<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>ERROR</code></pre>
</div>
</div>
</li>
<li>
<p>Busca por IP:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>analysis-pod<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span><span class="tok-s2">&quot;192.168&quot;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Estadísticas de logs:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>analysis-pod<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>wc<span class="tok-w"> </span>-l</code></pre>
</div>
</div>
</li>
<li>
<p>Busca logs entre timestamps (aproximadamente):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>analysis-pod<span class="tok-w"> </span>--since<span class="tok-o">=</span>2m<span class="tok-w"> </span>--tail<span class="tok-o">=</span><span class="tok-m">50</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Deployment y analiza logs de todos los Pods:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: apps/v1</span>
<span class="tok-s">kind: Deployment</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: analysis-deployment</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  replicas: 3</span>
<span class="tok-s">  selector:</span>
<span class="tok-s">    matchLabels:</span>
<span class="tok-s">      app: analyzer</span>
<span class="tok-s">  template:</span>
<span class="tok-s">    metadata:</span>
<span class="tok-s">      labels:</span>
<span class="tok-s">        app: analyzer</span>
<span class="tok-s">    spec:</span>
<span class="tok-s">      containers:</span>
<span class="tok-s">      - name: app</span>
<span class="tok-s">        image: busybox</span>
<span class="tok-s">        command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">        args:</span>
<span class="tok-s">        - |</span>
<span class="tok-s">          POD_ID=$(echo $HOSTNAME | tail -c 5)</span>
<span class="tok-s">          counter=1</span>
<span class="tok-s">          while true; do</span>
<span class="tok-s">            echo &quot;[$POD_ID] $(date &#39;+%H:%M:%S&#39;) - Process event #$counter&quot;</span>
<span class="tok-s">            counter=$((counter+1))</span>
<span class="tok-s">            sleep 1</span>
<span class="tok-s">          done</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Espera a que los Pods estén corriendo:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>sleep<span class="tok-w"> </span><span class="tok-m">10</span></code></pre>
</div>
</div>
</li>
<li>
<p>Análisis de logs de todo el Deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Todos los logs</span>
kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>analyzer<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>head<span class="tok-w"> </span>-30

<span class="tok-c1"># Contar eventos por Pod</span>
kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>analyzer<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>awk<span class="tok-w"> </span><span class="tok-s1">&#39;{print $1}&#39;</span><span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>sort<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>uniq<span class="tok-w"> </span>-c</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong></p>
</div>
<div class="paragraph">
<p>Debes poder filtrar y analizar logs usando comandos de línea.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Cómo buscas logs específicos en múltiples Pods?</p>
</li>
<li>
<p>¿Cómo analizas patrones en logs?</p>
</li>
<li>
<p>¿Cuáles son las limitaciones de analizar logs así?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_8_10_health_checks_y_probes">19.10. Ejercicio 8.10: Health Checks y Probes</h3>
<div class="paragraph">
<p><strong>Objetivo:</strong> Implementar liveness, readiness y startup probes para monitoreo.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong></p>
</div>
<div class="paragraph">
<p>Crea Pods con diferentes tipos de probes para que Kubernetes monitoree su salud.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un Pod con liveness probe:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: liveness-probe-pod</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    ports:</span>
<span class="tok-s">    - containerPort: 8080</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      counter=0</span>
<span class="tok-s">      while true; do</span>
<span class="tok-s">        # Simula un servidor en el puerto 8080</span>
<span class="tok-s">        {</span>
<span class="tok-s">          if [ $((counter % 20)) -lt 15 ]; then</span>
<span class="tok-s">            echo &quot;HTTP/1.1 200 OK&quot;</span>
<span class="tok-s">            echo &quot;&quot;</span>
<span class="tok-s">            echo &quot;OK&quot;</span>
<span class="tok-s">          else</span>
<span class="tok-s">            echo &quot;HTTP/1.1 500 Internal Server Error&quot;</span>
<span class="tok-s">            echo &quot;&quot;</span>
<span class="tok-s">            echo &quot;ERROR&quot;</span>
<span class="tok-s">          fi</span>
<span class="tok-s">        } | nc -l -p 8080 -q 1</span>
<span class="tok-s">        counter=$((counter+1))</span>
<span class="tok-s">        sleep 1</span>
<span class="tok-s">      done</span>

<span class="tok-s">    livenessProbe:</span>
<span class="tok-s">      httpGet:</span>
<span class="tok-s">        path: /</span>
<span class="tok-s">        port: 8080</span>
<span class="tok-s">      initialDelaySeconds: 5</span>
<span class="tok-s">      periodSeconds: 5</span>
<span class="tok-s">      failureThreshold: 3</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Observa el Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pod<span class="tok-w"> </span>liveness-probe-pod<span class="tok-w"> </span>-w</code></pre>
</div>
</div>
</li>
<li>
<p>Describe el Pod para ver resultados del probe:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>pod<span class="tok-w"> </span>liveness-probe-pod</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod con readiness probe:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: readiness-probe-pod</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    ports:</span>
<span class="tok-s">    - containerPort: 8080</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      echo &quot;Initializing...&quot;</span>
<span class="tok-s">      sleep 5</span>
<span class="tok-s">      echo &quot;Ready!&quot;</span>
<span class="tok-s">      while true; do</span>
<span class="tok-s">        {</span>
<span class="tok-s">          echo &quot;HTTP/1.1 200 OK&quot;</span>
<span class="tok-s">          echo &quot;&quot;</span>
<span class="tok-s">          echo &quot;READY&quot;</span>
<span class="tok-s">        } | nc -l -p 8080 -q 1</span>
<span class="tok-s">      done</span>

<span class="tok-s">    readinessProbe:</span>
<span class="tok-s">      httpGet:</span>
<span class="tok-s">        path: /</span>
<span class="tok-s">        port: 8080</span>
<span class="tok-s">      initialDelaySeconds: 2</span>
<span class="tok-s">      periodSeconds: 3</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Observa cómo tarda en estar ready:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pod<span class="tok-w"> </span>readiness-probe-pod<span class="tok-w"> </span>-w</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod con startup probe:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: startup-probe-pod</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    ports:</span>
<span class="tok-s">    - containerPort: 8080</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      echo &quot;Starting application... (slow startup)&quot;</span>
<span class="tok-s">      for i in $(seq 1 15); do</span>
<span class="tok-s">        echo &quot;Initializing step $i...&quot;</span>
<span class="tok-s">        sleep 1</span>
<span class="tok-s">      done</span>
<span class="tok-s">      echo &quot;Application ready!&quot;</span>
<span class="tok-s">      while true; do</span>
<span class="tok-s">        {</span>
<span class="tok-s">          echo &quot;HTTP/1.1 200 OK&quot;</span>
<span class="tok-s">          echo &quot;&quot;</span>
<span class="tok-s">          echo &quot;RUNNING&quot;</span>
<span class="tok-s">        } | nc -l -p 8080 -q 1</span>
<span class="tok-s">      done</span>

<span class="tok-s">    startupProbe:</span>
<span class="tok-s">      httpGet:</span>
<span class="tok-s">        path: /</span>
<span class="tok-s">        port: 8080</span>
<span class="tok-s">      failureThreshold: 30</span>
<span class="tok-s">      periodSeconds: 1</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Observa el pod en arranque:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>startup-probe-pod<span class="tok-w"> </span>-f</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un Pod con todos los probes:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>-<span class="tok-w"> </span><span class="tok-s">&lt;&lt;&#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: all-probes-pod</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: busybox</span>
<span class="tok-s">    ports:</span>
<span class="tok-s">    - containerPort: 8080</span>
<span class="tok-s">    command: [&quot;sh&quot;, &quot;-c&quot;]</span>
<span class="tok-s">    args:</span>
<span class="tok-s">    - |</span>
<span class="tok-s">      sleep 3</span>
<span class="tok-s">      while true; do</span>
<span class="tok-s">        {</span>
<span class="tok-s">          echo &quot;HTTP/1.1 200 OK&quot;</span>
<span class="tok-s">          echo &quot;&quot;</span>
<span class="tok-s">          echo &quot;HEALTHY&quot;</span>
<span class="tok-s">        } | nc -l -p 8080 -q 1</span>
<span class="tok-s">      done</span>

<span class="tok-s">    startupProbe:</span>
<span class="tok-s">      httpGet:</span>
<span class="tok-s">        path: /</span>
<span class="tok-s">        port: 8080</span>
<span class="tok-s">      failureThreshold: 10</span>
<span class="tok-s">      periodSeconds: 1</span>

<span class="tok-s">    readinessProbe:</span>
<span class="tok-s">      httpGet:</span>
<span class="tok-s">        path: /</span>
<span class="tok-s">        port: 8080</span>
<span class="tok-s">      periodSeconds: 5</span>

<span class="tok-s">    livenessProbe:</span>
<span class="tok-s">      httpGet:</span>
<span class="tok-s">        path: /</span>
<span class="tok-s">        port: 8080</span>
<span class="tok-s">      periodSeconds: 10</span>
<span class="tok-s">      failureThreshold: 2</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Describe el Pod para ver todos los probes:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>pod<span class="tok-w"> </span>all-probes-pod</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>liveness-probe-pod<span class="tok-w"> </span>readiness-probe-pod<span class="tok-w"> </span>startup-probe-pod<span class="tok-w"> </span>all-probes-pod</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Verificación:</strong></p>
</div>
<div class="paragraph">
<p>Los Pods deben mostrar resultados de probes en su estado.</p>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Cuál es la diferencia entre liveness, readiness y startup probes?</p>
</li>
<li>
<p>¿Cómo usa Kubernetes los resultados de los probes?</p>
</li>
<li>
<p>¿Cuándo debería usar cada tipo de probe?</p>
</li>
</ol>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resumen_de_conceptos_8">20. Resumen de Conceptos</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Estos ejercicios del Módulo 8 cubren:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Ejercicio 8.1</strong>: Obtener logs de contenedores</p>
</li>
<li>
<p><strong>Ejercicio 8.2</strong>: Logs en Pods multi-contenedor</p>
</li>
<li>
<p><strong>Ejercicio 8.3</strong>: Logs de Deployments</p>
</li>
<li>
<p><strong>Ejercicio 8.4</strong>: Eventos del cluster</p>
</li>
<li>
<p><strong>Ejercicio 8.5</strong>: Métricas con kubectl top</p>
</li>
<li>
<p><strong>Ejercicio 8.6</strong>: Resource limits y monitoreo</p>
</li>
<li>
<p><strong>Ejercicio 8.7</strong>: Logging con sidecar pattern</p>
</li>
<li>
<p><strong>Ejercicio 8.8</strong>: Exposición de métricas</p>
</li>
<li>
<p><strong>Ejercicio 8.9</strong>: Análisis de logs</p>
</li>
<li>
<p><strong>Ejercicio 8.10</strong>: Health checks y probes</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_módulo_9_escalado_y_performance">21. Módulo 9: Escalado y Performance</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_ejercicio_9_1_horizontal_pod_autoscaler_con_métrica_cpu">21.1. Ejercicio 9.1: Horizontal Pod Autoscaler con métrica CPU</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Crear un HPA que automáticamente escale un Deployment basado en utilización de CPU. Comprender cómo el HPA monitorea métricas y toma decisiones de escalado.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Crearás un Deployment con requests de CPU, configurarás un HPA para escalar basado en CPU, y luego generarás carga para observar el escalado automático.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un archivo YAML llamado <code>hpa-cpu-deployment.yaml</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">apps/v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Deployment</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">cpu-intensive-app</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">replicas</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">2</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">matchLabels</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">cpu-app</span>
<span class="tok-w">  </span><span class="tok-nt">template</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">cpu-app</span>
<span class="tok-w">    </span><span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">        </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">polinux/stress</span>
<span class="tok-w">        </span><span class="tok-nt">resources</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">requests</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-nt">cpu</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">100m</span>
<span class="tok-w">            </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">128Mi</span>
<span class="tok-w">          </span><span class="tok-nt">limits</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-nt">cpu</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">500m</span>
<span class="tok-w">            </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">256Mi</span>
<span class="tok-w">        </span><span class="tok-nt">args</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">[</span><span class="tok-s">&quot;stress&quot;</span><span class="tok-p tok-p-Indicator">,</span><span class="tok-w"> </span><span class="tok-s">&quot;--cpu&quot;</span><span class="tok-p tok-p-Indicator">,</span><span class="tok-w"> </span><span class="tok-s">&quot;1&quot;</span><span class="tok-p tok-p-Indicator">,</span><span class="tok-w"> </span><span class="tok-s">&quot;--timeout&quot;</span><span class="tok-p tok-p-Indicator">,</span><span class="tok-w"> </span><span class="tok-s">&quot;600s&quot;</span><span class="tok-p tok-p-Indicator">]</span>
<span class="tok-nn">---</span>
<span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">autoscaling/v2</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">HorizontalPodAutoscaler</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">cpu-hpa</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">scaleTargetRef</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">apps/v1</span>
<span class="tok-w">    </span><span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Deployment</span>
<span class="tok-w">    </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">cpu-intensive-app</span>
<span class="tok-w">  </span><span class="tok-nt">minReplicas</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">2</span>
<span class="tok-w">  </span><span class="tok-nt">maxReplicas</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">8</span>
<span class="tok-w">  </span><span class="tok-nt">metrics</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">type</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Resource</span>
<span class="tok-w">    </span><span class="tok-nt">resource</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">cpu</span>
<span class="tok-w">      </span><span class="tok-nt">target</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">type</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Utilization</span>
<span class="tok-w">        </span><span class="tok-nt">averageUtilization</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">70</span>
<span class="tok-w">  </span><span class="tok-nt">behavior</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">scaleUp</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">stabilizationWindowSeconds</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">30</span>
<span class="tok-w">      </span><span class="tok-nt">policies</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">type</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Percent</span>
<span class="tok-w">        </span><span class="tok-nt">value</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">100</span>
<span class="tok-w">        </span><span class="tok-nt">periodSeconds</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">30</span>
<span class="tok-w">    </span><span class="tok-nt">scaleDown</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">stabilizationWindowSeconds</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">60</span>
<span class="tok-w">      </span><span class="tok-nt">policies</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">type</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Percent</span>
<span class="tok-w">        </span><span class="tok-nt">value</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">50</span>
<span class="tok-w">        </span><span class="tok-nt">periodSeconds</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">60</span></code></pre>
</div>
</div>
</li>
<li>
<p>Despliega el Deployment y el HPA:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>hpa-cpu-deployment.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que el HPA está activo:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>hpa
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>hpa<span class="tok-w"> </span>cpu-hpa</code></pre>
</div>
</div>
</li>
<li>
<p>Monitorea el escalado en tiempo real:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># En una ventana de terminal</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>hpa<span class="tok-w"> </span>-w

<span class="tok-c1"># En otra ventana</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>cpu-app<span class="tok-w"> </span>-w</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia los recursos cuando termines:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>-f<span class="tok-w"> </span>hpa-cpu-deployment.yaml</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Cuándo comenzó el HPA a escalar hacia arriba? ¿Cuál fue el trigger?</p>
</li>
<li>
<p>¿Cuántas replicas máximas se alcanzaron?</p>
</li>
<li>
<p>¿Cuál es la diferencia entre stabilizationWindowSeconds en scaleUp vs scaleDown?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_9_2_hpa_con_múltiples_métricas_cpu_y_memoria">21.2. Ejercicio 9.2: HPA con múltiples métricas (CPU y Memoria)</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Configurar un HPA que evalúe múltiples métricas simultáneamente. Comprender cómo el HPA elige el escalado cuando hay conflicto entre métricas.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Crearás un HPA que escale basado en CPU O memoria, lo que significa que cualquiera de las dos métricas que alcance su umbral provocará escalado.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un archivo YAML llamado <code>hpa-multi-metrics.yaml</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">apps/v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Deployment</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">memory-intensive-app</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">replicas</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">2</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">matchLabels</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">mem-app</span>
<span class="tok-w">  </span><span class="tok-nt">template</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">mem-app</span>
<span class="tok-w">    </span><span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">        </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">polinux/stress</span>
<span class="tok-w">        </span><span class="tok-nt">resources</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">requests</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-nt">cpu</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">50m</span>
<span class="tok-w">            </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">64Mi</span>
<span class="tok-w">          </span><span class="tok-nt">limits</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-nt">cpu</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">200m</span>
<span class="tok-w">            </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">512Mi</span>
<span class="tok-w">        </span><span class="tok-nt">args</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">[</span><span class="tok-s">&quot;stress&quot;</span><span class="tok-p tok-p-Indicator">,</span><span class="tok-w"> </span><span class="tok-s">&quot;--vm&quot;</span><span class="tok-p tok-p-Indicator">,</span><span class="tok-w"> </span><span class="tok-s">&quot;1&quot;</span><span class="tok-p tok-p-Indicator">,</span><span class="tok-w"> </span><span class="tok-s">&quot;--vm-bytes&quot;</span><span class="tok-p tok-p-Indicator">,</span><span class="tok-w"> </span><span class="tok-s">&quot;100M&quot;</span><span class="tok-p tok-p-Indicator">,</span><span class="tok-w"> </span><span class="tok-s">&quot;--timeout&quot;</span><span class="tok-p tok-p-Indicator">,</span><span class="tok-w"> </span><span class="tok-s">&quot;600s&quot;</span><span class="tok-p tok-p-Indicator">]</span>
<span class="tok-nn">---</span>
<span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">autoscaling/v2</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">HorizontalPodAutoscaler</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">multi-metric-hpa</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">scaleTargetRef</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">apps/v1</span>
<span class="tok-w">    </span><span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Deployment</span>
<span class="tok-w">    </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">memory-intensive-app</span>
<span class="tok-w">  </span><span class="tok-nt">minReplicas</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">2</span>
<span class="tok-w">  </span><span class="tok-nt">maxReplicas</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">6</span>
<span class="tok-w">  </span><span class="tok-nt">metrics</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-c1"># Métrica 1: CPU</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">type</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Resource</span>
<span class="tok-w">    </span><span class="tok-nt">resource</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">cpu</span>
<span class="tok-w">      </span><span class="tok-nt">target</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">type</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Utilization</span>
<span class="tok-w">        </span><span class="tok-nt">averageUtilization</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">60</span>
<span class="tok-w">  </span><span class="tok-c1"># Métrica 2: Memoria</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">type</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Resource</span>
<span class="tok-w">    </span><span class="tok-nt">resource</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">memory</span>
<span class="tok-w">      </span><span class="tok-nt">target</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">type</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Utilization</span>
<span class="tok-w">        </span><span class="tok-nt">averageUtilization</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">70</span>
<span class="tok-w">  </span><span class="tok-nt">behavior</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">scaleUp</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">stabilizationWindowSeconds</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">0</span>
<span class="tok-w">      </span><span class="tok-nt">policies</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">type</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Percent</span>
<span class="tok-w">        </span><span class="tok-nt">value</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">100</span>
<span class="tok-w">        </span><span class="tok-nt">periodSeconds</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">15</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">type</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Pods</span>
<span class="tok-w">        </span><span class="tok-nt">value</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">2</span>
<span class="tok-w">        </span><span class="tok-nt">periodSeconds</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">15</span>
<span class="tok-w">      </span><span class="tok-nt">selectPolicy</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Max</span>
<span class="tok-w">    </span><span class="tok-nt">scaleDown</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">stabilizationWindowSeconds</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">300</span>
<span class="tok-w">      </span><span class="tok-nt">policies</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">type</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Percent</span>
<span class="tok-w">        </span><span class="tok-nt">value</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">50</span>
<span class="tok-w">        </span><span class="tok-nt">periodSeconds</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">60</span>
<span class="tok-w">      </span><span class="tok-nt">selectPolicy</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Min</span></code></pre>
</div>
</div>
</li>
<li>
<p>Despliega el HPA multi-métrica:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>hpa-multi-metrics.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Monitorea las métricas del HPA:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Ver estado actual</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>hpa<span class="tok-w"> </span>multi-metric-hpa

<span class="tok-c1"># Ver detalles de ambas métricas</span>
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>hpa<span class="tok-w"> </span>multi-metric-hpa

<span class="tok-c1"># Salida esperada:</span>
<span class="tok-c1"># Metrics:</span>
<span class="tok-c1">#   resource cpu on pods (as a percentage of request):</span>
<span class="tok-c1">#     Current / Target: ...</span>
<span class="tok-c1">#   resource memory on pods (as a percentage of request):</span>
<span class="tok-c1">#     Current / Target: ...</span></code></pre>
</div>
</div>
</li>
<li>
<p>Observa el comportamiento de escalado:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Monitorear cambios</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>hpa<span class="tok-w"> </span>multi-metric-hpa<span class="tok-w"> </span>-w</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia los recursos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>-f<span class="tok-w"> </span>hpa-multi-metrics.yaml</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Cuál métrica alcanzó su umbral primero?</p>
</li>
<li>
<p>¿Cómo selecciona el HPA qué métrica usar para escalar?</p>
</li>
<li>
<p>¿Cuál es la diferencia entre <code>selectPolicy: Max</code> y <code>selectPolicy: Min</code>?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_9_3_vertical_pod_autoscaler_en_modo_off_recomendaciones">21.3. Ejercicio 9.3: Vertical Pod Autoscaler en modo "off" (Recomendaciones)</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Usar VPA para obtener recomendaciones de recursos sin aplicarlas automáticamente. Comprender cómo VPA calcula recomendaciones basadas en uso histórico.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Crearás un Deployment con resources mal configurados y usarás VPA en modo "off" para ver qué cambios serían recomendados sin ejecutarlos.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un archivo YAML llamado <code>vpa-recommendations.yaml</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">apps/v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Deployment</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">poorly-configured-app</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">replicas</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">2</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">matchLabels</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">vpa-test-app</span>
<span class="tok-w">  </span><span class="tok-nt">template</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">vpa-test-app</span>
<span class="tok-w">    </span><span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">        </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx:1.21</span>
<span class="tok-w">        </span><span class="tok-nt">resources</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">requests</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-nt">cpu</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">1000m</span><span class="tok-w">        </span><span class="tok-c1"># Sobrer-estimado</span>
<span class="tok-w">            </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">512Mi</span><span class="tok-w">     </span><span class="tok-c1"># Sobrer-estimado</span>
<span class="tok-w">          </span><span class="tok-nt">limits</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-nt">cpu</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">2000m</span>
<span class="tok-w">            </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">1Gi</span>
<span class="tok-nn">---</span>
<span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">autoscaling.k8s.io/v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">VerticalPodAutoscaler</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app-vpa</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">targetRef</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">apps/v1</span>
<span class="tok-w">    </span><span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Deployment</span>
<span class="tok-w">    </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">poorly-configured-app</span>
<span class="tok-w">  </span><span class="tok-nt">updatePolicy</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">updateMode</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;off&quot;</span><span class="tok-w">       </span><span class="tok-c1"># Solo recomendaciones, sin aplicar</span>
<span class="tok-w">  </span><span class="tok-nt">resourcePolicy</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">containerPolicies</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">containerName</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">      </span><span class="tok-nt">minAllowed</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">cpu</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">100m</span>
<span class="tok-w">        </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">128Mi</span>
<span class="tok-w">      </span><span class="tok-nt">maxAllowed</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">cpu</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">1000m</span>
<span class="tok-w">        </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">1Gi</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que VPA esté instalado (si no, asume que está disponible):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>api-resources<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>VerticalPodAutoscaler</code></pre>
</div>
</div>
</li>
<li>
<p>Despliega el Deployment y VPA:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>vpa-recommendations.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Espera a que VPA recolecte datos (2-3 minutos):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>vpa</code></pre>
</div>
</div>
</li>
<li>
<p>Ver las recomendaciones de VPA:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>vpa<span class="tok-w"> </span>app-vpa

<span class="tok-c1"># Salida esperada:</span>
<span class="tok-c1"># Recommendation:</span>
<span class="tok-c1">#   Container Recommendations:</span>
<span class="tok-c1">#   - Container Name: app</span>
<span class="tok-c1">#     Lower Bound:</span>
<span class="tok-c1">#       cpu: 10m</span>
<span class="tok-c1">#       memory: 20Mi</span>
<span class="tok-c1">#     Target:</span>
<span class="tok-c1">#       cpu: 50m</span>
<span class="tok-c1">#       memory: 50Mi</span>
<span class="tok-c1">#     Upper Bound:</span>
<span class="tok-c1">#       cpu: 100m</span>
<span class="tok-c1">#       memory: 100Mi</span></code></pre>
</div>
</div>
</li>
<li>
<p>Comparar requests actuales vs recomendados:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>deployment<span class="tok-w"> </span>poorly-configured-app<span class="tok-w"> </span>-o<span class="tok-w"> </span>yaml<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>-A<span class="tok-w"> </span><span class="tok-m">4</span><span class="tok-w"> </span><span class="tok-s2">&quot;requests:&quot;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Limpia los recursos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>-f<span class="tok-w"> </span>vpa-recommendations.yaml</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Cuál es el <code>Target</code> que VPA recomendó para CPU y memoria?</p>
</li>
<li>
<p>¿Cuánta CPU y memoria podría ahorrar aplicando estas recomendaciones?</p>
</li>
<li>
<p>¿Por qué es útil ver recomendaciones antes de aplicarlas automáticamente?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_9_4_vertical_pod_autoscaler_en_modo_initial">21.4. Ejercicio 9.4: Vertical Pod Autoscaler en modo "initial"</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Usar VPA para ajustar automáticamente los recursos de nuevos Pods, dejando los existentes sin cambios. Comprender cómo VPA puede migrar gradualmente hacia mejor configuración.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Configurarás VPA en modo "initial" y luego actualizarás el Deployment para ver cómo VPA ajusta los nuevos Pods.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un archivo YAML llamado <code>vpa-initial-mode.yaml</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">apps/v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Deployment</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">vpa-initial-app</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">replicas</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">2</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">matchLabels</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">initial-vpa-app</span>
<span class="tok-w">  </span><span class="tok-nt">template</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">initial-vpa-app</span>
<span class="tok-w">    </span><span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">        </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx:1.21</span>
<span class="tok-w">        </span><span class="tok-nt">resources</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">requests</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-nt">cpu</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">500m</span><span class="tok-w">        </span><span class="tok-c1"># Estimado inicial</span>
<span class="tok-w">            </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">256Mi</span>
<span class="tok-w">          </span><span class="tok-nt">limits</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-nt">cpu</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">1000m</span>
<span class="tok-w">            </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">512Mi</span>
<span class="tok-nn">---</span>
<span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">autoscaling.k8s.io/v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">VerticalPodAutoscaler</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">initial-mode-vpa</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">targetRef</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">apps/v1</span>
<span class="tok-w">    </span><span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Deployment</span>
<span class="tok-w">    </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">vpa-initial-app</span>
<span class="tok-w">  </span><span class="tok-nt">updatePolicy</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">updateMode</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;initial&quot;</span><span class="tok-w">   </span><span class="tok-c1"># Ajusta solo Pods nuevos</span>
<span class="tok-w">  </span><span class="tok-nt">resourcePolicy</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">containerPolicies</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">containerName</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">      </span><span class="tok-nt">minAllowed</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">cpu</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">50m</span>
<span class="tok-w">        </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">64Mi</span>
<span class="tok-w">      </span><span class="tok-nt">maxAllowed</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">cpu</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">500m</span>
<span class="tok-w">        </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">512Mi</span></code></pre>
</div>
</div>
</li>
<li>
<p>Despliega el Deployment con VPA:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>vpa-initial-mode.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Registra los requests actuales de los Pods existentes:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>initial-vpa-app<span class="tok-w"> </span>-o<span class="tok-w"> </span><span class="tok-nv">jsonpath</span><span class="tok-o">=</span><span class="tok-s1">&#39;{range .items[*]}{.metadata.name}{&quot;\t&quot;}{.spec.containers[0].resources.requests}{&quot;\n&quot;}{end}&#39;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Espera a que VPA genere recomendaciones (2-3 minutos):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>vpa<span class="tok-w"> </span>initial-mode-vpa</code></pre>
</div>
</div>
</li>
<li>
<p>Fuerza un rollout para crear nuevos Pods:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>rollout<span class="tok-w"> </span>restart<span class="tok-w"> </span>deployment/vpa-initial-app</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que los nuevos Pods tienen diferentes requests:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>initial-vpa-app<span class="tok-w"> </span>-o<span class="tok-w"> </span><span class="tok-nv">jsonpath</span><span class="tok-o">=</span><span class="tok-s1">&#39;{range .items[*]}{.metadata.name}{&quot;\t&quot;}{.spec.containers[0].resources.requests}{&quot;\n&quot;}{end}&#39;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Limpia los recursos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>-f<span class="tok-w"> </span>vpa-initial-mode.yaml</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Cuáles fueron los requests del primer set de Pods?</p>
</li>
<li>
<p>¿Cuáles fueron los requests del nuevo set después del rollout?</p>
</li>
<li>
<p>¿Por qué es útil el modo "initial" en lugar de "off" o "recreate"?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_9_5_resource_quotas_para_limitar_uso_de_namespace">21.5. Ejercicio 9.5: Resource Quotas para limitar uso de namespace</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Crear un Resource Quota para limitar el consumo total de CPU y memoria en un namespace. Comprender cómo Kubernetes puede prevenir que un namespace monopolice recursos.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Crearás un namespace con un Resource Quota restrictivo y luego intentarás desplegar Pods que exceden el quota.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un archivo YAML llamado <code>resource-quota.yaml</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Namespace</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">quota-demo</span>
<span class="tok-nn">---</span>
<span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">ResourceQuota</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">compute-quota</span>
<span class="tok-w">  </span><span class="tok-nt">namespace</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">quota-demo</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">hard</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">requests.cpu</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;2&quot;</span><span class="tok-w">          </span><span class="tok-c1"># 2 CPUs totales</span>
<span class="tok-w">    </span><span class="tok-nt">requests.memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;2Gi&quot;</span><span class="tok-w">     </span><span class="tok-c1"># 2 GB memoria</span>
<span class="tok-w">    </span><span class="tok-nt">limits.cpu</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;4&quot;</span><span class="tok-w">            </span><span class="tok-c1"># 4 CPUs en limits</span>
<span class="tok-w">    </span><span class="tok-nt">limits.memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;4Gi&quot;</span><span class="tok-w">       </span><span class="tok-c1"># 4 GB en limits</span>
<span class="tok-w">    </span><span class="tok-nt">pods</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;10&quot;</span><span class="tok-w">                 </span><span class="tok-c1"># Máximo 10 Pods</span>
<span class="tok-w">  </span><span class="tok-nt">scopeSelector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">matchExpressions</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">operator</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">In</span>
<span class="tok-w">      </span><span class="tok-nt">scopeName</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">PriorityClass</span>
<span class="tok-w">      </span><span class="tok-nt">values</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">[</span><span class="tok-s">&quot;default&quot;</span><span class="tok-p tok-p-Indicator">]</span>
<span class="tok-nn">---</span>
<span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">LimitRange</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">container-limits</span>
<span class="tok-w">  </span><span class="tok-nt">namespace</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">quota-demo</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">limits</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">max</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">cpu</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;1&quot;</span>
<span class="tok-w">      </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;1Gi&quot;</span>
<span class="tok-w">    </span><span class="tok-nt">min</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">cpu</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;50m&quot;</span>
<span class="tok-w">      </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;64Mi&quot;</span>
<span class="tok-w">    </span><span class="tok-nt">default</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">cpu</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;100m&quot;</span>
<span class="tok-w">      </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;128Mi&quot;</span>
<span class="tok-w">    </span><span class="tok-nt">defaultRequest</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">cpu</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;50m&quot;</span>
<span class="tok-w">      </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;64Mi&quot;</span>
<span class="tok-w">    </span><span class="tok-nt">type</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Container</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea el namespace y quota:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>resource-quota.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el quota:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>resourcequota<span class="tok-w"> </span>compute-quota<span class="tok-w"> </span>-n<span class="tok-w"> </span>quota-demo</code></pre>
</div>
</div>
</li>
<li>
<p>Despliega un Deployment que usa 1 CPU y 512 Mi de memoria (dentro del quota):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat<span class="tok-w"> </span><span class="tok-s">&lt;&lt; EOF | kubectl apply -f -</span>
<span class="tok-s">apiVersion: apps/v1</span>
<span class="tok-s">kind: Deployment</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: within-quota-app</span>
<span class="tok-s">  namespace: quota-demo</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  replicas: 2</span>
<span class="tok-s">  selector:</span>
<span class="tok-s">    matchLabels:</span>
<span class="tok-s">      app: test-app</span>
<span class="tok-s">  template:</span>
<span class="tok-s">    metadata:</span>
<span class="tok-s">      labels:</span>
<span class="tok-s">        app: test-app</span>
<span class="tok-s">    spec:</span>
<span class="tok-s">      containers:</span>
<span class="tok-s">      - name: app</span>
<span class="tok-s">        image: nginx:1.21</span>
<span class="tok-s">        resources:</span>
<span class="tok-s">          requests:</span>
<span class="tok-s">            cpu: 500m</span>
<span class="tok-s">            memory: 256Mi</span>
<span class="tok-s">          limits:</span>
<span class="tok-s">            cpu: 1000m</span>
<span class="tok-s">            memory: 512Mi</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el uso actual del quota:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>resourcequota<span class="tok-w"> </span>compute-quota<span class="tok-w"> </span>-n<span class="tok-w"> </span>quota-demo</code></pre>
</div>
</div>
</li>
<li>
<p>Intenta desplegar otro Deployment que excedería el quota:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat<span class="tok-w"> </span><span class="tok-s">&lt;&lt; EOF | kubectl apply -f -</span>
<span class="tok-s">apiVersion: apps/v1</span>
<span class="tok-s">kind: Deployment</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: exceeds-quota-app</span>
<span class="tok-s">  namespace: quota-demo</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  replicas: 2</span>
<span class="tok-s">  selector:</span>
<span class="tok-s">    matchLabels:</span>
<span class="tok-s">      app: excess-app</span>
<span class="tok-s">  template:</span>
<span class="tok-s">    metadata:</span>
<span class="tok-s">      labels:</span>
<span class="tok-s">        app: excess-app</span>
<span class="tok-s">    spec:</span>
<span class="tok-s">      containers:</span>
<span class="tok-s">      - name: app</span>
<span class="tok-s">        image: nginx:1.21</span>
<span class="tok-s">        resources:</span>
<span class="tok-s">          requests:</span>
<span class="tok-s">            cpu: 1500m</span>
<span class="tok-s">            memory: 1Gi</span>
<span class="tok-s">          limits:</span>
<span class="tok-s">            cpu: 2000m</span>
<span class="tok-s">            memory: 2Gi</span>
<span class="tok-s">EOF</span>

<span class="tok-c1"># Salida esperada: Error - exceeded quota</span></code></pre>
</div>
</div>
</li>
<li>
<p>Limpia los recursos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>namespace<span class="tok-w"> </span>quota-demo</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Qué sucedió cuando intentaste crear un Deployment que excedía el quota?</p>
</li>
<li>
<p>¿Cómo se calcula el uso en el quota (suma de requests o suma de limits)?</p>
</li>
<li>
<p>¿Cuáles son otros recursos que se pueden limitar con Resource Quota?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_9_6_pod_anti_affinity_para_alta_disponibilidad">21.6. Ejercicio 9.6: Pod Anti-Affinity para alta disponibilidad</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Configurar Pod Anti-Affinity para asegurar que replicas de una aplicación se distribuyan en diferentes nodos. Comprender cómo mejorar la tolerancia a fallos.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Crearás un Deployment con Pod Anti-Affinity que requiere que cada Pod esté en un nodo diferente.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un archivo YAML llamado <code>pod-anti-affinity.yaml</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">apps/v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Deployment</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">anti-affinity-app</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">replicas</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">3</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">matchLabels</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">distributed-app</span>
<span class="tok-w">  </span><span class="tok-nt">template</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">distributed-app</span>
<span class="tok-w">    </span><span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">affinity</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">podAntiAffinity</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-c1"># Requerido: cada Pod en nodo diferente</span>
<span class="tok-w">          </span><span class="tok-nt">requiredDuringSchedulingIgnoredDuringExecution</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">labelSelector</span><span class="tok-p">:</span>
<span class="tok-w">              </span><span class="tok-nt">matchExpressions</span><span class="tok-p">:</span>
<span class="tok-w">              </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">key</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">                </span><span class="tok-nt">operator</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">In</span>
<span class="tok-w">                </span><span class="tok-nt">values</span><span class="tok-p">:</span>
<span class="tok-w">                </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">distributed-app</span>
<span class="tok-w">            </span><span class="tok-nt">topologyKey</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">kubernetes.io/hostname</span>

<span class="tok-w">      </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">        </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx:1.21</span>
<span class="tok-w">        </span><span class="tok-nt">resources</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">requests</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-nt">cpu</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">100m</span>
<span class="tok-w">            </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">64Mi</span>
<span class="tok-w">          </span><span class="tok-nt">limits</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-nt">cpu</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">200m</span>
<span class="tok-w">            </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">128Mi</span>
<span class="tok-w">        </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">containerPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span></code></pre>
</div>
</div>
</li>
<li>
<p>Despliega el Deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>pod-anti-affinity.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica la distribución de Pods en nodos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-o<span class="tok-w"> </span>wide<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>distributed-app

<span class="tok-c1"># Salida esperada: cada Pod en diferentes nodos</span></code></pre>
</div>
</div>
</li>
<li>
<p>Ver detalles de scheduling:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>deployment<span class="tok-w"> </span>anti-affinity-app

<span class="tok-c1"># Busca información sobre affinity</span></code></pre>
</div>
</div>
</li>
<li>
<p>Observa el comportamiento cuando intentas escalar:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Escala a 5 replicas (puede fallar si no hay suficientes nodos)</span>
kubectl<span class="tok-w"> </span>scale<span class="tok-w"> </span>deployment<span class="tok-w"> </span>anti-affinity-app<span class="tok-w"> </span>--replicas<span class="tok-o">=</span><span class="tok-m">5</span>

<span class="tok-c1"># Ver estado</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-o<span class="tok-w"> </span>wide<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>distributed-app

<span class="tok-c1"># Algunos pueden quedar Pending si no hay suficientes nodos</span></code></pre>
</div>
</div>
</li>
<li>
<p>Limpia los recursos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>-f<span class="tok-w"> </span>pod-anti-affinity.yaml</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Cuál fue la distribución de Pods en los nodos?</p>
</li>
<li>
<p>¿Qué pasó cuando intentaste escalar a 5 replicas?</p>
</li>
<li>
<p>¿Cuál es la diferencia entre <code>required</code> y <code>preferred</code> en Pod Anti-Affinity?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_9_7_taints_y_tolerations_para_nodos_especializados">21.7. Ejercicio 9.7: Taints y Tolerations para nodos especializados</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Usar Taints para marcar nodos especializados y Tolerations para permitir que solo ciertos Pods se ejecuten en ellos. Comprender cómo aislar workloads.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Simulará un escenario donde algunos nodos están reservados para aplicaciones específicas, como GPU o alta memoria.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Obtén el nombre de un nodo:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>nodes

<span class="tok-c1"># Elige un nodo para experimentar (no debe ser crítico)</span>
<span class="tok-c1"># Asumamos que el nodo se llama &quot;worker-node-1&quot;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Agrega un taint al nodo (lo que impide que Pods normales se ejecuten):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Este es un comando informativo, requiere node existente</span>
<span class="tok-c1"># kubectl taint nodes worker-node-1 gpu=required:NoSchedule</span>

<span class="tok-c1"># Para este ejercicio, crea un Pod con toleration</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea un archivo YAML llamado <code>taints-tolerations.yaml</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Pod</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">gpu-application</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx:1.21</span>

<span class="tok-w">  </span><span class="tok-c1"># Pod normal SIN toleration</span>
<span class="tok-w">  </span><span class="tok-nt">tolerations</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">[]</span>

<span class="tok-nn">---</span>
<span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Pod</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">gpu-tolerating-app</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx:1.21</span>

<span class="tok-w">  </span><span class="tok-c1"># Pod CON toleration para el taint</span>
<span class="tok-w">  </span><span class="tok-nt">tolerations</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">key</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">gpu</span>
<span class="tok-w">    </span><span class="tok-nt">operator</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Equal</span>
<span class="tok-w">    </span><span class="tok-nt">value</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">required</span>
<span class="tok-w">    </span><span class="tok-nt">effect</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">NoSchedule</span></code></pre>
</div>
</div>
</li>
<li>
<p>Ver información de taints en nodos (informativo):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Ver taints del cluster</span>
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>nodes<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>Taints

<span class="tok-c1"># Ver master node taints (por defecto tienen NoSchedule)</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crear un Pod con toleration de demostración:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat<span class="tok-w"> </span><span class="tok-s">&lt;&lt; EOF | kubectl apply -f -</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: master-tolerating-pod</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  tolerations:</span>
<span class="tok-s">  - key: node-role.kubernetes.io/master</span>
<span class="tok-s">    operator: Exists</span>
<span class="tok-s">    effect: NoSchedule</span>
<span class="tok-s">  - key: node-role.kubernetes.io/control-plane</span>
<span class="tok-s">    operator: Exists</span>
<span class="tok-s">    effect: NoSchedule</span>

<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: nginx:1.21</span>
<span class="tok-s">    resources:</span>
<span class="tok-s">      requests:</span>
<span class="tok-s">        cpu: 10m</span>
<span class="tok-s">        memory: 32Mi</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que el Pod está corriendo en un nodo master/control-plane:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>master-tolerating-pod<span class="tok-w"> </span>-o<span class="tok-w"> </span>wide</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia los recursos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>master-tolerating-pod</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Cuáles son los taints por defecto en nodos master?</p>
</li>
<li>
<p>¿Cuál es la diferencia entre <code>NoSchedule</code>, <code>PreferNoSchedule</code> y <code>NoExecute</code>?</p>
</li>
<li>
<p>¿Cuándo usarías Taints en lugar de Node Affinity?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_9_8_priority_classes_para_preemption">21.8. Ejercicio 9.8: Priority Classes para preemption</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Crear Priority Classes para definir la importancia de Pods y comprender cómo el scheduler puede preemptar (desalojar) Pods de baja prioridad cuando hay demanda de Pods críticos.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Crearás dos Priority Classes (alta y baja) y observarás cómo Kubernetes prioriza Pods críticos.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un archivo YAML llamado <code>priority-classes.yaml</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">scheduling.k8s.io/v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">PriorityClass</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">critical-priority</span>
<span class="tok-nt">value</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">1000</span>
<span class="tok-nt">globalDefault</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">false</span>
<span class="tok-nt">description</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;Aplicaciones</span><span class="tok-nv"> </span><span class="tok-s">críticas</span><span class="tok-nv"> </span><span class="tok-s">de</span><span class="tok-nv"> </span><span class="tok-s">producción&quot;</span>
<span class="tok-nn">---</span>
<span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">scheduling.k8s.io/v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">PriorityClass</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">low-priority</span>
<span class="tok-nt">value</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">100</span>
<span class="tok-nt">globalDefault</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">false</span>
<span class="tok-nt">description</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-s">&quot;Batch</span><span class="tok-nv"> </span><span class="tok-s">jobs</span><span class="tok-nv"> </span><span class="tok-s">y</span><span class="tok-nv"> </span><span class="tok-s">operaciones</span><span class="tok-nv"> </span><span class="tok-s">no</span><span class="tok-nv"> </span><span class="tok-s">críticas&quot;</span>
<span class="tok-nn">---</span>
<span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Pod</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">critical-pod</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">priorityClassName</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">critical-priority</span>
<span class="tok-w">  </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx:1.21</span>
<span class="tok-w">    </span><span class="tok-nt">resources</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">requests</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">cpu</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">100m</span>
<span class="tok-w">        </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">64Mi</span>
<span class="tok-w">      </span><span class="tok-nt">limits</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">cpu</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">200m</span>
<span class="tok-w">        </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">128Mi</span>
<span class="tok-nn">---</span>
<span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Pod</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">batch-pod</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">priorityClassName</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">low-priority</span>
<span class="tok-w">  </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">busybox</span>
<span class="tok-w">    </span><span class="tok-nt">resources</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">requests</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">cpu</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">100m</span>
<span class="tok-w">        </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">64Mi</span>
<span class="tok-w">      </span><span class="tok-nt">limits</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">cpu</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">200m</span>
<span class="tok-w">        </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">128Mi</span>
<span class="tok-w">    </span><span class="tok-nt">command</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">[</span><span class="tok-s">&quot;sleep&quot;</span><span class="tok-p tok-p-Indicator">,</span><span class="tok-w"> </span><span class="tok-s">&quot;3600&quot;</span><span class="tok-p tok-p-Indicator">]</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crea las Priority Classes:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>priority-classes.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica que las Priority Classes fueron creadas:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>priorityclass

<span class="tok-c1"># Salida:</span>
<span class="tok-c1"># NAME                       VALUE   GLOBAL-DEFAULT   AGE</span>
<span class="tok-c1"># critical-priority          1000    false            5m</span>
<span class="tok-c1"># low-priority               100     false            5m</span></code></pre>
</div>
</div>
</li>
<li>
<p>Ver prioridades de los Pods:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-o<span class="tok-w"> </span>custom-columns<span class="tok-o">=</span>NAME:.metadata.name,PRIORITY:.spec.priorityClassName</code></pre>
</div>
</div>
</li>
<li>
<p>Describe los Pods para ver más detalles:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>pod<span class="tok-w"> </span>critical-pod
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>pod<span class="tok-w"> </span>batch-pod

<span class="tok-c1"># Busca &quot;Priority&quot; en la salida</span></code></pre>
</div>
</div>
</li>
<li>
<p>Limpia los recursos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>critical-pod<span class="tok-w"> </span>batch-pod
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>priorityclass<span class="tok-w"> </span>critical-priority<span class="tok-w"> </span>low-priority</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Cuál es la diferencia entre <code>value</code> en Priority Class?</p>
</li>
<li>
<p>¿Qué significa <code>globalDefault: true</code> en una Priority Class?</p>
</li>
<li>
<p>¿Cuándo Kubernetes preempta (desaloja) un Pod de baja prioridad?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_9_9_resource_limits_y_monitoreo_con_kubectl_top">21.9. Ejercicio 9.9: Resource Limits y monitoreo con kubectl top</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Establecer resource limits para Pods y usar kubectl top para monitorear su consumo real versus los límites definidos.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Crearás Pods con diferentes límites de recursos y observarás cómo el kernel los enforza.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crea un archivo YAML llamado <code>resource-limits-demo.yaml</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">apps/v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Deployment</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">limited-app</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">replicas</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">2</span>
<span class="tok-w">  </span><span class="tok-nt">selector</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">matchLabels</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">limited-app</span>
<span class="tok-w">  </span><span class="tok-nt">template</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">labels</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">app</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">limited-app</span>
<span class="tok-w">    </span><span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">        </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx:1.21</span>
<span class="tok-w">        </span><span class="tok-nt">resources</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-nt">requests</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-nt">cpu</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">100m</span>
<span class="tok-w">            </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">64Mi</span>
<span class="tok-w">          </span><span class="tok-nt">limits</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-nt">cpu</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">200m</span>
<span class="tok-w">            </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">128Mi</span>
<span class="tok-w">        </span><span class="tok-nt">ports</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">containerPort</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">80</span>
<span class="tok-nn">---</span>
<span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Pod</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">memory-leak-simulator</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">polinux/stress</span>
<span class="tok-w">    </span><span class="tok-nt">args</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-p tok-p-Indicator">[</span><span class="tok-s">&quot;stress&quot;</span><span class="tok-p tok-p-Indicator">,</span><span class="tok-w"> </span><span class="tok-s">&quot;--vm&quot;</span><span class="tok-p tok-p-Indicator">,</span><span class="tok-w"> </span><span class="tok-s">&quot;1&quot;</span><span class="tok-p tok-p-Indicator">,</span><span class="tok-w"> </span><span class="tok-s">&quot;--vm-bytes&quot;</span><span class="tok-p tok-p-Indicator">,</span><span class="tok-w"> </span><span class="tok-s">&quot;200M&quot;</span><span class="tok-p tok-p-Indicator">,</span><span class="tok-w"> </span><span class="tok-s">&quot;--timeout&quot;</span><span class="tok-p tok-p-Indicator">,</span><span class="tok-w"> </span><span class="tok-s">&quot;300s&quot;</span><span class="tok-p tok-p-Indicator">]</span>
<span class="tok-w">    </span><span class="tok-nt">resources</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">requests</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">cpu</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">100m</span>
<span class="tok-w">        </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">64Mi</span>
<span class="tok-w">      </span><span class="tok-nt">limits</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">cpu</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">500m</span>
<span class="tok-w">        </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">256Mi</span><span class="tok-w">        </span><span class="tok-c1"># Será excedido, causa OOM kill</span></code></pre>
</div>
</div>
</li>
<li>
<p>Despliega los recursos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>resource-limits-demo.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Espera unos segundos y monitorea los Pods:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-o<span class="tok-w"> </span>wide</code></pre>
</div>
</div>
</li>
<li>
<p>Ver consumo de recursos con kubectl top (si Metrics Server está instalado):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Ver consumo de nodos</span>
kubectl<span class="tok-w"> </span>top<span class="tok-w"> </span>nodes

<span class="tok-c1"># Ver consumo de Pods</span>
kubectl<span class="tok-w"> </span>top<span class="tok-w"> </span>pods

<span class="tok-c1"># Ver consumo de pods específicos</span>
kubectl<span class="tok-w"> </span>top<span class="tok-w"> </span>pod<span class="tok-w"> </span>limited-app-xxx<span class="tok-w"> </span>limited-app-yyy<span class="tok-w"> </span>memory-leak-simulator

<span class="tok-c1"># Ordena por CPU</span>
kubectl<span class="tok-w"> </span>top<span class="tok-w"> </span>pods<span class="tok-w"> </span>--sort-by<span class="tok-o">=</span>cpu</code></pre>
</div>
</div>
</li>
<li>
<p>Describe el Pod que simula memory leak:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>pod<span class="tok-w"> </span>memory-leak-simulator

<span class="tok-c1"># Busca &quot;OOMKilled&quot; o estado de contenedor</span></code></pre>
</div>
</div>
</li>
<li>
<p>Ver los logs si está disponible:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>events<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>memory-leak-simulator</code></pre>
</div>
</div>
</li>
<li>
<p>Limpia los recursos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>-f<span class="tok-w"> </span>resource-limits-demo.yaml</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Qué pasó cuando el Pod intentó usar más memoria que su límite?</p>
</li>
<li>
<p>¿Cuál es la diferencia entre OOMKilled y Evicted?</p>
</li>
<li>
<p>¿Cómo puedes saber si un Pod excedió sus límites de CPU?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_9_10_cluster_autoscaler_y_node_affinity">21.10. Ejercicio 9.10: Cluster Autoscaler y Node Affinity</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Entender cómo Cluster Autoscaler interactúa con Node Affinity para escalar nodos cuando Pods no pueden ser scheduled.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Crearás Deployments con Node Affinity y observarás cómo Cluster Autoscaler crearía nuevos nodos si fuera necesario.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Ver información de nodos del cluster:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>nodes
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>nodes<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>head<span class="tok-w"> </span>-50</code></pre>
</div>
</div>
</li>
<li>
<p>Crea un archivo YAML llamado <code>cluster-autoscaler-demo.yaml</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Namespace</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">autoscaler-demo</span>
<span class="tok-nn">---</span>
<span class="tok-nt">apiVersion</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">v1</span>
<span class="tok-nt">kind</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">Pod</span>
<span class="tok-nt">metadata</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">affinity-demo-pod</span>
<span class="tok-w">  </span><span class="tok-nt">namespace</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">autoscaler-demo</span>
<span class="tok-nt">spec</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-nt">affinity</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-nt">nodeAffinity</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">requiredDuringSchedulingIgnoredDuringExecution</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">nodeSelectorTerms</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">matchExpressions</span><span class="tok-p">:</span>
<span class="tok-w">          </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">key</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">node-role.kubernetes.io/control-plane</span>
<span class="tok-w">            </span><span class="tok-nt">operator</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">NotIn</span>
<span class="tok-w">            </span><span class="tok-nt">values</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-s">&quot;true&quot;</span>
<span class="tok-w">          </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">key</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">disktype</span>
<span class="tok-w">            </span><span class="tok-nt">operator</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">In</span>
<span class="tok-w">            </span><span class="tok-nt">values</span><span class="tok-p">:</span>
<span class="tok-w">            </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">ssd</span>

<span class="tok-w">  </span><span class="tok-nt">containers</span><span class="tok-p">:</span>
<span class="tok-w">  </span><span class="tok-p tok-p-Indicator">-</span><span class="tok-w"> </span><span class="tok-nt">name</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">app</span>
<span class="tok-w">    </span><span class="tok-nt">image</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">nginx:1.21</span>
<span class="tok-w">    </span><span class="tok-nt">resources</span><span class="tok-p">:</span>
<span class="tok-w">      </span><span class="tok-nt">requests</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">cpu</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">500m</span>
<span class="tok-w">        </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">256Mi</span>
<span class="tok-w">      </span><span class="tok-nt">limits</span><span class="tok-p">:</span>
<span class="tok-w">        </span><span class="tok-nt">cpu</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">1000m</span>
<span class="tok-w">        </span><span class="tok-nt">memory</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">512Mi</span>

<span class="tok-w">  </span><span class="tok-c1"># Si el nodo especificado no existe, el Pod quedará Pending</span>
<span class="tok-w">  </span><span class="tok-c1"># Si Cluster Autoscaler estuviera activo, crearía un nuevo nodo</span></code></pre>
</div>
</div>
</li>
<li>
<p>Despliega el demo:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>cluster-autoscaler-demo.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Verifica el estado del Pod:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-n<span class="tok-w"> </span>autoscaler-demo

<span class="tok-c1"># Probablemente estará en estado Pending</span>
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>pod<span class="tok-w"> </span>affinity-demo-pod<span class="tok-w"> </span>-n<span class="tok-w"> </span>autoscaler-demo

<span class="tok-c1"># Busca &quot;Unable to schedule&quot; en los eventos</span></code></pre>
</div>
</div>
</li>
<li>
<p>Ver Pending Pods (esto es lo que triggerea Cluster Autoscaler):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>--field-selector<span class="tok-o">=</span>status.phase<span class="tok-o">=</span>Pending<span class="tok-w"> </span>-A</code></pre>
</div>
</div>
</li>
<li>
<p>Monitorear Cluster Autoscaler (si existe):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Ver logs de Cluster Autoscaler (si está instalado)</span>
kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>-n<span class="tok-w"> </span>kube-system<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>cluster-autoscaler<span class="tok-w"> </span>-f<span class="tok-w"> </span>--tail<span class="tok-o">=</span><span class="tok-m">20</span>

<span class="tok-c1"># En un cluster real con autoscaling:</span>
<span class="tok-c1"># Verías logs como: &quot;Scale-up is enabled. Will try to scale nodes...&quot;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Limpia los recursos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>namespace<span class="tok-w"> </span>autoscaler-demo</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Por qué el Pod quedó en estado Pending?</p>
</li>
<li>
<p>¿Qué sucedería en un cluster con Cluster Autoscaler activo?</p>
</li>
<li>
<p>¿Cuál es la diferencia entre HPA (escala Pods) y Cluster Autoscaler (escala nodos)?</p>
</li>
</ol>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resumen_de_conceptos_9">22. Resumen de Conceptos</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Estos ejercicios del Módulo 9 cubren:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Ejercicio 9.1</strong>: HPA con métrica CPU</p>
</li>
<li>
<p><strong>Ejercicio 9.2</strong>: HPA con múltiples métricas</p>
</li>
<li>
<p><strong>Ejercicio 9.3</strong>: VPA recomendaciones (modo off)</p>
</li>
<li>
<p><strong>Ejercicio 9.4</strong>: VPA auto-actualización (modo initial)</p>
</li>
<li>
<p><strong>Ejercicio 9.5</strong>: Resource Quotas por namespace</p>
</li>
<li>
<p><strong>Ejercicio 9.6</strong>: Pod Anti-Affinity para distribución</p>
</li>
<li>
<p><strong>Ejercicio 9.7</strong>: Taints y Tolerations</p>
</li>
<li>
<p><strong>Ejercicio 9.8</strong>: Priority Classes</p>
</li>
<li>
<p><strong>Ejercicio 9.9</strong>: Resource Limits y monitoreo</p>
</li>
<li>
<p><strong>Ejercicio 9.10</strong>: Cluster Autoscaler y scheduling</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_módulo_10_helm_y_package_management">23. Módulo 10: Helm y Package Management</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_ejercicio_10_1_gestión_de_repositorios_de_helm">23.1. Ejercicio 10.1: Gestión de Repositorios de Helm</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Aprender a agregar, actualizar y gestionar repositorios de Helm. Entender cómo Helm accede a Charts públicos desde repositorios remotos.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Trabajarás con repositorios de Helm, agregando fuentes oficiales y buscando Charts disponibles.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Verifica que Helm está instalado:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>helm<span class="tok-w"> </span>version

<span class="tok-c1"># Salida esperada:</span>
<span class="tok-c1"># version.BuildInfo{Version:&quot;v3.x.x&quot;, ...}</span></code></pre>
</div>
</div>
</li>
<li>
<p>Agregar el repositorio oficial de Helm:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Agregar repositorio stable</span>
helm<span class="tok-w"> </span>repo<span class="tok-w"> </span>add<span class="tok-w"> </span>stable<span class="tok-w"> </span>https://charts.helm.sh/stable

<span class="tok-c1"># Agregar repositorio Bitnami (Charts de alta calidad)</span>
helm<span class="tok-w"> </span>repo<span class="tok-w"> </span>add<span class="tok-w"> </span>bitnami<span class="tok-w"> </span>https://charts.bitnami.com/bitnami

<span class="tok-c1"># Ver repositorios agregados</span>
helm<span class="tok-w"> </span>repo<span class="tok-w"> </span>list

<span class="tok-c1"># Salida esperada:</span>
<span class="tok-c1"># NAME      URL</span>
<span class="tok-c1"># stable    https://charts.helm.sh/stable</span>
<span class="tok-c1"># bitnami   https://charts.bitnami.com/bitnami</span></code></pre>
</div>
</div>
</li>
<li>
<p>Actualizar índices de repositorios:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Actualizar todos los repositorios</span>
helm<span class="tok-w"> </span>repo<span class="tok-w"> </span>update

<span class="tok-c1"># Salida esperada:</span>
<span class="tok-c1"># Hang tight while we grab the latest from your chart repositories...</span>
<span class="tok-c1"># ...Successfully got an update from the &quot;stable&quot; chart repository</span>
<span class="tok-c1"># ...Successfully got an update from the &quot;bitnami&quot; chart repository</span>
<span class="tok-c1"># Update Complete. ⎈ Happy Helming!</span></code></pre>
</div>
</div>
</li>
<li>
<p>Buscar Charts en repositorios:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Buscar nginx</span>
helm<span class="tok-w"> </span>search<span class="tok-w"> </span>repo<span class="tok-w"> </span>nginx

<span class="tok-c1"># Buscar postgresql</span>
helm<span class="tok-w"> </span>search<span class="tok-w"> </span>repo<span class="tok-w"> </span>postgresql

<span class="tok-c1"># Buscar todos los Charts en bitnami</span>
helm<span class="tok-w"> </span>search<span class="tok-w"> </span>repo<span class="tok-w"> </span>bitnami<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>head<span class="tok-w"> </span>-20</code></pre>
</div>
</div>
</li>
<li>
<p>Ver detalles de un Chart específico:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Ver metadatos del Chart</span>
helm<span class="tok-w"> </span>show<span class="tok-w"> </span>chart<span class="tok-w"> </span>bitnami/nginx

<span class="tok-c1"># Ver valores por defecto</span>
helm<span class="tok-w"> </span>show<span class="tok-w"> </span>values<span class="tok-w"> </span>bitnami/nginx<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>head<span class="tok-w"> </span>-30

<span class="tok-c1"># Ver todo (Chart + README + valores)</span>
helm<span class="tok-w"> </span>show<span class="tok-w"> </span>all<span class="tok-w"> </span>bitnami/nginx<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>head<span class="tok-w"> </span>-50</code></pre>
</div>
</div>
</li>
<li>
<p>Listar versiones disponibles de un Chart:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Ver todas las versiones</span>
helm<span class="tok-w"> </span>search<span class="tok-w"> </span>repo<span class="tok-w"> </span>bitnami/nginx<span class="tok-w"> </span>--versions<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>head<span class="tok-w"> </span>-10</code></pre>
</div>
</div>
</li>
<li>
<p>Remover un repositorio:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Remover repositorio stable (opcional)</span>
<span class="tok-c1"># helm repo remove stable</span>

<span class="tok-c1"># Ver repositorios actuales</span>
helm<span class="tok-w"> </span>repo<span class="tok-w"> </span>list</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Cuál es la diferencia entre el repositorio "stable" y "bitnami"?</p>
</li>
<li>
<p>¿Por qué es importante actualizar los índices de repositorios con <code>helm repo update</code>?</p>
</li>
<li>
<p>¿Cómo podrías usar un repositorio privado o corporativo?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_10_2_instalación_de_un_chart_desde_repositorio">23.2. Ejercicio 10.2: Instalación de un Chart desde Repositorio</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Instalar un Chart desde un repositorio remoto con valores por defecto. Comprender el ciclo completo de instalación de Helm.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Instalarás un Chart nginx desde Bitnami y verificarás la release creada.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Instalar nginx desde Bitnami con valores por defecto:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Instalación simple</span>
helm<span class="tok-w"> </span>install<span class="tok-w"> </span>my-nginx<span class="tok-w"> </span>bitnami/nginx

<span class="tok-c1"># Salida esperada:</span>
<span class="tok-c1"># NAME: my-nginx</span>
<span class="tok-c1"># LAST DEPLOYED: ...</span>
<span class="tok-c1"># NAMESPACE: default</span>
<span class="tok-c1"># STATUS: deployed</span>
<span class="tok-c1"># ...</span></code></pre>
</div>
</div>
</li>
<li>
<p>Listar releases instaladas:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Ver todas las releases</span>
helm<span class="tok-w"> </span>list

<span class="tok-c1"># Salida esperada:</span>
<span class="tok-c1"># NAME      NAMESPACE STATUS    CHART        APP VERSION</span>
<span class="tok-c1"># my-nginx  default   deployed  nginx-15...  1.25.x</span></code></pre>
</div>
</div>
</li>
<li>
<p>Ver status de la release:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Status detallado</span>
helm<span class="tok-w"> </span>status<span class="tok-w"> </span>my-nginx

<span class="tok-c1"># Ver recursos creados en Kubernetes</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>all<span class="tok-w"> </span>-l<span class="tok-w"> </span>app.kubernetes.io/instance<span class="tok-o">=</span>my-nginx

<span class="tok-c1"># Ver Pods</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span>app.kubernetes.io/instance<span class="tok-o">=</span>my-nginx</code></pre>
</div>
</div>
</li>
<li>
<p>Ver valores de la release:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Ver solo valores personalizados (sobrescritos)</span>
helm<span class="tok-w"> </span>get<span class="tok-w"> </span>values<span class="tok-w"> </span>my-nginx

<span class="tok-c1"># Ver todos los valores (incluyendo defaults)</span>
helm<span class="tok-w"> </span>get<span class="tok-w"> </span>values<span class="tok-w"> </span>my-nginx<span class="tok-w"> </span>--all<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>head<span class="tok-w"> </span>-50</code></pre>
</div>
</div>
</li>
<li>
<p>Ver manifiestos YAML desplegados:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Ver todos los manifiestos</span>
helm<span class="tok-w"> </span>get<span class="tok-w"> </span>manifest<span class="tok-w"> </span>my-nginx<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>head<span class="tok-w"> </span>-50</code></pre>
</div>
</div>
</li>
<li>
<p>Ver Chart.yaml de la release:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Ver metadatos del Chart</span>
helm<span class="tok-w"> </span>get<span class="tok-w"> </span>chart<span class="tok-w"> </span>my-nginx</code></pre>
</div>
</div>
</li>
<li>
<p>Ver notas post-instalación:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Ver instrucciones</span>
helm<span class="tok-w"> </span>get<span class="tok-w"> </span>notes<span class="tok-w"> </span>my-nginx</code></pre>
</div>
</div>
</li>
<li>
<p>Desinstalar la release:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Desinstalar</span>
helm<span class="tok-w"> </span>uninstall<span class="tok-w"> </span>my-nginx

<span class="tok-c1"># Verificar que se removió</span>
helm<span class="tok-w"> </span>list</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Cuál fue el status de la release después de instalar?</p>
</li>
<li>
<p>¿Cuáles fueron los recursos de Kubernetes creados por Helm?</p>
</li>
<li>
<p>¿Cómo se diferencian los valores por defecto de los personalizados?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_10_3_instalación_con_valores_personalizados">23.3. Ejercicio 10.3: Instalación con Valores Personalizados</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Instalar un Chart personalizando valores con --set y archivos values. Comprender cómo parametrizar Deployments.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Instalarás nginx con réplicas, tipo de servicio y otras configuraciones personalizadas.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crear un archivo values personalizado:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>custom-values.yaml<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;EOF&#39;</span>
<span class="tok-s"># Configuración personalizada para nginx</span>
<span class="tok-s">replicaCount: 3</span>

<span class="tok-s">image:</span>
<span class="tok-s">  repository: bitnami/nginx</span>
<span class="tok-s">  tag: &quot;1.25.0&quot;</span>

<span class="tok-s">service:</span>
<span class="tok-s">  type: LoadBalancer</span>
<span class="tok-s">  port: 80</span>

<span class="tok-s">resources:</span>
<span class="tok-s">  limits:</span>
<span class="tok-s">    cpu: 200m</span>
<span class="tok-s">    memory: 256Mi</span>
<span class="tok-s">  requests:</span>
<span class="tok-s">    cpu: 100m</span>
<span class="tok-s">    memory: 128Mi</span>

<span class="tok-s">autoscaling:</span>
<span class="tok-s">  enabled: true</span>
<span class="tok-s">  minReplicas: 2</span>
<span class="tok-s">  maxReplicas: 5</span>
<span class="tok-s">  targetCPUUtilizationPercentage: 70</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Instalar con archivo values:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Instalar usando archivo values</span>
helm<span class="tok-w"> </span>install<span class="tok-w"> </span>my-nginx-custom<span class="tok-w"> </span>bitnami/nginx<span class="tok-w"> </span>-f<span class="tok-w"> </span>custom-values.yaml

<span class="tok-c1"># Ver detalles</span>
helm<span class="tok-w"> </span>status<span class="tok-w"> </span>my-nginx-custom</code></pre>
</div>
</div>
</li>
<li>
<p>Verificar configuración:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Ver valores personalizados</span>
helm<span class="tok-w"> </span>get<span class="tok-w"> </span>values<span class="tok-w"> </span>my-nginx-custom

<span class="tok-c1"># Ver Pods creados</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span>app.kubernetes.io/instance<span class="tok-o">=</span>my-nginx-custom

<span class="tok-c1"># Ver Service</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>svc<span class="tok-w"> </span>-l<span class="tok-w"> </span>app.kubernetes.io/instance<span class="tok-o">=</span>my-nginx-custom</code></pre>
</div>
</div>
</li>
<li>
<p>Instalar con --set desde línea de comandos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Instalar con múltiples --set</span>
helm<span class="tok-w"> </span>install<span class="tok-w"> </span>my-nginx-cli<span class="tok-w"> </span>bitnami/nginx<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--set<span class="tok-w"> </span><span class="tok-nv">replicaCount</span><span class="tok-o">=</span><span class="tok-m">2</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--set<span class="tok-w"> </span>service.type<span class="tok-o">=</span>NodePort<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--set<span class="tok-w"> </span>resources.requests.cpu<span class="tok-o">=</span>50m

<span class="tok-c1"># Ver valores</span>
helm<span class="tok-w"> </span>get<span class="tok-w"> </span>values<span class="tok-w"> </span>my-nginx-cli</code></pre>
</div>
</div>
</li>
<li>
<p>Combinar archivo values y --set:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># El --set sobreescribe el archivo values</span>
helm<span class="tok-w"> </span>install<span class="tok-w"> </span>my-nginx-combined<span class="tok-w"> </span>bitnami/nginx<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>-f<span class="tok-w"> </span>custom-values.yaml<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--set<span class="tok-w"> </span><span class="tok-nv">replicaCount</span><span class="tok-o">=</span><span class="tok-m">4</span>

<span class="tok-c1"># Ver valores (replicaCount debe ser 4)</span>
helm<span class="tok-w"> </span>get<span class="tok-w"> </span>values<span class="tok-w"> </span>my-nginx-combined<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>replicaCount</code></pre>
</div>
</div>
</li>
<li>
<p>Usar --set-string para valores complejos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># --set-string evita conversiones automáticas</span>
helm<span class="tok-w"> </span>install<span class="tok-w"> </span>my-nginx-string<span class="tok-w"> </span>bitnami/nginx<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--set-string<span class="tok-w"> </span>image.tag<span class="tok-o">=</span><span class="tok-s2">&quot;1.25.0&quot;</span>

<span class="tok-c1"># Ver el tag (debe ser string, no convertido a número)</span>
helm<span class="tok-w"> </span>get<span class="tok-w"> </span>values<span class="tok-w"> </span>my-nginx-string<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>tag</code></pre>
</div>
</div>
</li>
<li>
<p>Ver manifiestos antes de instalar (--dry-run):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Simulación: ver qué se instalaría sin hacerlo realmente</span>
helm<span class="tok-w"> </span>install<span class="tok-w"> </span>my-nginx-test<span class="tok-w"> </span>bitnami/nginx<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--dry-run<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--debug<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>head<span class="tok-w"> </span>-50

<span class="tok-c1"># No crea recursos reales, solo muestra salida</span></code></pre>
</div>
</div>
</li>
<li>
<p>Limpiar todas las releases:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>helm<span class="tok-w"> </span>uninstall<span class="tok-w"> </span>my-nginx-custom<span class="tok-w"> </span>my-nginx-cli<span class="tok-w"> </span>my-nginx-combined<span class="tok-w"> </span>my-nginx-string</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Cuál es la diferencia entre usar --set y un archivo values?</p>
</li>
<li>
<p>¿Qué pasa cuando especificas el mismo valor en archivo values y --set?</p>
</li>
<li>
<p>¿Por qué --dry-run es útil antes de instalar en producción?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_10_4_actualización_de_releases_helm_upgrade">23.4. Ejercicio 10.4: Actualización de Releases (helm upgrade)</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Actualizar una release existente con nuevas versiones del Chart o cambios de configuración. Entender cómo Helm maneja upgrades.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Instalarás un Chart, luego lo actualizarás cambiando valores y versión.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Instalar una versión inicial:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Instalar con valores iniciales</span>
helm<span class="tok-w"> </span>install<span class="tok-w"> </span>my-app<span class="tok-w"> </span>bitnami/nginx<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--set<span class="tok-w"> </span><span class="tok-nv">replicaCount</span><span class="tok-o">=</span><span class="tok-m">2</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--set<span class="tok-w"> </span>image.tag<span class="tok-o">=</span><span class="tok-s2">&quot;1.24.0&quot;</span>

<span class="tok-c1"># Ver status</span>
helm<span class="tok-w"> </span>status<span class="tok-w"> </span>my-app</code></pre>
</div>
</div>
</li>
<li>
<p>Ver historial de la release (solo 1 entry):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>helm<span class="tok-w"> </span><span class="tok-nb">history</span><span class="tok-w"> </span>my-app

<span class="tok-c1"># Salida esperada:</span>
<span class="tok-c1"># REVISION STATUS      CHART         APP VERSION DESCRIPTION</span>
<span class="tok-c1"># 1        deployed    nginx-15.0.0  1.24.0      Install complete</span></code></pre>
</div>
</div>
</li>
<li>
<p>Realizar un upgrade cambiando valores:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Upgrade: aumentar replicas</span>
helm<span class="tok-w"> </span>upgrade<span class="tok-w"> </span>my-app<span class="tok-w"> </span>bitnami/nginx<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--set<span class="tok-w"> </span><span class="tok-nv">replicaCount</span><span class="tok-o">=</span><span class="tok-m">4</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--set<span class="tok-w"> </span>image.tag<span class="tok-o">=</span><span class="tok-s2">&quot;1.25.0&quot;</span>

<span class="tok-c1"># Ver status</span>
helm<span class="tok-w"> </span>status<span class="tok-w"> </span>my-app</code></pre>
</div>
</div>
</li>
<li>
<p>Ver historial después del upgrade:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>helm<span class="tok-w"> </span><span class="tok-nb">history</span><span class="tok-w"> </span>my-app

<span class="tok-c1"># Salida esperada (now 2 revisions):</span>
<span class="tok-c1"># REVISION STATUS      CHART         APP VERSION DESCRIPTION</span>
<span class="tok-c1"># 1        superseded  nginx-15.0.0  1.24.0      Install complete</span>
<span class="tok-c1"># 2        deployed    nginx-15.0.0  1.25.0      Upgrade complete</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verificar cambios en los Pods:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Pods nuevos con nueva imagen</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span>app.kubernetes.io/instance<span class="tok-o">=</span>my-app

<span class="tok-c1"># Ver imagen en uso</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pod<span class="tok-w"> </span>-l<span class="tok-w"> </span>app.kubernetes.io/instance<span class="tok-o">=</span>my-app<span class="tok-w"> </span>-o<span class="tok-w"> </span><span class="tok-nv">jsonpath</span><span class="tok-o">=</span><span class="tok-s1">&#39;{range .items[*]}{.spec.containers[0].image}{&quot;\n&quot;}{end}&#39;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Upgrade atómico (con rollback automático en error):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Si algo falla, automáticamente hace rollback</span>
helm<span class="tok-w"> </span>upgrade<span class="tok-w"> </span>my-app<span class="tok-w"> </span>bitnami/nginx<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--set<span class="tok-w"> </span><span class="tok-nv">replicaCount</span><span class="tok-o">=</span><span class="tok-m">3</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--atomic

<span class="tok-c1"># Ver nuevo status</span>
helm<span class="tok-w"> </span>status<span class="tok-w"> </span>my-app</code></pre>
</div>
</div>
</li>
<li>
<p>Ver cambios que haría un upgrade (--dry-run):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Simulación: ver qué cambiaría sin hacerlo</span>
helm<span class="tok-w"> </span>upgrade<span class="tok-w"> </span>my-app<span class="tok-w"> </span>bitnami/nginx<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--set<span class="tok-w"> </span><span class="tok-nv">replicaCount</span><span class="tok-o">=</span><span class="tok-m">5</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--dry-run<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--debug<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>head<span class="tok-w"> </span>-100

<span class="tok-c1"># No aplica los cambios, solo muestra</span></code></pre>
</div>
</div>
</li>
<li>
<p>Obtener valores actuales:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Ver solo valores personalizados</span>
helm<span class="tok-w"> </span>get<span class="tok-w"> </span>values<span class="tok-w"> </span>my-app

<span class="tok-c1"># Ver todos (incluyendo defaults)</span>
helm<span class="tok-w"> </span>get<span class="tok-w"> </span>values<span class="tok-w"> </span>my-app<span class="tok-w"> </span>--all<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>replicaCount</code></pre>
</div>
</div>
</li>
<li>
<p>Limpiar:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>helm<span class="tok-w"> </span>uninstall<span class="tok-w"> </span>my-app</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Cuál fue la diferencia entre la primera instalación y el primer upgrade?</p>
</li>
<li>
<p>¿Cuántos Pods se recrearon durante el upgrade?</p>
</li>
<li>
<p>¿Para qué sirve el modo --atomic?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_10_5_historial_y_rollback_de_releases">23.5. Ejercicio 10.5: Historial y Rollback de Releases</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Comprender cómo Helm mantiene historial de cambios y cómo revertir a versiones anteriores.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Realizarás varios upgrades y luego harás rollback a revisiones anteriores.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Instalar una aplicación:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>helm<span class="tok-w"> </span>install<span class="tok-w"> </span>myapp<span class="tok-w"> </span>bitnami/nginx<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--set<span class="tok-w"> </span><span class="tok-nv">replicaCount</span><span class="tok-o">=</span><span class="tok-m">1</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--set<span class="tok-w"> </span>image.tag<span class="tok-o">=</span><span class="tok-s2">&quot;1.24.0&quot;</span>

helm<span class="tok-w"> </span><span class="tok-nb">history</span><span class="tok-w"> </span>myapp</code></pre>
</div>
</div>
</li>
<li>
<p>Realizar varios upgrades:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Upgrade 1</span>
helm<span class="tok-w"> </span>upgrade<span class="tok-w"> </span>myapp<span class="tok-w"> </span>bitnami/nginx<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--set<span class="tok-w"> </span><span class="tok-nv">replicaCount</span><span class="tok-o">=</span><span class="tok-m">2</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--set<span class="tok-w"> </span>image.tag<span class="tok-o">=</span><span class="tok-s2">&quot;1.24.0&quot;</span>

<span class="tok-c1"># Upgrade 2</span>
helm<span class="tok-w"> </span>upgrade<span class="tok-w"> </span>myapp<span class="tok-w"> </span>bitnami/nginx<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--set<span class="tok-w"> </span><span class="tok-nv">replicaCount</span><span class="tok-o">=</span><span class="tok-m">3</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--set<span class="tok-w"> </span>image.tag<span class="tok-o">=</span><span class="tok-s2">&quot;1.25.0&quot;</span>

<span class="tok-c1"># Upgrade 3</span>
helm<span class="tok-w"> </span>upgrade<span class="tok-w"> </span>myapp<span class="tok-w"> </span>bitnami/nginx<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--set<span class="tok-w"> </span><span class="tok-nv">replicaCount</span><span class="tok-o">=</span><span class="tok-m">4</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--set<span class="tok-w"> </span>image.tag<span class="tok-o">=</span><span class="tok-s2">&quot;1.25.1&quot;</span>

<span class="tok-c1"># Ver historial completo</span>
helm<span class="tok-w"> </span><span class="tok-nb">history</span><span class="tok-w"> </span>myapp

<span class="tok-c1"># Salida esperada:</span>
<span class="tok-c1"># REVISION STATUS      CHART  APP VERSION DESCRIPTION</span>
<span class="tok-c1"># 1        superseded  ...    1.24.0      Install complete</span>
<span class="tok-c1"># 2        superseded  ...    1.24.0      Upgrade complete</span>
<span class="tok-c1"># 3        superseded  ...    1.25.0      Upgrade complete</span>
<span class="tok-c1"># 4        deployed    ...    1.25.1      Upgrade complete</span></code></pre>
</div>
</div>
</li>
<li>
<p>Ver estado actual:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span>app.kubernetes.io/instance<span class="tok-o">=</span>myapp<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>wc<span class="tok-w"> </span>-l

<span class="tok-c1"># Debería mostrar 5 (header + 4 pods)</span></code></pre>
</div>
</div>
</li>
<li>
<p>Hacer rollback a la revisión anterior:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Rollback sin argumentos = vuelve a la revisión anterior</span>
helm<span class="tok-w"> </span>rollback<span class="tok-w"> </span>myapp

<span class="tok-c1"># Ver status</span>
helm<span class="tok-w"> </span>status<span class="tok-w"> </span>myapp

<span class="tok-c1"># Ver historial (nueva revisión 5 con los valores de revisión 3)</span>
helm<span class="tok-w"> </span><span class="tok-nb">history</span><span class="tok-w"> </span>myapp</code></pre>
</div>
</div>
</li>
<li>
<p>Rollback a una revisión específica:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Rollback a revisión 2 específicamente</span>
helm<span class="tok-w"> </span>rollback<span class="tok-w"> </span>myapp<span class="tok-w"> </span><span class="tok-m">2</span>

<span class="tok-c1"># Ver valores (replicaCount=2)</span>
helm<span class="tok-w"> </span>get<span class="tok-w"> </span>values<span class="tok-w"> </span>myapp<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>replicaCount

<span class="tok-c1"># Ver historial (nueva revisión 6)</span>
helm<span class="tok-w"> </span><span class="tok-nb">history</span><span class="tok-w"> </span>myapp</code></pre>
</div>
</div>
</li>
<li>
<p>Ver diferencias entre revisiones:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Comparar revisión actual con revisión 1</span>
helm<span class="tok-w"> </span>get<span class="tok-w"> </span>manifest<span class="tok-w"> </span>myapp<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>current.yaml
helm<span class="tok-w"> </span>get<span class="tok-w"> </span>manifest<span class="tok-w"> </span>myapp<span class="tok-w"> </span>--revision<span class="tok-w"> </span><span class="tok-m">1</span><span class="tok-w"> </span>&gt;<span class="tok-w"> </span>revision1.yaml

<span class="tok-c1"># Ver diferencias (si tienes diff)</span>
<span class="tok-c1"># diff revision1.yaml current.yaml | head -30</span></code></pre>
</div>
</div>
</li>
<li>
<p>Limpiar:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>rm<span class="tok-w"> </span>-f<span class="tok-w"> </span>current.yaml<span class="tok-w"> </span>revision1.yaml
helm<span class="tok-w"> </span>uninstall<span class="tok-w"> </span>myapp</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Cuántas revisiones se crearon después de 3 upgrades?</p>
</li>
<li>
<p>¿Qué pasó con los Pods al hacer rollback?</p>
</li>
<li>
<p>¿Cuál es la diferencia entre <code>helm rollback</code> sin argumentos y <code>helm rollback revision N</code>?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_10_6_crear_un_chart_básico_desde_cero">23.6. Ejercicio 10.6: Crear un Chart Básico desde Cero</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Crear un Chart de Helm manualmente. Entender la estructura de un Chart y sus componentes.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Crearás un Chart simple para una aplicación nginx personalizada.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crear la estructura del Chart:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Crear directorio del Chart</span>
mkdir<span class="tok-w"> </span>-p<span class="tok-w"> </span>my-simple-app/templates

<span class="tok-c1"># Estructura:</span>
<span class="tok-c1"># my-simple-app/</span>
<span class="tok-c1"># ├── Chart.yaml</span>
<span class="tok-c1"># ├── values.yaml</span>
<span class="tok-c1"># ├── templates/</span>
<span class="tok-c1"># │   ├── deployment.yaml</span>
<span class="tok-c1"># │   ├── service.yaml</span>
<span class="tok-c1"># │   └── _helpers.tpl</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crear Chart.yaml:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>my-simple-app/Chart.yaml<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v2</span>
<span class="tok-s">name: my-simple-app</span>
<span class="tok-s">description: &quot;Mi primer Chart de Helm&quot;</span>
<span class="tok-s">type: application</span>
<span class="tok-s">version: 1.0.0</span>
<span class="tok-s">appVersion: &quot;1.0.0&quot;</span>
<span class="tok-s">maintainers:</span>
<span class="tok-s">  - name: Mi Nombre</span>
<span class="tok-s">    email: mi@email.com</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crear values.yaml:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>my-simple-app/values.yaml<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;EOF&#39;</span>
<span class="tok-s"># Configuración por defecto</span>

<span class="tok-s">replicaCount: 2</span>

<span class="tok-s">image:</span>
<span class="tok-s">  repository: nginx</span>
<span class="tok-s">  pullPolicy: IfNotPresent</span>
<span class="tok-s">  tag: &quot;1.24.0&quot;</span>

<span class="tok-s">service:</span>
<span class="tok-s">  type: ClusterIP</span>
<span class="tok-s">  port: 80</span>
<span class="tok-s">  targetPort: 80</span>

<span class="tok-s">resources:</span>
<span class="tok-s">  limits:</span>
<span class="tok-s">    cpu: 200m</span>
<span class="tok-s">    memory: 128Mi</span>
<span class="tok-s">  requests:</span>
<span class="tok-s">    cpu: 100m</span>
<span class="tok-s">    memory: 64Mi</span>

<span class="tok-s">nodeSelector: {}</span>

<span class="tok-s">tolerations: []</span>

<span class="tok-s">affinity: {}</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crear deployment.yaml template:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>my-simple-app/templates/deployment.yaml<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;EOF&#39;</span>
<span class="tok-s">apiVersion: apps/v1</span>
<span class="tok-s">kind: Deployment</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: {{ .Release.Name }}-{{ .Chart.Name }}</span>
<span class="tok-s">  labels:</span>
<span class="tok-s">    app: {{ .Chart.Name }}</span>
<span class="tok-s">    release: {{ .Release.Name }}</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  replicas: {{ .Values.replicaCount }}</span>
<span class="tok-s">  selector:</span>
<span class="tok-s">    matchLabels:</span>
<span class="tok-s">      app: {{ .Chart.Name }}</span>
<span class="tok-s">      release: {{ .Release.Name }}</span>
<span class="tok-s">  template:</span>
<span class="tok-s">    metadata:</span>
<span class="tok-s">      labels:</span>
<span class="tok-s">        app: {{ .Chart.Name }}</span>
<span class="tok-s">        release: {{ .Release.Name }}</span>
<span class="tok-s">    spec:</span>
<span class="tok-s">      containers:</span>
<span class="tok-s">      - name: {{ .Chart.Name }}</span>
<span class="tok-s">        image: &quot;{{ .Values.image.repository }}:{{ .Values.image.tag }}&quot;</span>
<span class="tok-s">        imagePullPolicy: {{ .Values.image.pullPolicy }}</span>
<span class="tok-s">        ports:</span>
<span class="tok-s">        - containerPort: {{ .Values.service.targetPort }}</span>
<span class="tok-s">        resources:</span>
<span class="tok-s">          {{- toYaml .Values.resources | nindent 10 }}</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crear service.yaml template:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>my-simple-app/templates/service.yaml<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Service</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: {{ .Release.Name }}-{{ .Chart.Name }}</span>
<span class="tok-s">  labels:</span>
<span class="tok-s">    app: {{ .Chart.Name }}</span>
<span class="tok-s">    release: {{ .Release.Name }}</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  type: {{ .Values.service.type }}</span>
<span class="tok-s">  selector:</span>
<span class="tok-s">    app: {{ .Chart.Name }}</span>
<span class="tok-s">    release: {{ .Release.Name }}</span>
<span class="tok-s">  ports:</span>
<span class="tok-s">  - port: {{ .Values.service.port }}</span>
<span class="tok-s">    targetPort: {{ .Values.service.targetPort }}</span>
<span class="tok-s">    protocol: TCP</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Validar el Chart:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Validar sintaxis</span>
helm<span class="tok-w"> </span>lint<span class="tok-w"> </span>my-simple-app

<span class="tok-c1"># Salida esperada:</span>
<span class="tok-c1"># ==&gt; Linting my-simple-app</span>
<span class="tok-c1"># [OK] Chart.yaml is consistent</span>
<span class="tok-c1"># ...</span></code></pre>
</div>
</div>
</li>
<li>
<p>Ver manifiestos generados:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Ver YAML final sin instalar</span>
helm<span class="tok-w"> </span>template<span class="tok-w"> </span>my-release<span class="tok-w"> </span>my-simple-app

<span class="tok-c1"># Salida esperada: manifiestos YAML compilados</span></code></pre>
</div>
</div>
</li>
<li>
<p>Instalar tu Chart:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Instalar desde Chart local</span>
helm<span class="tok-w"> </span>install<span class="tok-w"> </span>my-test-release<span class="tok-w"> </span>./my-simple-app

<span class="tok-c1"># Ver resultados</span>
helm<span class="tok-w"> </span>list
helm<span class="tok-w"> </span>status<span class="tok-w"> </span>my-test-release

<span class="tok-c1"># Ver recursos creados</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>deployment,svc<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">chart</span><span class="tok-o">=</span>my-simple-app</code></pre>
</div>
</div>
</li>
<li>
<p>Actualizar el Chart y hacer upgrade:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Cambiar valores</span>
helm<span class="tok-w"> </span>upgrade<span class="tok-w"> </span>my-test-release<span class="tok-w"> </span>./my-simple-app<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--set<span class="tok-w"> </span><span class="tok-nv">replicaCount</span><span class="tok-o">=</span><span class="tok-m">3</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--set<span class="tok-w"> </span>image.tag<span class="tok-o">=</span><span class="tok-s2">&quot;1.25.0&quot;</span>

<span class="tok-c1"># Ver cambios</span>
helm<span class="tok-w"> </span>get<span class="tok-w"> </span>values<span class="tok-w"> </span>my-test-release</code></pre>
</div>
</div>
</li>
<li>
<p>Limpiar:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>helm<span class="tok-w"> </span>uninstall<span class="tok-w"> </span>my-test-release
rm<span class="tok-w"> </span>-rf<span class="tok-w"> </span>my-simple-app</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Cuál es la diferencia entre <code>{{ .Release.Name }}</code> y <code>{{ .Chart.Name }}</code>?</p>
</li>
<li>
<p>¿Qué hace <code>{{ toYaml .Values.resources | nindent 10 }}</code>?</p>
</li>
<li>
<p>¿Cómo cambiarías el Chart para soportar HPA?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_10_7_templates_con_lógica_condicionales_y_loops">23.7. Ejercicio 10.7: Templates con Lógica (Condicionales y Loops)</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Usar lógica de Go templating en Helm para crear templates más flexibles. Comprender condicionales, loops y funciones.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Extenderás el Chart anterior con conditionals y loops para mayor flexibilidad.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crear un Chart mejorado:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>mkdir<span class="tok-w"> </span>-p<span class="tok-w"> </span>advanced-chart/templates</code></pre>
</div>
</div>
</li>
<li>
<p>Crear Chart.yaml:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>advanced-chart/Chart.yaml<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v2</span>
<span class="tok-s">name: advanced-app</span>
<span class="tok-s">version: 1.0.0</span>
<span class="tok-s">appVersion: &quot;1.0.0&quot;</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crear values.yaml mejorado:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>advanced-chart/values.yaml<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;EOF&#39;</span>
<span class="tok-s">replicaCount: 2</span>

<span class="tok-s">image:</span>
<span class="tok-s">  repository: nginx</span>
<span class="tok-s">  tag: &quot;1.25.0&quot;</span>

<span class="tok-s">service:</span>
<span class="tok-s">  enabled: true</span>
<span class="tok-s">  type: ClusterIP</span>
<span class="tok-s">  port: 80</span>

<span class="tok-s">ingress:</span>
<span class="tok-s">  enabled: true</span>
<span class="tok-s">  hostname: myapp.example.com</span>

<span class="tok-s">autoscaling:</span>
<span class="tok-s">  enabled: true</span>
<span class="tok-s">  minReplicas: 1</span>
<span class="tok-s">  maxReplicas: 5</span>
<span class="tok-s">  targetCPUUtilizationPercentage: 70</span>

<span class="tok-s">env:</span>
<span class="tok-s">  DEBUG: &quot;false&quot;</span>
<span class="tok-s">  LOG_LEVEL: &quot;info&quot;</span>

<span class="tok-s">volumeMounts:</span>
<span class="tok-s">  - name: config</span>
<span class="tok-s">    mountPath: /etc/config</span>

<span class="tok-s">volumes:</span>
<span class="tok-s">  - name: config</span>
<span class="tok-s">    emptyDir: {}</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crear deployment con condicionales:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>advanced-chart/templates/deployment.yaml<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;EOF&#39;</span>
<span class="tok-s">apiVersion: apps/v1</span>
<span class="tok-s">kind: Deployment</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: {{ .Release.Name }}-advanced</span>
<span class="tok-s">  labels:</span>
<span class="tok-s">    app: advanced</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  replicas: {{ .Values.replicaCount }}</span>
<span class="tok-s">  selector:</span>
<span class="tok-s">    matchLabels:</span>
<span class="tok-s">      app: advanced</span>
<span class="tok-s">  template:</span>
<span class="tok-s">    metadata:</span>
<span class="tok-s">      labels:</span>
<span class="tok-s">        app: advanced</span>
<span class="tok-s">    spec:</span>
<span class="tok-s">      containers:</span>
<span class="tok-s">      - name: app</span>
<span class="tok-s">        image: &quot;{{ .Values.image.repository }}:{{ .Values.image.tag }}&quot;</span>
<span class="tok-s">        ports:</span>
<span class="tok-s">        - containerPort: 8080</span>

<span class="tok-s">        # Env variables condicionales</span>
<span class="tok-s">        {{- if .Values.env }}</span>
<span class="tok-s">        env:</span>
<span class="tok-s">        {{- range $key, $value := .Values.env }}</span>
<span class="tok-s">        - name: {{ $key }}</span>
<span class="tok-s">          value: &quot;{{ $value }}&quot;</span>
<span class="tok-s">        {{- end }}</span>
<span class="tok-s">        {{- end }}</span>

<span class="tok-s">        # Volume mounts condicionales</span>
<span class="tok-s">        {{- if .Values.volumeMounts }}</span>
<span class="tok-s">        volumeMounts:</span>
<span class="tok-s">        {{- toYaml .Values.volumeMounts | nindent 8 }}</span>
<span class="tok-s">        {{- end }}</span>

<span class="tok-s">      # Volumes condicionales</span>
<span class="tok-s">      {{- if .Values.volumes }}</span>
<span class="tok-s">      volumes:</span>
<span class="tok-s">      {{- toYaml .Values.volumes | nindent 6 }}</span>
<span class="tok-s">      {{- end }}</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crear service con condicionales:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>advanced-chart/templates/service.yaml<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;EOF&#39;</span>
<span class="tok-s">{{- if .Values.service.enabled }}</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Service</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: {{ .Release.Name }}-service</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  type: {{ .Values.service.type }}</span>
<span class="tok-s">  selector:</span>
<span class="tok-s">    app: advanced</span>
<span class="tok-s">  ports:</span>
<span class="tok-s">  - port: {{ .Values.service.port }}</span>
<span class="tok-s">    targetPort: 8080</span>
<span class="tok-s">{{- end }}</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crear HPA condicional:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>advanced-chart/templates/hpa.yaml<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;EOF&#39;</span>
<span class="tok-s">{{- if .Values.autoscaling.enabled }}</span>
<span class="tok-s">apiVersion: autoscaling/v2</span>
<span class="tok-s">kind: HorizontalPodAutoscaler</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: {{ .Release.Name }}-hpa</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  scaleTargetRef:</span>
<span class="tok-s">    apiVersion: apps/v1</span>
<span class="tok-s">    kind: Deployment</span>
<span class="tok-s">    name: {{ .Release.Name }}-advanced</span>
<span class="tok-s">  minReplicas: {{ .Values.autoscaling.minReplicas }}</span>
<span class="tok-s">  maxReplicas: {{ .Values.autoscaling.maxReplicas }}</span>
<span class="tok-s">  metrics:</span>
<span class="tok-s">  - type: Resource</span>
<span class="tok-s">    resource:</span>
<span class="tok-s">      name: cpu</span>
<span class="tok-s">      target:</span>
<span class="tok-s">        type: Utilization</span>
<span class="tok-s">        averageUtilization: {{ .Values.autoscaling.targetCPUUtilizationPercentage }}</span>
<span class="tok-s">{{- end }}</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Validar el Chart:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>helm<span class="tok-w"> </span>lint<span class="tok-w"> </span>advanced-chart</code></pre>
</div>
</div>
</li>
<li>
<p>Ver manifiestos con todas las opciones habilitadas:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>helm<span class="tok-w"> </span>template<span class="tok-w"> </span>myapp<span class="tok-w"> </span>advanced-chart

<span class="tok-c1"># Debe mostrar: Deployment, Service, HPA</span></code></pre>
</div>
</div>
</li>
<li>
<p>Ver manifiestos con algunas opciones deshabilitadas:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>helm<span class="tok-w"> </span>template<span class="tok-w"> </span>myapp<span class="tok-w"> </span>advanced-chart<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--set<span class="tok-w"> </span>service.enabled<span class="tok-o">=</span><span class="tok-nb">false</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--set<span class="tok-w"> </span>autoscaling.enabled<span class="tok-o">=</span><span class="tok-nb">false</span>

<span class="tok-c1"># Debe mostrar solo: Deployment (sin Service ni HPA)</span></code></pre>
</div>
</div>
</li>
<li>
<p>Instalar y verificar:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Instalar con HPA habilitado</span>
helm<span class="tok-w"> </span>install<span class="tok-w"> </span>adv-app<span class="tok-w"> </span>advanced-chart<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--set<span class="tok-w"> </span>autoscaling.enabled<span class="tok-o">=</span><span class="tok-nb">true</span>

<span class="tok-c1"># Ver recursos</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>deployment,service,hpa<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>advanced

<span class="tok-c1"># Ver valores de env</span>
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>deployment<span class="tok-w"> </span>adv-app-advanced<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>-A<span class="tok-w"> </span><span class="tok-m">5</span><span class="tok-w"> </span><span class="tok-s2">&quot;ENV:&quot;</span>

<span class="tok-c1"># Desinstalar</span>
helm<span class="tok-w"> </span>uninstall<span class="tok-w"> </span>adv-app
rm<span class="tok-w"> </span>-rf<span class="tok-w"> </span>advanced-chart</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Cuál es la diferencia entre <code>{{ if }}&#8230;&#8203;{{ end }}</code> y <code>{{- if }}&#8230;&#8203;{{- end }}</code>?</p>
</li>
<li>
<p>¿Cómo hace Helm para iterar sobre diccionarios con <code>range</code>?</p>
</li>
<li>
<p>¿Por qué es útil poder habilitar/deshabilitar componentes con condicionales?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_10_8_chart_dependencies_subcharts">23.8. Ejercicio 10.8: Chart Dependencies (Subcharts)</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Usar subcharts dentro de un Chart principal para reutilizar componentes comunes. Comprender cómo Helm maneja dependencias.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Crearás un Chart que depende de PostgreSQL desde Bitnami.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crear directorio del Chart principal:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>mkdir<span class="tok-w"> </span>-p<span class="tok-w"> </span>multi-tier-app/templates
mkdir<span class="tok-w"> </span>-p<span class="tok-w"> </span>multi-tier-app/charts</code></pre>
</div>
</div>
</li>
<li>
<p>Crear Chart.yaml con dependencias:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>multi-tier-app/Chart.yaml<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v2</span>
<span class="tok-s">name: multi-tier-app</span>
<span class="tok-s">version: 1.0.0</span>
<span class="tok-s">appVersion: &quot;1.0.0&quot;</span>

<span class="tok-s"># Dependencias (subcharts)</span>
<span class="tok-s">dependencies:</span>
<span class="tok-s">  - name: postgresql</span>
<span class="tok-s">    version: &quot;11.x.x&quot;</span>
<span class="tok-s">    repository: &quot;https://charts.bitnami.com/bitnami&quot;</span>
<span class="tok-s">    condition: postgresql.enabled</span>
<span class="tok-s">    alias: db</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crear values.yaml con configuración de subcharts:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>multi-tier-app/values.yaml<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;EOF&#39;</span>
<span class="tok-s"># Configuración de la aplicación principal</span>
<span class="tok-s">app:</span>
<span class="tok-s">  image: nginx</span>
<span class="tok-s">  tag: &quot;1.25.0&quot;</span>
<span class="tok-s">  replicas: 2</span>

<span class="tok-s"># Configuración del subchart postgresql</span>
<span class="tok-s">postgresql:</span>
<span class="tok-s">  enabled: true</span>
<span class="tok-s">  auth:</span>
<span class="tok-s">    username: appuser</span>
<span class="tok-s">    password: changeme123</span>
<span class="tok-s">    database: myappdb</span>
<span class="tok-s">  primary:</span>
<span class="tok-s">    persistence:</span>
<span class="tok-s">      enabled: false</span>
<span class="tok-s">      # En producción: enabled: true, size: 10Gi</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Actualizar dependencias:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Descargar subchart de postgresql</span>
helm<span class="tok-w"> </span>dependency<span class="tok-w"> </span>update<span class="tok-w"> </span>multi-tier-app

<span class="tok-c1"># Verificar que se descargó</span>
ls<span class="tok-w"> </span>-la<span class="tok-w"> </span>multi-tier-app/charts/

<span class="tok-c1"># Salida esperada:</span>
<span class="tok-c1"># postgresql-11.x.x/</span>
<span class="tok-c1"># Chart.lock</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crear plantilla de aplicación que usa el subchart:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>multi-tier-app/templates/deployment.yaml<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;EOF&#39;</span>
<span class="tok-s">apiVersion: apps/v1</span>
<span class="tok-s">kind: Deployment</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: {{ .Release.Name }}-app</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  replicas: {{ .Values.app.replicas }}</span>
<span class="tok-s">  selector:</span>
<span class="tok-s">    matchLabels:</span>
<span class="tok-s">      app: myapp</span>
<span class="tok-s">  template:</span>
<span class="tok-s">    metadata:</span>
<span class="tok-s">      labels:</span>
<span class="tok-s">        app: myapp</span>
<span class="tok-s">    spec:</span>
<span class="tok-s">      containers:</span>
<span class="tok-s">      - name: app</span>
<span class="tok-s">        image: &quot;{{ .Values.app.image }}:{{ .Values.app.tag }}&quot;</span>
<span class="tok-s">        ports:</span>
<span class="tok-s">        - containerPort: 8080</span>
<span class="tok-s">        {{- if .Values.postgresql.enabled }}</span>
<span class="tok-s">        env:</span>
<span class="tok-s">        - name: DATABASE_HOST</span>
<span class="tok-s">          value: &quot;{{ .Release.Name }}-db&quot;</span>
<span class="tok-s">        - name: DATABASE_PORT</span>
<span class="tok-s">          value: &quot;5432&quot;</span>
<span class="tok-s">        - name: DATABASE_NAME</span>
<span class="tok-s">          value: &quot;{{ .Values.postgresql.auth.database }}&quot;</span>
<span class="tok-s">        - name: DATABASE_USER</span>
<span class="tok-s">          value: &quot;{{ .Values.postgresql.auth.username }}&quot;</span>
<span class="tok-s">        - name: DATABASE_PASSWORD</span>
<span class="tok-s">          valueFrom:</span>
<span class="tok-s">            secretKeyRef:</span>
<span class="tok-s">              name: {{ .Release.Name }}-db</span>
<span class="tok-s">              key: password</span>
<span class="tok-s">        {{- end }}</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crear ConfigMap con variables de entorno:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>multi-tier-app/templates/configmap.yaml<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;EOF&#39;</span>
<span class="tok-s">{{- if .Values.postgresql.enabled }}</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: ConfigMap</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: {{ .Release.Name }}-app-config</span>
<span class="tok-s">data:</span>
<span class="tok-s">  database_host: &quot;{{ .Release.Name }}-db&quot;</span>
<span class="tok-s">  database_name: &quot;{{ .Values.postgresql.auth.database }}&quot;</span>
<span class="tok-s">  app_version: &quot;{{ .Chart.AppVersion }}&quot;</span>
<span class="tok-s">{{- end }}</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Validar el Chart:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>helm<span class="tok-w"> </span>lint<span class="tok-w"> </span>multi-tier-app</code></pre>
</div>
</div>
</li>
<li>
<p>Ver manifiestos (incluye postgres):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>helm<span class="tok-w"> </span>template<span class="tok-w"> </span>mystack<span class="tok-w"> </span>multi-tier-app<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>head<span class="tok-w"> </span>-100

<span class="tok-c1"># Debe mostrar manifiestos de:</span>
<span class="tok-c1"># - PostgreSQL (subchart)</span>
<span class="tok-c1"># - Deployment de aplicación (Chart principal)</span>
<span class="tok-c1"># - ConfigMap</span></code></pre>
</div>
</div>
</li>
<li>
<p>Ver manifiestos sin PostgreSQL:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>helm<span class="tok-w"> </span>template<span class="tok-w"> </span>mystack<span class="tok-w"> </span>multi-tier-app<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--set<span class="tok-w"> </span>postgresql.enabled<span class="tok-o">=</span><span class="tok-nb">false</span>

<span class="tok-c1"># Solo debe mostrar Deployment y ConfigMap</span></code></pre>
</div>
</div>
</li>
<li>
<p>Instalar el Chart:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Instalar con todas las dependencias</span>
helm<span class="tok-w"> </span>install<span class="tok-w"> </span>mystack<span class="tok-w"> </span>multi-tier-app

<span class="tok-c1"># Ver status</span>
helm<span class="tok-w"> </span>status<span class="tok-w"> </span>mystack

<span class="tok-c1"># Ver recursos creados (postgres + app)</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span>app.kubernetes.io/instance<span class="tok-o">=</span>mystack

<span class="tok-c1"># Desinstalar</span>
helm<span class="tok-w"> </span>uninstall<span class="tok-w"> </span>mystack
rm<span class="tok-w"> </span>-rf<span class="tok-w"> </span>multi-tier-app</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Qué contiene el archivo Chart.lock?</p>
</li>
<li>
<p>¿Cómo especificas en values.yaml la configuración del subchart postgresql?</p>
</li>
<li>
<p>¿Por qué es útil tener una condición <code>postgresql.enabled</code>?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_10_9_empaquetar_y_distribuir_charts">23.9. Ejercicio 10.9: Empaquetar y Distribuir Charts</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Empaquetar un Chart en formato .tgz y prepararlo para distribuir en un repositorio.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Empaquetarás un Chart y crearás un índice para un repositorio.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crear un Chart simple:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>helm<span class="tok-w"> </span>create<span class="tok-w"> </span>simple-web-app

<span class="tok-c1"># Estructura creada automáticamente</span>
ls<span class="tok-w"> </span>-la<span class="tok-w"> </span>simple-web-app/</code></pre>
</div>
</div>
</li>
<li>
<p>Validar el Chart:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>helm<span class="tok-w"> </span>lint<span class="tok-w"> </span>simple-web-app

<span class="tok-c1"># Salida esperada: [OK]</span></code></pre>
</div>
</div>
</li>
<li>
<p>Empaquetar el Chart:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Crear archivo .tgz</span>
helm<span class="tok-w"> </span>package<span class="tok-w"> </span>simple-web-app

<span class="tok-c1"># Salida esperada:</span>
<span class="tok-c1"># Successfully packaged chart and saved it to: /path/simple-web-app-0.1.0.tgz</span>

<span class="tok-c1"># Verificar archivo</span>
ls<span class="tok-w"> </span>-lh<span class="tok-w"> </span>simple-web-app-*.tgz</code></pre>
</div>
</div>
</li>
<li>
<p>Crear repositorio local:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Crear directorio para repositorio</span>
mkdir<span class="tok-w"> </span>-p<span class="tok-w"> </span>my-helm-repo
cp<span class="tok-w"> </span>simple-web-app-0.1.0.tgz<span class="tok-w"> </span>my-helm-repo/

<span class="tok-c1"># Crear índice de repositorio</span>
helm<span class="tok-w"> </span>repo<span class="tok-w"> </span>index<span class="tok-w"> </span>my-helm-repo/

<span class="tok-c1"># Verificar archivos creados</span>
ls<span class="tok-w"> </span>-la<span class="tok-w"> </span>my-helm-repo/

<span class="tok-c1"># Debe contener:</span>
<span class="tok-c1"># - simple-web-app-0.1.0.tgz</span>
<span class="tok-c1"># - index.yaml</span></code></pre>
</div>
</div>
</li>
<li>
<p>Ver contenido del index.yaml:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat<span class="tok-w"> </span>my-helm-repo/index.yaml

<span class="tok-c1"># Contiene metadatos del Chart y ubicación</span></code></pre>
</div>
</div>
</li>
<li>
<p>Agregar repositorio local:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Agregar repositorio local (asume servidor HTTP o path local)</span>
<span class="tok-c1"># Para HTTP necesitarías: helm repo add myrepo http://myserver/my-helm-repo</span>

<span class="tok-c1"># Para path local (solo para demostración):</span>
helm<span class="tok-w"> </span>repo<span class="tok-w"> </span>add<span class="tok-w"> </span>mylocal-repo<span class="tok-w"> </span>file://<span class="tok-k">$(</span><span class="tok-nb">pwd</span><span class="tok-k">)</span>/my-helm-repo

<span class="tok-c1"># Actualizar</span>
helm<span class="tok-w"> </span>repo<span class="tok-w"> </span>update

<span class="tok-c1"># Buscar Chart</span>
helm<span class="tok-w"> </span>search<span class="tok-w"> </span>repo<span class="tok-w"> </span>mylocal-repo</code></pre>
</div>
</div>
</li>
<li>
<p>Instalar desde repositorio personalizado:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Instalar desde repositorio local</span>
<span class="tok-c1"># helm install myapp mylocal-repo/simple-web-app</span>

<span class="tok-c1"># O instalar desde .tgz directamente</span>
helm<span class="tok-w"> </span>install<span class="tok-w"> </span>myapp<span class="tok-w"> </span>./simple-web-app-0.1.0.tgz

<span class="tok-c1"># Ver detalles</span>
helm<span class="tok-w"> </span>status<span class="tok-w"> </span>myapp

<span class="tok-c1"># Desinstalar</span>
helm<span class="tok-w"> </span>uninstall<span class="tok-w"> </span>myapp</code></pre>
</div>
</div>
</li>
<li>
<p>Crear versión mejorada del Chart:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Modificar simple-web-app/Chart.yaml</span>
<span class="tok-c1"># Cambiar version: 0.1.0 a version: 0.2.0</span>
<span class="tok-c1"># Cambiar appVersion: &quot;1.16.0&quot; a appVersion: &quot;1.17.0&quot;</span>

sed<span class="tok-w"> </span>-i<span class="tok-w"> </span><span class="tok-s1">&#39;s/version: 0.1.0/version: 0.2.0/&#39;</span><span class="tok-w"> </span>simple-web-app/Chart.yaml
sed<span class="tok-w"> </span>-i<span class="tok-w"> </span><span class="tok-s1">&#39;s/appVersion: &quot;1.16.0&quot;/appVersion: &quot;1.17.0&quot;/&#39;</span><span class="tok-w"> </span>simple-web-app/Chart.yaml

<span class="tok-c1"># Empaquetar nueva versión</span>
helm<span class="tok-w"> </span>package<span class="tok-w"> </span>simple-web-app

<span class="tok-c1"># Actualizar índice (agrega la nueva versión)</span>
helm<span class="tok-w"> </span>repo<span class="tok-w"> </span>index<span class="tok-w"> </span>my-helm-repo/

<span class="tok-c1"># Ver ambas versiones en index.yaml</span>
cat<span class="tok-w"> </span>my-helm-repo/index.yaml<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>version</code></pre>
</div>
</div>
</li>
<li>
<p>Limpiar:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>helm<span class="tok-w"> </span>repo<span class="tok-w"> </span>remove<span class="tok-w"> </span>mylocal-repo
rm<span class="tok-w"> </span>-rf<span class="tok-w"> </span>simple-web-app<span class="tok-w"> </span>my-helm-repo<span class="tok-w"> </span>simple-web-app-*.tgz</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Qué información contiene el archivo index.yaml?</p>
</li>
<li>
<p>¿Cómo se distribuiría un repositorio privado de Helm?</p>
</li>
<li>
<p>¿Por qué es importante mantener múltiples versiones de Charts?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_10_10_helm_en_cicd_despliegues_automatizados">23.10. Ejercicio 10.10: Helm en CI/CD (Despliegues Automatizados)</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Integrar Helm en pipelines de CI/CD para automatizar despliegues. Entender cómo Helm facilita GitOps.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Simularás un script de despliegue que usa Helm para actualizar aplicaciones en múltiples ambientes.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crear estructura de proyecto:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>mkdir<span class="tok-w"> </span>-p<span class="tok-w"> </span>helm-cicd/<span class="tok-o">{</span>charts,values<span class="tok-o">}</span>

<span class="tok-c1"># Crear valores por ambiente</span>
cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>helm-cicd/values/dev.yaml<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;EOF&#39;</span>
<span class="tok-s">replicaCount: 1</span>
<span class="tok-s">image:</span>
<span class="tok-s">  tag: &quot;latest&quot;</span>
<span class="tok-s">service:</span>
<span class="tok-s">  type: ClusterIP</span>
<span class="tok-s">EOF</span>

cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>helm-cicd/values/staging.yaml<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;EOF&#39;</span>
<span class="tok-s">replicaCount: 2</span>
<span class="tok-s">image:</span>
<span class="tok-s">  tag: &quot;v1.0.0&quot;</span>
<span class="tok-s">service:</span>
<span class="tok-s">  type: ClusterIP</span>
<span class="tok-s">EOF</span>

cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>helm-cicd/values/prod.yaml<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;EOF&#39;</span>
<span class="tok-s">replicaCount: 3</span>
<span class="tok-s">image:</span>
<span class="tok-s">  tag: &quot;v1.0.0&quot;</span>
<span class="tok-s">service:</span>
<span class="tok-s">  type: LoadBalancer</span>
<span class="tok-s">autoscaling:</span>
<span class="tok-s">  enabled: true</span>
<span class="tok-s">  minReplicas: 2</span>
<span class="tok-s">  maxReplicas: 10</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crear Chart simple:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>helm<span class="tok-w"> </span>create<span class="tok-w"> </span>helm-cicd/charts/myapp

<span class="tok-c1"># Estructura:</span>
<span class="tok-c1"># charts/myapp/</span>
<span class="tok-c1"># ├── Chart.yaml</span>
<span class="tok-c1"># ├── values.yaml</span>
<span class="tok-c1"># ├── templates/...</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crear script de despliegue (simulate CI/CD):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>helm-cicd/deploy.sh<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;SCRIPT&#39;</span>
<span class="tok-s">#!/bin/bash</span>

<span class="tok-s">set -e</span>

<span class="tok-s">APP_NAME=&quot;myapp&quot;</span>
<span class="tok-s">CHART_PATH=&quot;./charts/myapp&quot;</span>

<span class="tok-s"># Validar Chart</span>
<span class="tok-s">echo &quot;Validando Chart...&quot;</span>
<span class="tok-s">helm lint &quot;$CHART_PATH&quot;</span>

<span class="tok-s"># Función para desplegar a ambiente</span>
<span class="tok-s">deploy_to_environment() {</span>
<span class="tok-s">  local ENV=$1</span>
<span class="tok-s">  local NAMESPACE=$2</span>

<span class="tok-s">  echo &quot;Desplegando a $ENV...&quot;</span>

<span class="tok-s">  # Crear namespace si no existe</span>
<span class="tok-s">  kubectl create namespace &quot;$NAMESPACE&quot; --dry-run=client -o yaml | kubectl apply -f -</span>

<span class="tok-s">  # Usar helm upgrade --install (idempotente)</span>
<span class="tok-s">  helm upgrade --install &quot;$APP_NAME-$ENV&quot; &quot;$CHART_PATH&quot; \</span>
<span class="tok-s">    --namespace &quot;$NAMESPACE&quot; \</span>
<span class="tok-s">    --values &quot;values/$ENV.yaml&quot; \</span>
<span class="tok-s">    --wait \</span>
<span class="tok-s">    --timeout 5m</span>

<span class="tok-s">  echo &quot;$ENV desplegado exitosamente&quot;</span>
<span class="tok-s">  echo &quot;&quot;</span>
<span class="tok-s">}</span>

<span class="tok-s"># Desplegar a dev, staging, prod</span>
<span class="tok-s">deploy_to_environment &quot;dev&quot; &quot;dev&quot;</span>
<span class="tok-s">deploy_to_environment &quot;staging&quot; &quot;staging&quot;</span>
<span class="tok-s">deploy_to_environment &quot;prod&quot; &quot;production&quot;</span>

<span class="tok-s">echo &quot;Todos los ambientes actualizados exitosamente&quot;</span>

<span class="tok-s"># Ver releases</span>
<span class="tok-s">echo &quot;&quot;</span>
<span class="tok-s">echo &quot;Releases instaladas:&quot;</span>
<span class="tok-s">helm list -A</span>
<span class="tok-s">SCRIPT</span>

chmod<span class="tok-w"> </span>+x<span class="tok-w"> </span>helm-cicd/deploy.sh</code></pre>
</div>
</div>
</li>
<li>
<p>Crear script de despliegue selectivo:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>helm-cicd/deploy-single.sh<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;SCRIPT&#39;</span>
<span class="tok-s">#!/bin/bash</span>

<span class="tok-s"># Uso: ./deploy-single.sh dev</span>
<span class="tok-s"># Despliega solo a un ambiente</span>

<span class="tok-s">if [ $# -eq 0 ]; then</span>
<span class="tok-s">  echo &quot;Uso: $0 &lt;dev|staging|prod&gt;&quot;</span>
<span class="tok-s">  exit 1</span>
<span class="tok-s">fi</span>

<span class="tok-s">ENV=$1</span>
<span class="tok-s">NAMESPACE=$([ &quot;$ENV&quot; = &quot;prod&quot; ] &amp;&amp; echo &quot;production&quot; || echo &quot;$ENV&quot;)</span>
<span class="tok-s">CHART_PATH=&quot;./charts/myapp&quot;</span>
<span class="tok-s">APP_NAME=&quot;myapp&quot;</span>

<span class="tok-s">echo &quot;Desplegando $ENV a namespace $NAMESPACE...&quot;</span>

<span class="tok-s"># Validar values file</span>
<span class="tok-s">if [ ! -f &quot;values/$ENV.yaml&quot; ]; then</span>
<span class="tok-s">  echo &quot;Error: values/$ENV.yaml no existe&quot;</span>
<span class="tok-s">  exit 1</span>
<span class="tok-s">fi</span>

<span class="tok-s"># Validación</span>
<span class="tok-s">echo &quot;Validando Chart...&quot;</span>
<span class="tok-s">helm lint &quot;$CHART_PATH&quot;</span>

<span class="tok-s"># Ver cambios que se harían</span>
<span class="tok-s">echo &quot;&quot;</span>
<span class="tok-s">echo &quot;Cambios que se aplicarán:&quot;</span>
<span class="tok-s">helm upgrade --install &quot;$APP_NAME-$ENV&quot; &quot;$CHART_PATH&quot; \</span>
<span class="tok-s">  --namespace &quot;$NAMESPACE&quot; \</span>
<span class="tok-s">  --values &quot;values/$ENV.yaml&quot; \</span>
<span class="tok-s">  --dry-run</span>

<span class="tok-s"># Ejecutar deployment</span>
<span class="tok-s">echo &quot;&quot;</span>
<span class="tok-s">read -p &quot;¿Continuar con despliegue? (s/n) &quot; -n 1 -r</span>
<span class="tok-s">echo</span>
<span class="tok-s">if [[ $REPLY =~ ^[Ss]$ ]]; then</span>
<span class="tok-s">  helm upgrade --install &quot;$APP_NAME-$ENV&quot; &quot;$CHART_PATH&quot; \</span>
<span class="tok-s">    --namespace &quot;$NAMESPACE&quot; \</span>
<span class="tok-s">    --values &quot;values/$ENV.yaml&quot; \</span>
<span class="tok-s">    --atomic</span>
<span class="tok-s">  echo &quot;Despliegue completado&quot;</span>
<span class="tok-s">else</span>
<span class="tok-s">  echo &quot;Despliegue cancelado&quot;</span>
<span class="tok-s">  exit 1</span>
<span class="tok-s">fi</span>
<span class="tok-s">SCRIPT</span>

chmod<span class="tok-w"> </span>+x<span class="tok-w"> </span>helm-cicd/deploy-single.sh</code></pre>
</div>
</div>
</li>
<li>
<p>Ver estructura completa:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>tree<span class="tok-w"> </span>helm-cicd/<span class="tok-w"> </span><span class="tok-m">2</span>&gt;/dev/null<span class="tok-w"> </span><span class="tok-o">||</span><span class="tok-w"> </span>find<span class="tok-w"> </span>helm-cicd/<span class="tok-w"> </span>-type<span class="tok-w"> </span>f</code></pre>
</div>
</div>
</li>
<li>
<p>Ejecutar despliegue a un ambiente (simulación):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">cd</span><span class="tok-w"> </span>helm-cicd/

<span class="tok-c1"># Primero validar Chart</span>
helm<span class="tok-w"> </span>lint<span class="tok-w"> </span>charts/myapp

<span class="tok-c1"># Ver qué haría el despliegue (dry-run)</span>
helm<span class="tok-w"> </span>upgrade<span class="tok-w"> </span>--install<span class="tok-w"> </span>myapp-dev<span class="tok-w"> </span>charts/myapp<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--namespace<span class="tok-w"> </span>dev<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--create-namespace<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--values<span class="tok-w"> </span>values/dev.yaml<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--dry-run<span class="tok-w"> </span>--debug<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>head<span class="tok-w"> </span>-50</code></pre>
</div>
</div>
</li>
<li>
<p>Crear script de rollback:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>helm-cicd/rollback.sh<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;SCRIPT&#39;</span>
<span class="tok-s">#!/bin/bash</span>

<span class="tok-s"># rollback.sh &lt;app-name&gt; [revision]</span>

<span class="tok-s">if [ $# -eq 0 ]; then</span>
<span class="tok-s">  echo &quot;Uso: $0 &lt;app-name&gt; [revision]&quot;</span>
<span class="tok-s">  exit 1</span>
<span class="tok-s">fi</span>

<span class="tok-s">APP_NAME=$1</span>
<span class="tok-s">REVISION=${2:-0}  # 0 = previous</span>

<span class="tok-s">echo &quot;Historial de $APP_NAME:&quot;</span>
<span class="tok-s">helm history &quot;$APP_NAME&quot; -a</span>

<span class="tok-s">if [ &quot;$REVISION&quot; -eq 0 ]; then</span>
<span class="tok-s">  echo &quot;&quot;</span>
<span class="tok-s">  echo &quot;Haciendo rollback a revisión anterior...&quot;</span>
<span class="tok-s">  helm rollback &quot;$APP_NAME&quot;</span>
<span class="tok-s">else</span>
<span class="tok-s">  echo &quot;&quot;</span>
<span class="tok-s">  echo &quot;Haciendo rollback a revisión $REVISION...&quot;</span>
<span class="tok-s">  helm rollback &quot;$APP_NAME&quot; &quot;$REVISION&quot;</span>
<span class="tok-s">fi</span>

<span class="tok-s">echo &quot;Rollback completado&quot;</span>
<span class="tok-s">SCRIPT</span>

chmod<span class="tok-w"> </span>+x<span class="tok-w"> </span>helm-cicd/rollback.sh</code></pre>
</div>
</div>
</li>
<li>
<p>Ver los valores que se usarían:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Ver valores de dev</span>
cat<span class="tok-w"> </span>helm-cicd/values/dev.yaml

<span class="tok-c1"># Ver valores de prod</span>
cat<span class="tok-w"> </span>helm-cicd/values/prod.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Simular despliegue a dev:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Ver manifiestos (sin aplicar)</span>
helm<span class="tok-w"> </span>template<span class="tok-w"> </span>myapp-dev<span class="tok-w"> </span>helm-cicd/charts/myapp<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--values<span class="tok-w"> </span>helm-cicd/values/dev.yaml<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>head<span class="tok-w"> </span>-50</code></pre>
</div>
</div>
</li>
<li>
<p>Limpiar:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">cd</span><span class="tok-w"> </span>..
rm<span class="tok-w"> </span>-rf<span class="tok-w"> </span>helm-cicd

<span class="tok-c1"># Si habías instalado releases, desinstalalas:</span>
<span class="tok-c1"># helm uninstall myapp-dev -n dev</span>
<span class="tok-c1"># helm uninstall myapp-staging -n staging</span>
<span class="tok-c1"># helm uninstall myapp-prod -n production</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Por qué <code>helm upgrade --install</code> es mejor que <code>helm install</code> en CI/CD?</p>
</li>
<li>
<p>¿Cómo asegurarías que los valores específicos de producción no se cambian accidentalmente?</p>
</li>
<li>
<p>¿Cómo integrarías este script en un pipeline de GitHub Actions o GitLab CI?</p>
</li>
</ol>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resumen_de_conceptos_10">24. Resumen de Conceptos</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Estos ejercicios del Módulo 10 cubren:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Ejercicio 10.1</strong>: Gestión de repositorios de Helm</p>
</li>
<li>
<p><strong>Ejercicio 10.2</strong>: Instalación de Charts desde repositorio</p>
</li>
<li>
<p><strong>Ejercicio 10.3</strong>: Personalización con valores</p>
</li>
<li>
<p><strong>Ejercicio 10.4</strong>: Upgrades y cambios de configuración</p>
</li>
<li>
<p><strong>Ejercicio 10.5</strong>: Historial y rollback de releases</p>
</li>
<li>
<p><strong>Ejercicio 10.6</strong>: Crear Charts desde cero</p>
</li>
<li>
<p><strong>Ejercicio 10.7</strong>: Templates con lógica (condicionales/loops)</p>
</li>
<li>
<p><strong>Ejercicio 10.8</strong>: Usar subcharts y dependencias</p>
</li>
<li>
<p><strong>Ejercicio 10.9</strong>: Empaquetar y distribuir Charts</p>
</li>
<li>
<p><strong>Ejercicio 10.10</strong>: Automatización con CI/CD</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_módulo_11_cicd_con_kubernetes">25. Módulo 11: CI/CD con Kubernetes</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_ejercicio_11_1_blue_green_deployment">25.1. Ejercicio 11.1: Blue-Green Deployment</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Implementar una estrategia Blue-Green para desplegar nueva versión sin downtime. Comprender cómo cambiar tráfico instantáneamente.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Desplegarás dos versiones idénticas de una aplicación (Blue y Green) y cambiarás el tráfico entre ellas.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crear el deployment Blue (versión actual en producción):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>blue-deployment.yaml<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;EOF&#39;</span>
<span class="tok-s">apiVersion: apps/v1</span>
<span class="tok-s">kind: Deployment</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: app-blue</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  replicas: 2</span>
<span class="tok-s">  selector:</span>
<span class="tok-s">    matchLabels:</span>
<span class="tok-s">      app: myapp</span>
<span class="tok-s">      version: blue</span>
<span class="tok-s">  template:</span>
<span class="tok-s">    metadata:</span>
<span class="tok-s">      labels:</span>
<span class="tok-s">        app: myapp</span>
<span class="tok-s">        version: blue</span>
<span class="tok-s">    spec:</span>
<span class="tok-s">      containers:</span>
<span class="tok-s">      - name: app</span>
<span class="tok-s">        image: nginx:1.24.0</span>
<span class="tok-s">        ports:</span>
<span class="tok-s">        - containerPort: 80</span>
<span class="tok-s">        env:</span>
<span class="tok-s">        - name: VERSION</span>
<span class="tok-s">          value: &quot;1.0.0 (Blue)&quot;</span>
<span class="tok-s">EOF</span>

kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>blue-deployment.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Crear el deployment Green (versión candidata):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>green-deployment.yaml<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;EOF&#39;</span>
<span class="tok-s">apiVersion: apps/v1</span>
<span class="tok-s">kind: Deployment</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: app-green</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  replicas: 2</span>
<span class="tok-s">  selector:</span>
<span class="tok-s">    matchLabels:</span>
<span class="tok-s">      app: myapp</span>
<span class="tok-s">      version: green</span>
<span class="tok-s">  template:</span>
<span class="tok-s">    metadata:</span>
<span class="tok-s">      labels:</span>
<span class="tok-s">        app: myapp</span>
<span class="tok-s">        version: green</span>
<span class="tok-s">    spec:</span>
<span class="tok-s">      containers:</span>
<span class="tok-s">      - name: app</span>
<span class="tok-s">        image: nginx:1.25.0</span>
<span class="tok-s">        ports:</span>
<span class="tok-s">        - containerPort: 80</span>
<span class="tok-s">        env:</span>
<span class="tok-s">        - name: VERSION</span>
<span class="tok-s">          value: &quot;2.0.0 (Green)&quot;</span>
<span class="tok-s">EOF</span>

kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>green-deployment.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Crear el Service apuntando a Blue:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>service.yaml<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Service</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: myapp</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  selector:</span>
<span class="tok-s">    app: myapp</span>
<span class="tok-s">    version: blue</span>
<span class="tok-s">  ports:</span>
<span class="tok-s">  - port: 80</span>
<span class="tok-s">    targetPort: 80</span>
<span class="tok-s">  type: LoadBalancer</span>
<span class="tok-s">EOF</span>

kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>service.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Verificar que ambos deployments están corriendo:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Ver Pods de Blue</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">version</span><span class="tok-o">=</span>blue

<span class="tok-c1"># Ver Pods de Green</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">version</span><span class="tok-o">=</span>green

<span class="tok-c1"># Ver Service actual</span>
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>svc<span class="tok-w"> </span>myapp</code></pre>
</div>
</div>
</li>
<li>
<p>Verificar tráfico en Blue:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># El tráfico actual va a Blue</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>endpoints<span class="tok-w"> </span>myapp

<span class="tok-c1"># Acceder al servicio (si es posible)</span>
<span class="tok-c1"># curl &lt;service-ip&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Conmutar tráfico a Green (cambiar selector del Service):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Patch del Service para apuntar a Green</span>
kubectl<span class="tok-w"> </span>patch<span class="tok-w"> </span>service<span class="tok-w"> </span>myapp<span class="tok-w"> </span>-p<span class="tok-w"> </span><span class="tok-s1">&#39;{&quot;spec&quot;:{&quot;selector&quot;:{&quot;version&quot;:&quot;green&quot;}}}&#39;</span>

<span class="tok-c1"># Verificar que endpoints cambió</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>endpoints<span class="tok-w"> </span>myapp

<span class="tok-c1"># Ahora todo el tráfico va a Green</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verificar que Green está recibiendo tráfico:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">version</span><span class="tok-o">=</span>green</code></pre>
</div>
</div>
</li>
<li>
<p>Rollback instantáneo si hay problemas:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Cambiar de vuelta a Blue</span>
kubectl<span class="tok-w"> </span>patch<span class="tok-w"> </span>service<span class="tok-w"> </span>myapp<span class="tok-w"> </span>-p<span class="tok-w"> </span><span class="tok-s1">&#39;{&quot;spec&quot;:{&quot;selector&quot;:{&quot;version&quot;:&quot;blue&quot;}}}&#39;</span>

<span class="tok-c1"># Verificar endpoints</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>endpoints<span class="tok-w"> </span>myapp</code></pre>
</div>
</div>
</li>
<li>
<p>Una vez que Green es estable, eliminar Blue:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>deployment<span class="tok-w"> </span>app-blue

<span class="tok-c1"># Cambiar definitivamente a Green</span>
kubectl<span class="tok-w"> </span>patch<span class="tok-w"> </span>service<span class="tok-w"> </span>myapp<span class="tok-w"> </span>-p<span class="tok-w"> </span><span class="tok-s1">&#39;{&quot;spec&quot;:{&quot;selector&quot;:{&quot;version&quot;:&quot;green&quot;}}}&#39;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Limpiar:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>-f<span class="tok-w"> </span>green-deployment.yaml
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>-f<span class="tok-w"> </span>service.yaml
rm<span class="tok-w"> </span>-f<span class="tok-w"> </span>blue-deployment.yaml<span class="tok-w"> </span>green-deployment.yaml<span class="tok-w"> </span>service.yaml</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Cuál es el ventaja principal de Blue-Green vs Rolling Update?</p>
</li>
<li>
<p>¿Qué sucede con las conexiones existentes cuando cambias el selector del servicio?</p>
</li>
<li>
<p>¿Cómo sincronizarías datos entre Blue y Green si la aplicación tiene estado?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_11_2_canary_deployment_usando_réplicas">25.2. Ejercicio 11.2: Canary Deployment usando Réplicas</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Implementar un Canary Deployment controlando el número de replicas. Gradualmente aumentar tráfico a nueva versión.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Desplegarás versión estable con muchas replicas y versión canaria con pocas replicas, luego cambiarás el ratio.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crear Deployment con versión estable (v1):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>canary-v1.yaml<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;EOF&#39;</span>
<span class="tok-s">apiVersion: apps/v1</span>
<span class="tok-s">kind: Deployment</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: myapp-v1</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  replicas: 9        # 90% del tráfico</span>
<span class="tok-s">  selector:</span>
<span class="tok-s">    matchLabels:</span>
<span class="tok-s">      app: myapp</span>
<span class="tok-s">      version: v1</span>
<span class="tok-s">  template:</span>
<span class="tok-s">    metadata:</span>
<span class="tok-s">      labels:</span>
<span class="tok-s">        app: myapp</span>
<span class="tok-s">        version: v1</span>
<span class="tok-s">    spec:</span>
<span class="tok-s">      containers:</span>
<span class="tok-s">      - name: app</span>
<span class="tok-s">        image: nginx:1.24.0</span>
<span class="tok-s">        ports:</span>
<span class="tok-s">        - containerPort: 80</span>
<span class="tok-s">        env:</span>
<span class="tok-s">        - name: VERSION</span>
<span class="tok-s">          value: &quot;v1 - stable&quot;</span>
<span class="tok-s">EOF</span>

kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>canary-v1.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Crear Deployment con versión canaria (v2):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>canary-v2.yaml<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;EOF&#39;</span>
<span class="tok-s">apiVersion: apps/v1</span>
<span class="tok-s">kind: Deployment</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: myapp-v2</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  replicas: 1        # 10% del tráfico (1 pod de 10 total)</span>
<span class="tok-s">  selector:</span>
<span class="tok-s">    matchLabels:</span>
<span class="tok-s">      app: myapp</span>
<span class="tok-s">      version: v2</span>
<span class="tok-s">  template:</span>
<span class="tok-s">    metadata:</span>
<span class="tok-s">      labels:</span>
<span class="tok-s">        app: myapp</span>
<span class="tok-s">        version: v2</span>
<span class="tok-s">    spec:</span>
<span class="tok-s">      containers:</span>
<span class="tok-s">      - name: app</span>
<span class="tok-s">        image: nginx:1.25.0</span>
<span class="tok-s">        ports:</span>
<span class="tok-s">        - containerPort: 80</span>
<span class="tok-s">        env:</span>
<span class="tok-s">        - name: VERSION</span>
<span class="tok-s">          value: &quot;v2 - canary&quot;</span>
<span class="tok-s">EOF</span>

kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>canary-v2.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Crear Service que balancea entre ambas versiones:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>canary-service.yaml<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Service</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: myapp-canary</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  selector:</span>
<span class="tok-s">    app: myapp</span>
<span class="tok-s">  ports:</span>
<span class="tok-s">  - port: 80</span>
<span class="tok-s">    targetPort: 80</span>
<span class="tok-s">  type: LoadBalancer</span>
<span class="tok-s">EOF</span>

kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>canary-service.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Verificar el ratio de tráfico:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Ver Pods totales</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>myapp

<span class="tok-c1"># Contar por versión</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">version</span><span class="tok-o">=</span>v1<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>wc<span class="tok-w"> </span>-l<span class="tok-w">   </span><span class="tok-c1"># Debe ser 10 (header + 9 pods)</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">version</span><span class="tok-o">=</span>v2<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>wc<span class="tok-w"> </span>-l<span class="tok-w">   </span><span class="tok-c1"># Debe ser 2 (header + 1 pod)</span>

<span class="tok-c1"># Ver endpoints (proporcional al número de replicas)</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>endpoints<span class="tok-w"> </span>myapp-canary</code></pre>
</div>
</div>
</li>
<li>
<p>Monitorear canario (simular métricas):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Crear logs para simular monitoreo</span>
kubectl<span class="tok-w"> </span>logs<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">version</span><span class="tok-o">=</span>v2<span class="tok-w"> </span>--tail<span class="tok-o">=</span><span class="tok-m">5</span>

<span class="tok-c1"># En la práctica:</span>
<span class="tok-c1"># - Observar error rate de v2</span>
<span class="tok-c1"># - Comparar latencia</span>
<span class="tok-c1"># - Validar que v2 funciona correctamente</span></code></pre>
</div>
</div>
</li>
<li>
<p>Aumentar tráfico a v2 (aumentar replicas):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Escalar v1 a 5 replicas (50%)</span>
kubectl<span class="tok-w"> </span>scale<span class="tok-w"> </span>deployment<span class="tok-w"> </span>myapp-v1<span class="tok-w"> </span>--replicas<span class="tok-o">=</span><span class="tok-m">5</span>

<span class="tok-c1"># Escalar v2 a 5 replicas (50%)</span>
kubectl<span class="tok-w"> </span>scale<span class="tok-w"> </span>deployment<span class="tok-w"> </span>myapp-v2<span class="tok-w"> </span>--replicas<span class="tok-o">=</span><span class="tok-m">5</span>

<span class="tok-c1"># Ver cambio</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>myapp</code></pre>
</div>
</div>
</li>
<li>
<p>Continuar aumentando tráfico a v2:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Escalar v1 a 1 replica (10%)</span>
kubectl<span class="tok-w"> </span>scale<span class="tok-w"> </span>deployment<span class="tok-w"> </span>myapp-v1<span class="tok-w"> </span>--replicas<span class="tok-o">=</span><span class="tok-m">1</span>

<span class="tok-c1"># Escalar v2 a 9 replicas (90%)</span>
kubectl<span class="tok-w"> </span>scale<span class="tok-w"> </span>deployment<span class="tok-w"> </span>myapp-v2<span class="tok-w"> </span>--replicas<span class="tok-o">=</span><span class="tok-m">9</span>

<span class="tok-c1"># Ver proporción actual</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>myapp</code></pre>
</div>
</div>
</li>
<li>
<p>Completar rollout a v2:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Escalar v1 a 0 (eliminar)</span>
kubectl<span class="tok-w"> </span>scale<span class="tok-w"> </span>deployment<span class="tok-w"> </span>myapp-v1<span class="tok-w"> </span>--replicas<span class="tok-o">=</span><span class="tok-m">0</span>

<span class="tok-c1"># Escalar v2 a 10 (100%)</span>
kubectl<span class="tok-w"> </span>scale<span class="tok-w"> </span>deployment<span class="tok-w"> </span>myapp-v2<span class="tok-w"> </span>--replicas<span class="tok-o">=</span><span class="tok-m">10</span>

<span class="tok-c1"># Verificar</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">version</span><span class="tok-o">=</span>v2</code></pre>
</div>
</div>
</li>
<li>
<p>Limpiar:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>-f<span class="tok-w"> </span>canary-v1.yaml<span class="tok-w"> </span>canary-v2.yaml<span class="tok-w"> </span>canary-service.yaml
rm<span class="tok-w"> </span>-f<span class="tok-w"> </span>canary-v1.yaml<span class="tok-w"> </span>canary-v2.yaml<span class="tok-w"> </span>canary-service.yaml</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Cuál es la desventaja de usar número de replicas para control de tráfico?</p>
</li>
<li>
<p>¿Cómo automatizarías estos cambios de replicas basado en métricas?</p>
</li>
<li>
<p>¿Qué problemas surgen si v2 tiene un bug y afecta al 50% de usuarios?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_11_3_rolling_update_avanzado">25.3. Ejercicio 11.3: Rolling Update Avanzado</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Comprender cómo Kubernetes realiza rolling updates nativamente. Controlar la estrategia de actualización.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Crearás un Deployment con rolling update y observarás cómo actualiza Pods gradualmente.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crear Deployment con rolling update personalizado:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>rolling-update.yaml<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;EOF&#39;</span>
<span class="tok-s">apiVersion: apps/v1</span>
<span class="tok-s">kind: Deployment</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: app-rolling</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  replicas: 4</span>
<span class="tok-s">  strategy:</span>
<span class="tok-s">    type: RollingUpdate</span>
<span class="tok-s">    rollingUpdate:</span>
<span class="tok-s">      maxSurge: 1          # Máximo 1 pod adicional</span>
<span class="tok-s">      maxUnavailable: 1    # Máximo 1 pod unavailable</span>
<span class="tok-s">  minReadySeconds: 5       # Esperar 5s antes de considerar ready</span>
<span class="tok-s">  selector:</span>
<span class="tok-s">    matchLabels:</span>
<span class="tok-s">      app: rolling-app</span>
<span class="tok-s">  template:</span>
<span class="tok-s">    metadata:</span>
<span class="tok-s">      labels:</span>
<span class="tok-s">        app: rolling-app</span>
<span class="tok-s">      annotations:</span>
<span class="tok-s">        timestamp: &quot;initial&quot;</span>
<span class="tok-s">    spec:</span>
<span class="tok-s">      containers:</span>
<span class="tok-s">      - name: app</span>
<span class="tok-s">        image: nginx:1.24.0</span>
<span class="tok-s">        ports:</span>
<span class="tok-s">        - containerPort: 80</span>
<span class="tok-s">        readinessProbe:</span>
<span class="tok-s">          httpGet:</span>
<span class="tok-s">            path: /</span>
<span class="tok-s">            port: 80</span>
<span class="tok-s">          initialDelaySeconds: 2</span>
<span class="tok-s">          periodSeconds: 2</span>
<span class="tok-s">        livenessProbe:</span>
<span class="tok-s">          httpGet:</span>
<span class="tok-s">            path: /</span>
<span class="tok-s">            port: 80</span>
<span class="tok-s">          initialDelaySeconds: 5</span>
<span class="tok-s">          periodSeconds: 5</span>
<span class="tok-s">EOF</span>

kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>rolling-update.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Verificar el Deployment inicial:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Ver Pods</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>rolling-app

<span class="tok-c1"># Ver replicaset</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>rs<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>rolling-app

<span class="tok-c1"># Ver status</span>
kubectl<span class="tok-w"> </span>rollout<span class="tok-w"> </span>status<span class="tok-w"> </span>deployment/app-rolling</code></pre>
</div>
</div>
</li>
<li>
<p>Registrar información de las replicas iniciales:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Ver imágenes en uso</span>
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>rolling-app<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>Image</code></pre>
</div>
</div>
</li>
<li>
<p>Iniciar rolling update a nueva versión:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Actualizar imagen (trigger rolling update)</span>
kubectl<span class="tok-w"> </span><span class="tok-nb">set</span><span class="tok-w"> </span>image<span class="tok-w"> </span>deployment/app-rolling<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>nginx:1.25.0<span class="tok-w"> </span>--record

<span class="tok-c1"># Ver estado en tiempo real</span>
kubectl<span class="tok-w"> </span>rollout<span class="tok-w"> </span>status<span class="tok-w"> </span>deployment/app-rolling<span class="tok-w"> </span>--watch</code></pre>
</div>
</div>
</li>
<li>
<p>Monitorear el update en progreso:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># En otra ventana, ver cambios de Pods</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>rolling-app<span class="tok-w"> </span>-w

<span class="tok-c1"># Ver ReplicaSets durante update</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>rs<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>rolling-app</code></pre>
</div>
</div>
</li>
<li>
<p>Ver historial de updates:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>rollout<span class="tok-w"> </span><span class="tok-nb">history</span><span class="tok-w"> </span>deployment/app-rolling

<span class="tok-c1"># Ver detalles de una revisión específica</span>
kubectl<span class="tok-w"> </span>rollout<span class="tok-w"> </span><span class="tok-nb">history</span><span class="tok-w"> </span>deployment/app-rolling<span class="tok-w"> </span>--revision<span class="tok-o">=</span><span class="tok-m">1</span></code></pre>
</div>
</div>
</li>
<li>
<p>Pausar el rolling update (si hay problemas):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Parar en mitad del update</span>
<span class="tok-c1"># kubectl rollout pause deployment/app-rolling</span>

<span class="tok-c1"># Después de investigar, resumir:</span>
<span class="tok-c1"># kubectl rollout resume deployment/app-rolling</span></code></pre>
</div>
</div>
</li>
<li>
<p>Hacer rollback a versión anterior:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Rollback a revisión anterior</span>
kubectl<span class="tok-w"> </span>rollout<span class="tok-w"> </span>undo<span class="tok-w"> </span>deployment/app-rolling

<span class="tok-c1"># Ver status</span>
kubectl<span class="tok-w"> </span>rollout<span class="tok-w"> </span>status<span class="tok-w"> </span>deployment/app-rolling

<span class="tok-c1"># Verificar imagen actualizada</span>
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>rolling-app<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>Image</code></pre>
</div>
</div>
</li>
<li>
<p>Rollback a revisión específica:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Ver historial</span>
kubectl<span class="tok-w"> </span>rollout<span class="tok-w"> </span><span class="tok-nb">history</span><span class="tok-w"> </span>deployment/app-rolling

<span class="tok-c1"># Rollback a revisión específica</span>
kubectl<span class="tok-w"> </span>rollout<span class="tok-w"> </span>undo<span class="tok-w"> </span>deployment/app-rolling<span class="tok-w"> </span>--to-revision<span class="tok-o">=</span><span class="tok-m">1</span>

<span class="tok-c1"># Verificar</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>rs<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>rolling-app</code></pre>
</div>
</div>
</li>
<li>
<p>Limpiar:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>-f<span class="tok-w"> </span>rolling-update.yaml
rm<span class="tok-w"> </span>-f<span class="tok-w"> </span>rolling-update.yaml</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Qué significa <code>maxSurge: 1</code> en tu configuración?</p>
</li>
<li>
<p>¿Cómo controla Kubernetes que los Pods nuevos estén listos?</p>
</li>
<li>
<p>¿Cuál es la diferencia entre pausar y deshacer un rolling update?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_11_4_gitops_con_argocd_simulación">25.4. Ejercicio 11.4: GitOps con ArgoCD (Simulación)</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Entender el flujo de trabajo GitOps sin instalar ArgoCD. Simular cómo un operador sincroniza Git con cluster.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Crearás un script que simula el comportamiento de GitOps: obtener manifiestos de Git y aplicarlos.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crear estructura de repositorio simulado:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>mkdir<span class="tok-w"> </span>-p<span class="tok-w"> </span>gitops-repo/k8s

cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>gitops-repo/k8s/deployment.yaml<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;EOF&#39;</span>
<span class="tok-s">apiVersion: apps/v1</span>
<span class="tok-s">kind: Deployment</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: gitops-app</span>
<span class="tok-s">  namespace: default</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  replicas: 2</span>
<span class="tok-s">  selector:</span>
<span class="tok-s">    matchLabels:</span>
<span class="tok-s">      app: gitops-app</span>
<span class="tok-s">  template:</span>
<span class="tok-s">    metadata:</span>
<span class="tok-s">      labels:</span>
<span class="tok-s">        app: gitops-app</span>
<span class="tok-s">    spec:</span>
<span class="tok-s">      containers:</span>
<span class="tok-s">      - name: app</span>
<span class="tok-s">        image: nginx:1.24.0</span>
<span class="tok-s">        ports:</span>
<span class="tok-s">        - containerPort: 80</span>
<span class="tok-s">EOF</span>

cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>gitops-repo/k8s/service.yaml<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Service</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: gitops-app</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  selector:</span>
<span class="tok-s">    app: gitops-app</span>
<span class="tok-s">  ports:</span>
<span class="tok-s">  - port: 80</span>
<span class="tok-s">    targetPort: 80</span>
<span class="tok-s">  type: LoadBalancer</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Simular un "Application" de ArgoCD:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>gitops-application.yaml<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;EOF&#39;</span>
<span class="tok-s"># Simulación de Application de ArgoCD</span>
<span class="tok-s"># Campos key:</span>
<span class="tok-s"># - source.path: dónde están los manifiestos en Git</span>
<span class="tok-s"># - destination.namespace: dónde desplegar</span>
<span class="tok-s"># - syncPolicy.automated: sincronización automática</span>

<span class="tok-s">metadata:</span>
<span class="tok-s">  name: gitops-app</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  project: default</span>
<span class="tok-s">  source:</span>
<span class="tok-s">    repoURL: file://$(pwd)/gitops-repo</span>
<span class="tok-s">    path: k8s/</span>
<span class="tok-s">    targetRevision: main</span>
<span class="tok-s">  destination:</span>
<span class="tok-s">    server: https://kubernetes.default.svc</span>
<span class="tok-s">    namespace: default</span>
<span class="tok-s">  syncPolicy:</span>
<span class="tok-s">    automated:</span>
<span class="tok-s">      prune: true      # Eliminar recursos no en Git</span>
<span class="tok-s">      selfHeal: true   # Resincronizar si diverge</span>
<span class="tok-s">    syncOptions:</span>
<span class="tok-s">    - CreateNamespace=true</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Simular sincronización inicial (obtener manifiestos de Git):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;=== Simulando: ArgoCD obtiene manifiestos de Git ===&quot;</span>

<span class="tok-c1"># Aplicar todos los manifiestos del &quot;repositorio&quot;</span>
kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>gitops-repo/k8s/

<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;=== Aplicación desplegada ===&quot;</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>deployment,svc<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>gitops-app</code></pre>
</div>
</div>
</li>
<li>
<p>Simular cambio en Git (actualizar imagen):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Cambiar imagen en &quot;repositorio&quot;</span>
sed<span class="tok-w"> </span>-i<span class="tok-w"> </span><span class="tok-s1">&#39;s/nginx:1.24.0/nginx:1.25.0/&#39;</span><span class="tok-w"> </span>gitops-repo/k8s/deployment.yaml

<span class="tok-c1"># Mostrar el cambio</span>
<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;=== Cambio en Git detectado ===&quot;</span>
cat<span class="tok-w"> </span>gitops-repo/k8s/deployment.yaml<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>image:</code></pre>
</div>
</div>
</li>
<li>
<p>Simular sincronización automática (ArgoCD detecta cambio):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;=== Simulando: ArgoCD detecta cambio en Git ===&quot;</span>

<span class="tok-c1"># Aplicar cambios nuevamente (simula sync automático)</span>
kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>gitops-repo/k8s/

<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;=== Cluster sincronizado con Git ===&quot;</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>deployment<span class="tok-w"> </span>gitops-app<span class="tok-w"> </span>-o<span class="tok-w"> </span><span class="tok-nv">jsonpath</span><span class="tok-o">=</span><span class="tok-s1">&#39;{.spec.template.spec.containers[0].image}&#39;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Simular drift detection (alguien cambia cluster manualmente):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Simular cambio manual en cluster (desviación de Git)</span>
<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;=== Simulando cambio manual en cluster ===&quot;</span>
kubectl<span class="tok-w"> </span><span class="tok-nb">set</span><span class="tok-w"> </span>image<span class="tok-w"> </span>deployment/gitops-app<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>nginx:1.22.0

<span class="tok-c1"># Verificar divergencia</span>
<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;En Cluster:&quot;</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>deployment<span class="tok-w"> </span>gitops-app<span class="tok-w"> </span>-o<span class="tok-w"> </span><span class="tok-nv">jsonpath</span><span class="tok-o">=</span><span class="tok-s1">&#39;{.spec.template.spec.containers[0].image}&#39;</span>
<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;&quot;</span>
<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;En Git:&quot;</span>
grep<span class="tok-w"> </span>image:<span class="tok-w"> </span>gitops-repo/k8s/deployment.yaml<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>-oP<span class="tok-w"> </span><span class="tok-s1">&#39;nginx:\d+\.\d+\.\d+&#39;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Simular auto-healing (GitOps restaura estado):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;=== Simulando: Auto-healing restaura estado a Git ===&quot;</span>

<span class="tok-c1"># Aplicar nuevamente (simula reconciliación automática)</span>
kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>gitops-repo/k8s/

<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;Cluster restaurado a estado de Git:&quot;</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>deployment<span class="tok-w"> </span>gitops-app<span class="tok-w"> </span>-o<span class="tok-w"> </span><span class="tok-nv">jsonpath</span><span class="tok-o">=</span><span class="tok-s1">&#39;{.spec.template.spec.containers[0].image}&#39;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Simular rollback via Git:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># En Git, revertir a versión anterior</span>
git<span class="tok-w"> </span>-C<span class="tok-w"> </span>gitops-repo<span class="tok-w"> </span>checkout<span class="tok-w"> </span>HEAD~1<span class="tok-w"> </span>k8s/deployment.yaml<span class="tok-w"> </span><span class="tok-m">2</span>&gt;/dev/null<span class="tok-w"> </span><span class="tok-o">||</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>sed<span class="tok-w"> </span>-i<span class="tok-w"> </span><span class="tok-s1">&#39;s/nginx:1.25.0/nginx:1.24.0/&#39;</span><span class="tok-w"> </span>gitops-repo/k8s/deployment.yaml

<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;=== Cambio reverted en Git ===&quot;</span>

<span class="tok-c1"># Sincronizar cluster</span>
kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>gitops-repo/k8s/

<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;Cluster rollback a versión anterior:&quot;</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>deployment<span class="tok-w"> </span>gitops-app<span class="tok-w"> </span>-o<span class="tok-w"> </span><span class="tok-nv">jsonpath</span><span class="tok-o">=</span><span class="tok-s1">&#39;{.spec.template.spec.containers[0].image}&#39;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Verificar prune (eliminar recursos no en Git):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Crear recurso que NO está en Git</span>
cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>orphan.yaml<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: ConfigMap</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: orphan-config</span>
<span class="tok-s">  labels:</span>
<span class="tok-s">    app: gitops-app</span>
<span class="tok-s">data:</span>
<span class="tok-s">  key: value</span>
<span class="tok-s">EOF</span>

kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>orphan.yaml

<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;ConfigMap creado (no en Git):&quot;</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>configmap<span class="tok-w"> </span>orphan-config

<span class="tok-c1"># Simular prune: eliminar recursos que no están en Git</span>
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>configmap<span class="tok-w"> </span>orphan-config

<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;ConfigMap eliminado (prune simulado)&quot;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Limpiar:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>-f<span class="tok-w"> </span>gitops-repo/k8s/
rm<span class="tok-w"> </span>-rf<span class="tok-w"> </span>gitops-repo<span class="tok-w"> </span>gitops-application.yaml<span class="tok-w"> </span>orphan.yaml</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Cuál es la ventaja de tener Git como "fuente de verdad"?</p>
</li>
<li>
<p>¿Cómo ArgoCD detecta cambios? ¿Polling o webhooks?</p>
</li>
<li>
<p>¿Qué pasaría si alguien hace kubectl apply mientras GitOps está sincronizando?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_11_5_estrategia_de_image_pull_secrets">25.5. Ejercicio 11.5: Estrategia de Image Pull Secrets</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Crear y usar secrets para registros privados. Comprender cómo Kubernetes autentica en registros de imágenes.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Crearás un secret de Docker y lo usarás en un Deployment para obtener imágenes de un registro privado.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crear un Docker Registry secret:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Crear secret para autenticación privada</span>
kubectl<span class="tok-w"> </span>create<span class="tok-w"> </span>secret<span class="tok-w"> </span>docker-registry<span class="tok-w"> </span>private-registry<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--docker-server<span class="tok-o">=</span>registry.example.com<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--docker-username<span class="tok-o">=</span>myuser<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--docker-password<span class="tok-o">=</span>mypassword<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--docker-email<span class="tok-o">=</span>user@example.com

<span class="tok-c1"># Verificar que se creó</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>secret<span class="tok-w"> </span>private-registry</code></pre>
</div>
</div>
</li>
<li>
<p>Ver el contenido del secret (codificado):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># El secret contiene .dockerconfigjson en base64</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>secret<span class="tok-w"> </span>private-registry<span class="tok-w"> </span>-o<span class="tok-w"> </span><span class="tok-nv">jsonpath</span><span class="tok-o">=</span><span class="tok-s1">&#39;{.data.\.dockerconfigjson}&#39;</span><span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>base64<span class="tok-w"> </span>-d<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>jq<span class="tok-w"> </span>.</code></pre>
</div>
</div>
</li>
<li>
<p>Crear un Deployment que usa la imagen privada:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>private-deployment.yaml<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;EOF&#39;</span>
<span class="tok-s">apiVersion: apps/v1</span>
<span class="tok-s">kind: Deployment</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: private-app</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  replicas: 2</span>
<span class="tok-s">  selector:</span>
<span class="tok-s">    matchLabels:</span>
<span class="tok-s">      app: private-app</span>
<span class="tok-s">  template:</span>
<span class="tok-s">    metadata:</span>
<span class="tok-s">      labels:</span>
<span class="tok-s">        app: private-app</span>
<span class="tok-s">    spec:</span>
<span class="tok-s">      # Referencia al secret de autenticación</span>
<span class="tok-s">      imagePullSecrets:</span>
<span class="tok-s">      - name: private-registry</span>

<span class="tok-s">      containers:</span>
<span class="tok-s">      - name: app</span>
<span class="tok-s">        # Imagen en registro privado</span>
<span class="tok-s">        image: registry.example.com/myapp:v1.0.0</span>
<span class="tok-s">        ports:</span>
<span class="tok-s">        - containerPort: 8080</span>
<span class="tok-s">        imagePullPolicy: IfNotPresent</span>
<span class="tok-s">EOF</span>

kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>private-deployment.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Verificar el estado (probablemente fallo de pull):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Los Pods fallarán porque registry.example.com no existe</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>private-app

<span class="tok-c1"># Ver eventos de error</span>
kubectl<span class="tok-w"> </span>describe<span class="tok-w"> </span>pod<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>private-app<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>grep<span class="tok-w"> </span>-A<span class="tok-w"> </span><span class="tok-m">5</span><span class="tok-w"> </span><span class="tok-s2">&quot;Events:&quot;</span>

<span class="tok-c1"># El error debe mencionar: &quot;ImagePullBackOff&quot; o similar</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crear secret para registro privado local (simulación):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Crear secreto para usar imágenes públicas como si fueran privadas</span>
<span class="tok-c1"># (Para demostración, usamos Docker Hub pero como si fuera privado)</span>

kubectl<span class="tok-w"> </span>create<span class="tok-w"> </span>secret<span class="tok-w"> </span>docker-registry<span class="tok-w"> </span>docker-hub-secret<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--docker-server<span class="tok-o">=</span>docker.io<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--docker-username<span class="tok-o">=</span>myuser<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--docker-password<span class="tok-o">=</span>mytoken<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--docker-email<span class="tok-o">=</span>user@example.com<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>--dry-run<span class="tok-o">=</span>client<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>-o<span class="tok-w"> </span>yaml<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>docker-secret.yaml

<span class="tok-c1"># Ver el secret</span>
cat<span class="tok-w"> </span>docker-secret.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Usar secret en ServiceAccount para todos los Pods:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Actualizar el ServiceAccount default para incluir secret</span>
kubectl<span class="tok-w"> </span>patch<span class="tok-w"> </span>serviceaccount<span class="tok-w"> </span>default<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>-p<span class="tok-w"> </span><span class="tok-s1">&#39;{&quot;imagePullSecrets&quot;: [{&quot;name&quot;: &quot;private-registry&quot;}]}&#39;</span>

<span class="tok-c1"># Verificar</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>serviceaccount<span class="tok-w"> </span>default<span class="tok-w"> </span>-o<span class="tok-w"> </span><span class="tok-nv">jsonpath</span><span class="tok-o">=</span><span class="tok-s1">&#39;{.imagePullSecrets}&#39;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crear Deployment que hereda el secret del ServiceAccount:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>app-with-sa.yaml<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;EOF&#39;</span>
<span class="tok-s">apiVersion: apps/v1</span>
<span class="tok-s">kind: Deployment</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: app-with-sa</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  replicas: 1</span>
<span class="tok-s">  selector:</span>
<span class="tok-s">    matchLabels:</span>
<span class="tok-s">      app: app-with-sa</span>
<span class="tok-s">  template:</span>
<span class="tok-s">    metadata:</span>
<span class="tok-s">      labels:</span>
<span class="tok-s">        app: app-with-sa</span>
<span class="tok-s">    spec:</span>
<span class="tok-s">      serviceAccountName: default  # Usa secret del SA</span>
<span class="tok-s">      containers:</span>
<span class="tok-s">      - name: app</span>
<span class="tok-s">        image: nginx:1.24.0</span>
<span class="tok-s">        ports:</span>
<span class="tok-s">        - containerPort: 80</span>
<span class="tok-s">EOF</span>

kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>app-with-sa.yaml

<span class="tok-c1"># Este Pod usará el secret del ServiceAccount</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>app-with-sa</code></pre>
</div>
</div>
</li>
<li>
<p>Ver imagen pull policies:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>pull-policies.yaml<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;EOF&#39;</span>
<span class="tok-s"># Always: siempre pull (para :latest)</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: always-pull</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  imagePullSecrets:</span>
<span class="tok-s">  - name: private-registry</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: registry.example.com/myapp:latest</span>
<span class="tok-s">    imagePullPolicy: Always</span>
<span class="tok-s">---</span>
<span class="tok-s"># IfNotPresent: pull solo si no existe localmente</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: if-not-present</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  imagePullSecrets:</span>
<span class="tok-s">  - name: private-registry</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: registry.example.com/myapp:v1.0.0</span>
<span class="tok-s">    imagePullPolicy: IfNotPresent</span>
<span class="tok-s">---</span>
<span class="tok-s"># Never: no pull, usar imagen local o fallar</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: never-pull</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: myapp:v1.0.0</span>
<span class="tok-s">    imagePullPolicy: Never</span>
<span class="tok-s">EOF</span>

<span class="tok-c1"># No aplicar (fallaría), solo para referencia</span>
cat<span class="tok-w"> </span>pull-policies.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Listar todos los secrets:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>secrets

<span class="tok-c1"># Filtrar solo docker-registry</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>secrets<span class="tok-w"> </span>-o<span class="tok-w"> </span><span class="tok-nv">jsonpath</span><span class="tok-o">=</span><span class="tok-s1">&#39;{range .items[?(@.type==&quot;kubernetes.io/dockercfg&quot;)]}{.metadata.name}{&quot;\n&quot;}{end}&#39;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Limpiar:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>secret<span class="tok-w"> </span>private-registry<span class="tok-w"> </span>docker-hub-secret
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>-f<span class="tok-w"> </span>private-deployment.yaml<span class="tok-w"> </span>app-with-sa.yaml
kubectl<span class="tok-w"> </span>patch<span class="tok-w"> </span>serviceaccount<span class="tok-w"> </span>default<span class="tok-w"> </span>--type<span class="tok-o">=</span><span class="tok-s1">&#39;json&#39;</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>-p<span class="tok-o">=</span><span class="tok-s1">&#39;[{&quot;op&quot;: &quot;remove&quot;, &quot;path&quot;: &quot;/imagePullSecrets&quot;}]&#39;</span>

rm<span class="tok-w"> </span>-f<span class="tok-w"> </span>private-deployment.yaml<span class="tok-w"> </span>app-with-sa.yaml<span class="tok-w"> </span>docker-secret.yaml<span class="tok-w"> </span>pull-policies.yaml</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Cuál es la diferencia entre <code>imagePullSecrets</code> en Pod vs en ServiceAccount?</p>
</li>
<li>
<p>¿Por qué es peligroso usar <code>imagePullPolicy: Always</code> con imágenes privadas?</p>
</li>
<li>
<p>¿Cómo rotatarías credenciales sin romper Pods que ya están corriendo?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_11_6_image_scanning_con_simulación">25.6. Ejercicio 11.6: Image Scanning con Simulación</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Entender cómo funciona el image scanning. Simular detección de vulnerabilidades.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Crearás un script que simula el scanning de vulnerabilidades en imágenes.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Simular descarga de imagen y análisis:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>image-scan-simulator.sh<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;EOF&#39;</span>
<span class="tok-s">#!/bin/bash</span>

<span class="tok-s"># Simulador de Trivy (image scanning)</span>

<span class="tok-s">IMAGE=${1:-nginx:1.24.0}</span>

<span class="tok-s">echo &quot;=== Trivy Image Scan Simulator ===&quot;</span>
<span class="tok-s">echo &quot;Image: $IMAGE&quot;</span>
<span class="tok-s">echo &quot;&quot;</span>

<span class="tok-s"># Simular escaneo</span>
<span class="tok-s">case &quot;$IMAGE&quot; in</span>
<span class="tok-s">  *1.22* | *1.23*)</span>
<span class="tok-s">    echo &quot;High and Critical vulnerabilities found!&quot;</span>
<span class="tok-s">    echo &quot;&quot;</span>
<span class="tok-s">    echo &quot;Vulnerabilities:&quot;</span>
<span class="tok-s">    echo &quot;  CVE-2023-1234 CRITICAL - in openssl&quot;</span>
<span class="tok-s">    echo &quot;  CVE-2023-5678 HIGH - in curl&quot;</span>
<span class="tok-s">    echo &quot;&quot;</span>
<span class="tok-s">    exit 1</span>
<span class="tok-s">    ;;</span>
<span class="tok-s">  *1.24*)</span>
<span class="tok-s">    echo &quot;Medium vulnerabilities found&quot;</span>
<span class="tok-s">    echo &quot;&quot;</span>
<span class="tok-s">    echo &quot;Vulnerabilities:&quot;</span>
<span class="tok-s">    echo &quot;  CVE-2024-1111 MEDIUM - in apt&quot;</span>
<span class="tok-s">    echo &quot;&quot;</span>
<span class="tok-s">    exit 0</span>
<span class="tok-s">    ;;</span>
<span class="tok-s">  *1.25*)</span>
<span class="tok-s">    echo &quot;No vulnerabilities found&quot;</span>
<span class="tok-s">    echo &quot;&quot;</span>
<span class="tok-s">    echo &quot;Status: PASSED&quot;</span>
<span class="tok-s">    exit 0</span>
<span class="tok-s">    ;;</span>
<span class="tok-s">  *)</span>
<span class="tok-s">    echo &quot;Unknown image&quot;</span>
<span class="tok-s">    exit 1</span>
<span class="tok-s">    ;;</span>
<span class="tok-s">esac</span>
<span class="tok-s">EOF</span>

chmod<span class="tok-w"> </span>+x<span class="tok-w"> </span>image-scan-simulator.sh</code></pre>
</div>
</div>
</li>
<li>
<p>Simular scanning de diferentes versiones:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Versión antigua (vulnerabilidades críticas)</span>
<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;=== Scanning nginx:1.22.0 ===&quot;</span>
./image-scan-simulator.sh<span class="tok-w"> </span>nginx:1.22.0
<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;&quot;</span>

<span class="tok-c1"># Versión media (vulnerabilidades medium)</span>
<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;=== Scanning nginx:1.24.0 ===&quot;</span>
./image-scan-simulator.sh<span class="tok-w"> </span>nginx:1.24.0
<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;&quot;</span>

<span class="tok-c1"># Versión nueva (sin vulnerabilidades)</span>
<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;=== Scanning nginx:1.25.0 ===&quot;</span>
./image-scan-simulator.sh<span class="tok-w"> </span>nginx:1.25.0</code></pre>
</div>
</div>
</li>
<li>
<p>Crear política de admission que bloquea imágenes:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>image-policy.yaml<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;EOF&#39;</span>
<span class="tok-s"># Política de Kyverno para bloquear imágenes vulnerables</span>
<span class="tok-s"># (Simulación - no ejecutar realmente)</span>

<span class="tok-s">apiVersion: kyverno.io/v1</span>
<span class="tok-s">kind: ClusterPolicy</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: block-vulnerable-images</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  validationFailureAction: enforce</span>
<span class="tok-s">  rules:</span>
<span class="tok-s">  - name: check-image-version</span>
<span class="tok-s">    match:</span>
<span class="tok-s">      resources:</span>
<span class="tok-s">        kinds:</span>
<span class="tok-s">        - Pod</span>
<span class="tok-s">    validate:</span>
<span class="tok-s">      message: &quot;Image must be &gt;= 1.24.0 for nginx&quot;</span>
<span class="tok-s">      pattern:</span>
<span class="tok-s">        spec:</span>
<span class="tok-s">          containers:</span>
<span class="tok-s">          - image: &quot;nginx:*&quot;</span>
<span class="tok-s">            # Bloquear versiones antiguas</span>
<span class="tok-s">            # Este es un ejemplo simplificado</span>
<span class="tok-s">EOF</span>

cat<span class="tok-w"> </span>image-policy.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Crear script que genera reporte de scanning:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>scan-report.sh<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;EOF&#39;</span>
<span class="tok-s">#!/bin/bash</span>

<span class="tok-s"># Generar reporte de scan de varias imágenes</span>

<span class="tok-s">IMAGES=(</span>
<span class="tok-s">  &quot;nginx:1.22.0&quot;</span>
<span class="tok-s">  &quot;nginx:1.24.0&quot;</span>
<span class="tok-s">  &quot;nginx:1.25.0&quot;</span>
<span class="tok-s">)</span>

<span class="tok-s">echo &quot;=== Image Vulnerability Report ===&quot;</span>
<span class="tok-s">echo &quot;Generated: $(date)&quot;</span>
<span class="tok-s">echo &quot;&quot;</span>

<span class="tok-s">PASSED=0</span>
<span class="tok-s">FAILED=0</span>

<span class="tok-s">for image in &quot;${IMAGES[@]}&quot;; do</span>
<span class="tok-s">  echo &quot;Scanning: $image&quot;</span>
<span class="tok-s">  if ./image-scan-simulator.sh &quot;$image&quot; &gt; /dev/null 2&gt;&amp;1; then</span>
<span class="tok-s">    echo &quot;Status: PASSED ✓&quot;</span>
<span class="tok-s">    ((PASSED++))</span>
<span class="tok-s">  else</span>
<span class="tok-s">    echo &quot;Status: FAILED ✗&quot;</span>
<span class="tok-s">    ((FAILED++))</span>
<span class="tok-s">  fi</span>
<span class="tok-s">  echo &quot;&quot;</span>
<span class="tok-s">done</span>

<span class="tok-s">echo &quot;=== Summary ===&quot;</span>
<span class="tok-s">echo &quot;Total images: ${#IMAGES[@]}&quot;</span>
<span class="tok-s">echo &quot;Passed: $PASSED&quot;</span>
<span class="tok-s">echo &quot;Failed: $FAILED&quot;</span>

<span class="tok-s">if [ $FAILED -gt 0 ]; then</span>
<span class="tok-s">  exit 1</span>
<span class="tok-s">fi</span>
<span class="tok-s">EOF</span>

chmod<span class="tok-w"> </span>+x<span class="tok-w"> </span>scan-report.sh</code></pre>
</div>
</div>
</li>
<li>
<p>Ejecutar el reporte:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>./scan-report.sh</code></pre>
</div>
</div>
</li>
<li>
<p>Simular integración en CI/CD (bloquear builds):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>ci-with-scanning.sh<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;EOF&#39;</span>
<span class="tok-s">#!/bin/bash</span>

<span class="tok-s"># Simulación de CI/CD con scanning integrado</span>

<span class="tok-s">IMAGE_TO_BUILD=&quot;nginx:1.23.0&quot;</span>

<span class="tok-s">echo &quot;=== CI/CD Pipeline with Image Scanning ===&quot;</span>
<span class="tok-s">echo &quot;Building image: $IMAGE_TO_BUILD&quot;</span>
<span class="tok-s">echo &quot;&quot;</span>

<span class="tok-s"># Paso 1: Build (simulado)</span>
<span class="tok-s">echo &quot;Step 1: Building Docker image...&quot;</span>
<span class="tok-s">echo &quot;docker build -t $IMAGE_TO_BUILD .&quot;</span>
<span class="tok-s">echo &quot;&quot;</span>

<span class="tok-s"># Paso 2: Scan</span>
<span class="tok-s">echo &quot;Step 2: Scanning image for vulnerabilities...&quot;</span>
<span class="tok-s">if ./image-scan-simulator.sh &quot;$IMAGE_TO_BUILD&quot; &gt; /dev/null; then</span>
<span class="tok-s">  echo &quot;✓ Image passed scanning&quot;</span>
<span class="tok-s">else</span>
<span class="tok-s">  echo &quot;✗ Image scanning FAILED&quot;</span>
<span class="tok-s">  echo &quot;Blocking deployment due to vulnerabilities&quot;</span>
<span class="tok-s">  exit 1</span>
<span class="tok-s">fi</span>
<span class="tok-s">echo &quot;&quot;</span>

<span class="tok-s"># Paso 3: Push (no se alcanza si scan falla)</span>
<span class="tok-s">echo &quot;Step 3: Pushing to registry...&quot;</span>
<span class="tok-s">echo &quot;docker push $IMAGE_TO_BUILD&quot;</span>
<span class="tok-s">EOF</span>

chmod<span class="tok-w"> </span>+x<span class="tok-w"> </span>ci-with-scanning.sh</code></pre>
</div>
</div>
</li>
<li>
<p>Ejecutar CI/CD con scan fallido:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>./ci-with-scanning.sh</code></pre>
</div>
</div>
</li>
<li>
<p>Mostrar cómo pasar el scan:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Cambiar a versión sin vulnerabilidades</span>
sed<span class="tok-w"> </span>-i<span class="tok-w"> </span><span class="tok-s1">&#39;s/nginx:1.23.0/nginx:1.25.0/&#39;</span><span class="tok-w"> </span>ci-with-scanning.sh

<span class="tok-c1"># Ejecutar nuevamente</span>
./ci-with-scanning.sh</code></pre>
</div>
</div>
</li>
<li>
<p>Crear tabla de políticas de vulnerabilidades:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>vulnerability-policy.yaml<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;EOF&#39;</span>
<span class="tok-s"># Políticas de remediación de vulnerabilidades</span>

<span class="tok-s">policies:</span>
<span class="tok-s">  critical:</span>
<span class="tok-s">    action: &quot;block&quot;           # Bloquear despliegue</span>
<span class="tok-s">    maxAge: &quot;0 days&quot;         # No permitir imágenes antiguas</span>

<span class="tok-s">  high:</span>
<span class="tok-s">    action: &quot;require-approval&quot; # Requiere aprobación manual</span>
<span class="tok-s">    maxAge: &quot;7 days&quot;         # Revisar cada 7 días</span>

<span class="tok-s">  medium:</span>
<span class="tok-s">    action: &quot;warn&quot;           # Solo advertencia</span>
<span class="tok-s">    maxAge: &quot;30 days&quot;        # Revisar cada 30 días</span>

<span class="tok-s">  low:</span>
<span class="tok-s">    action: &quot;allow&quot;          # Permitido</span>
<span class="tok-s">    maxAge: &quot;90 days&quot;</span>

<span class="tok-s">exception_process:</span>
<span class="tok-s">  - name: &quot;Security team reviews&quot;</span>
<span class="tok-s">  - name: &quot;Risk assessment&quot;</span>
<span class="tok-s">  - name: &quot;Approved by CISO&quot;</span>
<span class="tok-s">  - name: &quot;Documented exception&quot;</span>
<span class="tok-s">EOF</span>

cat<span class="tok-w"> </span>vulnerability-policy.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Limpiar:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>rm<span class="tok-w"> </span>-f<span class="tok-w"> </span>image-scan-simulator.sh<span class="tok-w"> </span>scan-report.sh<span class="tok-w"> </span>ci-with-scanning.sh<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">      </span>image-policy.yaml<span class="tok-w"> </span>vulnerability-policy.yaml</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Cómo actualizarías automáticamente imágenes base cuando hay vulnerabilidades?</p>
</li>
<li>
<p>¿Qué diferencia hay entre scanning en CI vs scanning de imágenes en ejecución?</p>
</li>
<li>
<p>¿Cómo balancearías seguridad (bloquear todo) vs velocidad (permitir todo)?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_11_7_rolling_update_con_health_checks">25.7. Ejercicio 11.7: Rolling Update con Health Checks</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Implementar health checks que guían el rolling update. Comprender readiness y liveness probes.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Crearás un Deployment con health checks que controlan si un Pod está listo para recibir tráfico.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crear Deployment con readiness probe fallando:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>health-check.yaml<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;EOF&#39;</span>
<span class="tok-s">apiVersion: apps/v1</span>
<span class="tok-s">kind: Deployment</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: app-health</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  replicas: 4</span>
<span class="tok-s">  strategy:</span>
<span class="tok-s">    type: RollingUpdate</span>
<span class="tok-s">    rollingUpdate:</span>
<span class="tok-s">      maxSurge: 1</span>
<span class="tok-s">      maxUnavailable: 1</span>
<span class="tok-s">  selector:</span>
<span class="tok-s">    matchLabels:</span>
<span class="tok-s">      app: app-health</span>
<span class="tok-s">  template:</span>
<span class="tok-s">    metadata:</span>
<span class="tok-s">      labels:</span>
<span class="tok-s">        app: app-health</span>
<span class="tok-s">    spec:</span>
<span class="tok-s">      containers:</span>
<span class="tok-s">      - name: app</span>
<span class="tok-s">        image: nginx:1.24.0</span>
<span class="tok-s">        ports:</span>
<span class="tok-s">        - containerPort: 80</span>

<span class="tok-s">        # Readiness Probe: ¿está listo para recibir tráfico?</span>
<span class="tok-s">        readinessProbe:</span>
<span class="tok-s">          httpGet:</span>
<span class="tok-s">            path: /</span>
<span class="tok-s">            port: 80</span>
<span class="tok-s">          initialDelaySeconds: 2</span>
<span class="tok-s">          periodSeconds: 2</span>
<span class="tok-s">          timeoutSeconds: 1</span>
<span class="tok-s">          failureThreshold: 3</span>

<span class="tok-s">        # Liveness Probe: ¿sigue vivo el contenedor?</span>
<span class="tok-s">        livenessProbe:</span>
<span class="tok-s">          httpGet:</span>
<span class="tok-s">            path: /</span>
<span class="tok-s">            port: 80</span>
<span class="tok-s">          initialDelaySeconds: 10</span>
<span class="tok-s">          periodSeconds: 10</span>
<span class="tok-s">          failureThreshold: 3</span>
<span class="tok-s">EOF</span>

kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>health-check.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Verificar que todos los Pods están ready:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Ver estado de readiness</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>app-health

<span class="tok-c1"># READY debe ser 1/1 para todos</span></code></pre>
</div>
</div>
</li>
<li>
<p>Simular fallo de readiness probe:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Ejecutar comando que hace que nginx falle health check</span>
<span class="tok-c1"># (simulación: cambiar endpoint)</span>

<span class="tok-c1"># En realidad esto requeriría un pod especial, pero podemos simular:</span>
cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>readiness-failure.yaml<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Pod</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: failing-readiness</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  containers:</span>
<span class="tok-s">  - name: app</span>
<span class="tok-s">    image: nginx:1.24.0</span>
<span class="tok-s">    readinessProbe:</span>
<span class="tok-s">      httpGet:</span>
<span class="tok-s">        path: /nonexistent  # Esta ruta no existe</span>
<span class="tok-s">        port: 80</span>
<span class="tok-s">      initialDelaySeconds: 2</span>
<span class="tok-s">      periodSeconds: 2</span>
<span class="tok-s">      failureThreshold: 1</span>
<span class="tok-s">EOF</span>

kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>readiness-failure.yaml

<span class="tok-c1"># Ver que no está ready</span>
sleep<span class="tok-w"> </span><span class="tok-m">5</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pod<span class="tok-w"> </span>failing-readiness</code></pre>
</div>
</div>
</li>
<li>
<p>Ver endpoints durante readiness failure:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Los Pods no-ready no aparecen en endpoints</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>endpoints<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>app-health<span class="tok-w"> </span><span class="tok-m">2</span>&gt;/dev/null<span class="tok-w"> </span><span class="tok-o">||</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>service<span class="tok-w"> </span>app-health<span class="tok-w"> </span><span class="tok-m">2</span>&gt;/dev/null<span class="tok-w"> </span><span class="tok-o">||</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">  </span><span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;No service created&quot;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Crear Service para ver endpoints:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>health-service.yaml<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Service</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: app-health</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  selector:</span>
<span class="tok-s">    app: app-health</span>
<span class="tok-s">  ports:</span>
<span class="tok-s">  - port: 80</span>
<span class="tok-s">    targetPort: 80</span>
<span class="tok-s">EOF</span>

kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>health-service.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Ver endpoints (solo Pods ready):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>endpoints<span class="tok-w"> </span>app-health</code></pre>
</div>
</div>
</li>
<li>
<p>Actualizar imagen con health check:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;=== Iniciando rolling update ===&quot;</span>

<span class="tok-c1"># El nuevo Pod debe pasar readiness probe antes de ser incluido en endpoints</span>
kubectl<span class="tok-w"> </span><span class="tok-nb">set</span><span class="tok-w"> </span>image<span class="tok-w"> </span>deployment/app-health<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>nginx:1.25.0<span class="tok-w"> </span>--record

<span class="tok-c1"># Monitorear en tiempo real</span>
kubectl<span class="tok-w"> </span>rollout<span class="tok-w"> </span>status<span class="tok-w"> </span>deployment/app-health<span class="tok-w"> </span>--watch</code></pre>
</div>
</div>
</li>
<li>
<p>Ver Pods nuevos pasando readiness:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Los nuevos Pods pasan el readiness check gradualmente</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>app-health<span class="tok-w"> </span>-o<span class="tok-w"> </span>wide

<span class="tok-c1"># Ver cambio de endpoints</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>endpoints<span class="tok-w"> </span>app-health</code></pre>
</div>
</div>
</li>
<li>
<p>Simular un update que falla health check:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Actualizar a imagen que tiene endpoint incorrecto</span>
cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>bad-deployment.yaml<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;EOF&#39;</span>
<span class="tok-s">apiVersion: apps/v1</span>
<span class="tok-s">kind: Deployment</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: bad-health</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  replicas: 2</span>
<span class="tok-s">  strategy:</span>
<span class="tok-s">    type: RollingUpdate</span>
<span class="tok-s">    rollingUpdate:</span>
<span class="tok-s">      maxSurge: 1</span>
<span class="tok-s">      maxUnavailable: 0</span>
<span class="tok-s">  selector:</span>
<span class="tok-s">    matchLabels:</span>
<span class="tok-s">      app: bad-health</span>
<span class="tok-s">  template:</span>
<span class="tok-s">    metadata:</span>
<span class="tok-s">      labels:</span>
<span class="tok-s">        app: bad-health</span>
<span class="tok-s">    spec:</span>
<span class="tok-s">      containers:</span>
<span class="tok-s">      - name: app</span>
<span class="tok-s">        image: nginx:1.24.0</span>
<span class="tok-s">        readinessProbe:</span>
<span class="tok-s">          httpGet:</span>
<span class="tok-s">            path: /admin  # Ruta que no existe por defecto</span>
<span class="tok-s">            port: 80</span>
<span class="tok-s">          initialDelaySeconds: 1</span>
<span class="tok-s">          periodSeconds: 1</span>
<span class="tok-s">          failureThreshold: 1</span>
<span class="tok-s">EOF</span>

kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>bad-deployment.yaml

<span class="tok-c1"># Ver que Pods nunca llegan a ready</span>
sleep<span class="tok-w"> </span><span class="tok-m">10</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>bad-health</code></pre>
</div>
</div>
</li>
<li>
<p>Limpiar:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>deployment<span class="tok-w"> </span>app-health<span class="tok-w"> </span>bad-health
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>pod<span class="tok-w"> </span>failing-readiness
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>-f<span class="tok-w"> </span>health-service.yaml
rm<span class="tok-w"> </span>-f<span class="tok-w"> </span>health-check.yaml<span class="tok-w"> </span>readiness-failure.yaml<span class="tok-w"> </span>bad-deployment.yaml<span class="tok-w"> </span>health-service.yaml</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Cuál es la diferencia entre readiness y liveness probes?</p>
</li>
<li>
<p>¿Qué sucede si initialDelaySeconds es muy bajo para tu aplicación?</p>
</li>
<li>
<p>¿Cómo asegurarías que todos los Pods sean ready antes de remover los antiguos?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_11_8_recreate_strategy_vs_rolling_update">25.8. Ejercicio 11.8: Recreate Strategy vs Rolling Update</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Comprender cuándo usar cada estrategia de deployment. Conocer trade-offs.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Compararás dos deployment strategies: Recreate (downtime) vs RollingUpdate (sin downtime).</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crear Deployment con estrategia Recreate:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>recreate-deployment.yaml<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;EOF&#39;</span>
<span class="tok-s">apiVersion: apps/v1</span>
<span class="tok-s">kind: Deployment</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: app-recreate</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  replicas: 3</span>
<span class="tok-s">  strategy:</span>
<span class="tok-s">    type: Recreate    # Eliminar todos, luego crear nuevos</span>
<span class="tok-s">  selector:</span>
<span class="tok-s">    matchLabels:</span>
<span class="tok-s">      app: app-recreate</span>
<span class="tok-s">  template:</span>
<span class="tok-s">    metadata:</span>
<span class="tok-s">      labels:</span>
<span class="tok-s">        app: app-recreate</span>
<span class="tok-s">      annotations:</span>
<span class="tok-s">        timestamp: &quot;start&quot;</span>
<span class="tok-s">    spec:</span>
<span class="tok-s">      containers:</span>
<span class="tok-s">      - name: app</span>
<span class="tok-s">        image: nginx:1.24.0</span>
<span class="tok-s">        ports:</span>
<span class="tok-s">        - containerPort: 80</span>
<span class="tok-s">EOF</span>

kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>recreate-deployment.yaml

<span class="tok-c1"># Verificar</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>app-recreate</code></pre>
</div>
</div>
</li>
<li>
<p>Crear Deployment con estrategia RollingUpdate:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>rolling-deployment.yaml<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;EOF&#39;</span>
<span class="tok-s">apiVersion: apps/v1</span>
<span class="tok-s">kind: Deployment</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: app-rolling</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  replicas: 3</span>
<span class="tok-s">  strategy:</span>
<span class="tok-s">    type: RollingUpdate</span>
<span class="tok-s">    rollingUpdate:</span>
<span class="tok-s">      maxSurge: 1</span>
<span class="tok-s">      maxUnavailable: 1</span>
<span class="tok-s">  selector:</span>
<span class="tok-s">    matchLabels:</span>
<span class="tok-s">      app: app-rolling</span>
<span class="tok-s">  template:</span>
<span class="tok-s">    metadata:</span>
<span class="tok-s">      labels:</span>
<span class="tok-s">        app: app-rolling</span>
<span class="tok-s">    spec:</span>
<span class="tok-s">      containers:</span>
<span class="tok-s">      - name: app</span>
<span class="tok-s">        image: nginx:1.24.0</span>
<span class="tok-s">        ports:</span>
<span class="tok-s">        - containerPort: 80</span>
<span class="tok-s">EOF</span>

kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>rolling-deployment.yaml

<span class="tok-c1"># Verificar</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>app-rolling</code></pre>
</div>
</div>
</li>
<li>
<p>Crear Services para ambos:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>services.yaml<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;EOF&#39;</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Service</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: app-recreate</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  selector:</span>
<span class="tok-s">    app: app-recreate</span>
<span class="tok-s">  ports:</span>
<span class="tok-s">  - port: 80</span>
<span class="tok-s">    targetPort: 80</span>
<span class="tok-s">---</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Service</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: app-rolling</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  selector:</span>
<span class="tok-s">    app: app-rolling</span>
<span class="tok-s">  ports:</span>
<span class="tok-s">  - port: 80</span>
<span class="tok-s">    targetPort: 80</span>
<span class="tok-s">EOF</span>

kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>services.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Monitorear Recreate strategy durante update:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># En una ventana</span>
<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;=== Monitoreo de Recreate Strategy ===&quot;</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>app-recreate<span class="tok-w"> </span>-w

<span class="tok-c1"># En otra ventana, iniciar update</span>
<span class="tok-c1"># (esperar a que la primera ventana muestre el comando)</span></code></pre>
</div>
</div>
</li>
<li>
<p>Realizar update con Recreate (window 2):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;=== Iniciando Recreate Update ===&quot;</span>
kubectl<span class="tok-w"> </span><span class="tok-nb">set</span><span class="tok-w"> </span>image<span class="tok-w"> </span>deployment/app-recreate<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>nginx:1.25.0<span class="tok-w"> </span>--record

<span class="tok-c1"># Ver estado</span>
kubectl<span class="tok-w"> </span>rollout<span class="tok-w"> </span>status<span class="tok-w"> </span>deployment/app-recreate</code></pre>
</div>
</div>
</li>
<li>
<p>Observar el downtime:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Durante el update, todos los Pods están siendo eliminados</span>
<span class="tok-c1"># y luego recreados con nueva imagen</span>
<span class="tok-c1"># Habrá momento donde no hay Pods listos (downtime)</span>

kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>app-recreate</code></pre>
</div>
</div>
</li>
<li>
<p>Monitorear RollingUpdate strategy (ventana 1):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># En una ventana</span>
<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;=== Monitoreo de RollingUpdate Strategy ===&quot;</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>app-rolling<span class="tok-w"> </span>-w

<span class="tok-c1"># Esperar...</span></code></pre>
</div>
</div>
</li>
<li>
<p>Realizar update con RollingUpdate (ventana 2):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;=== Iniciando RollingUpdate Update ===&quot;</span>
kubectl<span class="tok-w"> </span><span class="tok-nb">set</span><span class="tok-w"> </span>image<span class="tok-w"> </span>deployment/app-rolling<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>nginx:1.25.0<span class="tok-w"> </span>--record

<span class="tok-c1"># Ver estado</span>
kubectl<span class="tok-w"> </span>rollout<span class="tok-w"> </span>status<span class="tok-w"> </span>deployment/app-rolling</code></pre>
</div>
</div>
</li>
<li>
<p>Comparar disponibilidad durante updates:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Recreate: todos los Pods eliminados simultáneamente = downtime</span>
<span class="tok-c1"># Rolling: siempre hay Pods listos = sin downtime</span>

kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>deployment<span class="tok-w"> </span>app-recreate<span class="tok-w"> </span>app-rolling<span class="tok-w"> </span>-o<span class="tok-w"> </span>wide</code></pre>
</div>
</div>
</li>
<li>
<p>Limpiar:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>deployment<span class="tok-w"> </span>app-recreate<span class="tok-w"> </span>app-rolling
kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>-f<span class="tok-w"> </span>services.yaml
rm<span class="tok-w"> </span>-f<span class="tok-w"> </span>recreate-deployment.yaml<span class="tok-w"> </span>rolling-deployment.yaml<span class="tok-w"> </span>services.yaml</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Cuándo usarías Recreate a pesar del downtime?</p>
</li>
<li>
<p>¿Cómo afectaría cada strategy a una aplicación con estado (database)?</p>
</li>
<li>
<p>¿Cuál es más rápido: Recreate o RollingUpdate?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_11_9_multi_environment_deployment">25.9. Ejercicio 11.9: Multi-Environment Deployment</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Desplegar la misma aplicación en múltiples ambientes (dev, staging, prod) con configuraciones diferentes.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Crearás manifiestos para dev, staging y prod, cada uno con valores apropiados.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crear namespaces para ambientes:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>create<span class="tok-w"> </span>namespace<span class="tok-w"> </span>dev
kubectl<span class="tok-w"> </span>create<span class="tok-w"> </span>namespace<span class="tok-w"> </span>staging
kubectl<span class="tok-w"> </span>create<span class="tok-w"> </span>namespace<span class="tok-w"> </span>prod

<span class="tok-c1"># Verificar</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>namespaces</code></pre>
</div>
</div>
</li>
<li>
<p>Crear manifiestos base (compartidos):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>base-app.yaml<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;EOF&#39;</span>
<span class="tok-s">apiVersion: apps/v1</span>
<span class="tok-s">kind: Deployment</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: myapp</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  selector:</span>
<span class="tok-s">    matchLabels:</span>
<span class="tok-s">      app: myapp</span>
<span class="tok-s">  template:</span>
<span class="tok-s">    metadata:</span>
<span class="tok-s">      labels:</span>
<span class="tok-s">        app: myapp</span>
<span class="tok-s">    spec:</span>
<span class="tok-s">      containers:</span>
<span class="tok-s">      - name: app</span>
<span class="tok-s">        image: nginx:1.24.0</span>
<span class="tok-s">        ports:</span>
<span class="tok-s">        - containerPort: 80</span>
<span class="tok-s">---</span>
<span class="tok-s">apiVersion: v1</span>
<span class="tok-s">kind: Service</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: myapp</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  selector:</span>
<span class="tok-s">    app: myapp</span>
<span class="tok-s">  ports:</span>
<span class="tok-s">  - port: 80</span>
<span class="tok-s">    targetPort: 80</span>
<span class="tok-s">EOF</span></code></pre>
</div>
</div>
</li>
<li>
<p>Desplegar a DEV con réplica mínima:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>dev-override.yaml<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;EOF&#39;</span>
<span class="tok-s">apiVersion: apps/v1</span>
<span class="tok-s">kind: Deployment</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: myapp</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  replicas: 1  # DEV: mínimo</span>
<span class="tok-s">  template:</span>
<span class="tok-s">    spec:</span>
<span class="tok-s">      containers:</span>
<span class="tok-s">      - name: app</span>
<span class="tok-s">        image: nginx:1.24.0</span>
<span class="tok-s">        resources:</span>
<span class="tok-s">          requests:</span>
<span class="tok-s">            cpu: 50m</span>
<span class="tok-s">            memory: 32Mi</span>
<span class="tok-s">          limits:</span>
<span class="tok-s">            cpu: 100m</span>
<span class="tok-s">            memory: 64Mi</span>
<span class="tok-s">EOF</span>

kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-n<span class="tok-w"> </span>dev<span class="tok-w"> </span>-f<span class="tok-w"> </span>base-app.yaml
kubectl<span class="tok-w"> </span>patch<span class="tok-w"> </span>deployment<span class="tok-w"> </span>myapp<span class="tok-w"> </span>-n<span class="tok-w"> </span>dev<span class="tok-w"> </span>--patch-file<span class="tok-w"> </span>dev-override.yaml

<span class="tok-c1"># Verificar</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-n<span class="tok-w"> </span>dev</code></pre>
</div>
</div>
</li>
<li>
<p>Desplegar a STAGING con configuración media:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>staging-override.yaml<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;EOF&#39;</span>
<span class="tok-s">apiVersion: apps/v1</span>
<span class="tok-s">kind: Deployment</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: myapp</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  replicas: 2  # STAGING: dos replicas</span>
<span class="tok-s">  template:</span>
<span class="tok-s">    spec:</span>
<span class="tok-s">      containers:</span>
<span class="tok-s">      - name: app</span>
<span class="tok-s">        image: nginx:1.24.0</span>
<span class="tok-s">        resources:</span>
<span class="tok-s">          requests:</span>
<span class="tok-s">            cpu: 200m</span>
<span class="tok-s">            memory: 128Mi</span>
<span class="tok-s">          limits:</span>
<span class="tok-s">            cpu: 500m</span>
<span class="tok-s">            memory: 256Mi</span>
<span class="tok-s">EOF</span>

kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-n<span class="tok-w"> </span>staging<span class="tok-w"> </span>-f<span class="tok-w"> </span>base-app.yaml
kubectl<span class="tok-w"> </span>patch<span class="tok-w"> </span>deployment<span class="tok-w"> </span>myapp<span class="tok-w"> </span>-n<span class="tok-w"> </span>staging<span class="tok-w"> </span>--patch-file<span class="tok-w"> </span>staging-override.yaml

<span class="tok-c1"># Verificar</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-n<span class="tok-w"> </span>staging</code></pre>
</div>
</div>
</li>
<li>
<p>Desplegar a PROD con alta disponibilidad:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>prod-override.yaml<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;EOF&#39;</span>
<span class="tok-s">apiVersion: apps/v1</span>
<span class="tok-s">kind: Deployment</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: myapp</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  replicas: 5  # PROD: 5 replicas</span>
<span class="tok-s">  strategy:</span>
<span class="tok-s">    type: RollingUpdate</span>
<span class="tok-s">    rollingUpdate:</span>
<span class="tok-s">      maxSurge: 2</span>
<span class="tok-s">      maxUnavailable: 0</span>
<span class="tok-s">  template:</span>
<span class="tok-s">    spec:</span>
<span class="tok-s">      containers:</span>
<span class="tok-s">      - name: app</span>
<span class="tok-s">        image: nginx:1.24.0</span>
<span class="tok-s">        resources:</span>
<span class="tok-s">          requests:</span>
<span class="tok-s">            cpu: 500m</span>
<span class="tok-s">            memory: 256Mi</span>
<span class="tok-s">          limits:</span>
<span class="tok-s">            cpu: 1000m</span>
<span class="tok-s">            memory: 512Mi</span>
<span class="tok-s">        readinessProbe:</span>
<span class="tok-s">          httpGet:</span>
<span class="tok-s">            path: /</span>
<span class="tok-s">            port: 80</span>
<span class="tok-s">          periodSeconds: 5</span>
<span class="tok-s">        livenessProbe:</span>
<span class="tok-s">          httpGet:</span>
<span class="tok-s">            path: /</span>
<span class="tok-s">            port: 80</span>
<span class="tok-s">          periodSeconds: 10</span>
<span class="tok-s">EOF</span>

kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-n<span class="tok-w"> </span>prod<span class="tok-w"> </span>-f<span class="tok-w"> </span>base-app.yaml
kubectl<span class="tok-w"> </span>patch<span class="tok-w"> </span>deployment<span class="tok-w"> </span>myapp<span class="tok-w"> </span>-n<span class="tok-w"> </span>prod<span class="tok-w"> </span>--patch-file<span class="tok-w"> </span>prod-override.yaml

<span class="tok-c1"># Verificar</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-n<span class="tok-w"> </span>prod</code></pre>
</div>
</div>
</li>
<li>
<p>Ver resumen de todos los ambientes:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;=== DEV ===&quot;</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>deployment<span class="tok-w"> </span>-n<span class="tok-w"> </span>dev
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-n<span class="tok-w"> </span>dev<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>wc<span class="tok-w"> </span>-l

<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;&quot;</span>
<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;=== STAGING ===&quot;</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>deployment<span class="tok-w"> </span>-n<span class="tok-w"> </span>staging
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-n<span class="tok-w"> </span>staging<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>wc<span class="tok-w"> </span>-l

<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;&quot;</span>
<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;=== PROD ===&quot;</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>deployment<span class="tok-w"> </span>-n<span class="tok-w"> </span>prod
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-n<span class="tok-w"> </span>prod<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>wc<span class="tok-w"> </span>-l</code></pre>
</div>
</div>
</li>
<li>
<p>Actualizar versión solo en STAGING primero:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Staging es ambiente de &quot;canary&quot; antes de prod</span>
kubectl<span class="tok-w"> </span><span class="tok-nb">set</span><span class="tok-w"> </span>image<span class="tok-w"> </span>deployment/myapp<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>nginx:1.25.0<span class="tok-w"> </span>-n<span class="tok-w"> </span>staging

<span class="tok-c1"># Verificar</span>
kubectl<span class="tok-w"> </span>rollout<span class="tok-w"> </span>status<span class="tok-w"> </span>deployment/myapp<span class="tok-w"> </span>-n<span class="tok-w"> </span>staging</code></pre>
</div>
</div>
</li>
<li>
<p>Después de validar, actualizar PROD:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Una vez validado en staging, desplegar a producción</span>
kubectl<span class="tok-w"> </span><span class="tok-nb">set</span><span class="tok-w"> </span>image<span class="tok-w"> </span>deployment/myapp<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>nginx:1.25.0<span class="tok-w"> </span>-n<span class="tok-w"> </span>prod

<span class="tok-c1"># Monitorear el rolling update</span>
kubectl<span class="tok-w"> </span>rollout<span class="tok-w"> </span>status<span class="tok-w"> </span>deployment/myapp<span class="tok-w"> </span>-n<span class="tok-w"> </span>prod<span class="tok-w"> </span>--watch</code></pre>
</div>
</div>
</li>
<li>
<p>Mantener DEV con versión de desarrollo:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># DEV puede tener latest para pruebas rápidas</span>
kubectl<span class="tok-w"> </span><span class="tok-nb">set</span><span class="tok-w"> </span>image<span class="tok-w"> </span>deployment/myapp<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>nginx:latest<span class="tok-w"> </span>-n<span class="tok-w"> </span>dev

<span class="tok-c1"># Ver diferencias</span>
<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;DEV:&quot;</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>deployment<span class="tok-w"> </span>myapp<span class="tok-w"> </span>-n<span class="tok-w"> </span>dev<span class="tok-w"> </span>-o<span class="tok-w"> </span><span class="tok-nv">jsonpath</span><span class="tok-o">=</span><span class="tok-s1">&#39;{.spec.template.spec.containers[0].image}&#39;</span>

<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;&quot;</span>
<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;STAGING:&quot;</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>deployment<span class="tok-w"> </span>myapp<span class="tok-w"> </span>-n<span class="tok-w"> </span>staging<span class="tok-w"> </span>-o<span class="tok-w"> </span><span class="tok-nv">jsonpath</span><span class="tok-o">=</span><span class="tok-s1">&#39;{.spec.template.spec.containers[0].image}&#39;</span>

<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;&quot;</span>
<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;PROD:&quot;</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>deployment<span class="tok-w"> </span>myapp<span class="tok-w"> </span>-n<span class="tok-w"> </span>prod<span class="tok-w"> </span>-o<span class="tok-w"> </span><span class="tok-nv">jsonpath</span><span class="tok-o">=</span><span class="tok-s1">&#39;{.spec.template.spec.containers[0].image}&#39;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Limpiar:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>namespace<span class="tok-w"> </span>dev<span class="tok-w"> </span>staging<span class="tok-w"> </span>prod
rm<span class="tok-w"> </span>-f<span class="tok-w"> </span>base-app.yaml<span class="tok-w"> </span>dev-override.yaml<span class="tok-w"> </span>staging-override.yaml<span class="tok-w"> </span>prod-override.yaml</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Cuál es el beneficio de tener STAGING idéntico a PROD?</p>
</li>
<li>
<p>¿Cómo automatizarías la promoción de versiones dev → staging → prod?</p>
</li>
<li>
<p>¿Qué pasaría si DEV y PROD comparten la misma base de datos?</p>
</li>
</ol>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_ejercicio_11_10_rollout_control_y_monitoring">25.10. Ejercicio 11.10: Rollout Control y Monitoring</h3>
<div class="paragraph">
<p><strong>Objetivo de aprendizaje:</strong>
Controlar el proceso de rollout con pausas y reanudaciones. Monitorear el estado de despliegues.</p>
</div>
<div class="paragraph">
<p><strong>Descripción:</strong>
Crearás un rollout y practicarás pausing/resuming para control manual del proceso.</p>
</div>
<div class="paragraph">
<p><strong>Tareas:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crear Deployment para rollout control:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat<span class="tok-w"> </span>&gt;<span class="tok-w"> </span>rollout-control.yaml<span class="tok-w"> </span><span class="tok-s">&lt;&lt; &#39;EOF&#39;</span>
<span class="tok-s">apiVersion: apps/v1</span>
<span class="tok-s">kind: Deployment</span>
<span class="tok-s">metadata:</span>
<span class="tok-s">  name: app-rollout</span>
<span class="tok-s">spec:</span>
<span class="tok-s">  replicas: 8</span>
<span class="tok-s">  strategy:</span>
<span class="tok-s">    type: RollingUpdate</span>
<span class="tok-s">    rollingUpdate:</span>
<span class="tok-s">      maxSurge: 2</span>
<span class="tok-s">      maxUnavailable: 2</span>
<span class="tok-s">  selector:</span>
<span class="tok-s">    matchLabels:</span>
<span class="tok-s">      app: app-rollout</span>
<span class="tok-s">  template:</span>
<span class="tok-s">    metadata:</span>
<span class="tok-s">      labels:</span>
<span class="tok-s">        app: app-rollout</span>
<span class="tok-s">    spec:</span>
<span class="tok-s">      containers:</span>
<span class="tok-s">      - name: app</span>
<span class="tok-s">        image: nginx:1.24.0</span>
<span class="tok-s">        ports:</span>
<span class="tok-s">        - containerPort: 80</span>
<span class="tok-s">        readinessProbe:</span>
<span class="tok-s">          httpGet:</span>
<span class="tok-s">            path: /</span>
<span class="tok-s">            port: 80</span>
<span class="tok-s">          initialDelaySeconds: 2</span>
<span class="tok-s">          periodSeconds: 2</span>
<span class="tok-s">EOF</span>

kubectl<span class="tok-w"> </span>apply<span class="tok-w"> </span>-f<span class="tok-w"> </span>rollout-control.yaml

<span class="tok-c1"># Verificar</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>app-rollout</code></pre>
</div>
</div>
</li>
<li>
<p>Ver historial de rollouts:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>rollout<span class="tok-w"> </span><span class="tok-nb">history</span><span class="tok-w"> </span>deployment/app-rollout

<span class="tok-c1"># Salida esperada:</span>
<span class="tok-c1"># REVISION  CHANGE-CAUSE</span>
<span class="tok-c1"># 1         &lt;none&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Iniciar rollout a nueva versión:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># En una ventana, monitorear</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>app-rollout<span class="tok-w"> </span>-w

<span class="tok-c1"># En otra ventana, iniciar update</span>
<span class="tok-c1"># (esperar a que primera ventana esté lista)</span></code></pre>
</div>
</div>
</li>
<li>
<p>Iniciar el update (ventana 2):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span><span class="tok-nb">set</span><span class="tok-w"> </span>image<span class="tok-w"> </span>deployment/app-rollout<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>nginx:1.25.0<span class="tok-w"> </span>--record

<span class="tok-c1"># Ver estado</span>
kubectl<span class="tok-w"> </span>rollout<span class="tok-w"> </span>status<span class="tok-w"> </span>deployment/app-rollout</code></pre>
</div>
</div>
</li>
<li>
<p>Pausar el rollout a mitad de camino:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Esperar a que el update esté a mitad</span>
<span class="tok-c1"># (se verá en la ventana de monitoreo con pods antiguos y nuevos)</span>

<span class="tok-c1"># Pausar el update</span>
kubectl<span class="tok-w"> </span>rollout<span class="tok-w"> </span>pause<span class="tok-w"> </span>deployment/app-rollout

<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;Update paused - observar estado&quot;</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>app-rollout

<span class="tok-c1"># Ver replicasets</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>rs<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>app-rollout</code></pre>
</div>
</div>
</li>
<li>
<p>Investigar durante pausa:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Mientras está pausado, verificar status</span>
kubectl<span class="tok-w"> </span>rollout<span class="tok-w"> </span>status<span class="tok-w"> </span>deployment/app-rollout

<span class="tok-c1"># Ver que algunos Pods tienen versión nueva, otros vieja</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>app-rollout<span class="tok-w"> </span>-o<span class="tok-w"> </span><span class="tok-nv">jsonpath</span><span class="tok-o">=</span><span class="tok-s1">&#39;{range .items[*]}{.metadata.name}{&quot;\t&quot;}{.spec.containers[0].image}{&quot;\n&quot;}{end}&#39;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Resumir el rollout:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;Resumiendo update...&quot;</span>

kubectl<span class="tok-w"> </span>rollout<span class="tok-w"> </span>resume<span class="tok-w"> </span>deployment/app-rollout

<span class="tok-c1"># Monitorear hasta completar</span>
kubectl<span class="tok-w"> </span>rollout<span class="tok-w"> </span>status<span class="tok-w"> </span>deployment/app-rollout<span class="tok-w"> </span>--watch</code></pre>
</div>
</div>
</li>
<li>
<p>Ver historial después del rollout:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>rollout<span class="tok-w"> </span><span class="tok-nb">history</span><span class="tok-w"> </span>deployment/app-rollout

<span class="tok-c1"># Ahora debería haber 2 revisiones</span>
<span class="tok-c1"># REVISION  CHANGE-CAUSE</span>
<span class="tok-c1"># 1         &lt;none&gt;</span>
<span class="tok-c1"># 2         kubectl set image ...</span></code></pre>
</div>
</div>
</li>
<li>
<p>Ver detalles de cada revisión:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Revisión 1 (original)</span>
kubectl<span class="tok-w"> </span>rollout<span class="tok-w"> </span><span class="tok-nb">history</span><span class="tok-w"> </span>deployment/app-rollout<span class="tok-w"> </span>--revision<span class="tok-o">=</span><span class="tok-m">1</span>

<span class="tok-c1"># Revisión 2 (actualizada)</span>
kubectl<span class="tok-w"> </span>rollout<span class="tok-w"> </span><span class="tok-nb">history</span><span class="tok-w"> </span>deployment/app-rollout<span class="tok-w"> </span>--revision<span class="tok-o">=</span><span class="tok-m">2</span></code></pre>
</div>
</div>
</li>
<li>
<p>Hacer rollback y ver nuevo rollout:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;=== Rollback a revisión anterior ===&quot;</span>

kubectl<span class="tok-w"> </span>rollout<span class="tok-w"> </span>undo<span class="tok-w"> </span>deployment/app-rollout

<span class="tok-c1"># Ver status del undo (es otro rollout)</span>
kubectl<span class="tok-w"> </span>rollout<span class="tok-w"> </span>status<span class="tok-w"> </span>deployment/app-rollout

<span class="tok-c1"># Verificar que volvimos a imagen antigua</span>
kubectl<span class="tok-w"> </span>get<span class="tok-w"> </span>pods<span class="tok-w"> </span>-l<span class="tok-w"> </span><span class="tok-nv">app</span><span class="tok-o">=</span>app-rollout<span class="tok-w"> </span>-o<span class="tok-w"> </span><span class="tok-nv">jsonpath</span><span class="tok-o">=</span><span class="tok-s1">&#39;{range .items[*]}{.spec.containers[0].image}{&quot;\n&quot;}{end}&#39;</span><span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>sort<span class="tok-w"> </span><span class="tok-p">|</span><span class="tok-w"> </span>uniq<span class="tok-w"> </span>-c</code></pre>
</div>
</div>
</li>
<li>
<p>Ver historial después del rollback:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>rollout<span class="tok-w"> </span><span class="tok-nb">history</span><span class="tok-w"> </span>deployment/app-rollout

<span class="tok-c1"># Ahora hay 3 revisiones (el undo crea una nueva revisión)</span></code></pre>
</div>
</div>
</li>
<li>
<p>Limpiar:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>kubectl<span class="tok-w"> </span>delete<span class="tok-w"> </span>-f<span class="tok-w"> </span>rollout-control.yaml
rm<span class="tok-w"> </span>-f<span class="tok-w"> </span>rollout-control.yaml</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Preguntas de reflexión:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>¿Cuál es el caso de uso para pausar un rollout?</p>
</li>
<li>
<p>¿Cómo sabría que está seguro resumir un rollout pausado?</p>
</li>
<li>
<p>¿Cómo monitorizarías un rollout para detectar problemas automáticamente?</p>
</li>
</ol>
</div>
<hr>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resumen_de_conceptos_11">26. Resumen de Conceptos</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Estos ejercicios del Módulo 11 cubren:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Ejercicio 11.1</strong>: Blue-Green Deployment</p>
</li>
<li>
<p><strong>Ejercicio 11.2</strong>: Canary Deployment</p>
</li>
<li>
<p><strong>Ejercicio 11.3</strong>: Rolling Update Avanzado</p>
</li>
<li>
<p><strong>Ejercicio 11.4</strong>: GitOps (ArgoCD Simulation)</p>
</li>
<li>
<p><strong>Ejercicio 11.5</strong>: Image Pull Secrets</p>
</li>
<li>
<p><strong>Ejercicio 11.6</strong>: Image Scanning</p>
</li>
<li>
<p><strong>Ejercicio 11.7</strong>: Health Checks Impacting Rollouts</p>
</li>
<li>
<p><strong>Ejercicio 11.8</strong>: Recreate vs Rolling Strategy</p>
</li>
<li>
<p><strong>Ejercicio 11.9</strong>: Multi-Environment Deployments</p>
</li>
<li>
<p><strong>Ejercicio 11.10</strong>: Rollout Control y Monitoring</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_próximos_pasos_5">27. Próximos Pasos</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Una vez completes estos ejercicios, estarás listo para:
* Módulo 12: Service Mesh
* Módulo 13: Advanced Operations
* Módulo 14: Disaster Recovery &amp; Backup
* Y módulos posteriores&#8230;&#8203;</p>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2025-11-24 07:56:08 +0100
</div>
</div>
</body>
</html>